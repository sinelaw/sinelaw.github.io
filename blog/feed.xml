<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.3.3">Jekyll</generator><link href="/blog/feed.xml" rel="self" type="application/atom+xml" /><link href="/blog/" rel="alternate" type="text/html" /><updated>2025-12-08T21:47:45+00:00</updated><id>/blog/feed.xml</id><title type="html">Noam Lewis - The Blog</title><entry><title type="html">How Fresh Loads Huge Files Fast</title><link href="/blog/2025/12/08/how-fresh-loads-huge-files-fast.html" rel="alternate" type="text/html" title="How Fresh Loads Huge Files Fast" /><published>2025-12-08T23:47:12+00:00</published><updated>2025-12-08T23:47:12+00:00</updated><id>/blog/2025/12/08/how-fresh-loads-huge-files-fast.html</id><content type="html" xml:base="/blog/2025/12/08/how-fresh-loads-huge-files-fast.html"><![CDATA[<h1 id="how-fresh-loads-huge-files-fast">How Fresh Loads Huge Files Fast</h1>
<p>Fresh uses a <strong>piece tree</strong> (also called a piece table) for text storage. The piece table originated in the early 1970s - first in <a href="https://www.computerhistory.org/collections/catalog/102740449">J. Strother Moore and Bob Boyer's "77-Editor" at Edinburgh</a> (1971-1973), where they applied structure-sharing techniques from their theorem proving research to text editing. Moore later brought the idea to Xerox PARC, where Charles Simonyi adopted it for the <a href="https://en.wikipedia.org/wiki/Bravo_(editor)">Bravo editor</a> (1974). Simonyi later <a href="https://www.tiny.cloud/blog/wysiwyg-development-history/">brought it to Microsoft Word</a> (1983). The design minimizes memory copying by never modifying original file content - critical for early systems with limited RAM. <a href="https://code.visualstudio.com/blogs/2018/03/23/text-buffer-reimplementation">VS Code adopted piece tables in 2018</a>, replacing their previous line-array implementation.</p>
<p><a href="https://sinelaw.github.io/fresh/">Fresh</a>'s implementation adds immutable nodes (for concurrency and cheap snapshots) and lazy loading (for large files). (<a href="https://github.com/sinelaw/fresh">GitHub</a>)</p>
<h2 id="the-core-idea">The Core Idea</h2>
<p>Instead of storing text in the tree, store <strong>pointers</strong> to text that lives elsewhere.</p>
<h3 id="rope-helix-zed">Rope (<a href="https://github.com/helix-editor/helix/blob/master/docs/architecture.md">Helix</a>, <a href="https://zed.dev/blog/zed-decoded-rope-sumtree">Zed</a>)</h3>
<p>Text lives inside tree nodes:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 360.703125 160" style="max-width: 360.703px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_L_0" d="M132.395,55L123.918,59.167C115.44,63.333,98.486,71.667,90.009,79.333C81.531,87,81.531,94,81.531,97.5L81.531,101"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_R_0" d="M228.019,55L236.496,59.167C244.974,63.333,261.928,71.667,270.406,79.333C278.883,87,278.883,94,278.883,97.5L278.883,101"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(180.20703125, 31.5)" id="flowchart-Root-0" class="node default"><rect height="47" width="156.171875" y="-23.5" x="-78.0859375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> Node</tspan></tspan></text></g></g></g><g transform="translate(81.53125, 128.5)" id="flowchart-L-2" class="node default"><rect height="47" width="147.0625" y="-23.5" x="-73.53125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Leaf:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> '</tspan></tspan></text></g></g></g><g transform="translate(278.8828125, 128.5)" id="flowchart-R-4" class="node default"><rect height="47" width="147.640625" y="-23.5" x="-73.8203125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Leaf:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'World'</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<h3 id="piece-tree-fresh">Piece Tree (Fresh)</h3>
<p>Tree nodes point to separate buffers:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 644.46875 374.6000061035156" style="max-width: 644.469px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="97" width="475.8203125" y="269.5999984741211" x="79.32421875" style=""/><g transform="translate(292.03125, 269.5999984741211)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="211.5999984741211" width="628.46875" y="8" x="8" style=""/><g transform="translate(306.03125, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_L_0" d="M248.528,80L235.46,84.167C222.391,88.333,196.254,96.667,183.186,104.333C170.117,112,170.117,119,170.117,122.5L170.117,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_R_0" d="M395.941,80L409.009,84.167C422.078,88.333,448.215,96.667,461.283,104.333C474.352,112,474.352,119,474.352,122.5L474.352,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_L_B0_0" d="M170.117,194.6L170.117,198.767C170.117,202.933,170.117,211.267,170.117,219.6C170.117,227.933,170.117,236.267,170.117,244.6C170.117,252.933,170.117,261.267,182.551,269.397C194.984,277.528,219.85,285.457,232.284,289.421L244.717,293.385"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_R_B0_0" d="M474.352,194.6L474.352,198.767C474.352,202.933,474.352,211.267,474.352,219.6C474.352,227.933,474.352,236.267,474.352,244.6C474.352,252.933,474.352,261.267,461.918,269.397C449.485,277.528,424.618,285.457,412.185,289.421L399.752,293.385"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(322.234375, 56.5)" id="flowchart-Root-0" class="node default"><rect height="47" width="156.171875" y="-23.5" x="-78.0859375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> Node</tspan></tspan></text></g></g></g><g transform="translate(170.1171875, 162.29999923706055)" id="flowchart-L-2" class="node default"><rect height="64.5999984741211" width="254.234375" y="-32.29999923706055" x="-127.1171875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> offset</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> len</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">6</tspan></tspan></text></g></g></g><g transform="translate(474.3515625, 162.29999923706055)" id="flowchart-R-4" class="node default"><rect height="64.5999984741211" width="254.234375" y="-32.29999923706055" x="-127.1171875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> offset</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 6,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> len</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">5</tspan></tspan></text></g></g></g><g transform="translate(322.234375, 318.0999984741211)" id="flowchart-B0-5" class="node default"><rect height="47" width="213.171875" y="-23.5" x="-106.5859375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> World'</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>A <strong>piece</strong> is just three numbers: which buffer, starting offset, and length.</p>
<h2 id="what-happens-when-you-edit">What Happens When You Edit</h2>
<p>When you type or paste, Fresh appends to a new buffer and creates a piece pointing to it. The original buffer stays untouched.</p>
<h3 id="before-file-contains-hello-world">Before: File contains "Hello World"</h3>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 581.2890625 150.59999084472656" style="max-width: 581.289px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="134.5999984741211" width="280.953125" y="8" x="292.3359375" style=""/><g transform="translate(407.609375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="117" width="234.3359375" y="16.799999237060547" x="8" style=""/><g transform="translate(108.96484375, 16.799999237060547)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M217.336,75.3L221.503,75.3C225.669,75.3,234.003,75.3,242.336,75.3C250.669,75.3,259.003,75.3,267.336,75.3C275.669,75.3,284.003,75.3,291.669,75.3C299.336,75.3,306.336,75.3,309.836,75.3L313.336,75.3"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(125.16796875, 75.29999923706055)" id="flowchart-P1-0" class="node default"><rect height="47" width="184.3359375" y="-23.5" x="-92.16796875" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-11</tspan></tspan></text></g></g></g><g transform="translate(432.8125, 75.29999923706055)" id="flowchart-B0-1" class="node default"><rect height="64.5999984741211" width="230.953125" y="-32.29999923706055" x="-115.4765625" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (original):</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">World'</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<h3 id="after-insert-big--at-position-6">After: Insert "Big " at position 6</h3>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 581.2890625 331.3999938964844" style="max-width: 581.289px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="310.54999923706055" width="280.953125" y="12.850000381469727" x="292.3359375" style=""/><g transform="translate(407.609375, 12.850000381469727)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="315.3999996185303" width="234.3359375" y="8" x="8" style=""/><g transform="translate(108.96484375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M213.48,66.5L218.29,66.5C223.099,66.5,232.717,66.5,241.693,66.5C250.669,66.5,259.003,66.5,267.336,66.5C275.669,66.5,284.003,66.5,295.359,68.982C306.716,71.465,321.097,76.43,328.287,78.912L335.477,81.395"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P2_B1_0" d="M213.48,264.9L218.29,264.9C223.099,264.9,232.717,264.9,241.693,264.9C250.669,264.9,259.003,264.9,267.336,264.9C275.669,264.9,284.003,264.9,292.755,264.9C301.508,264.9,310.68,264.9,315.266,264.9L319.852,264.9"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P3_B0_0" d="M217.336,163.5L221.503,163.5C225.669,163.5,234.003,163.5,242.336,163.5C250.669,163.5,259.003,163.5,267.336,163.5C275.669,163.5,284.003,163.5,295.359,161.018C306.716,158.535,321.097,153.57,328.287,151.088L335.477,148.605"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(125.16796875, 66.5)" id="flowchart-P1-0" class="node default"><rect height="47" width="176.625" y="-23.5" x="-88.3125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-6</tspan></tspan></text></g></g></g><g transform="translate(125.16796875, 264.8999996185303)" id="flowchart-P2-1" class="node default"><rect height="47" width="176.625" y="-23.5" x="-88.3125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-4</tspan></tspan></text></g></g></g><g transform="translate(125.16796875, 163.5)" id="flowchart-P3-2" class="node default"><rect height="47" width="184.3359375" y="-23.5" x="-92.16796875" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 6-11</tspan></tspan></text></g></g></g><g transform="translate(432.8125, 115)" id="flowchart-B0-3" class="node default"><rect height="64.5999984741211" width="230.953125" y="-32.29999923706055" x="-115.4765625" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (original):</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">World'</tspan></tspan></text></g></g></g><g transform="translate(432.8125, 264.8999996185303)" id="flowchart-B1-4" class="node default"><rect height="47" width="217.921875" y="-23.5" x="-108.9609375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (added):</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Big</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> '</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>Document now reads: "Hello Big World"</p>
<p>The original file content in Buffer 0 was never modified or copied.</p>
<h2 id="lazy-loading">Lazy Loading</h2>
<p>For large files, Fresh doesn't load the entire file into memory. Buffers can be <strong>unloaded</strong> - they store a file path and byte range instead of actual data.</p>
<p>This is actually how the original <a href="https://computerhistory.org/blog/microsoft-word-for-windows-1-1a-source-code/">Word 1.1a</a> piece table worked: pieces pointed directly to spans in the original file on disk, loading content only when needed. VS Code's 2018 implementation loads files fully into memory; Fresh returns to the original memory-conscious design.</p>
<h3 id="before-3mb-file-just-opened">Before: 3MB file just opened</h3>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 920.953125 277.6000061035156" style="max-width: 920.953px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="114.5999984741211" width="904.953125" y="155" x="8" style=""/><g transform="translate(435.2734375, 155)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="97" width="860.5" y="8" x="30.2265625" style=""/><g transform="translate(444.2734375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M165.492,80L165.492,84.167C165.492,88.333,165.492,96.667,165.492,105C165.492,113.333,165.492,121.667,165.492,130C165.492,138.333,165.492,146.667,165.492,154.333C165.492,162,165.492,169,165.492,172.5L165.492,176"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P2_B1_0" d="M460.477,80L460.477,84.167C460.477,88.333,460.477,96.667,460.477,105C460.477,113.333,460.477,121.667,460.477,130C460.477,138.333,460.477,146.667,460.477,154.333C460.477,162,460.477,169,460.477,172.5L460.477,176"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P3_B2_0" d="M755.461,80L755.461,84.167C755.461,88.333,755.461,96.667,755.461,105C755.461,113.333,755.461,121.667,755.461,130C755.461,138.333,755.461,146.667,755.461,154.333C755.461,162,755.461,169,755.461,172.5L755.461,176"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(165.4921875, 56.5)" id="flowchart-P1-0" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(460.4765625, 56.5)" id="flowchart-P2-1" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(755.4609375, 56.5)" id="flowchart-P3-2" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(165.4921875, 212.29999923706055)" id="flowchart-B0-3" class="node default"><rect height="64.5999984741211" width="244.984375" y="-32.29999923706055" x="-122.4921875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">file:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> large.txt,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(460.4765625, 212.29999923706055)" id="flowchart-B1-4" class="node default"><rect height="64.5999984741211" width="244.984375" y="-32.29999923706055" x="-122.4921875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">file:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> large.txt,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1-2MB</tspan></tspan></text></g></g></g><g transform="translate(755.4609375, 212.29999923706055)" id="flowchart-B2-5" class="node default"><rect height="64.5999984741211" width="244.984375" y="-32.29999923706055" x="-122.4921875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">file:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> large.txt,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2-3MB</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<h3 id="after-user-scrolls-to-middle">After: User scrolls to middle</h3>
<p>Fresh loads only the visible chunk from disk:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 900.5 277.6000061035156" style="max-width: 900.5px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="114.5999984741211" width="884.5" y="155" x="8" style=""/><g transform="translate(425.046875, 155)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="97" width="840.046875" y="8" x="30.2265625" style=""/><g transform="translate(434.046875, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M165.492,80L165.492,84.167C165.492,88.333,165.492,96.667,165.492,105C165.492,113.333,165.492,121.667,165.492,130C165.492,138.333,165.492,146.667,165.492,154.333C165.492,162,165.492,169,165.492,172.5L165.492,176"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P2_B1_0" d="M450.25,80L450.25,84.167C450.25,88.333,450.25,96.667,450.25,105C450.25,113.333,450.25,121.667,450.25,130C450.25,138.333,450.25,146.667,450.25,154.333C450.25,162,450.25,169,450.25,172.5L450.25,176"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P3_B2_0" d="M735.008,80L735.008,84.167C735.008,88.333,735.008,96.667,735.008,105C735.008,113.333,735.008,121.667,735.008,130C735.008,138.333,735.008,146.667,735.008,154.333C735.008,162,735.008,169,735.008,172.5L735.008,176"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(165.4921875, 56.5)" id="flowchart-P1-0" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(450.25, 56.5)" id="flowchart-P2-1" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(735.0078125, 56.5)" id="flowchart-P3-2" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(165.4921875, 212.29999923706055)" id="flowchart-B0-3" class="node default"><rect height="64.5999984741211" width="244.984375" y="-32.29999923706055" x="-122.4921875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">file:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> large.txt,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(450.25, 212.29999923706055)" id="flowchart-B1-4" class="node default"><rect height="64.5999984741211" width="224.53125" y="-32.29999923706055" x="-112.265625" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> LOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">actual</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> in</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> memory</tspan></tspan></text></g></g></g><g transform="translate(735.0078125, 212.29999923706055)" id="flowchart-B2-5" class="node default"><rect height="64.5999984741211" width="244.984375" y="-32.29999923706055" x="-122.4921875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">file:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> large.txt,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2-3MB</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<h2 id="zero-copy-reads">Zero-Copy Reads</h2>
<p>When reading text for display, Fresh doesn't copy bytes. It returns slices pointing directly into the buffers:</p>
<pre class="rust"><code>// Returns &amp;[u8] pointing into buffer memory
// No allocation, no copy
let text = buffer.get_text_range(100, 200);</code></pre>
<p>Multiple pieces can reference the same buffer region. Displaying the same text twice doesn't double memory usage.</p>
<h2 id="the-tree-structure">The Tree Structure</h2>
<p>The pieces are organized in a balanced binary tree for fast lookups:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 507.453125 294.20001220703125" style="max-width: 507.453px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_I2_0" d="M248.328,73.6L240.675,77.767C233.021,81.933,217.714,90.267,210.06,97.933C202.406,105.6,202.406,112.6,202.406,116.1L202.406,119.6"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_L3_0" d="M368.828,73.6L376.482,77.767C384.135,81.933,399.443,90.267,407.096,99.483C414.75,108.7,414.75,118.8,414.75,123.85L414.75,128.9"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L1_0" d="M140.153,189.2L132.244,193.367C124.336,197.533,108.52,205.867,100.611,213.533C92.703,221.2,92.703,228.2,92.703,231.7L92.703,235.2"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L2_0" d="M264.66,189.2L272.568,193.367C280.476,197.533,296.293,205.867,304.201,213.533C312.109,221.2,312.109,228.2,312.109,231.7L312.109,235.2"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(308.578125, 40.79999923706055)" id="flowchart-I1-0" class="node default"><rect height="65.5999984741211" width="164.1796875" y="-32.79999923706055" x="-82.08984375" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 100</tspan></tspan></text></g></g></g><g transform="translate(202.40625, 156.39999771118164)" id="flowchart-I2-2" class="node default"><rect height="65.5999984741211" width="155.28125" y="-32.79999923706055" x="-77.640625" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan></tspan></text></g></g></g><g transform="translate(414.75, 156.39999771118164)" id="flowchart-L3-4" class="node default"><rect height="47" width="169.40625" y="-23.5" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan></text></g></g></g><g transform="translate(92.703125, 262.6999969482422)" id="flowchart-L1-6" class="node default"><rect height="47" width="169.40625" y="-23.5" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan></text></g></g></g><g transform="translate(312.109375, 262.6999969482422)" id="flowchart-L2-8" class="node default"><rect height="47" width="169.40625" y="-23.5" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>Each internal node caches the total bytes in its left subtree. To find byte offset 75:</p>
<ol type="1">
<li>Root has <code>left_bytes: 100</code>, and 75 &lt; 100, so go left</li>
<li>Internal has <code>left_bytes: 50</code>, and 75 &gt;= 50, so go right with offset 75-50=25</li>
<li>Piece has 50 bytes, offset 25 is within it</li>
</ol>
<p>This is O(log P) where P is the number of pieces.</p>
<h2 id="line-feed-tracking">Line Feed Tracking</h2>
<p>Text editors need fast line-based operations: "go to line 1000", "what line is byte offset 50000 on?", or simply displaying line numbers. Scanning the entire document for newlines would be O(N) - too slow for large files.</p>
<p>Fresh tracks line feeds the same way it tracks bytes. Each piece stores its newline count, and internal nodes cache the count for their left subtree:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 507.453125 348" style="max-width: 507.453px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_I2_0" d="M242.261,91.2L235.618,95.367C228.976,99.533,215.691,107.867,209.049,115.533C202.406,123.2,202.406,130.2,202.406,133.7L202.406,137.2"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_L3_0" d="M374.896,91.2L381.538,95.367C388.18,99.533,401.465,107.867,408.108,117C414.75,126.133,414.75,136.067,414.75,141.033L414.75,146"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L1_0" d="M133.883,224.4L127.02,228.567C120.156,232.733,106.43,241.067,99.566,248.733C92.703,256.4,92.703,263.4,92.703,266.9L92.703,270.4"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L2_0" d="M270.93,224.4L277.793,228.567C284.656,232.733,298.383,241.067,305.246,248.733C312.109,256.4,312.109,263.4,312.109,266.9L312.109,270.4"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(308.578125, 49.599998474121094)" id="flowchart-I1-0" class="node default"><rect height="83.19999694824219" width="164.1796875" y="-41.599998474121094" x="-82.08984375" style="" class="basic label-container"/><g transform="translate(0, -26.599998474121094)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 100</tspan></tspan><tspan dy="1.1em" y="2.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">lf_left:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 3</tspan></tspan></text></g></g></g><g transform="translate(202.40625, 182.79999542236328)" id="flowchart-I2-2" class="node default"><rect height="83.19999694824219" width="155.28125" y="-41.599998474121094" x="-77.640625" style="" class="basic label-container"/><g transform="translate(0, -26.599998474121094)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan></tspan><tspan dy="1.1em" y="2.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">lf_left:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2</tspan></tspan></text></g></g></g><g transform="translate(414.75, 182.79999542236328)" id="flowchart-L3-4" class="node default"><rect height="65.5999984741211" width="169.40625" y="-32.79999923706055" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">line_feeds:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1</tspan></tspan></text></g></g></g><g transform="translate(92.703125, 307.1999931335449)" id="flowchart-L1-6" class="node default"><rect height="65.5999984741211" width="169.40625" y="-32.79999923706055" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 30</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">line_feeds:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2</tspan></tspan></text></g></g></g><g transform="translate(312.109375, 307.1999931335449)" id="flowchart-L2-8" class="node default"><rect height="65.5999984741211" width="169.40625" y="-32.79999923706055" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 20</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">line_feeds:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>To find which piece contains line 3:</p>
<ol type="1">
<li>Root has <code>lf_left: 3</code>, and 3 &gt;= 3, so go right with line 3-3=0</li>
<li>Piece L3 has <code>line_feeds: 1</code>, line 0 is within it</li>
</ol>
<p>This enables O(log P) line-to-offset conversion. The same structure supports offset-to-line lookup by accumulating line counts while traversing.</p>
<h2 id="large-file-mode">Large File Mode</h2>
<p>For files over 100MB, Fresh switches to <strong>large file mode</strong>: no line indexing, pure byte-based navigation.</p>
<p>Why skip line indexing? Counting newlines in a 500MB file means reading the entire file - exactly what lazy loading tries to avoid. Instead, Fresh:</p>
<ul>
<li><strong>Navigates by bytes</strong>: The viewport tracks a byte offset, not a line number. Scrolling moves by byte ranges.</li>
<li><strong>Estimates line counts</strong>: For the scrollbar and status bar, Fresh estimates total lines as <code>file_size / average_line_length</code>.</li>
<li><strong>Shows approximate line numbers</strong>: Visible lines display estimated line numbers based on bytes seen so far.</li>
</ul>
<p>This means "go to line 50000" in a huge file is an approximation, but opening and scrolling remains instant regardless of file size.</p>
<h2 id="immutable-tree-structure">Immutable Tree Structure</h2>
<p>Fresh uses immutable nodes - once created, a node is never modified. Edits create new nodes instead.</p>
<blockquote>
<p><strong>Implementation note:</strong> Fresh is written in Rust. Nodes are wrapped in <code>Arc&lt;T&gt;</code> (Atomic Reference Counted pointer) - think of it as a pointer that tracks how many things reference it. Multiple parts of the code (even different threads) can safely hold the same <code>Arc</code>, and the data is automatically freed when the last reference is dropped. We'll gloss over this detail going forward - just know that "sharing" a node is cheap and thread-safe.</p>
</blockquote>
<p>After an edit, old tree versions remain valid:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 550.396484375 210" style="max-width: 550.396px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="subGraph1" class="cluster"><rect height="194" width="197.9140625" y="8" x="8" style=""/><g transform="translate(34.91015625, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Version</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (after</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> edit)</tspan></tspan></text></g></g></g><g data-look="classic" id="subGraph0" class="cluster"><rect height="194" width="316.482421875" y="8" x="225.9140625" style=""/><g transform="translate(305.4365234375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Version</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (before</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> edit)</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V1_Root_V1_L_0" d="M348.281,80L342.157,84.167C336.032,88.333,323.784,96.667,317.659,104.333C311.535,112,311.535,119,311.535,122.5L311.535,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V1_Root_V1_R_0" d="M417.363,80L423.488,84.167C429.612,88.333,441.861,96.667,447.985,104.333C454.109,112,454.109,119,454.109,122.5L454.109,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V2_Root_V1_L_0" d="M130.428,80L133.624,84.167C136.82,88.333,143.212,96.667,165.487,106.548C187.763,116.429,225.923,127.858,245.002,133.573L264.082,139.287"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V2_Root_V2_R_0" d="M107.557,80L106.698,84.167C105.839,88.333,104.121,96.667,103.261,104.333C102.402,112,102.402,119,102.402,122.5L102.402,126"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(382.822265625, 56.5)" id="flowchart-V1_Root-0" class="node default"><rect height="47" width="115.2421875" y="-23.5" x="-57.62109375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Root</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> v1</tspan></tspan></text></g></g></g><g transform="translate(311.53515625, 153.5)" id="flowchart-V1_L-1" class="node default"><rect height="47" width="87.2421875" y="-23.5" x="-43.62109375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Left</tspan></tspan></text></g></g></g><g transform="translate(454.109375, 153.5)" id="flowchart-V1_R-3" class="node default"><rect height="47" width="97.90625" y="-23.5" x="-48.953125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Right</tspan></tspan></text></g></g></g><g transform="translate(112.40234375, 56.5)" id="flowchart-V2_Root-4" class="node default"><rect height="47" width="115.2421875" y="-23.5" x="-57.62109375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Root</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> v2</tspan></tspan></text></g></g></g><g transform="translate(102.40234375, 153.5)" id="flowchart-V2_R-7" class="node default"><rect height="47" width="118.8046875" y="-23.5" x="-59.40234375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Right</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> v2</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>Version 2 shares the unchanged left subtree with Version 1. This enables:</p>
<ul>
<li>Undo/redo by keeping old root references</li>
<li>Concurrent reads without locks</li>
<li>Cheap snapshots</li>
</ul>
<h2 id="structural-diffing">Structural Diffing</h2>
<p>Fresh uses piece tree structure to power gutter change indicators (the marks showing modified lines). The algorithm finds what changed since last save:</p>
<ol type="1">
<li><strong>Pointer check</strong>: If saved and current tree roots are the same object, content is identical (instant).</li>
<li><strong>Structure diff</strong>: Compare piece references to find differing byte ranges. O(pieces), not O(file size).</li>
<li><strong>Content verification</strong> (optional): For small regions, verify bytes actually differ (handles undo edge cases).</li>
</ol>
<p>The diff returns line ranges that Fresh checks against the current viewport - only visible changed lines need indicators. This is especially useful for large files: detecting modifications in a 500MB file requires comparing piece metadata, not reading from disk.</p>
<h2 id="crash-recovery">Crash Recovery</h2>
<p>Fresh auto-saves modified buffers every 2 seconds for crash recovery. The piece tree structure makes this efficient for large files.</p>
<p><strong>The key insight</strong>: Recovery doesn't need to save the entire file - just the modifications. For a 500MB file with a few edits, Fresh saves only the changed chunks (a few KB), not 500MB.</p>
<p>The recovery format mirrors piece tree structure:</p>
<ul>
<li>Each chunk stores: byte offset, original length replaced, new content</li>
<li>To recover: load original file from disk, apply chunks on top</li>
</ul>
<p>This works because piece tree edits are already expressed as "replace bytes X-Y with content Z" - exactly what recovery chunks store. For new/small files, a single chunk contains the full content.</p>
<p>On crash detection (lock file exists but process died), Fresh offers to recover by reconstructing: original file + stored chunks  recovered content.</p>
<h2 id="fresh-vs-vs-code">Fresh vs VS Code</h2>
<p><a href="https://github.com/microsoft/vscode-textbuffer">VS Code also uses a piece tree</a>, but with a mutable tree - nodes are modified in place during rebalancing. Fresh uses a fully <a href="https://en.wikipedia.org/wiki/Persistent_data_structure">persistent data structure</a>: edits create new tree versions via path-copying, sharing unchanged subtrees between versions.</p>
<p>This gives Fresh cheap undo (keep old roots), lock-free concurrent reads, and instant snapshots - at the cost of more allocations per edit.</p>
<p>Fresh also implements lazy loading; VS Code loads entire files into memory.</p>
<h2 id="comparison-piece-tree-vs-rope">Comparison: Piece Tree vs Rope</h2>
<p>Different editors use different text storage structures:</p>
<ul>
<li><strong>Piece tree</strong>: VS Code, Fresh</li>
<li><strong><a href="https://en.wikipedia.org/wiki/Rope_(data_structure)">Rope</a></strong>: Helix (<a href="https://github.com/cessen/ropey">Ropey</a>), Zed (<a href="https://zed.dev/blog/zed-decoded-rope-sumtree">SumTree</a>)</li>
<li><strong>Rope-like</strong>: Vim (<a href="https://github.com/vim/vim/blob/master/src/memline.c">memline</a>), <a href="https://github.com/neovim/neovim/discussions/25647">Neovim?</a></li>
<li><strong><a href="https://en.wikipedia.org/wiki/Gap_buffer">Gap buffer</a></strong>: Emacs</li>
</ul>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Piece Tree (Fresh, VS Code, MS Word 1.1)</th>
<th>Rope (Helix, Zed, Neovim?)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Node contents</td>
<td>Pointer to buffer</td>
<td>Actual text (~1KB chunks)</td>
</tr>
<tr>
<td>Insert</td>
<td>Append to buffer, add piece</td>
<td>May copy/split chunk</td>
</tr>
<tr>
<td>Original file</td>
<td>Preserved in buffer 0</td>
<td>Reorganized into chunks</td>
</tr>
<tr>
<td>Large files</td>
<td>Lazy load regions (Fresh, Word 1.1a)</td>
<td>Must load or stream</td>
</tr>
<tr>
<td>Memory for edits</td>
<td>Minimal (just pointers)</td>
<td>Copies chunk data</td>
</tr>
</tbody>
</table>
<h2 id="piece-tree-trade-offs">Piece Tree Trade-offs</h2>
<p><strong>Pros:</strong> Original file preserved, inserts never copy existing text, natural lazy loading, pieces are small (~24 bytes) so more fit in cache, enables structural diffing (see above).</p>
<p><strong>Cons:</strong> Extra indirection (find piece, then fetch buffer), buffer fragmentation over many edits, poor cache locality for text content. Piece count grows with edits, though periodic coalescing can mitigate this.</p>
<p><em>(Note: Fresh's current implementation rebuilds the entire tree on each edit rather than path-copying, making edits O(P) instead of O(log P). This is an implementation gap, not inherent to the design.)</em></p>
<h2 id="further-reading">Further Reading</h2>
<ul>
<li><a href="https://sinelaw.github.io/fresh/">Fresh</a> - The editor discussed in this post (<a href="https://github.com/sinelaw/fresh">source on GitHub</a>)</li>
<li><a href="https://computerhistory.org/blog/microsoft-word-for-windows-1-1a-source-code/">Microsoft Word 1.1a Source Code</a> - Original piece table implementation from 1990</li>
<li><a href="https://code.visualstudio.com/blogs/2018/03/23/text-buffer-reimplementation">VS Code's Piece Table</a> - Microsoft's 2018 write-up on reviving piece tables</li>
<li><a href="https://zed.dev/blog/zed-decoded-rope-sumtree">Zed's Rope &amp; SumTree</a> - How Zed implements ropes with B+ trees</li>
<li><a href="https://coredumped.dev/2023/08/09/text-showdown-gap-buffers-vs-ropes/">Text Showdown: Gap Buffers vs Ropes</a> - Performance comparison</li>
<li><a href="https://www.cs.unm.edu/~crowley/papers/sds.pdf">Data Structures for Text Sequences</a> - Charles Crowley, 1998 (academic survey)</li>
</ul>
]]></content><author><name></name></author></entry><entry><title type="html">How Fresh Loads Huge Files Fast</title><link href="/blog/2025/12/08/how-fresh-loads-huge-files-fast.html" rel="alternate" type="text/html" title="How Fresh Loads Huge Files Fast" /><published>2025-12-08T23:34:54+00:00</published><updated>2025-12-08T23:34:54+00:00</updated><id>/blog/2025/12/08/how-fresh-loads-huge-files-fast.html</id><content type="html" xml:base="/blog/2025/12/08/how-fresh-loads-huge-files-fast.html"><![CDATA[<h1 id="how-fresh-loads-huge-files-fast">How Fresh Loads Huge Files Fast</h1>
<p>Fresh uses a <strong>piece tree</strong> (also called a piece table) for text storage. The piece table originated in the early 1970s - first in <a href="https://www.computerhistory.org/collections/catalog/102740449">J. Strother Moore and Bob Boyer's "77-Editor" at Edinburgh</a> (1971-1973), where they applied structure-sharing techniques from their theorem proving research to text editing. Moore later brought the idea to Xerox PARC, where Charles Simonyi adopted it for the <a href="https://en.wikipedia.org/wiki/Bravo_(editor)">Bravo editor</a> (1974). Simonyi later <a href="https://www.tiny.cloud/blog/wysiwyg-development-history/">brought it to Microsoft Word</a> (1983). The design minimizes memory copying by never modifying original file content - critical for early systems with limited RAM. <a href="https://code.visualstudio.com/blogs/2018/03/23/text-buffer-reimplementation">VS Code adopted piece tables in 2018</a>, replacing their previous line-array implementation.</p>
<p><a href="https://sinelaw.github.io/fresh/">Fresh</a>'s implementation adds immutable nodes (for concurrency and cheap snapshots) and lazy loading (for large files). (<a href="https://github.com/sinelaw/fresh">GitHub</a>)</p>
<h2 id="the-core-idea">The Core Idea</h2>
<p>Instead of storing text in the tree, store <strong>pointers</strong> to text that lives elsewhere.</p>
<h3 id="rope-helix-zed">Rope (<a href="https://github.com/helix-editor/helix/blob/master/docs/architecture.md">Helix</a>, <a href="https://zed.dev/blog/zed-decoded-rope-sumtree">Zed</a>)</h3>
<p>Text lives inside tree nodes:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 360.703125 160" style="max-width: 360.703px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_L_0" d="M132.395,55L123.918,59.167C115.44,63.333,98.486,71.667,90.009,79.333C81.531,87,81.531,94,81.531,97.5L81.531,101"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_R_0" d="M228.019,55L236.496,59.167C244.974,63.333,261.928,71.667,270.406,79.333C278.883,87,278.883,94,278.883,97.5L278.883,101"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(180.20703125, 31.5)" id="flowchart-Root-0" class="node default"><rect height="47" width="156.171875" y="-23.5" x="-78.0859375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> Node</tspan></tspan></text></g></g></g><g transform="translate(81.53125, 128.5)" id="flowchart-L-2" class="node default"><rect height="47" width="147.0625" y="-23.5" x="-73.53125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Leaf:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> '</tspan></tspan></text></g></g></g><g transform="translate(278.8828125, 128.5)" id="flowchart-R-4" class="node default"><rect height="47" width="147.640625" y="-23.5" x="-73.8203125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Leaf:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'World'</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<h3 id="piece-tree-fresh">Piece Tree (Fresh)</h3>
<p>Tree nodes point to separate buffers:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 644.46875 374.6000061035156" style="max-width: 644.469px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="97" width="475.8203125" y="269.5999984741211" x="79.32421875" style=""/><g transform="translate(292.03125, 269.5999984741211)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="211.5999984741211" width="628.46875" y="8" x="8" style=""/><g transform="translate(306.03125, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_L_0" d="M248.528,80L235.46,84.167C222.391,88.333,196.254,96.667,183.186,104.333C170.117,112,170.117,119,170.117,122.5L170.117,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_R_0" d="M395.941,80L409.009,84.167C422.078,88.333,448.215,96.667,461.283,104.333C474.352,112,474.352,119,474.352,122.5L474.352,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_L_B0_0" d="M170.117,194.6L170.117,198.767C170.117,202.933,170.117,211.267,170.117,219.6C170.117,227.933,170.117,236.267,170.117,244.6C170.117,252.933,170.117,261.267,182.551,269.397C194.984,277.528,219.85,285.457,232.284,289.421L244.717,293.385"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_R_B0_0" d="M474.352,194.6L474.352,198.767C474.352,202.933,474.352,211.267,474.352,219.6C474.352,227.933,474.352,236.267,474.352,244.6C474.352,252.933,474.352,261.267,461.918,269.397C449.485,277.528,424.618,285.457,412.185,289.421L399.752,293.385"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(322.234375, 56.5)" id="flowchart-Root-0" class="node default"><rect height="47" width="156.171875" y="-23.5" x="-78.0859375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> Node</tspan></tspan></text></g></g></g><g transform="translate(170.1171875, 162.29999923706055)" id="flowchart-L-2" class="node default"><rect height="64.5999984741211" width="254.234375" y="-32.29999923706055" x="-127.1171875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> offset</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> len</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">6</tspan></tspan></text></g></g></g><g transform="translate(474.3515625, 162.29999923706055)" id="flowchart-R-4" class="node default"><rect height="64.5999984741211" width="254.234375" y="-32.29999923706055" x="-127.1171875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> offset</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 6,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> len</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">5</tspan></tspan></text></g></g></g><g transform="translate(322.234375, 318.0999984741211)" id="flowchart-B0-5" class="node default"><rect height="47" width="213.171875" y="-23.5" x="-106.5859375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> World'</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>A <strong>piece</strong> is just three numbers: which buffer, starting offset, and length.</p>
<h2 id="what-happens-when-you-edit">What Happens When You Edit</h2>
<p>When you type or paste, Fresh appends to a new buffer and creates a piece pointing to it. The original buffer stays untouched.</p>
<h3 id="before-file-contains-hello-world">Before: File contains "Hello World"</h3>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 581.2890625 150.59999084472656" style="max-width: 581.289px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="134.5999984741211" width="280.953125" y="8" x="292.3359375" style=""/><g transform="translate(407.609375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="117" width="234.3359375" y="16.799999237060547" x="8" style=""/><g transform="translate(108.96484375, 16.799999237060547)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M217.336,75.3L221.503,75.3C225.669,75.3,234.003,75.3,242.336,75.3C250.669,75.3,259.003,75.3,267.336,75.3C275.669,75.3,284.003,75.3,291.669,75.3C299.336,75.3,306.336,75.3,309.836,75.3L313.336,75.3"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(125.16796875, 75.29999923706055)" id="flowchart-P1-0" class="node default"><rect height="47" width="184.3359375" y="-23.5" x="-92.16796875" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-11</tspan></tspan></text></g></g></g><g transform="translate(432.8125, 75.29999923706055)" id="flowchart-B0-1" class="node default"><rect height="64.5999984741211" width="230.953125" y="-32.29999923706055" x="-115.4765625" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (original):</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">World'</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<h3 id="after-insert-big--at-position-6">After: Insert "Big " at position 6</h3>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 581.2890625 331.3999938964844" style="max-width: 581.289px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="310.54999923706055" width="280.953125" y="12.850000381469727" x="292.3359375" style=""/><g transform="translate(407.609375, 12.850000381469727)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="315.3999996185303" width="234.3359375" y="8" x="8" style=""/><g transform="translate(108.96484375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M213.48,66.5L218.29,66.5C223.099,66.5,232.717,66.5,241.693,66.5C250.669,66.5,259.003,66.5,267.336,66.5C275.669,66.5,284.003,66.5,295.359,68.982C306.716,71.465,321.097,76.43,328.287,78.912L335.477,81.395"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P2_B1_0" d="M213.48,264.9L218.29,264.9C223.099,264.9,232.717,264.9,241.693,264.9C250.669,264.9,259.003,264.9,267.336,264.9C275.669,264.9,284.003,264.9,292.755,264.9C301.508,264.9,310.68,264.9,315.266,264.9L319.852,264.9"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P3_B0_0" d="M217.336,163.5L221.503,163.5C225.669,163.5,234.003,163.5,242.336,163.5C250.669,163.5,259.003,163.5,267.336,163.5C275.669,163.5,284.003,163.5,295.359,161.018C306.716,158.535,321.097,153.57,328.287,151.088L335.477,148.605"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(125.16796875, 66.5)" id="flowchart-P1-0" class="node default"><rect height="47" width="176.625" y="-23.5" x="-88.3125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-6</tspan></tspan></text></g></g></g><g transform="translate(125.16796875, 264.8999996185303)" id="flowchart-P2-1" class="node default"><rect height="47" width="176.625" y="-23.5" x="-88.3125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-4</tspan></tspan></text></g></g></g><g transform="translate(125.16796875, 163.5)" id="flowchart-P3-2" class="node default"><rect height="47" width="184.3359375" y="-23.5" x="-92.16796875" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 6-11</tspan></tspan></text></g></g></g><g transform="translate(432.8125, 115)" id="flowchart-B0-3" class="node default"><rect height="64.5999984741211" width="230.953125" y="-32.29999923706055" x="-115.4765625" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (original):</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">World'</tspan></tspan></text></g></g></g><g transform="translate(432.8125, 264.8999996185303)" id="flowchart-B1-4" class="node default"><rect height="47" width="217.921875" y="-23.5" x="-108.9609375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (added):</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Big</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> '</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>Document now reads: "Hello Big World"</p>
<p>The original file content in Buffer 0 was never modified or copied.</p>
<h2 id="lazy-loading">Lazy Loading</h2>
<p>For large files, Fresh doesn't load the entire file into memory. Buffers can be <strong>unloaded</strong> - they store a file path and byte range instead of actual data.</p>
<p>This is actually how the original <a href="https://computerhistory.org/blog/microsoft-word-for-windows-1-1a-source-code/">Word 1.1a</a> piece table worked: pieces pointed directly to spans in the original file on disk, loading content only when needed. VS Code's 2018 implementation loads files fully into memory; Fresh returns to the original memory-conscious design.</p>
<h3 id="before-3mb-file-just-opened">Before: 3MB file just opened</h3>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 920.953125 277.6000061035156" style="max-width: 920.953px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="114.5999984741211" width="904.953125" y="155" x="8" style=""/><g transform="translate(435.2734375, 155)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="97" width="860.5" y="8" x="30.2265625" style=""/><g transform="translate(444.2734375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M165.492,80L165.492,84.167C165.492,88.333,165.492,96.667,165.492,105C165.492,113.333,165.492,121.667,165.492,130C165.492,138.333,165.492,146.667,165.492,154.333C165.492,162,165.492,169,165.492,172.5L165.492,176"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P2_B1_0" d="M460.477,80L460.477,84.167C460.477,88.333,460.477,96.667,460.477,105C460.477,113.333,460.477,121.667,460.477,130C460.477,138.333,460.477,146.667,460.477,154.333C460.477,162,460.477,169,460.477,172.5L460.477,176"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P3_B2_0" d="M755.461,80L755.461,84.167C755.461,88.333,755.461,96.667,755.461,105C755.461,113.333,755.461,121.667,755.461,130C755.461,138.333,755.461,146.667,755.461,154.333C755.461,162,755.461,169,755.461,172.5L755.461,176"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(165.4921875, 56.5)" id="flowchart-P1-0" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(460.4765625, 56.5)" id="flowchart-P2-1" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(755.4609375, 56.5)" id="flowchart-P3-2" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(165.4921875, 212.29999923706055)" id="flowchart-B0-3" class="node default"><rect height="64.5999984741211" width="244.984375" y="-32.29999923706055" x="-122.4921875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">file:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> large.txt,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(460.4765625, 212.29999923706055)" id="flowchart-B1-4" class="node default"><rect height="64.5999984741211" width="244.984375" y="-32.29999923706055" x="-122.4921875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">file:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> large.txt,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1-2MB</tspan></tspan></text></g></g></g><g transform="translate(755.4609375, 212.29999923706055)" id="flowchart-B2-5" class="node default"><rect height="64.5999984741211" width="244.984375" y="-32.29999923706055" x="-122.4921875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">file:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> large.txt,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2-3MB</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<h3 id="after-user-scrolls-to-middle">After: User scrolls to middle</h3>
<p>Fresh loads only the visible chunk from disk:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 900.5 277.6000061035156" style="max-width: 900.5px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="114.5999984741211" width="884.5" y="155" x="8" style=""/><g transform="translate(425.046875, 155)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="97" width="840.046875" y="8" x="30.2265625" style=""/><g transform="translate(434.046875, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M165.492,80L165.492,84.167C165.492,88.333,165.492,96.667,165.492,105C165.492,113.333,165.492,121.667,165.492,130C165.492,138.333,165.492,146.667,165.492,154.333C165.492,162,165.492,169,165.492,172.5L165.492,176"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P2_B1_0" d="M450.25,80L450.25,84.167C450.25,88.333,450.25,96.667,450.25,105C450.25,113.333,450.25,121.667,450.25,130C450.25,138.333,450.25,146.667,450.25,154.333C450.25,162,450.25,169,450.25,172.5L450.25,176"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P3_B2_0" d="M735.008,80L735.008,84.167C735.008,88.333,735.008,96.667,735.008,105C735.008,113.333,735.008,121.667,735.008,130C735.008,138.333,735.008,146.667,735.008,154.333C735.008,162,735.008,169,735.008,172.5L735.008,176"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(165.4921875, 56.5)" id="flowchart-P1-0" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(450.25, 56.5)" id="flowchart-P2-1" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(735.0078125, 56.5)" id="flowchart-P3-2" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(165.4921875, 212.29999923706055)" id="flowchart-B0-3" class="node default"><rect height="64.5999984741211" width="244.984375" y="-32.29999923706055" x="-122.4921875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">file:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> large.txt,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(450.25, 212.29999923706055)" id="flowchart-B1-4" class="node default"><rect height="64.5999984741211" width="224.53125" y="-32.29999923706055" x="-112.265625" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> LOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">actual</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> in</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> memory</tspan></tspan></text></g></g></g><g transform="translate(735.0078125, 212.29999923706055)" id="flowchart-B2-5" class="node default"><rect height="64.5999984741211" width="244.984375" y="-32.29999923706055" x="-122.4921875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">file:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> large.txt,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2-3MB</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<h2 id="zero-copy-reads">Zero-Copy Reads</h2>
<p>When reading text for display, Fresh doesn't copy bytes. It returns slices pointing directly into the buffers:</p>
<pre class="rust"><code>// Returns &amp;[u8] pointing into buffer memory
// No allocation, no copy
let text = buffer.get_text_range(100, 200);</code></pre>
<p>Multiple pieces can reference the same buffer region. Displaying the same text twice doesn't double memory usage.</p>
<h2 id="the-tree-structure">The Tree Structure</h2>
<p>The pieces are organized in a balanced binary tree for fast lookups:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 507.453125 294.20001220703125" style="max-width: 507.453px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_I2_0" d="M248.328,73.6L240.675,77.767C233.021,81.933,217.714,90.267,210.06,97.933C202.406,105.6,202.406,112.6,202.406,116.1L202.406,119.6"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_L3_0" d="M368.828,73.6L376.482,77.767C384.135,81.933,399.443,90.267,407.096,99.483C414.75,108.7,414.75,118.8,414.75,123.85L414.75,128.9"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L1_0" d="M140.153,189.2L132.244,193.367C124.336,197.533,108.52,205.867,100.611,213.533C92.703,221.2,92.703,228.2,92.703,231.7L92.703,235.2"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L2_0" d="M264.66,189.2L272.568,193.367C280.476,197.533,296.293,205.867,304.201,213.533C312.109,221.2,312.109,228.2,312.109,231.7L312.109,235.2"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(308.578125, 40.79999923706055)" id="flowchart-I1-0" class="node default"><rect height="65.5999984741211" width="164.1796875" y="-32.79999923706055" x="-82.08984375" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 100</tspan></tspan></text></g></g></g><g transform="translate(202.40625, 156.39999771118164)" id="flowchart-I2-2" class="node default"><rect height="65.5999984741211" width="155.28125" y="-32.79999923706055" x="-77.640625" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan></tspan></text></g></g></g><g transform="translate(414.75, 156.39999771118164)" id="flowchart-L3-4" class="node default"><rect height="47" width="169.40625" y="-23.5" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan></text></g></g></g><g transform="translate(92.703125, 262.6999969482422)" id="flowchart-L1-6" class="node default"><rect height="47" width="169.40625" y="-23.5" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan></text></g></g></g><g transform="translate(312.109375, 262.6999969482422)" id="flowchart-L2-8" class="node default"><rect height="47" width="169.40625" y="-23.5" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>Each internal node caches the total bytes in its left subtree. To find byte offset 75:</p>
<ol type="1">
<li>Root has <code>left_bytes: 100</code>, and 75 &lt; 100, so go left</li>
<li>Internal has <code>left_bytes: 50</code>, and 75 &gt;= 50, so go right with offset 75-50=25</li>
<li>Piece has 50 bytes, offset 25 is within it</li>
</ol>
<p>This is O(log P) where P is the number of pieces.</p>
<h2 id="line-feed-tracking">Line Feed Tracking</h2>
<p>Text editors need fast line-based operations: "go to line 1000", "what line is byte offset 50000 on?", or simply displaying line numbers. Scanning the entire document for newlines would be O(N) - too slow for large files.</p>
<p>Fresh tracks line feeds the same way it tracks bytes. Each piece stores its newline count, and internal nodes cache the count for their left subtree:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 507.453125 348" style="max-width: 507.453px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_I2_0" d="M242.261,91.2L235.618,95.367C228.976,99.533,215.691,107.867,209.049,115.533C202.406,123.2,202.406,130.2,202.406,133.7L202.406,137.2"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_L3_0" d="M374.896,91.2L381.538,95.367C388.18,99.533,401.465,107.867,408.108,117C414.75,126.133,414.75,136.067,414.75,141.033L414.75,146"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L1_0" d="M133.883,224.4L127.02,228.567C120.156,232.733,106.43,241.067,99.566,248.733C92.703,256.4,92.703,263.4,92.703,266.9L92.703,270.4"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L2_0" d="M270.93,224.4L277.793,228.567C284.656,232.733,298.383,241.067,305.246,248.733C312.109,256.4,312.109,263.4,312.109,266.9L312.109,270.4"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(308.578125, 49.599998474121094)" id="flowchart-I1-0" class="node default"><rect height="83.19999694824219" width="164.1796875" y="-41.599998474121094" x="-82.08984375" style="" class="basic label-container"/><g transform="translate(0, -26.599998474121094)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 100</tspan></tspan><tspan dy="1.1em" y="2.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">lf_left:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 3</tspan></tspan></text></g></g></g><g transform="translate(202.40625, 182.79999542236328)" id="flowchart-I2-2" class="node default"><rect height="83.19999694824219" width="155.28125" y="-41.599998474121094" x="-77.640625" style="" class="basic label-container"/><g transform="translate(0, -26.599998474121094)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan></tspan><tspan dy="1.1em" y="2.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">lf_left:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2</tspan></tspan></text></g></g></g><g transform="translate(414.75, 182.79999542236328)" id="flowchart-L3-4" class="node default"><rect height="65.5999984741211" width="169.40625" y="-32.79999923706055" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">line_feeds:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1</tspan></tspan></text></g></g></g><g transform="translate(92.703125, 307.1999931335449)" id="flowchart-L1-6" class="node default"><rect height="65.5999984741211" width="169.40625" y="-32.79999923706055" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 30</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">line_feeds:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2</tspan></tspan></text></g></g></g><g transform="translate(312.109375, 307.1999931335449)" id="flowchart-L2-8" class="node default"><rect height="65.5999984741211" width="169.40625" y="-32.79999923706055" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 20</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">line_feeds:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>To find which piece contains line 3:</p>
<ol type="1">
<li>Root has <code>lf_left: 3</code>, and 3 &gt;= 3, so go right with line 3-3=0</li>
<li>Piece L3 has <code>line_feeds: 1</code>, line 0 is within it</li>
</ol>
<p>This enables O(log P) line-to-offset conversion. The same structure supports offset-to-line lookup by accumulating line counts while traversing.</p>
<h2 id="large-file-mode">Large File Mode</h2>
<p>For files over 100MB, Fresh switches to <strong>large file mode</strong>: no line indexing, pure byte-based navigation.</p>
<p>Why skip line indexing? Counting newlines in a 500MB file means reading the entire file - exactly what lazy loading tries to avoid. Instead, Fresh:</p>
<ul>
<li><strong>Navigates by bytes</strong>: The viewport tracks a byte offset, not a line number. Scrolling moves by byte ranges.</li>
<li><strong>Estimates line counts</strong>: For the scrollbar and status bar, Fresh estimates total lines as <code>file_size / average_line_length</code>.</li>
<li><strong>Shows approximate line numbers</strong>: Visible lines display estimated line numbers based on bytes seen so far.</li>
</ul>
<p>This means "go to line 50000" in a huge file is an approximation, but opening and scrolling remains instant regardless of file size.</p>
<h2 id="immutable-tree-structure">Immutable Tree Structure</h2>
<p>Fresh uses immutable nodes - once created, a node is never modified. Edits create new nodes instead.</p>
<blockquote>
<p><strong>Implementation note:</strong> Fresh is written in Rust. Nodes are wrapped in <code>Arc&lt;T&gt;</code> (Atomic Reference Counted pointer) - think of it as a pointer that tracks how many things reference it. Multiple parts of the code (even different threads) can safely hold the same <code>Arc</code>, and the data is automatically freed when the last reference is dropped. We'll gloss over this detail going forward - just know that "sharing" a node is cheap and thread-safe.</p>
</blockquote>
<p>After an edit, old tree versions remain valid:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 550.396484375 210" style="max-width: 550.396px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="subGraph1" class="cluster"><rect height="194" width="197.9140625" y="8" x="8" style=""/><g transform="translate(34.91015625, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Version</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (after</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> edit)</tspan></tspan></text></g></g></g><g data-look="classic" id="subGraph0" class="cluster"><rect height="194" width="316.482421875" y="8" x="225.9140625" style=""/><g transform="translate(305.4365234375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Version</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (before</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> edit)</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V1_Root_V1_L_0" d="M348.281,80L342.157,84.167C336.032,88.333,323.784,96.667,317.659,104.333C311.535,112,311.535,119,311.535,122.5L311.535,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V1_Root_V1_R_0" d="M417.363,80L423.488,84.167C429.612,88.333,441.861,96.667,447.985,104.333C454.109,112,454.109,119,454.109,122.5L454.109,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V2_Root_V1_L_0" d="M130.428,80L133.624,84.167C136.82,88.333,143.212,96.667,165.487,106.548C187.763,116.429,225.923,127.858,245.002,133.573L264.082,139.287"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V2_Root_V2_R_0" d="M107.557,80L106.698,84.167C105.839,88.333,104.121,96.667,103.261,104.333C102.402,112,102.402,119,102.402,122.5L102.402,126"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(382.822265625, 56.5)" id="flowchart-V1_Root-0" class="node default"><rect height="47" width="115.2421875" y="-23.5" x="-57.62109375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Root</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> v1</tspan></tspan></text></g></g></g><g transform="translate(311.53515625, 153.5)" id="flowchart-V1_L-1" class="node default"><rect height="47" width="87.2421875" y="-23.5" x="-43.62109375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Left</tspan></tspan></text></g></g></g><g transform="translate(454.109375, 153.5)" id="flowchart-V1_R-3" class="node default"><rect height="47" width="97.90625" y="-23.5" x="-48.953125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Right</tspan></tspan></text></g></g></g><g transform="translate(112.40234375, 56.5)" id="flowchart-V2_Root-4" class="node default"><rect height="47" width="115.2421875" y="-23.5" x="-57.62109375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Root</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> v2</tspan></tspan></text></g></g></g><g transform="translate(102.40234375, 153.5)" id="flowchart-V2_R-7" class="node default"><rect height="47" width="118.8046875" y="-23.5" x="-59.40234375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Right</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> v2</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>Version 2 shares the unchanged left subtree with Version 1. This enables:</p>
<ul>
<li>Undo/redo by keeping old root references</li>
<li>Concurrent reads without locks</li>
<li>Cheap snapshots</li>
</ul>
<h2 id="structural-diffing">Structural Diffing</h2>
<p>Fresh uses piece tree structure to power gutter change indicators (the marks showing modified lines). The algorithm finds what changed since last save:</p>
<ol type="1">
<li><strong>Pointer check</strong>: If saved and current tree roots are the same object, content is identical (instant).</li>
<li><strong>Structure diff</strong>: Compare piece references to find differing byte ranges. O(pieces), not O(file size).</li>
<li><strong>Content verification</strong> (optional): For small regions, verify bytes actually differ (handles undo edge cases).</li>
</ol>
<p>The diff returns line ranges that Fresh checks against the current viewport - only visible changed lines need indicators. This is especially useful for large files: detecting modifications in a 500MB file requires comparing piece metadata, not reading from disk.</p>
<h2 id="crash-recovery">Crash Recovery</h2>
<p>Fresh auto-saves modified buffers every 2 seconds for crash recovery. The piece tree structure makes this efficient for large files.</p>
<p><strong>The key insight</strong>: Recovery doesn't need to save the entire file - just the modifications. For a 500MB file with a few edits, Fresh saves only the changed chunks (a few KB), not 500MB.</p>
<p>The recovery format mirrors piece tree structure:</p>
<ul>
<li>Each chunk stores: byte offset, original length replaced, new content</li>
<li>To recover: load original file from disk, apply chunks on top</li>
</ul>
<p>This works because piece tree edits are already expressed as "replace bytes X-Y with content Z" - exactly what recovery chunks store. For new/small files, a single chunk contains the full content.</p>
<p>On crash detection (lock file exists but process died), Fresh offers to recover by reconstructing: original file + stored chunks  recovered content.</p>
<h2 id="fresh-vs-vs-code">Fresh vs VS Code</h2>
<p><a href="https://github.com/microsoft/vscode-textbuffer">VS Code also uses a piece tree</a>, but with a mutable tree - nodes are modified in place during rebalancing. Fresh uses a fully <a href="https://en.wikipedia.org/wiki/Persistent_data_structure">persistent data structure</a>: edits create new tree versions via path-copying, sharing unchanged subtrees between versions.</p>
<p>This gives Fresh cheap undo (keep old roots), lock-free concurrent reads, and instant snapshots - at the cost of more allocations per edit.</p>
<p>Fresh also implements lazy loading; VS Code loads entire files into memory.</p>
<h2 id="comparison-piece-tree-vs-rope">Comparison: Piece Tree vs Rope</h2>
<p>Different editors use different text storage structures:</p>
<ul>
<li><strong>Piece tree</strong>: VS Code, Fresh</li>
<li><strong><a href="https://en.wikipedia.org/wiki/Rope_(data_structure)">Rope</a></strong>: Helix (<a href="https://github.com/cessen/ropey">Ropey</a>), Zed (<a href="https://zed.dev/blog/zed-decoded-rope-sumtree">SumTree</a>)</li>
<li><strong><a href="https://en.wikipedia.org/wiki/Gap_buffer">Gap buffer</a></strong>: Emacs</li>
<li><strong>Block-based line storage</strong>: Vim/Neovim (<a href="https://github.com/neovim/neovim/discussions/25647">memline</a>)</li>
</ul>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Piece Tree (Fresh, VS Code)</th>
<th>Rope (Helix, Zed)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Node contents</td>
<td>Pointer to buffer</td>
<td>Actual text (~1KB chunks)</td>
</tr>
<tr>
<td>Insert</td>
<td>Append to buffer, add piece</td>
<td>May copy/split chunk</td>
</tr>
<tr>
<td>Original file</td>
<td>Preserved in buffer 0</td>
<td>Reorganized into chunks</td>
</tr>
<tr>
<td>Large files</td>
<td>Lazy load regions (Fresh, Word 1.1a)</td>
<td>Must load or stream</td>
</tr>
<tr>
<td>Memory for edits</td>
<td>Minimal (just pointers)</td>
<td>Copies chunk data</td>
</tr>
</tbody>
</table>
<h2 id="piece-tree-trade-offs">Piece Tree Trade-offs</h2>
<p><strong>Pros:</strong> Original file preserved, inserts never copy existing text, natural lazy loading, pieces are small (~24 bytes) so more fit in cache, enables structural diffing (see above).</p>
<p><strong>Cons:</strong> Extra indirection (find piece, then fetch buffer), buffer fragmentation over many edits, poor cache locality for text content. Piece count grows with edits, though periodic coalescing can mitigate this.</p>
<p><em>(Note: Fresh's current implementation rebuilds the entire tree on each edit rather than path-copying, making edits O(P) instead of O(log P). This is an implementation gap, not inherent to the design.)</em></p>
<h2 id="further-reading">Further Reading</h2>
<ul>
<li><a href="https://sinelaw.github.io/fresh/">Fresh</a> - The editor discussed in this post (<a href="https://github.com/sinelaw/fresh">source on GitHub</a>)</li>
<li><a href="https://computerhistory.org/blog/microsoft-word-for-windows-1-1a-source-code/">Microsoft Word 1.1a Source Code</a> - Original piece table implementation from 1990</li>
<li><a href="https://code.visualstudio.com/blogs/2018/03/23/text-buffer-reimplementation">VS Code's Piece Table</a> - Microsoft's 2018 write-up on reviving piece tables</li>
<li><a href="https://zed.dev/blog/zed-decoded-rope-sumtree">Zed's Rope &amp; SumTree</a> - How Zed implements ropes with B+ trees</li>
<li><a href="https://coredumped.dev/2023/08/09/text-showdown-gap-buffers-vs-ropes/">Text Showdown: Gap Buffers vs Ropes</a> - Performance comparison</li>
<li><a href="https://www.cs.unm.edu/~crowley/papers/sds.pdf">Data Structures for Text Sequences</a> - Charles Crowley, 1998 (academic survey)</li>
</ul>
]]></content><author><name></name></author></entry><entry><title type="html">How Fresh Loads Huge Files Fast</title><link href="/blog/2025/12/08/how-fresh-loads-huge-files-fast.html" rel="alternate" type="text/html" title="How Fresh Loads Huge Files Fast" /><published>2025-12-08T23:29:37+00:00</published><updated>2025-12-08T23:29:37+00:00</updated><id>/blog/2025/12/08/how-fresh-loads-huge-files-fast.html</id><content type="html" xml:base="/blog/2025/12/08/how-fresh-loads-huge-files-fast.html"><![CDATA[<h1 id="how-fresh-loads-huge-files-fast">How Fresh Loads Huge Files Fast</h1>
<p>Fresh uses a <strong>piece tree</strong> (also called a piece table) for text storage. The piece table originated in the early 1970s - first in <a href="https://www.computerhistory.org/collections/catalog/102740449">J. Strother Moore and Bob Boyer's "77-Editor" at Edinburgh</a> (1971-1973), where they applied structure-sharing techniques from their theorem proving research to text editing. Moore later brought the idea to Xerox PARC, where Charles Simonyi adopted it for the <a href="https://en.wikipedia.org/wiki/Bravo_(editor)">Bravo editor</a> (1974). Simonyi later <a href="https://www.tiny.cloud/blog/wysiwyg-development-history/">brought it to Microsoft Word</a> (1983). The design minimizes memory copying by never modifying original file content - critical for early systems with limited RAM. <a href="https://code.visualstudio.com/blogs/2018/03/23/text-buffer-reimplementation">VS Code adopted piece tables in 2018</a>, replacing their previous line-array implementation.</p>
<p><a href="https://sinelaw.github.io/fresh/">Fresh</a>'s implementation adds immutable nodes (for concurrency and cheap snapshots) and lazy loading (for large files). (<a href="https://github.com/sinelaw/fresh">GitHub</a>)</p>
<h2 id="the-core-idea">The Core Idea</h2>
<p>Instead of storing text in the tree, store <strong>pointers</strong> to text that lives elsewhere.</p>
<h3 id="rope-helix-zed">Rope (<a href="https://github.com/helix-editor/helix/blob/master/docs/architecture.md">Helix</a>, <a href="https://zed.dev/blog/zed-decoded-rope-sumtree">Zed</a>)</h3>
<p>Text lives inside tree nodes:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 360.703125 160" style="max-width: 360.703px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_L_0" d="M132.395,55L123.918,59.167C115.44,63.333,98.486,71.667,90.009,79.333C81.531,87,81.531,94,81.531,97.5L81.531,101"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_R_0" d="M228.019,55L236.496,59.167C244.974,63.333,261.928,71.667,270.406,79.333C278.883,87,278.883,94,278.883,97.5L278.883,101"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(180.20703125, 31.5)" id="flowchart-Root-0" class="node default"><rect height="47" width="156.171875" y="-23.5" x="-78.0859375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> Node</tspan></tspan></text></g></g></g><g transform="translate(81.53125, 128.5)" id="flowchart-L-2" class="node default"><rect height="47" width="147.0625" y="-23.5" x="-73.53125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Leaf:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> '</tspan></tspan></text></g></g></g><g transform="translate(278.8828125, 128.5)" id="flowchart-R-4" class="node default"><rect height="47" width="147.640625" y="-23.5" x="-73.8203125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Leaf:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'World'</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<h3 id="piece-tree-fresh">Piece Tree (Fresh)</h3>
<p>Tree nodes point to separate buffers:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 644.46875 374.6000061035156" style="max-width: 644.469px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="97" width="475.8203125" y="269.5999984741211" x="79.32421875" style=""/><g transform="translate(292.03125, 269.5999984741211)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="211.5999984741211" width="628.46875" y="8" x="8" style=""/><g transform="translate(306.03125, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_L_0" d="M248.528,80L235.46,84.167C222.391,88.333,196.254,96.667,183.186,104.333C170.117,112,170.117,119,170.117,122.5L170.117,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_R_0" d="M395.941,80L409.009,84.167C422.078,88.333,448.215,96.667,461.283,104.333C474.352,112,474.352,119,474.352,122.5L474.352,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_L_B0_0" d="M170.117,194.6L170.117,198.767C170.117,202.933,170.117,211.267,170.117,219.6C170.117,227.933,170.117,236.267,170.117,244.6C170.117,252.933,170.117,261.267,182.551,269.397C194.984,277.528,219.85,285.457,232.284,289.421L244.717,293.385"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_R_B0_0" d="M474.352,194.6L474.352,198.767C474.352,202.933,474.352,211.267,474.352,219.6C474.352,227.933,474.352,236.267,474.352,244.6C474.352,252.933,474.352,261.267,461.918,269.397C449.485,277.528,424.618,285.457,412.185,289.421L399.752,293.385"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(322.234375, 56.5)" id="flowchart-Root-0" class="node default"><rect height="47" width="156.171875" y="-23.5" x="-78.0859375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> Node</tspan></tspan></text></g></g></g><g transform="translate(170.1171875, 162.29999923706055)" id="flowchart-L-2" class="node default"><rect height="64.5999984741211" width="254.234375" y="-32.29999923706055" x="-127.1171875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> offset</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> len</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">6</tspan></tspan></text></g></g></g><g transform="translate(474.3515625, 162.29999923706055)" id="flowchart-R-4" class="node default"><rect height="64.5999984741211" width="254.234375" y="-32.29999923706055" x="-127.1171875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> offset</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 6,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> len</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">5</tspan></tspan></text></g></g></g><g transform="translate(322.234375, 318.0999984741211)" id="flowchart-B0-5" class="node default"><rect height="47" width="213.171875" y="-23.5" x="-106.5859375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> World'</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>A <strong>piece</strong> is just three numbers: which buffer, starting offset, and length.</p>
<h2 id="what-happens-when-you-edit">What Happens When You Edit</h2>
<p>When you type or paste, Fresh appends to a new buffer and creates a piece pointing to it. The original buffer stays untouched.</p>
<h3 id="before-file-contains-hello-world">Before: File contains "Hello World"</h3>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 581.2890625 150.59999084472656" style="max-width: 581.289px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="134.5999984741211" width="280.953125" y="8" x="292.3359375" style=""/><g transform="translate(407.609375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="117" width="234.3359375" y="16.799999237060547" x="8" style=""/><g transform="translate(108.96484375, 16.799999237060547)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M217.336,75.3L221.503,75.3C225.669,75.3,234.003,75.3,242.336,75.3C250.669,75.3,259.003,75.3,267.336,75.3C275.669,75.3,284.003,75.3,291.669,75.3C299.336,75.3,306.336,75.3,309.836,75.3L313.336,75.3"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(125.16796875, 75.29999923706055)" id="flowchart-P1-0" class="node default"><rect height="47" width="184.3359375" y="-23.5" x="-92.16796875" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-11</tspan></tspan></text></g></g></g><g transform="translate(432.8125, 75.29999923706055)" id="flowchart-B0-1" class="node default"><rect height="64.5999984741211" width="230.953125" y="-32.29999923706055" x="-115.4765625" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (original):</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">World'</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<h3 id="after-insert-big--at-position-6">After: Insert "Big " at position 6</h3>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 581.2890625 331.3999938964844" style="max-width: 581.289px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="310.54999923706055" width="280.953125" y="12.850000381469727" x="292.3359375" style=""/><g transform="translate(407.609375, 12.850000381469727)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="315.3999996185303" width="234.3359375" y="8" x="8" style=""/><g transform="translate(108.96484375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M213.48,66.5L218.29,66.5C223.099,66.5,232.717,66.5,241.693,66.5C250.669,66.5,259.003,66.5,267.336,66.5C275.669,66.5,284.003,66.5,295.359,68.982C306.716,71.465,321.097,76.43,328.287,78.912L335.477,81.395"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P2_B1_0" d="M213.48,264.9L218.29,264.9C223.099,264.9,232.717,264.9,241.693,264.9C250.669,264.9,259.003,264.9,267.336,264.9C275.669,264.9,284.003,264.9,292.755,264.9C301.508,264.9,310.68,264.9,315.266,264.9L319.852,264.9"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P3_B0_0" d="M217.336,163.5L221.503,163.5C225.669,163.5,234.003,163.5,242.336,163.5C250.669,163.5,259.003,163.5,267.336,163.5C275.669,163.5,284.003,163.5,295.359,161.018C306.716,158.535,321.097,153.57,328.287,151.088L335.477,148.605"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(125.16796875, 66.5)" id="flowchart-P1-0" class="node default"><rect height="47" width="176.625" y="-23.5" x="-88.3125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-6</tspan></tspan></text></g></g></g><g transform="translate(125.16796875, 264.8999996185303)" id="flowchart-P2-1" class="node default"><rect height="47" width="176.625" y="-23.5" x="-88.3125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-4</tspan></tspan></text></g></g></g><g transform="translate(125.16796875, 163.5)" id="flowchart-P3-2" class="node default"><rect height="47" width="184.3359375" y="-23.5" x="-92.16796875" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 6-11</tspan></tspan></text></g></g></g><g transform="translate(432.8125, 115)" id="flowchart-B0-3" class="node default"><rect height="64.5999984741211" width="230.953125" y="-32.29999923706055" x="-115.4765625" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (original):</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">World'</tspan></tspan></text></g></g></g><g transform="translate(432.8125, 264.8999996185303)" id="flowchart-B1-4" class="node default"><rect height="47" width="217.921875" y="-23.5" x="-108.9609375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (added):</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Big</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> '</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>Document now reads: "Hello Big World"</p>
<p>The original file content in Buffer 0 was never modified or copied.</p>
<h2 id="lazy-loading">Lazy Loading</h2>
<p>For large files, Fresh doesn't load the entire file into memory. Buffers can be <strong>unloaded</strong> - they store a file path and byte range instead of actual data.</p>
<p>This is actually how the original <a href="https://computerhistory.org/blog/microsoft-word-for-windows-1-1a-source-code/">Word 1.1a</a> piece table worked: pieces pointed directly to spans in the original file on disk, loading content only when needed. VS Code's 2018 implementation loads files fully into memory; Fresh returns to the original memory-conscious design.</p>
<h3 id="before-3mb-file-just-opened">Before: 3MB file just opened</h3>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 920.953125 277.6000061035156" style="max-width: 920.953px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="114.5999984741211" width="904.953125" y="155" x="8" style=""/><g transform="translate(435.2734375, 155)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="97" width="860.5" y="8" x="30.2265625" style=""/><g transform="translate(444.2734375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M165.492,80L165.492,84.167C165.492,88.333,165.492,96.667,165.492,105C165.492,113.333,165.492,121.667,165.492,130C165.492,138.333,165.492,146.667,165.492,154.333C165.492,162,165.492,169,165.492,172.5L165.492,176"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P2_B1_0" d="M460.477,80L460.477,84.167C460.477,88.333,460.477,96.667,460.477,105C460.477,113.333,460.477,121.667,460.477,130C460.477,138.333,460.477,146.667,460.477,154.333C460.477,162,460.477,169,460.477,172.5L460.477,176"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P3_B2_0" d="M755.461,80L755.461,84.167C755.461,88.333,755.461,96.667,755.461,105C755.461,113.333,755.461,121.667,755.461,130C755.461,138.333,755.461,146.667,755.461,154.333C755.461,162,755.461,169,755.461,172.5L755.461,176"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(165.4921875, 56.5)" id="flowchart-P1-0" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(460.4765625, 56.5)" id="flowchart-P2-1" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(755.4609375, 56.5)" id="flowchart-P3-2" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(165.4921875, 212.29999923706055)" id="flowchart-B0-3" class="node default"><rect height="64.5999984741211" width="244.984375" y="-32.29999923706055" x="-122.4921875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">file:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> large.txt,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(460.4765625, 212.29999923706055)" id="flowchart-B1-4" class="node default"><rect height="64.5999984741211" width="244.984375" y="-32.29999923706055" x="-122.4921875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">file:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> large.txt,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1-2MB</tspan></tspan></text></g></g></g><g transform="translate(755.4609375, 212.29999923706055)" id="flowchart-B2-5" class="node default"><rect height="64.5999984741211" width="244.984375" y="-32.29999923706055" x="-122.4921875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">file:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> large.txt,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2-3MB</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<h3 id="after-user-scrolls-to-middle">After: User scrolls to middle</h3>
<p>Fresh loads only the visible chunk from disk:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 900.5 277.6000061035156" style="max-width: 900.5px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="114.5999984741211" width="884.5" y="155" x="8" style=""/><g transform="translate(425.046875, 155)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="97" width="840.046875" y="8" x="30.2265625" style=""/><g transform="translate(434.046875, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M165.492,80L165.492,84.167C165.492,88.333,165.492,96.667,165.492,105C165.492,113.333,165.492,121.667,165.492,130C165.492,138.333,165.492,146.667,165.492,154.333C165.492,162,165.492,169,165.492,172.5L165.492,176"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P2_B1_0" d="M450.25,80L450.25,84.167C450.25,88.333,450.25,96.667,450.25,105C450.25,113.333,450.25,121.667,450.25,130C450.25,138.333,450.25,146.667,450.25,154.333C450.25,162,450.25,169,450.25,172.5L450.25,176"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P3_B2_0" d="M735.008,80L735.008,84.167C735.008,88.333,735.008,96.667,735.008,105C735.008,113.333,735.008,121.667,735.008,130C735.008,138.333,735.008,146.667,735.008,154.333C735.008,162,735.008,169,735.008,172.5L735.008,176"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(165.4921875, 56.5)" id="flowchart-P1-0" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(450.25, 56.5)" id="flowchart-P2-1" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(735.0078125, 56.5)" id="flowchart-P3-2" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(165.4921875, 212.29999923706055)" id="flowchart-B0-3" class="node default"><rect height="64.5999984741211" width="244.984375" y="-32.29999923706055" x="-122.4921875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">file:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> large.txt,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(450.25, 212.29999923706055)" id="flowchart-B1-4" class="node default"><rect height="64.5999984741211" width="224.53125" y="-32.29999923706055" x="-112.265625" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> LOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">actual</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> in</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> memory</tspan></tspan></text></g></g></g><g transform="translate(735.0078125, 212.29999923706055)" id="flowchart-B2-5" class="node default"><rect height="64.5999984741211" width="244.984375" y="-32.29999923706055" x="-122.4921875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">file:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> large.txt,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2-3MB</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<h2 id="zero-copy-reads">Zero-Copy Reads</h2>
<p>When reading text for display, Fresh doesn't copy bytes. It returns slices pointing directly into the buffers:</p>
<pre class="rust"><code>// Returns &amp;[u8] pointing into buffer memory
// No allocation, no copy
let text = buffer.get_text_range(100, 200);</code></pre>
<p>Multiple pieces can reference the same buffer region. Displaying the same text twice doesn't double memory usage.</p>
<h2 id="the-tree-structure">The Tree Structure</h2>
<p>The pieces are organized in a balanced binary tree for fast lookups:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 507.453125 294.20001220703125" style="max-width: 507.453px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_I2_0" d="M248.328,73.6L240.675,77.767C233.021,81.933,217.714,90.267,210.06,97.933C202.406,105.6,202.406,112.6,202.406,116.1L202.406,119.6"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_L3_0" d="M368.828,73.6L376.482,77.767C384.135,81.933,399.443,90.267,407.096,99.483C414.75,108.7,414.75,118.8,414.75,123.85L414.75,128.9"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L1_0" d="M140.153,189.2L132.244,193.367C124.336,197.533,108.52,205.867,100.611,213.533C92.703,221.2,92.703,228.2,92.703,231.7L92.703,235.2"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L2_0" d="M264.66,189.2L272.568,193.367C280.476,197.533,296.293,205.867,304.201,213.533C312.109,221.2,312.109,228.2,312.109,231.7L312.109,235.2"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(308.578125, 40.79999923706055)" id="flowchart-I1-0" class="node default"><rect height="65.5999984741211" width="164.1796875" y="-32.79999923706055" x="-82.08984375" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 100</tspan></tspan></text></g></g></g><g transform="translate(202.40625, 156.39999771118164)" id="flowchart-I2-2" class="node default"><rect height="65.5999984741211" width="155.28125" y="-32.79999923706055" x="-77.640625" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan></tspan></text></g></g></g><g transform="translate(414.75, 156.39999771118164)" id="flowchart-L3-4" class="node default"><rect height="47" width="169.40625" y="-23.5" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan></text></g></g></g><g transform="translate(92.703125, 262.6999969482422)" id="flowchart-L1-6" class="node default"><rect height="47" width="169.40625" y="-23.5" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan></text></g></g></g><g transform="translate(312.109375, 262.6999969482422)" id="flowchart-L2-8" class="node default"><rect height="47" width="169.40625" y="-23.5" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>Each internal node caches the total bytes in its left subtree. To find byte offset 75:</p>
<ol type="1">
<li>Root has <code>left_bytes: 100</code>, and 75 &lt; 100, so go left</li>
<li>Internal has <code>left_bytes: 50</code>, and 75 &gt;= 50, so go right with offset 75-50=25</li>
<li>Piece has 50 bytes, offset 25 is within it</li>
</ol>
<p>This is O(log P) where P is the number of pieces.</p>
<h2 id="line-feed-tracking">Line Feed Tracking</h2>
<p>Text editors need fast line-based operations: "go to line 1000", "what line is byte offset 50000 on?", or simply displaying line numbers. Scanning the entire document for newlines would be O(N) - too slow for large files.</p>
<p>Fresh tracks line feeds the same way it tracks bytes. Each piece stores its newline count, and internal nodes cache the count for their left subtree:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 507.453125 348" style="max-width: 507.453px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_I2_0" d="M242.261,91.2L235.618,95.367C228.976,99.533,215.691,107.867,209.049,115.533C202.406,123.2,202.406,130.2,202.406,133.7L202.406,137.2"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_L3_0" d="M374.896,91.2L381.538,95.367C388.18,99.533,401.465,107.867,408.108,117C414.75,126.133,414.75,136.067,414.75,141.033L414.75,146"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L1_0" d="M133.883,224.4L127.02,228.567C120.156,232.733,106.43,241.067,99.566,248.733C92.703,256.4,92.703,263.4,92.703,266.9L92.703,270.4"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L2_0" d="M270.93,224.4L277.793,228.567C284.656,232.733,298.383,241.067,305.246,248.733C312.109,256.4,312.109,263.4,312.109,266.9L312.109,270.4"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(308.578125, 49.599998474121094)" id="flowchart-I1-0" class="node default"><rect height="83.19999694824219" width="164.1796875" y="-41.599998474121094" x="-82.08984375" style="" class="basic label-container"/><g transform="translate(0, -26.599998474121094)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 100</tspan></tspan><tspan dy="1.1em" y="2.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">lf_left:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 3</tspan></tspan></text></g></g></g><g transform="translate(202.40625, 182.79999542236328)" id="flowchart-I2-2" class="node default"><rect height="83.19999694824219" width="155.28125" y="-41.599998474121094" x="-77.640625" style="" class="basic label-container"/><g transform="translate(0, -26.599998474121094)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan></tspan><tspan dy="1.1em" y="2.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">lf_left:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2</tspan></tspan></text></g></g></g><g transform="translate(414.75, 182.79999542236328)" id="flowchart-L3-4" class="node default"><rect height="65.5999984741211" width="169.40625" y="-32.79999923706055" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">line_feeds:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1</tspan></tspan></text></g></g></g><g transform="translate(92.703125, 307.1999931335449)" id="flowchart-L1-6" class="node default"><rect height="65.5999984741211" width="169.40625" y="-32.79999923706055" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 30</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">line_feeds:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2</tspan></tspan></text></g></g></g><g transform="translate(312.109375, 307.1999931335449)" id="flowchart-L2-8" class="node default"><rect height="65.5999984741211" width="169.40625" y="-32.79999923706055" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 20</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">line_feeds:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>To find which piece contains line 3:</p>
<ol type="1">
<li>Root has <code>lf_left: 3</code>, and 3 &gt;= 3, so go right with line 3-3=0</li>
<li>Piece L3 has <code>line_feeds: 1</code>, line 0 is within it</li>
</ol>
<p>This enables O(log P) line-to-offset conversion. The same structure supports offset-to-line lookup by accumulating line counts while traversing.</p>
<h2 id="large-file-mode">Large File Mode</h2>
<p>For files over 100MB, Fresh switches to <strong>large file mode</strong>: no line indexing, pure byte-based navigation.</p>
<p>Why skip line indexing? Counting newlines in a 500MB file means reading the entire file - exactly what lazy loading tries to avoid. Instead, Fresh:</p>
<ul>
<li><strong>Navigates by bytes</strong>: The viewport tracks a byte offset, not a line number. Scrolling moves by byte ranges.</li>
<li><strong>Estimates line counts</strong>: For the scrollbar and status bar, Fresh estimates total lines as <code>file_size / average_line_length</code>.</li>
<li><strong>Shows approximate line numbers</strong>: Visible lines display estimated line numbers based on bytes seen so far.</li>
</ul>
<p>This means "go to line 50000" in a huge file is an approximation, but opening and scrolling remains instant regardless of file size.</p>
<h2 id="immutable-tree-structure">Immutable Tree Structure</h2>
<p>Fresh uses immutable nodes - once created, a node is never modified. Edits create new nodes instead.</p>
<blockquote>
<p><strong>Implementation note:</strong> Fresh is written in Rust. Nodes are wrapped in <code>Arc&lt;T&gt;</code> (Atomic Reference Counted pointer) - think of it as a pointer that tracks how many things reference it. Multiple parts of the code (even different threads) can safely hold the same <code>Arc</code>, and the data is automatically freed when the last reference is dropped. We'll gloss over this detail going forward - just know that "sharing" a node is cheap and thread-safe.</p>
</blockquote>
<p>After an edit, old tree versions remain valid:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 550.396484375 210" style="max-width: 550.396px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="subGraph1" class="cluster"><rect height="194" width="197.9140625" y="8" x="8" style=""/><g transform="translate(34.91015625, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Version</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (after</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> edit)</tspan></tspan></text></g></g></g><g data-look="classic" id="subGraph0" class="cluster"><rect height="194" width="316.482421875" y="8" x="225.9140625" style=""/><g transform="translate(305.4365234375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Version</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (before</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> edit)</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V1_Root_V1_L_0" d="M348.281,80L342.157,84.167C336.032,88.333,323.784,96.667,317.659,104.333C311.535,112,311.535,119,311.535,122.5L311.535,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V1_Root_V1_R_0" d="M417.363,80L423.488,84.167C429.612,88.333,441.861,96.667,447.985,104.333C454.109,112,454.109,119,454.109,122.5L454.109,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V2_Root_V1_L_0" d="M130.428,80L133.624,84.167C136.82,88.333,143.212,96.667,165.487,106.548C187.763,116.429,225.923,127.858,245.002,133.573L264.082,139.287"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V2_Root_V2_R_0" d="M107.557,80L106.698,84.167C105.839,88.333,104.121,96.667,103.261,104.333C102.402,112,102.402,119,102.402,122.5L102.402,126"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(382.822265625, 56.5)" id="flowchart-V1_Root-0" class="node default"><rect height="47" width="115.2421875" y="-23.5" x="-57.62109375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Root</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> v1</tspan></tspan></text></g></g></g><g transform="translate(311.53515625, 153.5)" id="flowchart-V1_L-1" class="node default"><rect height="47" width="87.2421875" y="-23.5" x="-43.62109375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Left</tspan></tspan></text></g></g></g><g transform="translate(454.109375, 153.5)" id="flowchart-V1_R-3" class="node default"><rect height="47" width="97.90625" y="-23.5" x="-48.953125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Right</tspan></tspan></text></g></g></g><g transform="translate(112.40234375, 56.5)" id="flowchart-V2_Root-4" class="node default"><rect height="47" width="115.2421875" y="-23.5" x="-57.62109375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Root</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> v2</tspan></tspan></text></g></g></g><g transform="translate(102.40234375, 153.5)" id="flowchart-V2_R-7" class="node default"><rect height="47" width="118.8046875" y="-23.5" x="-59.40234375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Right</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> v2</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>Version 2 shares the unchanged left subtree with Version 1. This enables:</p>
<ul>
<li>Undo/redo by keeping old root references</li>
<li>Concurrent reads without locks</li>
<li>Cheap snapshots</li>
</ul>
<h2 id="structural-diffing">Structural Diffing</h2>
<p>Piece trees enable fast change detection without reading file content. Fresh uses a two-phase algorithm to find what changed since the last save:</p>
<ol type="1">
<li><strong>Pointer check</strong>: If the saved and current tree roots are the same object, content is identical (instant).</li>
<li><strong>Structure diff</strong>: Compare piece references - buffer ID, offset, length - to find which byte ranges differ. This is O(pieces), not O(file size).</li>
<li><strong>Content verification</strong> (optional): For small changed regions, verify actual bytes differ to handle edge cases like undo back to original.</li>
</ol>
<p>This matters for large files: detecting "has the user modified this 500MB file?" requires only comparing piece metadata, not reading megabytes from disk.</p>
<h2 id="fresh-vs-vs-code">Fresh vs VS Code</h2>
<p><a href="https://github.com/microsoft/vscode-textbuffer">VS Code also uses a piece tree</a>, but with a mutable tree - nodes are modified in place during rebalancing. Fresh uses a fully <a href="https://en.wikipedia.org/wiki/Persistent_data_structure">persistent data structure</a>: edits create new tree versions via path-copying, sharing unchanged subtrees between versions.</p>
<p>This gives Fresh cheap undo (keep old roots), lock-free concurrent reads, and instant snapshots - at the cost of more allocations per edit.</p>
<p>Fresh also implements lazy loading; VS Code loads entire files into memory.</p>
<h2 id="comparison-piece-tree-vs-rope">Comparison: Piece Tree vs Rope</h2>
<p>Different editors use different text storage structures:</p>
<ul>
<li><strong>Piece tree</strong>: VS Code, Fresh</li>
<li><strong><a href="https://en.wikipedia.org/wiki/Rope_(data_structure)">Rope</a></strong>: Helix (<a href="https://github.com/cessen/ropey">Ropey</a>), Zed (<a href="https://zed.dev/blog/zed-decoded-rope-sumtree">SumTree</a>)</li>
<li><strong><a href="https://en.wikipedia.org/wiki/Gap_buffer">Gap buffer</a></strong>: Emacs</li>
<li><strong>Block-based line storage</strong>: Vim/Neovim (<a href="https://github.com/neovim/neovim/discussions/25647">memline</a>)</li>
</ul>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Piece Tree (Fresh, VS Code)</th>
<th>Rope (Helix, Zed)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Node contents</td>
<td>Pointer to buffer</td>
<td>Actual text (~1KB chunks)</td>
</tr>
<tr>
<td>Insert</td>
<td>Append to buffer, add piece</td>
<td>May copy/split chunk</td>
</tr>
<tr>
<td>Original file</td>
<td>Preserved in buffer 0</td>
<td>Reorganized into chunks</td>
</tr>
<tr>
<td>Large files</td>
<td>Lazy load regions (Fresh, Word 1.1a)</td>
<td>Must load or stream</td>
</tr>
<tr>
<td>Memory for edits</td>
<td>Minimal (just pointers)</td>
<td>Copies chunk data</td>
</tr>
</tbody>
</table>
<h2 id="piece-tree-trade-offs">Piece Tree Trade-offs</h2>
<p><strong>Pros:</strong> Original file preserved, inserts never copy existing text, natural lazy loading, pieces are small (~24 bytes) so more fit in cache, enables structural diffing (see above).</p>
<p><strong>Cons:</strong> Extra indirection (find piece, then fetch buffer), buffer fragmentation over many edits, poor cache locality for text content. Piece count grows with edits, though periodic coalescing can mitigate this.</p>
<p><em>(Note: Fresh's current implementation rebuilds the entire tree on each edit rather than path-copying, making edits O(P) instead of O(log P). This is an implementation gap, not inherent to the design.)</em></p>
<h2 id="further-reading">Further Reading</h2>
<ul>
<li><a href="https://sinelaw.github.io/fresh/">Fresh</a> - The editor discussed in this post (<a href="https://github.com/sinelaw/fresh">source on GitHub</a>)</li>
<li><a href="https://computerhistory.org/blog/microsoft-word-for-windows-1-1a-source-code/">Microsoft Word 1.1a Source Code</a> - Original piece table implementation from 1990</li>
<li><a href="https://code.visualstudio.com/blogs/2018/03/23/text-buffer-reimplementation">VS Code's Piece Table</a> - Microsoft's 2018 write-up on reviving piece tables</li>
<li><a href="https://zed.dev/blog/zed-decoded-rope-sumtree">Zed's Rope &amp; SumTree</a> - How Zed implements ropes with B+ trees</li>
<li><a href="https://coredumped.dev/2023/08/09/text-showdown-gap-buffers-vs-ropes/">Text Showdown: Gap Buffers vs Ropes</a> - Performance comparison</li>
<li><a href="https://www.cs.unm.edu/~crowley/papers/sds.pdf">Data Structures for Text Sequences</a> - Charles Crowley, 1998 (academic survey)</li>
</ul>
]]></content><author><name></name></author></entry><entry><title type="html">How Fresh Loads Huge Files Fast</title><link href="/blog/2025/12/08/how-fresh-loads-huge-files-fast.html" rel="alternate" type="text/html" title="How Fresh Loads Huge Files Fast" /><published>2025-12-08T23:27:25+00:00</published><updated>2025-12-08T23:27:25+00:00</updated><id>/blog/2025/12/08/how-fresh-loads-huge-files-fast.html</id><content type="html" xml:base="/blog/2025/12/08/how-fresh-loads-huge-files-fast.html"><![CDATA[<h1 id="how-fresh-loads-huge-files-fast">How Fresh Loads Huge Files Fast</h1>
<p>Fresh uses a <strong>piece tree</strong> (also called a piece table) for text storage. The piece table originated in the early 1970s - first in <a href="https://www.computerhistory.org/collections/catalog/102740449">J. Strother Moore and Bob Boyer's "77-Editor" at Edinburgh</a> (1971-1973), where they applied structure-sharing techniques from their theorem proving research to text editing. Moore later brought the idea to Xerox PARC, where Charles Simonyi adopted it for the <a href="https://en.wikipedia.org/wiki/Bravo_(editor)">Bravo editor</a> (1974). Simonyi later <a href="https://www.tiny.cloud/blog/wysiwyg-development-history/">brought it to Microsoft Word</a> (1983). The design minimizes memory copying by never modifying original file content - critical for early systems with limited RAM. <a href="https://code.visualstudio.com/blogs/2018/03/23/text-buffer-reimplementation">VS Code adopted piece tables in 2018</a>, replacing their previous line-array implementation.</p>
<p><a href="https://sinelaw.github.io/fresh/">Fresh</a>'s implementation adds immutable nodes (for concurrency and cheap snapshots) and lazy loading (for large files). (<a href="https://github.com/sinelaw/fresh">GitHub</a>)</p>
<h2 id="the-core-idea">The Core Idea</h2>
<p>Instead of storing text in the tree, store <strong>pointers</strong> to text that lives elsewhere.</p>
<h3 id="rope-helix-zed">Rope (<a href="https://github.com/helix-editor/helix/blob/master/docs/architecture.md">Helix</a>, <a href="https://zed.dev/blog/zed-decoded-rope-sumtree">Zed</a>)</h3>
<p>Text lives inside tree nodes:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 360.703125 160" style="max-width: 360.703px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_L_0" d="M132.395,55L123.918,59.167C115.44,63.333,98.486,71.667,90.009,79.333C81.531,87,81.531,94,81.531,97.5L81.531,101"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_R_0" d="M228.019,55L236.496,59.167C244.974,63.333,261.928,71.667,270.406,79.333C278.883,87,278.883,94,278.883,97.5L278.883,101"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(180.20703125, 31.5)" id="flowchart-Root-0" class="node default"><rect height="47" width="156.171875" y="-23.5" x="-78.0859375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> Node</tspan></tspan></text></g></g></g><g transform="translate(81.53125, 128.5)" id="flowchart-L-2" class="node default"><rect height="47" width="147.0625" y="-23.5" x="-73.53125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Leaf:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> '</tspan></tspan></text></g></g></g><g transform="translate(278.8828125, 128.5)" id="flowchart-R-4" class="node default"><rect height="47" width="147.640625" y="-23.5" x="-73.8203125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Leaf:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'World'</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<h3 id="piece-tree-fresh">Piece Tree (Fresh)</h3>
<p>Tree nodes point to separate buffers:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 644.46875 374.6000061035156" style="max-width: 644.469px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="97" width="475.8203125" y="269.5999984741211" x="79.32421875" style=""/><g transform="translate(292.03125, 269.5999984741211)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="211.5999984741211" width="628.46875" y="8" x="8" style=""/><g transform="translate(306.03125, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_L_0" d="M248.528,80L235.46,84.167C222.391,88.333,196.254,96.667,183.186,104.333C170.117,112,170.117,119,170.117,122.5L170.117,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_R_0" d="M395.941,80L409.009,84.167C422.078,88.333,448.215,96.667,461.283,104.333C474.352,112,474.352,119,474.352,122.5L474.352,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_L_B0_0" d="M170.117,194.6L170.117,198.767C170.117,202.933,170.117,211.267,170.117,219.6C170.117,227.933,170.117,236.267,170.117,244.6C170.117,252.933,170.117,261.267,182.551,269.397C194.984,277.528,219.85,285.457,232.284,289.421L244.717,293.385"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_R_B0_0" d="M474.352,194.6L474.352,198.767C474.352,202.933,474.352,211.267,474.352,219.6C474.352,227.933,474.352,236.267,474.352,244.6C474.352,252.933,474.352,261.267,461.918,269.397C449.485,277.528,424.618,285.457,412.185,289.421L399.752,293.385"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(322.234375, 56.5)" id="flowchart-Root-0" class="node default"><rect height="47" width="156.171875" y="-23.5" x="-78.0859375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> Node</tspan></tspan></text></g></g></g><g transform="translate(170.1171875, 162.29999923706055)" id="flowchart-L-2" class="node default"><rect height="64.5999984741211" width="254.234375" y="-32.29999923706055" x="-127.1171875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> offset</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> len</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">6</tspan></tspan></text></g></g></g><g transform="translate(474.3515625, 162.29999923706055)" id="flowchart-R-4" class="node default"><rect height="64.5999984741211" width="254.234375" y="-32.29999923706055" x="-127.1171875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> offset</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 6,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> len</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">5</tspan></tspan></text></g></g></g><g transform="translate(322.234375, 318.0999984741211)" id="flowchart-B0-5" class="node default"><rect height="47" width="213.171875" y="-23.5" x="-106.5859375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> World'</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>A <strong>piece</strong> is just three numbers: which buffer, starting offset, and length.</p>
<h2 id="what-happens-when-you-edit">What Happens When You Edit</h2>
<p>When you type or paste, Fresh appends to a new buffer and creates a piece pointing to it. The original buffer stays untouched.</p>
<h3 id="before-file-contains-hello-world">Before: File contains "Hello World"</h3>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 581.2890625 150.59999084472656" style="max-width: 581.289px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="134.5999984741211" width="280.953125" y="8" x="292.3359375" style=""/><g transform="translate(407.609375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="117" width="234.3359375" y="16.799999237060547" x="8" style=""/><g transform="translate(108.96484375, 16.799999237060547)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M217.336,75.3L221.503,75.3C225.669,75.3,234.003,75.3,242.336,75.3C250.669,75.3,259.003,75.3,267.336,75.3C275.669,75.3,284.003,75.3,291.669,75.3C299.336,75.3,306.336,75.3,309.836,75.3L313.336,75.3"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(125.16796875, 75.29999923706055)" id="flowchart-P1-0" class="node default"><rect height="47" width="184.3359375" y="-23.5" x="-92.16796875" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-11</tspan></tspan></text></g></g></g><g transform="translate(432.8125, 75.29999923706055)" id="flowchart-B0-1" class="node default"><rect height="64.5999984741211" width="230.953125" y="-32.29999923706055" x="-115.4765625" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (original):</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">World'</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<h3 id="after-insert-big--at-position-6">After: Insert "Big " at position 6</h3>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 581.2890625 331.3999938964844" style="max-width: 581.289px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="310.54999923706055" width="280.953125" y="12.850000381469727" x="292.3359375" style=""/><g transform="translate(407.609375, 12.850000381469727)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="315.3999996185303" width="234.3359375" y="8" x="8" style=""/><g transform="translate(108.96484375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M213.48,66.5L218.29,66.5C223.099,66.5,232.717,66.5,241.693,66.5C250.669,66.5,259.003,66.5,267.336,66.5C275.669,66.5,284.003,66.5,295.359,68.982C306.716,71.465,321.097,76.43,328.287,78.912L335.477,81.395"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P2_B1_0" d="M213.48,264.9L218.29,264.9C223.099,264.9,232.717,264.9,241.693,264.9C250.669,264.9,259.003,264.9,267.336,264.9C275.669,264.9,284.003,264.9,292.755,264.9C301.508,264.9,310.68,264.9,315.266,264.9L319.852,264.9"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P3_B0_0" d="M217.336,163.5L221.503,163.5C225.669,163.5,234.003,163.5,242.336,163.5C250.669,163.5,259.003,163.5,267.336,163.5C275.669,163.5,284.003,163.5,295.359,161.018C306.716,158.535,321.097,153.57,328.287,151.088L335.477,148.605"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(125.16796875, 66.5)" id="flowchart-P1-0" class="node default"><rect height="47" width="176.625" y="-23.5" x="-88.3125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-6</tspan></tspan></text></g></g></g><g transform="translate(125.16796875, 264.8999996185303)" id="flowchart-P2-1" class="node default"><rect height="47" width="176.625" y="-23.5" x="-88.3125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-4</tspan></tspan></text></g></g></g><g transform="translate(125.16796875, 163.5)" id="flowchart-P3-2" class="node default"><rect height="47" width="184.3359375" y="-23.5" x="-92.16796875" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 6-11</tspan></tspan></text></g></g></g><g transform="translate(432.8125, 115)" id="flowchart-B0-3" class="node default"><rect height="64.5999984741211" width="230.953125" y="-32.29999923706055" x="-115.4765625" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (original):</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">World'</tspan></tspan></text></g></g></g><g transform="translate(432.8125, 264.8999996185303)" id="flowchart-B1-4" class="node default"><rect height="47" width="217.921875" y="-23.5" x="-108.9609375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (added):</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Big</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> '</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>Document now reads: "Hello Big World"</p>
<p>The original file content in Buffer 0 was never modified or copied.</p>
<h2 id="lazy-loading">Lazy Loading</h2>
<p>For large files, Fresh doesn't load the entire file into memory. Buffers can be <strong>unloaded</strong> - they store a file path and byte range instead of actual data.</p>
<p>This is actually how the original <a href="https://computerhistory.org/blog/microsoft-word-for-windows-1-1a-source-code/">Word 1.1a</a> piece table worked: pieces pointed directly to spans in the original file on disk, loading content only when needed. VS Code's 2018 implementation loads files fully into memory; Fresh returns to the original memory-conscious design.</p>
<h3 id="before-3mb-file-just-opened">Before: 3MB file just opened</h3>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 920.953125 277.6000061035156" style="max-width: 920.953px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="114.5999984741211" width="904.953125" y="155" x="8" style=""/><g transform="translate(435.2734375, 155)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="97" width="860.5" y="8" x="30.2265625" style=""/><g transform="translate(444.2734375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M165.492,80L165.492,84.167C165.492,88.333,165.492,96.667,165.492,105C165.492,113.333,165.492,121.667,165.492,130C165.492,138.333,165.492,146.667,165.492,154.333C165.492,162,165.492,169,165.492,172.5L165.492,176"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P2_B1_0" d="M460.477,80L460.477,84.167C460.477,88.333,460.477,96.667,460.477,105C460.477,113.333,460.477,121.667,460.477,130C460.477,138.333,460.477,146.667,460.477,154.333C460.477,162,460.477,169,460.477,172.5L460.477,176"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P3_B2_0" d="M755.461,80L755.461,84.167C755.461,88.333,755.461,96.667,755.461,105C755.461,113.333,755.461,121.667,755.461,130C755.461,138.333,755.461,146.667,755.461,154.333C755.461,162,755.461,169,755.461,172.5L755.461,176"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(165.4921875, 56.5)" id="flowchart-P1-0" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(460.4765625, 56.5)" id="flowchart-P2-1" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(755.4609375, 56.5)" id="flowchart-P3-2" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(165.4921875, 212.29999923706055)" id="flowchart-B0-3" class="node default"><rect height="64.5999984741211" width="244.984375" y="-32.29999923706055" x="-122.4921875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">file:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> large.txt,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(460.4765625, 212.29999923706055)" id="flowchart-B1-4" class="node default"><rect height="64.5999984741211" width="244.984375" y="-32.29999923706055" x="-122.4921875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">file:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> large.txt,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1-2MB</tspan></tspan></text></g></g></g><g transform="translate(755.4609375, 212.29999923706055)" id="flowchart-B2-5" class="node default"><rect height="64.5999984741211" width="244.984375" y="-32.29999923706055" x="-122.4921875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">file:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> large.txt,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2-3MB</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<h3 id="after-user-scrolls-to-middle">After: User scrolls to middle</h3>
<p>Fresh loads only the visible chunk from disk:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 900.5 277.6000061035156" style="max-width: 900.5px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="114.5999984741211" width="884.5" y="155" x="8" style=""/><g transform="translate(425.046875, 155)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="97" width="840.046875" y="8" x="30.2265625" style=""/><g transform="translate(434.046875, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M165.492,80L165.492,84.167C165.492,88.333,165.492,96.667,165.492,105C165.492,113.333,165.492,121.667,165.492,130C165.492,138.333,165.492,146.667,165.492,154.333C165.492,162,165.492,169,165.492,172.5L165.492,176"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P2_B1_0" d="M450.25,80L450.25,84.167C450.25,88.333,450.25,96.667,450.25,105C450.25,113.333,450.25,121.667,450.25,130C450.25,138.333,450.25,146.667,450.25,154.333C450.25,162,450.25,169,450.25,172.5L450.25,176"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P3_B2_0" d="M735.008,80L735.008,84.167C735.008,88.333,735.008,96.667,735.008,105C735.008,113.333,735.008,121.667,735.008,130C735.008,138.333,735.008,146.667,735.008,154.333C735.008,162,735.008,169,735.008,172.5L735.008,176"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(165.4921875, 56.5)" id="flowchart-P1-0" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(450.25, 56.5)" id="flowchart-P2-1" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(735.0078125, 56.5)" id="flowchart-P3-2" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(165.4921875, 212.29999923706055)" id="flowchart-B0-3" class="node default"><rect height="64.5999984741211" width="244.984375" y="-32.29999923706055" x="-122.4921875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">file:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> large.txt,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(450.25, 212.29999923706055)" id="flowchart-B1-4" class="node default"><rect height="64.5999984741211" width="224.53125" y="-32.29999923706055" x="-112.265625" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> LOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">actual</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> in</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> memory</tspan></tspan></text></g></g></g><g transform="translate(735.0078125, 212.29999923706055)" id="flowchart-B2-5" class="node default"><rect height="64.5999984741211" width="244.984375" y="-32.29999923706055" x="-122.4921875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">file:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> large.txt,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2-3MB</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<h2 id="zero-copy-reads">Zero-Copy Reads</h2>
<p>When reading text for display, Fresh doesn't copy bytes. It returns slices pointing directly into the buffers:</p>
<pre class="rust"><code>// Returns &amp;[u8] pointing into buffer memory
// No allocation, no copy
let text = buffer.get_text_range(100, 200);</code></pre>
<p>Multiple pieces can reference the same buffer region. Displaying the same text twice doesn't double memory usage.</p>
<h2 id="the-tree-structure">The Tree Structure</h2>
<p>The pieces are organized in a balanced binary tree for fast lookups:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 507.453125 294.20001220703125" style="max-width: 507.453px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_I2_0" d="M248.328,73.6L240.675,77.767C233.021,81.933,217.714,90.267,210.06,97.933C202.406,105.6,202.406,112.6,202.406,116.1L202.406,119.6"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_L3_0" d="M368.828,73.6L376.482,77.767C384.135,81.933,399.443,90.267,407.096,99.483C414.75,108.7,414.75,118.8,414.75,123.85L414.75,128.9"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L1_0" d="M140.153,189.2L132.244,193.367C124.336,197.533,108.52,205.867,100.611,213.533C92.703,221.2,92.703,228.2,92.703,231.7L92.703,235.2"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L2_0" d="M264.66,189.2L272.568,193.367C280.476,197.533,296.293,205.867,304.201,213.533C312.109,221.2,312.109,228.2,312.109,231.7L312.109,235.2"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(308.578125, 40.79999923706055)" id="flowchart-I1-0" class="node default"><rect height="65.5999984741211" width="164.1796875" y="-32.79999923706055" x="-82.08984375" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 100</tspan></tspan></text></g></g></g><g transform="translate(202.40625, 156.39999771118164)" id="flowchart-I2-2" class="node default"><rect height="65.5999984741211" width="155.28125" y="-32.79999923706055" x="-77.640625" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan></tspan></text></g></g></g><g transform="translate(414.75, 156.39999771118164)" id="flowchart-L3-4" class="node default"><rect height="47" width="169.40625" y="-23.5" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan></text></g></g></g><g transform="translate(92.703125, 262.6999969482422)" id="flowchart-L1-6" class="node default"><rect height="47" width="169.40625" y="-23.5" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan></text></g></g></g><g transform="translate(312.109375, 262.6999969482422)" id="flowchart-L2-8" class="node default"><rect height="47" width="169.40625" y="-23.5" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>Each internal node caches the total bytes in its left subtree. To find byte offset 75:</p>
<ol type="1">
<li>Root has <code>left_bytes: 100</code>, and 75 &lt; 100, so go left</li>
<li>Internal has <code>left_bytes: 50</code>, and 75 &gt;= 50, so go right with offset 75-50=25</li>
<li>Piece has 50 bytes, offset 25 is within it</li>
</ol>
<p>This is O(log P) where P is the number of pieces.</p>
<h2 id="line-feed-tracking">Line Feed Tracking</h2>
<p>Text editors need fast line-based operations: "go to line 1000", "what line is byte offset 50000 on?", or simply displaying line numbers. Scanning the entire document for newlines would be O(N) - too slow for large files.</p>
<p>Fresh tracks line feeds the same way it tracks bytes. Each piece stores its newline count, and internal nodes cache the count for their left subtree:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 507.453125 348" style="max-width: 507.453px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_I2_0" d="M242.261,91.2L235.618,95.367C228.976,99.533,215.691,107.867,209.049,115.533C202.406,123.2,202.406,130.2,202.406,133.7L202.406,137.2"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_L3_0" d="M374.896,91.2L381.538,95.367C388.18,99.533,401.465,107.867,408.108,117C414.75,126.133,414.75,136.067,414.75,141.033L414.75,146"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L1_0" d="M133.883,224.4L127.02,228.567C120.156,232.733,106.43,241.067,99.566,248.733C92.703,256.4,92.703,263.4,92.703,266.9L92.703,270.4"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L2_0" d="M270.93,224.4L277.793,228.567C284.656,232.733,298.383,241.067,305.246,248.733C312.109,256.4,312.109,263.4,312.109,266.9L312.109,270.4"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(308.578125, 49.599998474121094)" id="flowchart-I1-0" class="node default"><rect height="83.19999694824219" width="164.1796875" y="-41.599998474121094" x="-82.08984375" style="" class="basic label-container"/><g transform="translate(0, -26.599998474121094)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 100</tspan></tspan><tspan dy="1.1em" y="2.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">lf_left:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 3</tspan></tspan></text></g></g></g><g transform="translate(202.40625, 182.79999542236328)" id="flowchart-I2-2" class="node default"><rect height="83.19999694824219" width="155.28125" y="-41.599998474121094" x="-77.640625" style="" class="basic label-container"/><g transform="translate(0, -26.599998474121094)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan></tspan><tspan dy="1.1em" y="2.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">lf_left:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2</tspan></tspan></text></g></g></g><g transform="translate(414.75, 182.79999542236328)" id="flowchart-L3-4" class="node default"><rect height="65.5999984741211" width="169.40625" y="-32.79999923706055" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">line_feeds:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1</tspan></tspan></text></g></g></g><g transform="translate(92.703125, 307.1999931335449)" id="flowchart-L1-6" class="node default"><rect height="65.5999984741211" width="169.40625" y="-32.79999923706055" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 30</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">line_feeds:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2</tspan></tspan></text></g></g></g><g transform="translate(312.109375, 307.1999931335449)" id="flowchart-L2-8" class="node default"><rect height="65.5999984741211" width="169.40625" y="-32.79999923706055" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 20</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">line_feeds:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>To find which piece contains line 3:</p>
<ol type="1">
<li>Root has <code>lf_left: 3</code>, and 3 &gt;= 3, so go right with line 3-3=0</li>
<li>Piece L3 has <code>line_feeds: 1</code>, line 0 is within it</li>
</ol>
<p>This enables O(log P) line-to-offset conversion. The same structure supports offset-to-line lookup by accumulating line counts while traversing.</p>
<h2 id="large-file-mode">Large File Mode</h2>
<p>For files over 100MB, Fresh switches to <strong>large file mode</strong>: no line indexing, pure byte-based navigation.</p>
<p>Why skip line indexing? Counting newlines in a 500MB file means reading the entire file - exactly what lazy loading tries to avoid. Instead, Fresh:</p>
<ul>
<li><strong>Navigates by bytes</strong>: The viewport tracks a byte offset, not a line number. Scrolling moves by byte ranges.</li>
<li><strong>Estimates line counts</strong>: For the scrollbar and status bar, Fresh estimates total lines as <code>file_size / average_line_length</code>.</li>
<li><strong>Shows approximate line numbers</strong>: Visible lines display estimated line numbers based on bytes seen so far.</li>
</ul>
<p>This means "go to line 50000" in a huge file is an approximation, but opening and scrolling remains instant regardless of file size.</p>
<h2 id="immutable-tree-structure">Immutable Tree Structure</h2>
<p>Fresh uses immutable nodes - once created, a node is never modified. Edits create new nodes instead.</p>
<blockquote>
<p><strong>Implementation note:</strong> Fresh is written in Rust. Nodes are wrapped in <code>Arc&lt;T&gt;</code> (Atomic Reference Counted pointer) - think of it as a pointer that tracks how many things reference it. Multiple parts of the code (even different threads) can safely hold the same <code>Arc</code>, and the data is automatically freed when the last reference is dropped. We'll gloss over this detail going forward - just know that "sharing" a node is cheap and thread-safe.</p>
</blockquote>
<p>After an edit, old tree versions remain valid:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 550.396484375 210" style="max-width: 550.396px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="subGraph1" class="cluster"><rect height="194" width="197.9140625" y="8" x="8" style=""/><g transform="translate(34.91015625, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Version</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (after</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> edit)</tspan></tspan></text></g></g></g><g data-look="classic" id="subGraph0" class="cluster"><rect height="194" width="316.482421875" y="8" x="225.9140625" style=""/><g transform="translate(305.4365234375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Version</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (before</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> edit)</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V1_Root_V1_L_0" d="M348.281,80L342.157,84.167C336.032,88.333,323.784,96.667,317.659,104.333C311.535,112,311.535,119,311.535,122.5L311.535,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V1_Root_V1_R_0" d="M417.363,80L423.488,84.167C429.612,88.333,441.861,96.667,447.985,104.333C454.109,112,454.109,119,454.109,122.5L454.109,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V2_Root_V1_L_0" d="M130.428,80L133.624,84.167C136.82,88.333,143.212,96.667,165.487,106.548C187.763,116.429,225.923,127.858,245.002,133.573L264.082,139.287"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V2_Root_V2_R_0" d="M107.557,80L106.698,84.167C105.839,88.333,104.121,96.667,103.261,104.333C102.402,112,102.402,119,102.402,122.5L102.402,126"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(382.822265625, 56.5)" id="flowchart-V1_Root-0" class="node default"><rect height="47" width="115.2421875" y="-23.5" x="-57.62109375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Root</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> v1</tspan></tspan></text></g></g></g><g transform="translate(311.53515625, 153.5)" id="flowchart-V1_L-1" class="node default"><rect height="47" width="87.2421875" y="-23.5" x="-43.62109375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Left</tspan></tspan></text></g></g></g><g transform="translate(454.109375, 153.5)" id="flowchart-V1_R-3" class="node default"><rect height="47" width="97.90625" y="-23.5" x="-48.953125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Right</tspan></tspan></text></g></g></g><g transform="translate(112.40234375, 56.5)" id="flowchart-V2_Root-4" class="node default"><rect height="47" width="115.2421875" y="-23.5" x="-57.62109375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Root</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> v2</tspan></tspan></text></g></g></g><g transform="translate(102.40234375, 153.5)" id="flowchart-V2_R-7" class="node default"><rect height="47" width="118.8046875" y="-23.5" x="-59.40234375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Right</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> v2</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>Version 2 shares the unchanged left subtree with Version 1. This enables:</p>
<ul>
<li>Undo/redo by keeping old root references</li>
<li>Concurrent reads without locks</li>
<li>Cheap snapshots</li>
</ul>
<h2 id="fresh-vs-vs-code">Fresh vs VS Code</h2>
<p><a href="https://github.com/microsoft/vscode-textbuffer">VS Code also uses a piece tree</a>, but with a mutable tree - nodes are modified in place during rebalancing. Fresh uses a fully <a href="https://en.wikipedia.org/wiki/Persistent_data_structure">persistent data structure</a>: edits create new tree versions via path-copying, sharing unchanged subtrees between versions.</p>
<p>This gives Fresh cheap undo (keep old roots), lock-free concurrent reads, and instant snapshots - at the cost of more allocations per edit.</p>
<p>Fresh also implements lazy loading; VS Code loads entire files into memory.</p>
<h2 id="comparison-piece-tree-vs-rope">Comparison: Piece Tree vs Rope</h2>
<p>Different editors use different text storage structures:</p>
<ul>
<li><strong>Piece tree</strong>: VS Code, Fresh</li>
<li><strong><a href="https://en.wikipedia.org/wiki/Rope_(data_structure)">Rope</a></strong>: Helix (<a href="https://github.com/cessen/ropey">Ropey</a>), Zed (<a href="https://zed.dev/blog/zed-decoded-rope-sumtree">SumTree</a>)</li>
<li><strong><a href="https://en.wikipedia.org/wiki/Gap_buffer">Gap buffer</a></strong>: Emacs</li>
<li><strong>Block-based line storage</strong>: Vim/Neovim (<a href="https://github.com/neovim/neovim/discussions/25647">memline</a>)</li>
</ul>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Piece Tree (Fresh, VS Code)</th>
<th>Rope (Helix, Zed)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Node contents</td>
<td>Pointer to buffer</td>
<td>Actual text (~1KB chunks)</td>
</tr>
<tr>
<td>Insert</td>
<td>Append to buffer, add piece</td>
<td>May copy/split chunk</td>
</tr>
<tr>
<td>Original file</td>
<td>Preserved in buffer 0</td>
<td>Reorganized into chunks</td>
</tr>
<tr>
<td>Large files</td>
<td>Lazy load regions (Fresh, Word 1.1a)</td>
<td>Must load or stream</td>
</tr>
<tr>
<td>Memory for edits</td>
<td>Minimal (just pointers)</td>
<td>Copies chunk data</td>
</tr>
</tbody>
</table>
<h2 id="piece-tree-trade-offs">Piece Tree Trade-offs</h2>
<p><strong>Pros:</strong> Original file preserved, inserts never copy existing text, natural lazy loading, pieces are small (~24 bytes) so more fit in cache, and <strong>structural diffing</strong> - Fresh can diff two tree versions by comparing piece references (O(pieces)) without reading content, useful for detecting changes in large files.</p>
<p><strong>Cons:</strong> Extra indirection (find piece, then fetch buffer), buffer fragmentation over many edits, poor cache locality for text content, piece count grows unbounded.</p>
<p><em>(Note: Fresh's current implementation rebuilds the entire tree on each edit rather than path-copying, making edits O(P) instead of O(log P). This is an implementation gap, not inherent to the design.)</em></p>
<h2 id="further-reading">Further Reading</h2>
<ul>
<li><a href="https://sinelaw.github.io/fresh/">Fresh</a> - The editor discussed in this post (<a href="https://github.com/sinelaw/fresh">source on GitHub</a>)</li>
<li><a href="https://computerhistory.org/blog/microsoft-word-for-windows-1-1a-source-code/">Microsoft Word 1.1a Source Code</a> - Original piece table implementation from 1990</li>
<li><a href="https://code.visualstudio.com/blogs/2018/03/23/text-buffer-reimplementation">VS Code's Piece Table</a> - Microsoft's 2018 write-up on reviving piece tables</li>
<li><a href="https://zed.dev/blog/zed-decoded-rope-sumtree">Zed's Rope &amp; SumTree</a> - How Zed implements ropes with B+ trees</li>
<li><a href="https://coredumped.dev/2023/08/09/text-showdown-gap-buffers-vs-ropes/">Text Showdown: Gap Buffers vs Ropes</a> - Performance comparison</li>
<li><a href="https://www.cs.unm.edu/~crowley/papers/sds.pdf">Data Structures for Text Sequences</a> - Charles Crowley, 1998 (academic survey)</li>
</ul>
]]></content><author><name></name></author></entry><entry><title type="html">How Fresh Loads Huge Files Fast</title><link href="/blog/2025/12/08/how-fresh-loads-huge-files-fast.html" rel="alternate" type="text/html" title="How Fresh Loads Huge Files Fast" /><published>2025-12-08T23:23:17+00:00</published><updated>2025-12-08T23:23:17+00:00</updated><id>/blog/2025/12/08/how-fresh-loads-huge-files-fast.html</id><content type="html" xml:base="/blog/2025/12/08/how-fresh-loads-huge-files-fast.html"><![CDATA[<h1 id="how-fresh-loads-huge-files-fast">How Fresh Loads Huge Files Fast</h1>
<p>Fresh uses a <strong>piece tree</strong> (also called a piece table) for text storage. The piece table originated in the early 1970s - first in <a href="https://www.computerhistory.org/collections/catalog/102740449">J. Strother Moore and Bob Boyer's "77-Editor" at Edinburgh</a> (1971-1973), where they applied structure-sharing techniques from their theorem proving research to text editing. Moore later brought the idea to Xerox PARC, where Charles Simonyi adopted it for the <a href="https://en.wikipedia.org/wiki/Bravo_(editor)">Bravo editor</a> (1974). Simonyi later <a href="https://www.tiny.cloud/blog/wysiwyg-development-history/">brought it to Microsoft Word</a> (1983). The design minimizes memory copying by never modifying original file content - critical for early systems with limited RAM. <a href="https://code.visualstudio.com/blogs/2018/03/23/text-buffer-reimplementation">VS Code adopted piece tables in 2018</a>, replacing their previous line-array implementation.</p>
<p><a href="https://sinelaw.github.io/fresh/">Fresh</a>'s implementation adds immutable nodes (for concurrency and cheap snapshots) and lazy loading (for large files). (<a href="https://github.com/sinelaw/fresh">GitHub</a>)</p>
<h2 id="the-core-idea">The Core Idea</h2>
<p>Instead of storing text in the tree, store <strong>pointers</strong> to text that lives elsewhere.</p>
<h3 id="rope-helix-zed">Rope (<a href="https://github.com/helix-editor/helix/blob/master/docs/architecture.md">Helix</a>, <a href="https://zed.dev/blog/zed-decoded-rope-sumtree">Zed</a>)</h3>
<p>Text lives inside tree nodes:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 360.703125 160" style="max-width: 360.703px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_L_0" d="M132.395,55L123.918,59.167C115.44,63.333,98.486,71.667,90.009,79.333C81.531,87,81.531,94,81.531,97.5L81.531,101"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_R_0" d="M228.019,55L236.496,59.167C244.974,63.333,261.928,71.667,270.406,79.333C278.883,87,278.883,94,278.883,97.5L278.883,101"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(180.20703125, 31.5)" id="flowchart-Root-0" class="node default"><rect height="47" width="156.171875" y="-23.5" x="-78.0859375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> Node</tspan></tspan></text></g></g></g><g transform="translate(81.53125, 128.5)" id="flowchart-L-2" class="node default"><rect height="47" width="147.0625" y="-23.5" x="-73.53125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Leaf:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> '</tspan></tspan></text></g></g></g><g transform="translate(278.8828125, 128.5)" id="flowchart-R-4" class="node default"><rect height="47" width="147.640625" y="-23.5" x="-73.8203125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Leaf:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'World'</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<h3 id="piece-tree-fresh">Piece Tree (Fresh)</h3>
<p>Tree nodes point to separate buffers:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 644.46875 374.6000061035156" style="max-width: 644.469px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="97" width="475.8203125" y="269.5999984741211" x="79.32421875" style=""/><g transform="translate(292.03125, 269.5999984741211)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="211.5999984741211" width="628.46875" y="8" x="8" style=""/><g transform="translate(306.03125, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_L_0" d="M248.528,80L235.46,84.167C222.391,88.333,196.254,96.667,183.186,104.333C170.117,112,170.117,119,170.117,122.5L170.117,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_R_0" d="M395.941,80L409.009,84.167C422.078,88.333,448.215,96.667,461.283,104.333C474.352,112,474.352,119,474.352,122.5L474.352,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_L_B0_0" d="M170.117,194.6L170.117,198.767C170.117,202.933,170.117,211.267,170.117,219.6C170.117,227.933,170.117,236.267,170.117,244.6C170.117,252.933,170.117,261.267,182.551,269.397C194.984,277.528,219.85,285.457,232.284,289.421L244.717,293.385"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_R_B0_0" d="M474.352,194.6L474.352,198.767C474.352,202.933,474.352,211.267,474.352,219.6C474.352,227.933,474.352,236.267,474.352,244.6C474.352,252.933,474.352,261.267,461.918,269.397C449.485,277.528,424.618,285.457,412.185,289.421L399.752,293.385"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(322.234375, 56.5)" id="flowchart-Root-0" class="node default"><rect height="47" width="156.171875" y="-23.5" x="-78.0859375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> Node</tspan></tspan></text></g></g></g><g transform="translate(170.1171875, 162.29999923706055)" id="flowchart-L-2" class="node default"><rect height="64.5999984741211" width="254.234375" y="-32.29999923706055" x="-127.1171875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> offset</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> len</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">6</tspan></tspan></text></g></g></g><g transform="translate(474.3515625, 162.29999923706055)" id="flowchart-R-4" class="node default"><rect height="64.5999984741211" width="254.234375" y="-32.29999923706055" x="-127.1171875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> offset</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 6,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> len</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">5</tspan></tspan></text></g></g></g><g transform="translate(322.234375, 318.0999984741211)" id="flowchart-B0-5" class="node default"><rect height="47" width="213.171875" y="-23.5" x="-106.5859375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> World'</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>A <strong>piece</strong> is just three numbers: which buffer, starting offset, and length.</p>
<h2 id="what-happens-when-you-edit">What Happens When You Edit</h2>
<p>When you type or paste, Fresh appends to a new buffer and creates a piece pointing to it. The original buffer stays untouched.</p>
<h3 id="before-file-contains-hello-world">Before: File contains "Hello World"</h3>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 581.2890625 150.59999084472656" style="max-width: 581.289px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="134.5999984741211" width="280.953125" y="8" x="292.3359375" style=""/><g transform="translate(407.609375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="117" width="234.3359375" y="16.799999237060547" x="8" style=""/><g transform="translate(108.96484375, 16.799999237060547)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M217.336,75.3L221.503,75.3C225.669,75.3,234.003,75.3,242.336,75.3C250.669,75.3,259.003,75.3,267.336,75.3C275.669,75.3,284.003,75.3,291.669,75.3C299.336,75.3,306.336,75.3,309.836,75.3L313.336,75.3"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(125.16796875, 75.29999923706055)" id="flowchart-P1-0" class="node default"><rect height="47" width="184.3359375" y="-23.5" x="-92.16796875" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-11</tspan></tspan></text></g></g></g><g transform="translate(432.8125, 75.29999923706055)" id="flowchart-B0-1" class="node default"><rect height="64.5999984741211" width="230.953125" y="-32.29999923706055" x="-115.4765625" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (original):</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">World'</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<h3 id="after-insert-big--at-position-6">After: Insert "Big " at position 6</h3>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 581.2890625 331.3999938964844" style="max-width: 581.289px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="310.54999923706055" width="280.953125" y="12.850000381469727" x="292.3359375" style=""/><g transform="translate(407.609375, 12.850000381469727)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="315.3999996185303" width="234.3359375" y="8" x="8" style=""/><g transform="translate(108.96484375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M213.48,66.5L218.29,66.5C223.099,66.5,232.717,66.5,241.693,66.5C250.669,66.5,259.003,66.5,267.336,66.5C275.669,66.5,284.003,66.5,295.359,68.982C306.716,71.465,321.097,76.43,328.287,78.912L335.477,81.395"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P2_B1_0" d="M213.48,264.9L218.29,264.9C223.099,264.9,232.717,264.9,241.693,264.9C250.669,264.9,259.003,264.9,267.336,264.9C275.669,264.9,284.003,264.9,292.755,264.9C301.508,264.9,310.68,264.9,315.266,264.9L319.852,264.9"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P3_B0_0" d="M217.336,163.5L221.503,163.5C225.669,163.5,234.003,163.5,242.336,163.5C250.669,163.5,259.003,163.5,267.336,163.5C275.669,163.5,284.003,163.5,295.359,161.018C306.716,158.535,321.097,153.57,328.287,151.088L335.477,148.605"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(125.16796875, 66.5)" id="flowchart-P1-0" class="node default"><rect height="47" width="176.625" y="-23.5" x="-88.3125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-6</tspan></tspan></text></g></g></g><g transform="translate(125.16796875, 264.8999996185303)" id="flowchart-P2-1" class="node default"><rect height="47" width="176.625" y="-23.5" x="-88.3125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-4</tspan></tspan></text></g></g></g><g transform="translate(125.16796875, 163.5)" id="flowchart-P3-2" class="node default"><rect height="47" width="184.3359375" y="-23.5" x="-92.16796875" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 6-11</tspan></tspan></text></g></g></g><g transform="translate(432.8125, 115)" id="flowchart-B0-3" class="node default"><rect height="64.5999984741211" width="230.953125" y="-32.29999923706055" x="-115.4765625" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (original):</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">World'</tspan></tspan></text></g></g></g><g transform="translate(432.8125, 264.8999996185303)" id="flowchart-B1-4" class="node default"><rect height="47" width="217.921875" y="-23.5" x="-108.9609375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (added):</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Big</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> '</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>Document now reads: "Hello Big World"</p>
<p>The original file content in Buffer 0 was never modified or copied.</p>
<h2 id="lazy-loading">Lazy Loading</h2>
<p>For large files, Fresh doesn't load the entire file into memory. Buffers can be <strong>unloaded</strong> - they store a file path and byte range instead of actual data.</p>
<p>This is actually how the original <a href="https://computerhistory.org/blog/microsoft-word-for-windows-1-1a-source-code/">Word 1.1a</a> piece table worked: pieces pointed directly to spans in the original file on disk, loading content only when needed. VS Code's 2018 implementation loads files fully into memory; Fresh returns to the original memory-conscious design.</p>
<h3 id="before-3mb-file-just-opened">Before: 3MB file just opened</h3>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 920.953125 277.6000061035156" style="max-width: 920.953px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="114.5999984741211" width="904.953125" y="155" x="8" style=""/><g transform="translate(435.2734375, 155)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="97" width="860.5" y="8" x="30.2265625" style=""/><g transform="translate(444.2734375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M165.492,80L165.492,84.167C165.492,88.333,165.492,96.667,165.492,105C165.492,113.333,165.492,121.667,165.492,130C165.492,138.333,165.492,146.667,165.492,154.333C165.492,162,165.492,169,165.492,172.5L165.492,176"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P2_B1_0" d="M460.477,80L460.477,84.167C460.477,88.333,460.477,96.667,460.477,105C460.477,113.333,460.477,121.667,460.477,130C460.477,138.333,460.477,146.667,460.477,154.333C460.477,162,460.477,169,460.477,172.5L460.477,176"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P3_B2_0" d="M755.461,80L755.461,84.167C755.461,88.333,755.461,96.667,755.461,105C755.461,113.333,755.461,121.667,755.461,130C755.461,138.333,755.461,146.667,755.461,154.333C755.461,162,755.461,169,755.461,172.5L755.461,176"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(165.4921875, 56.5)" id="flowchart-P1-0" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(460.4765625, 56.5)" id="flowchart-P2-1" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(755.4609375, 56.5)" id="flowchart-P3-2" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(165.4921875, 212.29999923706055)" id="flowchart-B0-3" class="node default"><rect height="64.5999984741211" width="244.984375" y="-32.29999923706055" x="-122.4921875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">file:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> large.txt,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(460.4765625, 212.29999923706055)" id="flowchart-B1-4" class="node default"><rect height="64.5999984741211" width="244.984375" y="-32.29999923706055" x="-122.4921875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">file:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> large.txt,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1-2MB</tspan></tspan></text></g></g></g><g transform="translate(755.4609375, 212.29999923706055)" id="flowchart-B2-5" class="node default"><rect height="64.5999984741211" width="244.984375" y="-32.29999923706055" x="-122.4921875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">file:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> large.txt,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2-3MB</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<h3 id="after-user-scrolls-to-middle">After: User scrolls to middle</h3>
<p>Fresh loads only the visible chunk from disk:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 900.5 277.6000061035156" style="max-width: 900.5px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="114.5999984741211" width="884.5" y="155" x="8" style=""/><g transform="translate(425.046875, 155)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="97" width="840.046875" y="8" x="30.2265625" style=""/><g transform="translate(434.046875, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M165.492,80L165.492,84.167C165.492,88.333,165.492,96.667,165.492,105C165.492,113.333,165.492,121.667,165.492,130C165.492,138.333,165.492,146.667,165.492,154.333C165.492,162,165.492,169,165.492,172.5L165.492,176"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P2_B1_0" d="M450.25,80L450.25,84.167C450.25,88.333,450.25,96.667,450.25,105C450.25,113.333,450.25,121.667,450.25,130C450.25,138.333,450.25,146.667,450.25,154.333C450.25,162,450.25,169,450.25,172.5L450.25,176"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P3_B2_0" d="M735.008,80L735.008,84.167C735.008,88.333,735.008,96.667,735.008,105C735.008,113.333,735.008,121.667,735.008,130C735.008,138.333,735.008,146.667,735.008,154.333C735.008,162,735.008,169,735.008,172.5L735.008,176"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(165.4921875, 56.5)" id="flowchart-P1-0" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(450.25, 56.5)" id="flowchart-P2-1" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(735.0078125, 56.5)" id="flowchart-P3-2" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(165.4921875, 212.29999923706055)" id="flowchart-B0-3" class="node default"><rect height="64.5999984741211" width="244.984375" y="-32.29999923706055" x="-122.4921875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">file:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> large.txt,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(450.25, 212.29999923706055)" id="flowchart-B1-4" class="node default"><rect height="64.5999984741211" width="224.53125" y="-32.29999923706055" x="-112.265625" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> LOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">actual</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> in</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> memory</tspan></tspan></text></g></g></g><g transform="translate(735.0078125, 212.29999923706055)" id="flowchart-B2-5" class="node default"><rect height="64.5999984741211" width="244.984375" y="-32.29999923706055" x="-122.4921875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">file:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> large.txt,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2-3MB</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<h2 id="zero-copy-reads">Zero-Copy Reads</h2>
<p>When reading text for display, Fresh doesn't copy bytes. It returns slices pointing directly into the buffers:</p>
<pre class="rust"><code>// Returns &amp;[u8] pointing into buffer memory
// No allocation, no copy
let text = buffer.get_text_range(100, 200);</code></pre>
<p>Multiple pieces can reference the same buffer region. Displaying the same text twice doesn't double memory usage.</p>
<h2 id="the-tree-structure">The Tree Structure</h2>
<p>The pieces are organized in a balanced binary tree for fast lookups:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 507.453125 294.20001220703125" style="max-width: 507.453px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_I2_0" d="M248.328,73.6L240.675,77.767C233.021,81.933,217.714,90.267,210.06,97.933C202.406,105.6,202.406,112.6,202.406,116.1L202.406,119.6"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_L3_0" d="M368.828,73.6L376.482,77.767C384.135,81.933,399.443,90.267,407.096,99.483C414.75,108.7,414.75,118.8,414.75,123.85L414.75,128.9"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L1_0" d="M140.153,189.2L132.244,193.367C124.336,197.533,108.52,205.867,100.611,213.533C92.703,221.2,92.703,228.2,92.703,231.7L92.703,235.2"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L2_0" d="M264.66,189.2L272.568,193.367C280.476,197.533,296.293,205.867,304.201,213.533C312.109,221.2,312.109,228.2,312.109,231.7L312.109,235.2"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(308.578125, 40.79999923706055)" id="flowchart-I1-0" class="node default"><rect height="65.5999984741211" width="164.1796875" y="-32.79999923706055" x="-82.08984375" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 100</tspan></tspan></text></g></g></g><g transform="translate(202.40625, 156.39999771118164)" id="flowchart-I2-2" class="node default"><rect height="65.5999984741211" width="155.28125" y="-32.79999923706055" x="-77.640625" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan></tspan></text></g></g></g><g transform="translate(414.75, 156.39999771118164)" id="flowchart-L3-4" class="node default"><rect height="47" width="169.40625" y="-23.5" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan></text></g></g></g><g transform="translate(92.703125, 262.6999969482422)" id="flowchart-L1-6" class="node default"><rect height="47" width="169.40625" y="-23.5" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan></text></g></g></g><g transform="translate(312.109375, 262.6999969482422)" id="flowchart-L2-8" class="node default"><rect height="47" width="169.40625" y="-23.5" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>Each internal node caches the total bytes in its left subtree. To find byte offset 75:</p>
<ol type="1">
<li>Root has <code>left_bytes: 100</code>, and 75 &lt; 100, so go left</li>
<li>Internal has <code>left_bytes: 50</code>, and 75 &gt;= 50, so go right with offset 75-50=25</li>
<li>Piece has 50 bytes, offset 25 is within it</li>
</ol>
<p>This is O(log P) where P is the number of pieces.</p>
<h2 id="line-feed-tracking">Line Feed Tracking</h2>
<p>Text editors need fast line-based operations: "go to line 1000", "what line is byte offset 50000 on?", or simply displaying line numbers. Scanning the entire document for newlines would be O(N) - too slow for large files.</p>
<p>Fresh tracks line feeds the same way it tracks bytes. Each piece stores its newline count, and internal nodes cache the count for their left subtree:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 507.453125 348" style="max-width: 507.453px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_I2_0" d="M242.261,91.2L235.618,95.367C228.976,99.533,215.691,107.867,209.049,115.533C202.406,123.2,202.406,130.2,202.406,133.7L202.406,137.2"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_L3_0" d="M374.896,91.2L381.538,95.367C388.18,99.533,401.465,107.867,408.108,117C414.75,126.133,414.75,136.067,414.75,141.033L414.75,146"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L1_0" d="M133.883,224.4L127.02,228.567C120.156,232.733,106.43,241.067,99.566,248.733C92.703,256.4,92.703,263.4,92.703,266.9L92.703,270.4"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L2_0" d="M270.93,224.4L277.793,228.567C284.656,232.733,298.383,241.067,305.246,248.733C312.109,256.4,312.109,263.4,312.109,266.9L312.109,270.4"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(308.578125, 49.599998474121094)" id="flowchart-I1-0" class="node default"><rect height="83.19999694824219" width="164.1796875" y="-41.599998474121094" x="-82.08984375" style="" class="basic label-container"/><g transform="translate(0, -26.599998474121094)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 100</tspan></tspan><tspan dy="1.1em" y="2.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">lf_left:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 3</tspan></tspan></text></g></g></g><g transform="translate(202.40625, 182.79999542236328)" id="flowchart-I2-2" class="node default"><rect height="83.19999694824219" width="155.28125" y="-41.599998474121094" x="-77.640625" style="" class="basic label-container"/><g transform="translate(0, -26.599998474121094)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan></tspan><tspan dy="1.1em" y="2.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">lf_left:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2</tspan></tspan></text></g></g></g><g transform="translate(414.75, 182.79999542236328)" id="flowchart-L3-4" class="node default"><rect height="65.5999984741211" width="169.40625" y="-32.79999923706055" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">line_feeds:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1</tspan></tspan></text></g></g></g><g transform="translate(92.703125, 307.1999931335449)" id="flowchart-L1-6" class="node default"><rect height="65.5999984741211" width="169.40625" y="-32.79999923706055" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 30</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">line_feeds:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2</tspan></tspan></text></g></g></g><g transform="translate(312.109375, 307.1999931335449)" id="flowchart-L2-8" class="node default"><rect height="65.5999984741211" width="169.40625" y="-32.79999923706055" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 20</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">line_feeds:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>To find which piece contains line 3:</p>
<ol type="1">
<li>Root has <code>lf_left: 3</code>, and 3 &gt;= 3, so go right with line 3-3=0</li>
<li>Piece L3 has <code>line_feeds: 1</code>, line 0 is within it</li>
</ol>
<p>This enables O(log P) line-to-offset conversion. The same structure supports offset-to-line lookup by accumulating line counts while traversing.</p>
<h2 id="large-file-mode">Large File Mode</h2>
<p>For files over 100MB, Fresh switches to <strong>large file mode</strong>: no line indexing, pure byte-based navigation.</p>
<p>Why skip line indexing? Counting newlines in a 500MB file means reading the entire file - exactly what lazy loading tries to avoid. Instead, Fresh:</p>
<ul>
<li><strong>Navigates by bytes</strong>: The viewport tracks a byte offset, not a line number. Scrolling moves by byte ranges.</li>
<li><strong>Estimates line counts</strong>: For the scrollbar and status bar, Fresh estimates total lines as <code>file_size / average_line_length</code>.</li>
<li><strong>Shows approximate line numbers</strong>: Visible lines display estimated line numbers based on bytes seen so far.</li>
</ul>
<p>This means "go to line 50000" in a huge file is an approximation, but opening and scrolling remains instant regardless of file size.</p>
<h2 id="immutable-tree-structure">Immutable Tree Structure</h2>
<p>Fresh uses immutable nodes - once created, a node is never modified. Edits create new nodes instead.</p>
<blockquote>
<p><strong>Implementation note:</strong> Fresh is written in Rust. Nodes are wrapped in <code>Arc&lt;T&gt;</code> (Atomic Reference Counted pointer) - think of it as a pointer that tracks how many things reference it. Multiple parts of the code (even different threads) can safely hold the same <code>Arc</code>, and the data is automatically freed when the last reference is dropped. We'll gloss over this detail going forward - just know that "sharing" a node is cheap and thread-safe.</p>
</blockquote>
<p>After an edit, old tree versions remain valid:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 550.396484375 210" style="max-width: 550.396px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="subGraph1" class="cluster"><rect height="194" width="197.9140625" y="8" x="8" style=""/><g transform="translate(34.91015625, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Version</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (after</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> edit)</tspan></tspan></text></g></g></g><g data-look="classic" id="subGraph0" class="cluster"><rect height="194" width="316.482421875" y="8" x="225.9140625" style=""/><g transform="translate(305.4365234375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Version</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (before</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> edit)</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V1_Root_V1_L_0" d="M348.281,80L342.157,84.167C336.032,88.333,323.784,96.667,317.659,104.333C311.535,112,311.535,119,311.535,122.5L311.535,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V1_Root_V1_R_0" d="M417.363,80L423.488,84.167C429.612,88.333,441.861,96.667,447.985,104.333C454.109,112,454.109,119,454.109,122.5L454.109,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V2_Root_V1_L_0" d="M130.428,80L133.624,84.167C136.82,88.333,143.212,96.667,165.487,106.548C187.763,116.429,225.923,127.858,245.002,133.573L264.082,139.287"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V2_Root_V2_R_0" d="M107.557,80L106.698,84.167C105.839,88.333,104.121,96.667,103.261,104.333C102.402,112,102.402,119,102.402,122.5L102.402,126"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(382.822265625, 56.5)" id="flowchart-V1_Root-0" class="node default"><rect height="47" width="115.2421875" y="-23.5" x="-57.62109375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Root</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> v1</tspan></tspan></text></g></g></g><g transform="translate(311.53515625, 153.5)" id="flowchart-V1_L-1" class="node default"><rect height="47" width="87.2421875" y="-23.5" x="-43.62109375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Left</tspan></tspan></text></g></g></g><g transform="translate(454.109375, 153.5)" id="flowchart-V1_R-3" class="node default"><rect height="47" width="97.90625" y="-23.5" x="-48.953125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Right</tspan></tspan></text></g></g></g><g transform="translate(112.40234375, 56.5)" id="flowchart-V2_Root-4" class="node default"><rect height="47" width="115.2421875" y="-23.5" x="-57.62109375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Root</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> v2</tspan></tspan></text></g></g></g><g transform="translate(102.40234375, 153.5)" id="flowchart-V2_R-7" class="node default"><rect height="47" width="118.8046875" y="-23.5" x="-59.40234375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Right</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> v2</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>Version 2 shares the unchanged left subtree with Version 1. This enables:</p>
<ul>
<li>Undo/redo by keeping old root references</li>
<li>Concurrent reads without locks</li>
<li>Cheap snapshots</li>
</ul>
<h2 id="fresh-vs-vs-code">Fresh vs VS Code</h2>
<p><a href="https://github.com/microsoft/vscode-textbuffer">VS Code also uses a piece tree</a>. The core data structure is nearly identical - both cache byte counts and line counts per node for O(log N) lookups. The key difference is in tree mutability.</p>
<p><strong>VS Code</strong>: Mutable tree. Pieces themselves are immutable, but tree nodes are modified in place during rebalancing. After an edit, VS Code propagates size and line-count changes up to the root. Undo/redo requires a separate operation log.</p>
<p><strong>Fresh</strong>: Fully immutable tree. Edits produce new tree versions via path-copying - only nodes along the modified path are recreated, while unchanged subtrees are shared between versions. (This is a <a href="https://en.wikipedia.org/wiki/Persistent_data_structure">persistent data structure</a>.)</p>
<h3 id="inherent-trade-offs">Inherent Trade-offs</h3>
<p><strong>Immutable (Fresh):</strong></p>
<ul>
<li>Old tree versions stay valid - enables cheap snapshots and structural sharing</li>
<li>Concurrent reads need no synchronization</li>
<li>Undo can be "keep the old root" instead of "replay operations backward"</li>
<li>More allocations per edit (new nodes along modified path)</li>
</ul>
<p><strong>Mutable (VS Code):</strong></p>
<ul>
<li>Edits modify in place - less allocation overhead</li>
<li>Has a search cache to accelerate repeated position lookups</li>
<li>Requires separate undo infrastructure</li>
<li>Concurrent access needs synchronization</li>
</ul>
<p><strong>Lazy loading</strong> is orthogonal to mutability, but Fresh implements it and VS Code doesn't. Fresh can leave file regions on disk until accessed; VS Code loads the entire file into memory.</p>
<h2 id="comparison-piece-tree-vs-rope">Comparison: Piece Tree vs Rope</h2>
<p>Different editors use different text storage structures:</p>
<ul>
<li><strong>Piece tree</strong>: VS Code, Fresh</li>
<li><strong>Rope</strong>: Helix (uses <a href="https://github.com/cessen/ropey">Ropey</a>), Zed (custom <a href="https://zed.dev/blog/zed-decoded-rope-sumtree">SumTree</a>)</li>
<li><strong>Gap buffer</strong>: Emacs</li>
<li><strong>Line array</strong>: Vim, Neovim</li>
</ul>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Piece Tree (Fresh, VS Code)</th>
<th>Rope (Helix, Zed)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Node contents</td>
<td>Pointer to buffer</td>
<td>Actual text (~1KB chunks)</td>
</tr>
<tr>
<td>Insert</td>
<td>Append to buffer, add piece</td>
<td>May copy/split chunk</td>
</tr>
<tr>
<td>Original file</td>
<td>Preserved in buffer 0</td>
<td>Reorganized into chunks</td>
</tr>
<tr>
<td>Large files</td>
<td>Lazy load regions (Fresh, Word 1.1a)</td>
<td>Must load or stream</td>
</tr>
<tr>
<td>Memory for edits</td>
<td>Minimal (just pointers)</td>
<td>Copies chunk data</td>
</tr>
</tbody>
</table>
<h2 id="trade-offs">Trade-offs</h2>
<p><strong>Advantages:</strong></p>
<ul>
<li>Original file content preserved (useful for diffs, minimal saves)</li>
<li>Inserts never copy existing text</li>
<li>Natural lazy loading for large files</li>
<li>Pieces are small (~24 bytes) - more fit in CPU cache during tree traversal</li>
</ul>
<p><strong>Disadvantages:</strong></p>
<ul>
<li>Extra indirection: find piece, then fetch from buffer</li>
<li>Buffer fragmentation over many edits (many small buffers)</li>
<li>Cache locality for text is poor (data scattered across buffers)</li>
<li>No automatic chunk coalescing (piece count grows with edits)</li>
</ul>
<p><em>(Note: Fresh's current implementation doesn't fully exploit immutability - it rebuilds the entire tree on each edit rather than path-copying, making edits O(P) instead of O(log P). VS Code has additional optimizations like search caching and line content caching that Fresh lacks. These are implementation gaps, not inherent to the designs.)</em></p>
<h2 id="further-reading">Further Reading</h2>
<ul>
<li><a href="https://sinelaw.github.io/fresh/">Fresh</a> - The editor discussed in this post (<a href="https://github.com/sinelaw/fresh">source on GitHub</a>)</li>
<li><a href="https://computerhistory.org/blog/microsoft-word-for-windows-1-1a-source-code/">Microsoft Word 1.1a Source Code</a> - Original piece table implementation from 1990</li>
<li><a href="https://code.visualstudio.com/blogs/2018/03/23/text-buffer-reimplementation">VS Code's Piece Table</a> - Microsoft's 2018 write-up on reviving piece tables</li>
<li><a href="https://zed.dev/blog/zed-decoded-rope-sumtree">Zed's Rope &amp; SumTree</a> - How Zed implements ropes with B+ trees</li>
<li><a href="https://coredumped.dev/2023/08/09/text-showdown-gap-buffers-vs-ropes/">Text Showdown: Gap Buffers vs Ropes</a> - Performance comparison</li>
<li><a href="https://www.cs.unm.edu/~crowley/papers/sds.pdf">Data Structures for Text Sequences</a> - Charles Crowley, 1998 (academic survey)</li>
</ul>
]]></content><author><name></name></author></entry><entry><title type="html">How Fresh Loads Huge Files Fast</title><link href="/blog/2025/12/08/how-fresh-loads-huge-files-fast.html" rel="alternate" type="text/html" title="How Fresh Loads Huge Files Fast" /><published>2025-12-08T23:20:01+00:00</published><updated>2025-12-08T23:20:01+00:00</updated><id>/blog/2025/12/08/how-fresh-loads-huge-files-fast.html</id><content type="html" xml:base="/blog/2025/12/08/how-fresh-loads-huge-files-fast.html"><![CDATA[<h1 id="how-fresh-loads-huge-files-fast">How Fresh Loads Huge Files Fast</h1>
<p>Fresh uses a <strong>piece tree</strong> (also called a piece table) for text storage. The piece table originated in the early 1970s - first in <a href="https://www.computerhistory.org/collections/catalog/102740449">J. Strother Moore and Bob Boyer's "77-Editor" at Edinburgh</a> (1971-1973), where they applied structure-sharing techniques from their theorem proving research to text editing. Moore later brought the idea to Xerox PARC, where Charles Simonyi adopted it for the <a href="https://en.wikipedia.org/wiki/Bravo_(editor)">Bravo editor</a> (1974). Simonyi later <a href="https://www.tiny.cloud/blog/wysiwyg-development-history/">brought it to Microsoft Word</a> (1983). The design minimizes memory copying by never modifying original file content - critical for early systems with limited RAM. <a href="https://code.visualstudio.com/blogs/2018/03/23/text-buffer-reimplementation">VS Code adopted piece tables in 2018</a>, replacing their previous line-array implementation.</p>
<p><a href="https://sinelaw.github.io/fresh/">Fresh</a>'s implementation adds immutable nodes (for concurrency and cheap snapshots) and lazy loading (for large files). (<a href="https://github.com/sinelaw/fresh">GitHub</a>)</p>
<h2 id="the-core-idea">The Core Idea</h2>
<p>Instead of storing text in the tree, store <strong>pointers</strong> to text that lives elsewhere.</p>
<h3 id="rope-helix-zed">Rope (<a href="https://github.com/helix-editor/helix/blob/master/docs/architecture.md">Helix</a>, <a href="https://zed.dev/blog/zed-decoded-rope-sumtree">Zed</a>)</h3>
<p>Text lives inside tree nodes:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 360.703125 160" style="max-width: 360.703px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_L_0" d="M132.395,55L123.918,59.167C115.44,63.333,98.486,71.667,90.009,79.333C81.531,87,81.531,94,81.531,97.5L81.531,101"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_R_0" d="M228.019,55L236.496,59.167C244.974,63.333,261.928,71.667,270.406,79.333C278.883,87,278.883,94,278.883,97.5L278.883,101"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(180.20703125, 31.5)" id="flowchart-Root-0" class="node default"><rect height="47" width="156.171875" y="-23.5" x="-78.0859375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> Node</tspan></tspan></text></g></g></g><g transform="translate(81.53125, 128.5)" id="flowchart-L-2" class="node default"><rect height="47" width="147.0625" y="-23.5" x="-73.53125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Leaf:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> '</tspan></tspan></text></g></g></g><g transform="translate(278.8828125, 128.5)" id="flowchart-R-4" class="node default"><rect height="47" width="147.640625" y="-23.5" x="-73.8203125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Leaf:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'World'</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<h3 id="piece-tree-fresh">Piece Tree (Fresh)</h3>
<p>Tree nodes point to separate buffers:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 644.46875 374.6000061035156" style="max-width: 644.469px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="97" width="475.8203125" y="269.5999984741211" x="79.32421875" style=""/><g transform="translate(292.03125, 269.5999984741211)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="211.5999984741211" width="628.46875" y="8" x="8" style=""/><g transform="translate(306.03125, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_L_0" d="M248.528,80L235.46,84.167C222.391,88.333,196.254,96.667,183.186,104.333C170.117,112,170.117,119,170.117,122.5L170.117,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_R_0" d="M395.941,80L409.009,84.167C422.078,88.333,448.215,96.667,461.283,104.333C474.352,112,474.352,119,474.352,122.5L474.352,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_L_B0_0" d="M170.117,194.6L170.117,198.767C170.117,202.933,170.117,211.267,170.117,219.6C170.117,227.933,170.117,236.267,170.117,244.6C170.117,252.933,170.117,261.267,182.551,269.397C194.984,277.528,219.85,285.457,232.284,289.421L244.717,293.385"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_R_B0_0" d="M474.352,194.6L474.352,198.767C474.352,202.933,474.352,211.267,474.352,219.6C474.352,227.933,474.352,236.267,474.352,244.6C474.352,252.933,474.352,261.267,461.918,269.397C449.485,277.528,424.618,285.457,412.185,289.421L399.752,293.385"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(322.234375, 56.5)" id="flowchart-Root-0" class="node default"><rect height="47" width="156.171875" y="-23.5" x="-78.0859375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> Node</tspan></tspan></text></g></g></g><g transform="translate(170.1171875, 162.29999923706055)" id="flowchart-L-2" class="node default"><rect height="64.5999984741211" width="254.234375" y="-32.29999923706055" x="-127.1171875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> offset</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> len</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">6</tspan></tspan></text></g></g></g><g transform="translate(474.3515625, 162.29999923706055)" id="flowchart-R-4" class="node default"><rect height="64.5999984741211" width="254.234375" y="-32.29999923706055" x="-127.1171875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> offset</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 6,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> len</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">5</tspan></tspan></text></g></g></g><g transform="translate(322.234375, 318.0999984741211)" id="flowchart-B0-5" class="node default"><rect height="47" width="213.171875" y="-23.5" x="-106.5859375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> World'</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>A <strong>piece</strong> is just three numbers: which buffer, starting offset, and length.</p>
<h2 id="what-happens-when-you-edit">What Happens When You Edit</h2>
<p>When you type or paste, Fresh appends to a new buffer and creates a piece pointing to it. The original buffer stays untouched.</p>
<h3 id="before-file-contains-hello-world">Before: File contains "Hello World"</h3>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 581.2890625 150.59999084472656" style="max-width: 581.289px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="134.5999984741211" width="280.953125" y="8" x="292.3359375" style=""/><g transform="translate(407.609375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="117" width="234.3359375" y="16.799999237060547" x="8" style=""/><g transform="translate(108.96484375, 16.799999237060547)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M217.336,75.3L221.503,75.3C225.669,75.3,234.003,75.3,242.336,75.3C250.669,75.3,259.003,75.3,267.336,75.3C275.669,75.3,284.003,75.3,291.669,75.3C299.336,75.3,306.336,75.3,309.836,75.3L313.336,75.3"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(125.16796875, 75.29999923706055)" id="flowchart-P1-0" class="node default"><rect height="47" width="184.3359375" y="-23.5" x="-92.16796875" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-11</tspan></tspan></text></g></g></g><g transform="translate(432.8125, 75.29999923706055)" id="flowchart-B0-1" class="node default"><rect height="64.5999984741211" width="230.953125" y="-32.29999923706055" x="-115.4765625" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (original):</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">World'</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<h3 id="after-insert-big--at-position-6">After: Insert "Big " at position 6</h3>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 581.2890625 331.3999938964844" style="max-width: 581.289px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="310.54999923706055" width="280.953125" y="12.850000381469727" x="292.3359375" style=""/><g transform="translate(407.609375, 12.850000381469727)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="315.3999996185303" width="234.3359375" y="8" x="8" style=""/><g transform="translate(108.96484375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M213.48,66.5L218.29,66.5C223.099,66.5,232.717,66.5,241.693,66.5C250.669,66.5,259.003,66.5,267.336,66.5C275.669,66.5,284.003,66.5,295.359,68.982C306.716,71.465,321.097,76.43,328.287,78.912L335.477,81.395"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P2_B1_0" d="M213.48,264.9L218.29,264.9C223.099,264.9,232.717,264.9,241.693,264.9C250.669,264.9,259.003,264.9,267.336,264.9C275.669,264.9,284.003,264.9,292.755,264.9C301.508,264.9,310.68,264.9,315.266,264.9L319.852,264.9"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P3_B0_0" d="M217.336,163.5L221.503,163.5C225.669,163.5,234.003,163.5,242.336,163.5C250.669,163.5,259.003,163.5,267.336,163.5C275.669,163.5,284.003,163.5,295.359,161.018C306.716,158.535,321.097,153.57,328.287,151.088L335.477,148.605"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(125.16796875, 66.5)" id="flowchart-P1-0" class="node default"><rect height="47" width="176.625" y="-23.5" x="-88.3125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-6</tspan></tspan></text></g></g></g><g transform="translate(125.16796875, 264.8999996185303)" id="flowchart-P2-1" class="node default"><rect height="47" width="176.625" y="-23.5" x="-88.3125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-4</tspan></tspan></text></g></g></g><g transform="translate(125.16796875, 163.5)" id="flowchart-P3-2" class="node default"><rect height="47" width="184.3359375" y="-23.5" x="-92.16796875" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 6-11</tspan></tspan></text></g></g></g><g transform="translate(432.8125, 115)" id="flowchart-B0-3" class="node default"><rect height="64.5999984741211" width="230.953125" y="-32.29999923706055" x="-115.4765625" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (original):</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">World'</tspan></tspan></text></g></g></g><g transform="translate(432.8125, 264.8999996185303)" id="flowchart-B1-4" class="node default"><rect height="47" width="217.921875" y="-23.5" x="-108.9609375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (added):</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Big</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> '</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>Document now reads: "Hello Big World"</p>
<p>The original file content in Buffer 0 was never modified or copied.</p>
<h2 id="lazy-loading">Lazy Loading</h2>
<p>For large files, Fresh doesn't load the entire file into memory. Buffers can be <strong>unloaded</strong> - they store a file path and byte range instead of actual data.</p>
<p>This is actually how the original <a href="https://computerhistory.org/blog/microsoft-word-for-windows-1-1a-source-code/">Word 1.1a</a> piece table worked: pieces pointed directly to spans in the original file on disk, loading content only when needed. VS Code's 2018 implementation loads files fully into memory; Fresh returns to the original memory-conscious design.</p>
<h3 id="before-3mb-file-just-opened">Before: 3MB file just opened</h3>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 920.953125 277.6000061035156" style="max-width: 920.953px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="114.5999984741211" width="904.953125" y="155" x="8" style=""/><g transform="translate(435.2734375, 155)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="97" width="860.5" y="8" x="30.2265625" style=""/><g transform="translate(444.2734375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M165.492,80L165.492,84.167C165.492,88.333,165.492,96.667,165.492,105C165.492,113.333,165.492,121.667,165.492,130C165.492,138.333,165.492,146.667,165.492,154.333C165.492,162,165.492,169,165.492,172.5L165.492,176"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P2_B1_0" d="M460.477,80L460.477,84.167C460.477,88.333,460.477,96.667,460.477,105C460.477,113.333,460.477,121.667,460.477,130C460.477,138.333,460.477,146.667,460.477,154.333C460.477,162,460.477,169,460.477,172.5L460.477,176"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P3_B2_0" d="M755.461,80L755.461,84.167C755.461,88.333,755.461,96.667,755.461,105C755.461,113.333,755.461,121.667,755.461,130C755.461,138.333,755.461,146.667,755.461,154.333C755.461,162,755.461,169,755.461,172.5L755.461,176"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(165.4921875, 56.5)" id="flowchart-P1-0" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(460.4765625, 56.5)" id="flowchart-P2-1" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(755.4609375, 56.5)" id="flowchart-P3-2" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(165.4921875, 212.29999923706055)" id="flowchart-B0-3" class="node default"><rect height="64.5999984741211" width="244.984375" y="-32.29999923706055" x="-122.4921875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">file:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> large.txt,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(460.4765625, 212.29999923706055)" id="flowchart-B1-4" class="node default"><rect height="64.5999984741211" width="244.984375" y="-32.29999923706055" x="-122.4921875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">file:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> large.txt,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1-2MB</tspan></tspan></text></g></g></g><g transform="translate(755.4609375, 212.29999923706055)" id="flowchart-B2-5" class="node default"><rect height="64.5999984741211" width="244.984375" y="-32.29999923706055" x="-122.4921875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">file:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> large.txt,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2-3MB</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<h3 id="after-user-scrolls-to-middle">After: User scrolls to middle</h3>
<p>Fresh loads only the visible chunk from disk:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 900.5 277.6000061035156" style="max-width: 900.5px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="114.5999984741211" width="884.5" y="155" x="8" style=""/><g transform="translate(425.046875, 155)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="97" width="840.046875" y="8" x="30.2265625" style=""/><g transform="translate(434.046875, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M165.492,80L165.492,84.167C165.492,88.333,165.492,96.667,165.492,105C165.492,113.333,165.492,121.667,165.492,130C165.492,138.333,165.492,146.667,165.492,154.333C165.492,162,165.492,169,165.492,172.5L165.492,176"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P2_B1_0" d="M450.25,80L450.25,84.167C450.25,88.333,450.25,96.667,450.25,105C450.25,113.333,450.25,121.667,450.25,130C450.25,138.333,450.25,146.667,450.25,154.333C450.25,162,450.25,169,450.25,172.5L450.25,176"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P3_B2_0" d="M735.008,80L735.008,84.167C735.008,88.333,735.008,96.667,735.008,105C735.008,113.333,735.008,121.667,735.008,130C735.008,138.333,735.008,146.667,735.008,154.333C735.008,162,735.008,169,735.008,172.5L735.008,176"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(165.4921875, 56.5)" id="flowchart-P1-0" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(450.25, 56.5)" id="flowchart-P2-1" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(735.0078125, 56.5)" id="flowchart-P3-2" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(165.4921875, 212.29999923706055)" id="flowchart-B0-3" class="node default"><rect height="64.5999984741211" width="244.984375" y="-32.29999923706055" x="-122.4921875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">file:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> large.txt,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(450.25, 212.29999923706055)" id="flowchart-B1-4" class="node default"><rect height="64.5999984741211" width="224.53125" y="-32.29999923706055" x="-112.265625" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> LOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">actual</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> in</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> memory</tspan></tspan></text></g></g></g><g transform="translate(735.0078125, 212.29999923706055)" id="flowchart-B2-5" class="node default"><rect height="64.5999984741211" width="244.984375" y="-32.29999923706055" x="-122.4921875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">file:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> large.txt,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2-3MB</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<h2 id="zero-copy-reads">Zero-Copy Reads</h2>
<p>When reading text for display, Fresh doesn't copy bytes. It returns slices pointing directly into the buffers:</p>
<pre class="rust"><code>// Returns &amp;[u8] pointing into buffer memory
// No allocation, no copy
let text = buffer.get_text_range(100, 200);</code></pre>
<p>Multiple pieces can reference the same buffer region. Displaying the same text twice doesn't double memory usage.</p>
<h2 id="the-tree-structure">The Tree Structure</h2>
<p>The pieces are organized in a balanced binary tree for fast lookups:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 507.453125 294.20001220703125" style="max-width: 507.453px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_I2_0" d="M248.328,73.6L240.675,77.767C233.021,81.933,217.714,90.267,210.06,97.933C202.406,105.6,202.406,112.6,202.406,116.1L202.406,119.6"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_L3_0" d="M368.828,73.6L376.482,77.767C384.135,81.933,399.443,90.267,407.096,99.483C414.75,108.7,414.75,118.8,414.75,123.85L414.75,128.9"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L1_0" d="M140.153,189.2L132.244,193.367C124.336,197.533,108.52,205.867,100.611,213.533C92.703,221.2,92.703,228.2,92.703,231.7L92.703,235.2"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L2_0" d="M264.66,189.2L272.568,193.367C280.476,197.533,296.293,205.867,304.201,213.533C312.109,221.2,312.109,228.2,312.109,231.7L312.109,235.2"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(308.578125, 40.79999923706055)" id="flowchart-I1-0" class="node default"><rect height="65.5999984741211" width="164.1796875" y="-32.79999923706055" x="-82.08984375" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 100</tspan></tspan></text></g></g></g><g transform="translate(202.40625, 156.39999771118164)" id="flowchart-I2-2" class="node default"><rect height="65.5999984741211" width="155.28125" y="-32.79999923706055" x="-77.640625" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan></tspan></text></g></g></g><g transform="translate(414.75, 156.39999771118164)" id="flowchart-L3-4" class="node default"><rect height="47" width="169.40625" y="-23.5" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan></text></g></g></g><g transform="translate(92.703125, 262.6999969482422)" id="flowchart-L1-6" class="node default"><rect height="47" width="169.40625" y="-23.5" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan></text></g></g></g><g transform="translate(312.109375, 262.6999969482422)" id="flowchart-L2-8" class="node default"><rect height="47" width="169.40625" y="-23.5" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>Each internal node caches the total bytes in its left subtree. To find byte offset 75:</p>
<ol type="1">
<li>Root has <code>left_bytes: 100</code>, and 75 &lt; 100, so go left</li>
<li>Internal has <code>left_bytes: 50</code>, and 75 &gt;= 50, so go right with offset 75-50=25</li>
<li>Piece has 50 bytes, offset 25 is within it</li>
</ol>
<p>This is O(log P) where P is the number of pieces.</p>
<h2 id="line-feed-tracking">Line Feed Tracking</h2>
<p>Text editors need fast line-based operations: "go to line 1000", "what line is byte offset 50000 on?", or simply displaying line numbers. Scanning the entire document for newlines would be O(N) - too slow for large files.</p>
<p>Fresh tracks line feeds the same way it tracks bytes. Each piece stores its newline count, and internal nodes cache the count for their left subtree:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 507.453125 348" style="max-width: 507.453px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_I2_0" d="M242.261,91.2L235.618,95.367C228.976,99.533,215.691,107.867,209.049,115.533C202.406,123.2,202.406,130.2,202.406,133.7L202.406,137.2"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_L3_0" d="M374.896,91.2L381.538,95.367C388.18,99.533,401.465,107.867,408.108,117C414.75,126.133,414.75,136.067,414.75,141.033L414.75,146"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L1_0" d="M133.883,224.4L127.02,228.567C120.156,232.733,106.43,241.067,99.566,248.733C92.703,256.4,92.703,263.4,92.703,266.9L92.703,270.4"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L2_0" d="M270.93,224.4L277.793,228.567C284.656,232.733,298.383,241.067,305.246,248.733C312.109,256.4,312.109,263.4,312.109,266.9L312.109,270.4"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(308.578125, 49.599998474121094)" id="flowchart-I1-0" class="node default"><rect height="83.19999694824219" width="164.1796875" y="-41.599998474121094" x="-82.08984375" style="" class="basic label-container"/><g transform="translate(0, -26.599998474121094)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 100</tspan></tspan><tspan dy="1.1em" y="2.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">lf_left:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 3</tspan></tspan></text></g></g></g><g transform="translate(202.40625, 182.79999542236328)" id="flowchart-I2-2" class="node default"><rect height="83.19999694824219" width="155.28125" y="-41.599998474121094" x="-77.640625" style="" class="basic label-container"/><g transform="translate(0, -26.599998474121094)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan></tspan><tspan dy="1.1em" y="2.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">lf_left:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2</tspan></tspan></text></g></g></g><g transform="translate(414.75, 182.79999542236328)" id="flowchart-L3-4" class="node default"><rect height="65.5999984741211" width="169.40625" y="-32.79999923706055" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">line_feeds:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1</tspan></tspan></text></g></g></g><g transform="translate(92.703125, 307.1999931335449)" id="flowchart-L1-6" class="node default"><rect height="65.5999984741211" width="169.40625" y="-32.79999923706055" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 30</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">line_feeds:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2</tspan></tspan></text></g></g></g><g transform="translate(312.109375, 307.1999931335449)" id="flowchart-L2-8" class="node default"><rect height="65.5999984741211" width="169.40625" y="-32.79999923706055" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 20</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">line_feeds:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>To find which piece contains line 3:</p>
<ol type="1">
<li>Root has <code>lf_left: 3</code>, and 3 &gt;= 3, so go right with line 3-3=0</li>
<li>Piece L3 has <code>line_feeds: 1</code>, line 0 is within it</li>
</ol>
<p>This enables O(log P) line-to-offset conversion. The same structure supports offset-to-line lookup by accumulating line counts while traversing.</p>
<p>For large files where line indexing hasn't been computed (lazy loading), these counts are <code>None</code> and Fresh falls back to scanning. Once a region is loaded and indexed, the counts become available.</p>
<h2 id="immutable-tree-structure">Immutable Tree Structure</h2>
<p>Fresh uses immutable nodes - once created, a node is never modified. Edits create new nodes instead.</p>
<blockquote>
<p><strong>Implementation note:</strong> Fresh is written in Rust. Nodes are wrapped in <code>Arc&lt;T&gt;</code> (Atomic Reference Counted pointer) - think of it as a pointer that tracks how many things reference it. Multiple parts of the code (even different threads) can safely hold the same <code>Arc</code>, and the data is automatically freed when the last reference is dropped. We'll gloss over this detail going forward - just know that "sharing" a node is cheap and thread-safe.</p>
</blockquote>
<p>After an edit, old tree versions remain valid:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 550.396484375 210" style="max-width: 550.396px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="subGraph1" class="cluster"><rect height="194" width="197.9140625" y="8" x="8" style=""/><g transform="translate(34.91015625, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Version</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (after</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> edit)</tspan></tspan></text></g></g></g><g data-look="classic" id="subGraph0" class="cluster"><rect height="194" width="316.482421875" y="8" x="225.9140625" style=""/><g transform="translate(305.4365234375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Version</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (before</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> edit)</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V1_Root_V1_L_0" d="M348.281,80L342.157,84.167C336.032,88.333,323.784,96.667,317.659,104.333C311.535,112,311.535,119,311.535,122.5L311.535,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V1_Root_V1_R_0" d="M417.363,80L423.488,84.167C429.612,88.333,441.861,96.667,447.985,104.333C454.109,112,454.109,119,454.109,122.5L454.109,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V2_Root_V1_L_0" d="M130.428,80L133.624,84.167C136.82,88.333,143.212,96.667,165.487,106.548C187.763,116.429,225.923,127.858,245.002,133.573L264.082,139.287"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V2_Root_V2_R_0" d="M107.557,80L106.698,84.167C105.839,88.333,104.121,96.667,103.261,104.333C102.402,112,102.402,119,102.402,122.5L102.402,126"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(382.822265625, 56.5)" id="flowchart-V1_Root-0" class="node default"><rect height="47" width="115.2421875" y="-23.5" x="-57.62109375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Root</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> v1</tspan></tspan></text></g></g></g><g transform="translate(311.53515625, 153.5)" id="flowchart-V1_L-1" class="node default"><rect height="47" width="87.2421875" y="-23.5" x="-43.62109375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Left</tspan></tspan></text></g></g></g><g transform="translate(454.109375, 153.5)" id="flowchart-V1_R-3" class="node default"><rect height="47" width="97.90625" y="-23.5" x="-48.953125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Right</tspan></tspan></text></g></g></g><g transform="translate(112.40234375, 56.5)" id="flowchart-V2_Root-4" class="node default"><rect height="47" width="115.2421875" y="-23.5" x="-57.62109375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Root</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> v2</tspan></tspan></text></g></g></g><g transform="translate(102.40234375, 153.5)" id="flowchart-V2_R-7" class="node default"><rect height="47" width="118.8046875" y="-23.5" x="-59.40234375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Right</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> v2</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>Version 2 shares the unchanged left subtree with Version 1. This enables:</p>
<ul>
<li>Undo/redo by keeping old root references</li>
<li>Concurrent reads without locks</li>
<li>Cheap snapshots</li>
</ul>
<h2 id="fresh-vs-vs-code">Fresh vs VS Code</h2>
<p><a href="https://github.com/microsoft/vscode-textbuffer">VS Code also uses a piece tree</a>. The core data structure is nearly identical - both cache byte counts and line counts per node for O(log N) lookups. The key difference is in tree mutability.</p>
<p><strong>VS Code</strong>: Mutable tree. Pieces themselves are immutable, but tree nodes are modified in place during rebalancing. After an edit, VS Code propagates size and line-count changes up to the root. Undo/redo requires a separate operation log.</p>
<p><strong>Fresh</strong>: Fully immutable tree. Edits produce new tree versions via path-copying - only nodes along the modified path are recreated, while unchanged subtrees are shared between versions. (This is a <a href="https://en.wikipedia.org/wiki/Persistent_data_structure">persistent data structure</a>.)</p>
<h3 id="inherent-trade-offs">Inherent Trade-offs</h3>
<p><strong>Immutable (Fresh):</strong></p>
<ul>
<li>Old tree versions stay valid - enables cheap snapshots and structural sharing</li>
<li>Concurrent reads need no synchronization</li>
<li>Undo can be "keep the old root" instead of "replay operations backward"</li>
<li>More allocations per edit (new nodes along modified path)</li>
</ul>
<p><strong>Mutable (VS Code):</strong></p>
<ul>
<li>Edits modify in place - less allocation overhead</li>
<li>Has a search cache to accelerate repeated position lookups</li>
<li>Requires separate undo infrastructure</li>
<li>Concurrent access needs synchronization</li>
</ul>
<p><strong>Lazy loading</strong> is orthogonal to mutability, but Fresh implements it and VS Code doesn't. Fresh can leave file regions on disk until accessed; VS Code loads the entire file into memory.</p>
<h2 id="comparison-piece-tree-vs-rope">Comparison: Piece Tree vs Rope</h2>
<p>Different editors use different text storage structures:</p>
<ul>
<li><strong>Piece tree</strong>: VS Code, Fresh</li>
<li><strong>Rope</strong>: Helix (uses <a href="https://github.com/cessen/ropey">Ropey</a>), Zed (custom <a href="https://zed.dev/blog/zed-decoded-rope-sumtree">SumTree</a>)</li>
<li><strong>Gap buffer</strong>: Emacs</li>
<li><strong>Line array</strong>: Vim, Neovim</li>
</ul>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Piece Tree (Fresh, VS Code)</th>
<th>Rope (Helix, Zed)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Node contents</td>
<td>Pointer to buffer</td>
<td>Actual text (~1KB chunks)</td>
</tr>
<tr>
<td>Insert</td>
<td>Append to buffer, add piece</td>
<td>May copy/split chunk</td>
</tr>
<tr>
<td>Original file</td>
<td>Preserved in buffer 0</td>
<td>Reorganized into chunks</td>
</tr>
<tr>
<td>Large files</td>
<td>Lazy load regions (Fresh, Word 1.1a)</td>
<td>Must load or stream</td>
</tr>
<tr>
<td>Memory for edits</td>
<td>Minimal (just pointers)</td>
<td>Copies chunk data</td>
</tr>
</tbody>
</table>
<h2 id="trade-offs">Trade-offs</h2>
<p><strong>Advantages:</strong></p>
<ul>
<li>Original file content preserved (useful for diffs, minimal saves)</li>
<li>Inserts never copy existing text</li>
<li>Natural lazy loading for large files</li>
<li>Pieces are small (~24 bytes) - more fit in CPU cache during tree traversal</li>
</ul>
<p><strong>Disadvantages:</strong></p>
<ul>
<li>Extra indirection: find piece, then fetch from buffer</li>
<li>Buffer fragmentation over many edits (many small buffers)</li>
<li>Cache locality for text is poor (data scattered across buffers)</li>
<li>No automatic chunk coalescing (piece count grows with edits)</li>
</ul>
<p><em>(Note: Fresh's current implementation doesn't fully exploit immutability - it rebuilds the entire tree on each edit rather than path-copying, making edits O(P) instead of O(log P). VS Code has additional optimizations like search caching and line content caching that Fresh lacks. These are implementation gaps, not inherent to the designs.)</em></p>
<h2 id="further-reading">Further Reading</h2>
<ul>
<li><a href="https://sinelaw.github.io/fresh/">Fresh</a> - The editor discussed in this post (<a href="https://github.com/sinelaw/fresh">source on GitHub</a>)</li>
<li><a href="https://computerhistory.org/blog/microsoft-word-for-windows-1-1a-source-code/">Microsoft Word 1.1a Source Code</a> - Original piece table implementation from 1990</li>
<li><a href="https://code.visualstudio.com/blogs/2018/03/23/text-buffer-reimplementation">VS Code's Piece Table</a> - Microsoft's 2018 write-up on reviving piece tables</li>
<li><a href="https://zed.dev/blog/zed-decoded-rope-sumtree">Zed's Rope &amp; SumTree</a> - How Zed implements ropes with B+ trees</li>
<li><a href="https://coredumped.dev/2023/08/09/text-showdown-gap-buffers-vs-ropes/">Text Showdown: Gap Buffers vs Ropes</a> - Performance comparison</li>
<li><a href="https://www.cs.unm.edu/~crowley/papers/sds.pdf">Data Structures for Text Sequences</a> - Charles Crowley, 1998 (academic survey)</li>
</ul>
]]></content><author><name></name></author></entry><entry><title type="html">How Fresh Loads Huge Files Fast</title><link href="/blog/2025/12/08/how-fresh-loads-huge-files-fast.html" rel="alternate" type="text/html" title="How Fresh Loads Huge Files Fast" /><published>2025-12-08T23:17:22+00:00</published><updated>2025-12-08T23:17:22+00:00</updated><id>/blog/2025/12/08/how-fresh-loads-huge-files-fast.html</id><content type="html" xml:base="/blog/2025/12/08/how-fresh-loads-huge-files-fast.html"><![CDATA[<h1 id="how-fresh-loads-huge-files-fast">How Fresh Loads Huge Files Fast</h1>
<p>Fresh uses a <strong>piece tree</strong> (also called a piece table) for text storage. The piece table originated in the early 1970s - first in <a href="https://www.computerhistory.org/collections/catalog/102740449">J. Strother Moore and Bob Boyer's "77-Editor" at Edinburgh</a> (1971-1973), where they applied structure-sharing techniques from their theorem proving research to text editing. Moore later brought the idea to Xerox PARC, where Charles Simonyi adopted it for the <a href="https://en.wikipedia.org/wiki/Bravo_(editor)">Bravo editor</a> (1974). Simonyi later <a href="https://www.tiny.cloud/blog/wysiwyg-development-history/">brought it to Microsoft Word</a> (1983). The design minimizes memory copying by never modifying original file content - critical for early systems with limited RAM. <a href="https://code.visualstudio.com/blogs/2018/03/23/text-buffer-reimplementation">VS Code adopted piece tables in 2018</a>, replacing their previous line-array implementation.</p>
<p><a href="https://sinelaw.github.io/fresh/">Fresh</a>'s implementation adds immutable nodes (for concurrency and cheap snapshots) and lazy loading (for large files). (<a href="https://github.com/sinelaw/fresh">GitHub</a>)</p>
<h2 id="the-core-idea">The Core Idea</h2>
<p>Instead of storing text in the tree, store <strong>pointers</strong> to text that lives elsewhere.</p>
<h3 id="rope-helix-zed">Rope (<a href="https://github.com/helix-editor/helix/blob/master/docs/architecture.md">Helix</a>, <a href="https://zed.dev/blog/zed-decoded-rope-sumtree">Zed</a>)</h3>
<p>Text lives inside tree nodes:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 360.703125 160" style="max-width: 360.703px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_L_0" d="M132.395,55L123.918,59.167C115.44,63.333,98.486,71.667,90.009,79.333C81.531,87,81.531,94,81.531,97.5L81.531,101"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_R_0" d="M228.019,55L236.496,59.167C244.974,63.333,261.928,71.667,270.406,79.333C278.883,87,278.883,94,278.883,97.5L278.883,101"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(180.20703125, 31.5)" id="flowchart-Root-0" class="node default"><rect height="47" width="156.171875" y="-23.5" x="-78.0859375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> Node</tspan></tspan></text></g></g></g><g transform="translate(81.53125, 128.5)" id="flowchart-L-2" class="node default"><rect height="47" width="147.0625" y="-23.5" x="-73.53125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Leaf:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> '</tspan></tspan></text></g></g></g><g transform="translate(278.8828125, 128.5)" id="flowchart-R-4" class="node default"><rect height="47" width="147.640625" y="-23.5" x="-73.8203125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Leaf:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'World'</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<h3 id="piece-tree-fresh">Piece Tree (Fresh)</h3>
<p>Tree nodes point to separate buffers:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 644.46875 374.6000061035156" style="max-width: 644.469px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="97" width="475.8203125" y="269.5999984741211" x="79.32421875" style=""/><g transform="translate(292.03125, 269.5999984741211)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="211.5999984741211" width="628.46875" y="8" x="8" style=""/><g transform="translate(306.03125, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_L_0" d="M248.528,80L235.46,84.167C222.391,88.333,196.254,96.667,183.186,104.333C170.117,112,170.117,119,170.117,122.5L170.117,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_R_0" d="M395.941,80L409.009,84.167C422.078,88.333,448.215,96.667,461.283,104.333C474.352,112,474.352,119,474.352,122.5L474.352,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_L_B0_0" d="M170.117,194.6L170.117,198.767C170.117,202.933,170.117,211.267,170.117,219.6C170.117,227.933,170.117,236.267,170.117,244.6C170.117,252.933,170.117,261.267,182.551,269.397C194.984,277.528,219.85,285.457,232.284,289.421L244.717,293.385"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_R_B0_0" d="M474.352,194.6L474.352,198.767C474.352,202.933,474.352,211.267,474.352,219.6C474.352,227.933,474.352,236.267,474.352,244.6C474.352,252.933,474.352,261.267,461.918,269.397C449.485,277.528,424.618,285.457,412.185,289.421L399.752,293.385"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(322.234375, 56.5)" id="flowchart-Root-0" class="node default"><rect height="47" width="156.171875" y="-23.5" x="-78.0859375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> Node</tspan></tspan></text></g></g></g><g transform="translate(170.1171875, 162.29999923706055)" id="flowchart-L-2" class="node default"><rect height="64.5999984741211" width="254.234375" y="-32.29999923706055" x="-127.1171875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> offset</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> len</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">6</tspan></tspan></text></g></g></g><g transform="translate(474.3515625, 162.29999923706055)" id="flowchart-R-4" class="node default"><rect height="64.5999984741211" width="254.234375" y="-32.29999923706055" x="-127.1171875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> offset</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 6,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> len</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">5</tspan></tspan></text></g></g></g><g transform="translate(322.234375, 318.0999984741211)" id="flowchart-B0-5" class="node default"><rect height="47" width="213.171875" y="-23.5" x="-106.5859375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> World'</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>A <strong>piece</strong> is just three numbers: which buffer, starting offset, and length.</p>
<h2 id="what-happens-when-you-edit">What Happens When You Edit</h2>
<p>When you type or paste, Fresh appends to a new buffer and creates a piece pointing to it. The original buffer stays untouched.</p>
<h3 id="before-file-contains-hello-world">Before: File contains "Hello World"</h3>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 581.2890625 150.59999084472656" style="max-width: 581.289px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="134.5999984741211" width="280.953125" y="8" x="292.3359375" style=""/><g transform="translate(407.609375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="117" width="234.3359375" y="16.799999237060547" x="8" style=""/><g transform="translate(108.96484375, 16.799999237060547)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M217.336,75.3L221.503,75.3C225.669,75.3,234.003,75.3,242.336,75.3C250.669,75.3,259.003,75.3,267.336,75.3C275.669,75.3,284.003,75.3,291.669,75.3C299.336,75.3,306.336,75.3,309.836,75.3L313.336,75.3"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(125.16796875, 75.29999923706055)" id="flowchart-P1-0" class="node default"><rect height="47" width="184.3359375" y="-23.5" x="-92.16796875" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-11</tspan></tspan></text></g></g></g><g transform="translate(432.8125, 75.29999923706055)" id="flowchart-B0-1" class="node default"><rect height="64.5999984741211" width="230.953125" y="-32.29999923706055" x="-115.4765625" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (original):</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">World'</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<h3 id="after-insert-big--at-position-6">After: Insert "Big " at position 6</h3>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 581.2890625 331.3999938964844" style="max-width: 581.289px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="310.54999923706055" width="280.953125" y="12.850000381469727" x="292.3359375" style=""/><g transform="translate(407.609375, 12.850000381469727)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="315.3999996185303" width="234.3359375" y="8" x="8" style=""/><g transform="translate(108.96484375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M213.48,66.5L218.29,66.5C223.099,66.5,232.717,66.5,241.693,66.5C250.669,66.5,259.003,66.5,267.336,66.5C275.669,66.5,284.003,66.5,295.359,68.982C306.716,71.465,321.097,76.43,328.287,78.912L335.477,81.395"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P2_B1_0" d="M213.48,264.9L218.29,264.9C223.099,264.9,232.717,264.9,241.693,264.9C250.669,264.9,259.003,264.9,267.336,264.9C275.669,264.9,284.003,264.9,292.755,264.9C301.508,264.9,310.68,264.9,315.266,264.9L319.852,264.9"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P3_B0_0" d="M217.336,163.5L221.503,163.5C225.669,163.5,234.003,163.5,242.336,163.5C250.669,163.5,259.003,163.5,267.336,163.5C275.669,163.5,284.003,163.5,295.359,161.018C306.716,158.535,321.097,153.57,328.287,151.088L335.477,148.605"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(125.16796875, 66.5)" id="flowchart-P1-0" class="node default"><rect height="47" width="176.625" y="-23.5" x="-88.3125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-6</tspan></tspan></text></g></g></g><g transform="translate(125.16796875, 264.8999996185303)" id="flowchart-P2-1" class="node default"><rect height="47" width="176.625" y="-23.5" x="-88.3125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-4</tspan></tspan></text></g></g></g><g transform="translate(125.16796875, 163.5)" id="flowchart-P3-2" class="node default"><rect height="47" width="184.3359375" y="-23.5" x="-92.16796875" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 6-11</tspan></tspan></text></g></g></g><g transform="translate(432.8125, 115)" id="flowchart-B0-3" class="node default"><rect height="64.5999984741211" width="230.953125" y="-32.29999923706055" x="-115.4765625" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (original):</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">World'</tspan></tspan></text></g></g></g><g transform="translate(432.8125, 264.8999996185303)" id="flowchart-B1-4" class="node default"><rect height="47" width="217.921875" y="-23.5" x="-108.9609375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (added):</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Big</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> '</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>Document now reads: "Hello Big World"</p>
<p>The original file content in Buffer 0 was never modified or copied.</p>
<h2 id="lazy-loading">Lazy Loading</h2>
<p>For large files, Fresh doesn't load the entire file into memory. Buffers can be <strong>unloaded</strong> - they store a file path and byte range instead of actual data.</p>
<p>This is actually how the original <a href="https://computerhistory.org/blog/microsoft-word-for-windows-1-1a-source-code/">Word 1.1a</a> piece table worked: pieces pointed directly to spans in the original file on disk, loading content only when needed. VS Code's 2018 implementation loads files fully into memory; Fresh returns to the original memory-conscious design.</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 835.59375 312.79998779296875" style="max-width: 835.594px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="149.8000030517578" width="607.578125" y="155" x="96.0078125" style=""/><g transform="translate(374.59375, 155)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="97" width="819.59375" y="8" x="8" style=""/><g transform="translate(401.59375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M143.266,80L143.266,84.167C143.266,88.333,143.266,96.667,143.266,105C143.266,113.333,143.266,121.667,143.266,130C143.266,138.333,143.266,146.667,168.583,158.056C193.9,169.446,244.535,183.892,269.852,191.115L295.169,198.338"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P2_B0_0" d="M405.797,80L405.797,84.167C405.797,88.333,405.797,96.667,405.797,105C405.797,113.333,405.797,121.667,405.797,130C405.797,138.333,405.797,146.667,405.797,154.333C405.797,162,405.797,169,405.797,172.5L405.797,176"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P3_B0_0" d="M680.328,80L680.328,84.167C680.328,88.333,680.328,96.667,680.328,105C680.328,113.333,680.328,121.667,680.328,130C680.328,138.333,680.328,146.667,653.013,158.286C625.698,169.905,571.067,184.809,543.752,192.262L516.437,199.714"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(143.265625, 56.5)" id="flowchart-P1-0" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(405.796875, 56.5)" id="flowchart-P2-1" class="node default"><rect height="47" width="224.53125" y="-23.5" x="-112.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1MB-2MB</tspan></tspan></text></g></g></g><g transform="translate(680.328125, 56.5)" id="flowchart-P3-2" class="node default"><rect height="47" width="224.53125" y="-23.5" x="-112.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2MB-3MB</tspan></tspan></text></g></g></g><g transform="translate(405.796875, 229.9000015258789)" id="flowchart-B0-3" class="node default"><rect height="99.80000305175781" width="213.5625" y="-49.900001525878906" x="-106.78125" style="" class="basic label-container"/><g transform="translate(0, -34.900001525878906)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">file:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> /path/to/large.txt</tspan></tspan><tspan dy="1.1em" y="2.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">offset:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0</tspan></tspan><tspan dy="1.1em" y="3.2em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 3MB</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>When you scroll to a region, Fresh loads only that chunk from disk:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 315.53125 397.3999938964844" style="max-width: 315.531px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"/><g class="edgeLabels"/><g class="nodes"><g transform="translate(0, 0)" class="root"><g class="clusters"><g data-look="classic" id="subGraph0" class="cluster"><rect height="381.3999938964844" width="299.53125" y="8" x="8" style=""/><g transform="translate(74.55859375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">After</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> scrolling</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> to</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> middle</tspan></tspan></text></g></g></g></g><g class="edgePaths"/><g class="edgeLabels"/><g class="nodes"><g transform="translate(157.765625, 75.29999923706055)" id="flowchart-B0_new-0" class="node default"><rect height="64.5999984741211" width="213.5625" y="-32.29999923706055" x="-106.78125" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">(0-1MB)</tspan></tspan></text></g></g></g><g transform="translate(157.765625, 198.6999969482422)" id="flowchart-B1_new-1" class="node default"><rect height="82.19999694824219" width="224.53125" y="-41.099998474121094" x="-112.265625" style="" class="basic label-container"/><g transform="translate(0, -26.099998474121094)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> LOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">(1MB-2MB)</tspan></tspan><tspan dy="1.1em" y="2.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">actual</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> in</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> memory</tspan></tspan></text></g></g></g><g transform="translate(157.765625, 322.0999946594238)" id="flowchart-B2_new-2" class="node default"><rect height="64.5999984741211" width="213.5625" y="-32.29999923706055" x="-106.78125" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">(2MB-3MB)</tspan></tspan></text></g></g></g></g></g></g></g></g></svg></p>
<h2 id="zero-copy-reads">Zero-Copy Reads</h2>
<p>When reading text for display, Fresh doesn't copy bytes. It returns slices pointing directly into the buffers:</p>
<pre class="rust"><code>// Returns &amp;[u8] pointing into buffer memory
// No allocation, no copy
let text = buffer.get_text_range(100, 200);</code></pre>
<p>Multiple pieces can reference the same buffer region. Displaying the same text twice doesn't double memory usage.</p>
<h2 id="the-tree-structure">The Tree Structure</h2>
<p>The pieces are organized in a balanced binary tree for fast lookups:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 507.453125 294.20001220703125" style="max-width: 507.453px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_I2_0" d="M248.328,73.6L240.675,77.767C233.021,81.933,217.714,90.267,210.06,97.933C202.406,105.6,202.406,112.6,202.406,116.1L202.406,119.6"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_L3_0" d="M368.828,73.6L376.482,77.767C384.135,81.933,399.443,90.267,407.096,99.483C414.75,108.7,414.75,118.8,414.75,123.85L414.75,128.9"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L1_0" d="M140.153,189.2L132.244,193.367C124.336,197.533,108.52,205.867,100.611,213.533C92.703,221.2,92.703,228.2,92.703,231.7L92.703,235.2"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L2_0" d="M264.66,189.2L272.568,193.367C280.476,197.533,296.293,205.867,304.201,213.533C312.109,221.2,312.109,228.2,312.109,231.7L312.109,235.2"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(308.578125, 40.79999923706055)" id="flowchart-I1-0" class="node default"><rect height="65.5999984741211" width="164.1796875" y="-32.79999923706055" x="-82.08984375" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 100</tspan></tspan></text></g></g></g><g transform="translate(202.40625, 156.39999771118164)" id="flowchart-I2-2" class="node default"><rect height="65.5999984741211" width="155.28125" y="-32.79999923706055" x="-77.640625" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan></tspan></text></g></g></g><g transform="translate(414.75, 156.39999771118164)" id="flowchart-L3-4" class="node default"><rect height="47" width="169.40625" y="-23.5" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan></text></g></g></g><g transform="translate(92.703125, 262.6999969482422)" id="flowchart-L1-6" class="node default"><rect height="47" width="169.40625" y="-23.5" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan></text></g></g></g><g transform="translate(312.109375, 262.6999969482422)" id="flowchart-L2-8" class="node default"><rect height="47" width="169.40625" y="-23.5" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>Each internal node caches the total bytes in its left subtree. To find byte offset 75:</p>
<ol type="1">
<li>Root has <code>left_bytes: 100</code>, and 75 &lt; 100, so go left</li>
<li>Internal has <code>left_bytes: 50</code>, and 75 &gt;= 50, so go right with offset 75-50=25</li>
<li>Piece has 50 bytes, offset 25 is within it</li>
</ol>
<p>This is O(log P) where P is the number of pieces.</p>
<h2 id="line-feed-tracking">Line Feed Tracking</h2>
<p>Text editors need fast line-based operations: "go to line 1000", "what line is byte offset 50000 on?", or simply displaying line numbers. Scanning the entire document for newlines would be O(N) - too slow for large files.</p>
<p>Fresh tracks line feeds the same way it tracks bytes. Each piece stores its newline count, and internal nodes cache the count for their left subtree:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 507.453125 348" style="max-width: 507.453px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_I2_0" d="M242.261,91.2L235.618,95.367C228.976,99.533,215.691,107.867,209.049,115.533C202.406,123.2,202.406,130.2,202.406,133.7L202.406,137.2"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_L3_0" d="M374.896,91.2L381.538,95.367C388.18,99.533,401.465,107.867,408.108,117C414.75,126.133,414.75,136.067,414.75,141.033L414.75,146"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L1_0" d="M133.883,224.4L127.02,228.567C120.156,232.733,106.43,241.067,99.566,248.733C92.703,256.4,92.703,263.4,92.703,266.9L92.703,270.4"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L2_0" d="M270.93,224.4L277.793,228.567C284.656,232.733,298.383,241.067,305.246,248.733C312.109,256.4,312.109,263.4,312.109,266.9L312.109,270.4"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(308.578125, 49.599998474121094)" id="flowchart-I1-0" class="node default"><rect height="83.19999694824219" width="164.1796875" y="-41.599998474121094" x="-82.08984375" style="" class="basic label-container"/><g transform="translate(0, -26.599998474121094)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 100</tspan></tspan><tspan dy="1.1em" y="2.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">lf_left:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 3</tspan></tspan></text></g></g></g><g transform="translate(202.40625, 182.79999542236328)" id="flowchart-I2-2" class="node default"><rect height="83.19999694824219" width="155.28125" y="-41.599998474121094" x="-77.640625" style="" class="basic label-container"/><g transform="translate(0, -26.599998474121094)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan></tspan><tspan dy="1.1em" y="2.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">lf_left:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2</tspan></tspan></text></g></g></g><g transform="translate(414.75, 182.79999542236328)" id="flowchart-L3-4" class="node default"><rect height="65.5999984741211" width="169.40625" y="-32.79999923706055" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">line_feeds:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1</tspan></tspan></text></g></g></g><g transform="translate(92.703125, 307.1999931335449)" id="flowchart-L1-6" class="node default"><rect height="65.5999984741211" width="169.40625" y="-32.79999923706055" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 30</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">line_feeds:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2</tspan></tspan></text></g></g></g><g transform="translate(312.109375, 307.1999931335449)" id="flowchart-L2-8" class="node default"><rect height="65.5999984741211" width="169.40625" y="-32.79999923706055" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 20</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">line_feeds:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>To find which piece contains line 3:</p>
<ol type="1">
<li>Root has <code>lf_left: 3</code>, and 3 &gt;= 3, so go right with line 3-3=0</li>
<li>Piece L3 has <code>line_feeds: 1</code>, line 0 is within it</li>
</ol>
<p>This enables O(log P) line-to-offset conversion. The same structure supports offset-to-line lookup by accumulating line counts while traversing.</p>
<p>For large files where line indexing hasn't been computed (lazy loading), these counts are <code>None</code> and Fresh falls back to scanning. Once a region is loaded and indexed, the counts become available.</p>
<h2 id="immutable-tree-structure">Immutable Tree Structure</h2>
<p>Fresh uses immutable nodes - once created, a node is never modified. Edits create new nodes instead.</p>
<blockquote>
<p><strong>Implementation note:</strong> Fresh is written in Rust. Nodes are wrapped in <code>Arc&lt;T&gt;</code> (Atomic Reference Counted pointer) - think of it as a pointer that tracks how many things reference it. Multiple parts of the code (even different threads) can safely hold the same <code>Arc</code>, and the data is automatically freed when the last reference is dropped. We'll gloss over this detail going forward - just know that "sharing" a node is cheap and thread-safe.</p>
</blockquote>
<p>After an edit, old tree versions remain valid:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 550.396484375 210" style="max-width: 550.396px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="subGraph1" class="cluster"><rect height="194" width="197.9140625" y="8" x="8" style=""/><g transform="translate(34.91015625, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Version</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (after</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> edit)</tspan></tspan></text></g></g></g><g data-look="classic" id="subGraph0" class="cluster"><rect height="194" width="316.482421875" y="8" x="225.9140625" style=""/><g transform="translate(305.4365234375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Version</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (before</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> edit)</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V1_Root_V1_L_0" d="M348.281,80L342.157,84.167C336.032,88.333,323.784,96.667,317.659,104.333C311.535,112,311.535,119,311.535,122.5L311.535,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V1_Root_V1_R_0" d="M417.363,80L423.488,84.167C429.612,88.333,441.861,96.667,447.985,104.333C454.109,112,454.109,119,454.109,122.5L454.109,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V2_Root_V1_L_0" d="M130.428,80L133.624,84.167C136.82,88.333,143.212,96.667,165.487,106.548C187.763,116.429,225.923,127.858,245.002,133.573L264.082,139.287"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V2_Root_V2_R_0" d="M107.557,80L106.698,84.167C105.839,88.333,104.121,96.667,103.261,104.333C102.402,112,102.402,119,102.402,122.5L102.402,126"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(382.822265625, 56.5)" id="flowchart-V1_Root-0" class="node default"><rect height="47" width="115.2421875" y="-23.5" x="-57.62109375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Root</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> v1</tspan></tspan></text></g></g></g><g transform="translate(311.53515625, 153.5)" id="flowchart-V1_L-1" class="node default"><rect height="47" width="87.2421875" y="-23.5" x="-43.62109375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Left</tspan></tspan></text></g></g></g><g transform="translate(454.109375, 153.5)" id="flowchart-V1_R-3" class="node default"><rect height="47" width="97.90625" y="-23.5" x="-48.953125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Right</tspan></tspan></text></g></g></g><g transform="translate(112.40234375, 56.5)" id="flowchart-V2_Root-4" class="node default"><rect height="47" width="115.2421875" y="-23.5" x="-57.62109375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Root</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> v2</tspan></tspan></text></g></g></g><g transform="translate(102.40234375, 153.5)" id="flowchart-V2_R-7" class="node default"><rect height="47" width="118.8046875" y="-23.5" x="-59.40234375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Right</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> v2</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>Version 2 shares the unchanged left subtree with Version 1. This enables:</p>
<ul>
<li>Undo/redo by keeping old root references</li>
<li>Concurrent reads without locks</li>
<li>Cheap snapshots</li>
</ul>
<h2 id="fresh-vs-vs-code">Fresh vs VS Code</h2>
<p><a href="https://github.com/microsoft/vscode-textbuffer">VS Code also uses a piece tree</a>. The core data structure is nearly identical - both cache byte counts and line counts per node for O(log N) lookups. The key difference is in tree mutability.</p>
<p><strong>VS Code</strong>: Mutable tree. Pieces themselves are immutable, but tree nodes are modified in place during rebalancing. After an edit, VS Code propagates size and line-count changes up to the root. Undo/redo requires a separate operation log.</p>
<p><strong>Fresh</strong>: Fully immutable tree. Edits produce new tree versions via path-copying - only nodes along the modified path are recreated, while unchanged subtrees are shared between versions. (This is a <a href="https://en.wikipedia.org/wiki/Persistent_data_structure">persistent data structure</a>.)</p>
<h3 id="inherent-trade-offs">Inherent Trade-offs</h3>
<p><strong>Immutable (Fresh):</strong></p>
<ul>
<li>Old tree versions stay valid - enables cheap snapshots and structural sharing</li>
<li>Concurrent reads need no synchronization</li>
<li>Undo can be "keep the old root" instead of "replay operations backward"</li>
<li>More allocations per edit (new nodes along modified path)</li>
</ul>
<p><strong>Mutable (VS Code):</strong></p>
<ul>
<li>Edits modify in place - less allocation overhead</li>
<li>Has a search cache to accelerate repeated position lookups</li>
<li>Requires separate undo infrastructure</li>
<li>Concurrent access needs synchronization</li>
</ul>
<p><strong>Lazy loading</strong> is orthogonal to mutability, but Fresh implements it and VS Code doesn't. Fresh can leave file regions on disk until accessed; VS Code loads the entire file into memory.</p>
<h2 id="comparison-piece-tree-vs-rope">Comparison: Piece Tree vs Rope</h2>
<p>Different editors use different text storage structures:</p>
<ul>
<li><strong>Piece tree</strong>: VS Code, Fresh</li>
<li><strong>Rope</strong>: Helix (uses <a href="https://github.com/cessen/ropey">Ropey</a>), Zed (custom <a href="https://zed.dev/blog/zed-decoded-rope-sumtree">SumTree</a>)</li>
<li><strong>Gap buffer</strong>: Emacs</li>
<li><strong>Line array</strong>: Vim, Neovim</li>
</ul>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Piece Tree (Fresh, VS Code)</th>
<th>Rope (Helix, Zed)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Node contents</td>
<td>Pointer to buffer</td>
<td>Actual text (~1KB chunks)</td>
</tr>
<tr>
<td>Insert</td>
<td>Append to buffer, add piece</td>
<td>May copy/split chunk</td>
</tr>
<tr>
<td>Original file</td>
<td>Preserved in buffer 0</td>
<td>Reorganized into chunks</td>
</tr>
<tr>
<td>Large files</td>
<td>Lazy load regions (Fresh, Word 1.1a)</td>
<td>Must load or stream</td>
</tr>
<tr>
<td>Memory for edits</td>
<td>Minimal (just pointers)</td>
<td>Copies chunk data</td>
</tr>
</tbody>
</table>
<h2 id="trade-offs">Trade-offs</h2>
<p><strong>Advantages:</strong></p>
<ul>
<li>Original file content preserved (useful for diffs, minimal saves)</li>
<li>Inserts never copy existing text</li>
<li>Natural lazy loading for large files</li>
<li>Pieces are small (~24 bytes) - more fit in CPU cache during tree traversal</li>
</ul>
<p><strong>Disadvantages:</strong></p>
<ul>
<li>Extra indirection: find piece, then fetch from buffer</li>
<li>Buffer fragmentation over many edits (many small buffers)</li>
<li>Cache locality for text is poor (data scattered across buffers)</li>
<li>No automatic chunk coalescing (piece count grows with edits)</li>
</ul>
<p><em>(Note: Fresh's current implementation doesn't fully exploit immutability - it rebuilds the entire tree on each edit rather than path-copying, making edits O(P) instead of O(log P). VS Code has additional optimizations like search caching and line content caching that Fresh lacks. These are implementation gaps, not inherent to the designs.)</em></p>
<h2 id="further-reading">Further Reading</h2>
<ul>
<li><a href="https://sinelaw.github.io/fresh/">Fresh</a> - The editor discussed in this post (<a href="https://github.com/sinelaw/fresh">source on GitHub</a>)</li>
<li><a href="https://computerhistory.org/blog/microsoft-word-for-windows-1-1a-source-code/">Microsoft Word 1.1a Source Code</a> - Original piece table implementation from 1990</li>
<li><a href="https://code.visualstudio.com/blogs/2018/03/23/text-buffer-reimplementation">VS Code's Piece Table</a> - Microsoft's 2018 write-up on reviving piece tables</li>
<li><a href="https://zed.dev/blog/zed-decoded-rope-sumtree">Zed's Rope &amp; SumTree</a> - How Zed implements ropes with B+ trees</li>
<li><a href="https://coredumped.dev/2023/08/09/text-showdown-gap-buffers-vs-ropes/">Text Showdown: Gap Buffers vs Ropes</a> - Performance comparison</li>
<li><a href="https://www.cs.unm.edu/~crowley/papers/sds.pdf">Data Structures for Text Sequences</a> - Charles Crowley, 1998 (academic survey)</li>
</ul>
]]></content><author><name></name></author></entry><entry><title type="html">How Fresh Loads Huge Files Fast</title><link href="/blog/2025/12/08/how-fresh-loads-huge-files-fast.html" rel="alternate" type="text/html" title="How Fresh Loads Huge Files Fast" /><published>2025-12-08T23:12:44+00:00</published><updated>2025-12-08T23:12:44+00:00</updated><id>/blog/2025/12/08/how-fresh-loads-huge-files-fast.html</id><content type="html" xml:base="/blog/2025/12/08/how-fresh-loads-huge-files-fast.html"><![CDATA[<h1 id="how-fresh-loads-huge-files-fast">How Fresh Loads Huge Files Fast</h1>
<p>Fresh uses a <strong>piece tree</strong> (also called a piece table) for text storage. The piece table originated in the early 1970s - first in <a href="https://www.computerhistory.org/collections/catalog/102740449">J. Strother Moore and Bob Boyer's "77-Editor" at Edinburgh</a> (1971-1973), where they applied structure-sharing techniques from their theorem proving research to text editing. Moore later brought the idea to Xerox PARC, where Charles Simonyi adopted it for the <a href="https://en.wikipedia.org/wiki/Bravo_(editor)">Bravo editor</a> (1974). Simonyi later <a href="https://www.tiny.cloud/blog/wysiwyg-development-history/">brought it to Microsoft Word</a> (1983). The design minimizes memory copying by never modifying original file content - critical for early systems with limited RAM. <a href="https://code.visualstudio.com/blogs/2018/03/23/text-buffer-reimplementation">VS Code revived this approach in 2018</a>.</p>
<p><a href="https://sinelaw.github.io/fresh/">Fresh</a>'s implementation adds immutable nodes (for concurrency and cheap snapshots) and lazy loading (for large files). (<a href="https://github.com/sinelaw/fresh">GitHub</a>)</p>
<h2 id="the-core-idea">The Core Idea</h2>
<p>Instead of storing text in the tree, store <strong>pointers</strong> to text that lives elsewhere.</p>
<h3 id="rope-helix-zed">Rope (<a href="https://github.com/helix-editor/helix/blob/master/docs/architecture.md">Helix</a>, <a href="https://zed.dev/blog/zed-decoded-rope-sumtree">Zed</a>)</h3>
<p>Text lives inside tree nodes:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 360.703125 160" style="max-width: 360.703px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_L_0" d="M132.395,55L123.918,59.167C115.44,63.333,98.486,71.667,90.009,79.333C81.531,87,81.531,94,81.531,97.5L81.531,101"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_R_0" d="M228.019,55L236.496,59.167C244.974,63.333,261.928,71.667,270.406,79.333C278.883,87,278.883,94,278.883,97.5L278.883,101"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(180.20703125, 31.5)" id="flowchart-Root-0" class="node default"><rect height="47" width="156.171875" y="-23.5" x="-78.0859375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> Node</tspan></tspan></text></g></g></g><g transform="translate(81.53125, 128.5)" id="flowchart-L-2" class="node default"><rect height="47" width="147.0625" y="-23.5" x="-73.53125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Leaf:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> '</tspan></tspan></text></g></g></g><g transform="translate(278.8828125, 128.5)" id="flowchart-R-4" class="node default"><rect height="47" width="147.640625" y="-23.5" x="-73.8203125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Leaf:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'World'</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<h3 id="piece-tree-fresh">Piece Tree (Fresh)</h3>
<p>Tree nodes point to separate buffers:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 644.46875 374.6000061035156" style="max-width: 644.469px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="97" width="475.8203125" y="269.5999984741211" x="79.32421875" style=""/><g transform="translate(292.03125, 269.5999984741211)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="211.5999984741211" width="628.46875" y="8" x="8" style=""/><g transform="translate(306.03125, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_L_0" d="M248.528,80L235.46,84.167C222.391,88.333,196.254,96.667,183.186,104.333C170.117,112,170.117,119,170.117,122.5L170.117,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_R_0" d="M395.941,80L409.009,84.167C422.078,88.333,448.215,96.667,461.283,104.333C474.352,112,474.352,119,474.352,122.5L474.352,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_L_B0_0" d="M170.117,194.6L170.117,198.767C170.117,202.933,170.117,211.267,170.117,219.6C170.117,227.933,170.117,236.267,170.117,244.6C170.117,252.933,170.117,261.267,182.551,269.397C194.984,277.528,219.85,285.457,232.284,289.421L244.717,293.385"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_R_B0_0" d="M474.352,194.6L474.352,198.767C474.352,202.933,474.352,211.267,474.352,219.6C474.352,227.933,474.352,236.267,474.352,244.6C474.352,252.933,474.352,261.267,461.918,269.397C449.485,277.528,424.618,285.457,412.185,289.421L399.752,293.385"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(322.234375, 56.5)" id="flowchart-Root-0" class="node default"><rect height="47" width="156.171875" y="-23.5" x="-78.0859375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> Node</tspan></tspan></text></g></g></g><g transform="translate(170.1171875, 162.29999923706055)" id="flowchart-L-2" class="node default"><rect height="64.5999984741211" width="254.234375" y="-32.29999923706055" x="-127.1171875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> offset</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> len</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">6</tspan></tspan></text></g></g></g><g transform="translate(474.3515625, 162.29999923706055)" id="flowchart-R-4" class="node default"><rect height="64.5999984741211" width="254.234375" y="-32.29999923706055" x="-127.1171875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> offset</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 6,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> len</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">5</tspan></tspan></text></g></g></g><g transform="translate(322.234375, 318.0999984741211)" id="flowchart-B0-5" class="node default"><rect height="47" width="213.171875" y="-23.5" x="-106.5859375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> World'</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>A <strong>piece</strong> is just three numbers: which buffer, starting offset, and length.</p>
<h2 id="what-happens-when-you-edit">What Happens When You Edit</h2>
<p>When you type or paste, Fresh appends to a new buffer and creates a piece pointing to it. The original buffer stays untouched.</p>
<h3 id="before-file-contains-hello-world">Before: File contains "Hello World"</h3>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 581.2890625 150.59999084472656" style="max-width: 581.289px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="134.5999984741211" width="280.953125" y="8" x="292.3359375" style=""/><g transform="translate(407.609375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="117" width="234.3359375" y="16.799999237060547" x="8" style=""/><g transform="translate(108.96484375, 16.799999237060547)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M217.336,75.3L221.503,75.3C225.669,75.3,234.003,75.3,242.336,75.3C250.669,75.3,259.003,75.3,267.336,75.3C275.669,75.3,284.003,75.3,291.669,75.3C299.336,75.3,306.336,75.3,309.836,75.3L313.336,75.3"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(125.16796875, 75.29999923706055)" id="flowchart-P1-0" class="node default"><rect height="47" width="184.3359375" y="-23.5" x="-92.16796875" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-11</tspan></tspan></text></g></g></g><g transform="translate(432.8125, 75.29999923706055)" id="flowchart-B0-1" class="node default"><rect height="64.5999984741211" width="230.953125" y="-32.29999923706055" x="-115.4765625" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (original):</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">World'</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<h3 id="after-insert-big--at-position-6">After: Insert "Big " at position 6</h3>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 581.2890625 331.3999938964844" style="max-width: 581.289px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="310.54999923706055" width="280.953125" y="12.850000381469727" x="292.3359375" style=""/><g transform="translate(407.609375, 12.850000381469727)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="315.3999996185303" width="234.3359375" y="8" x="8" style=""/><g transform="translate(108.96484375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M213.48,66.5L218.29,66.5C223.099,66.5,232.717,66.5,241.693,66.5C250.669,66.5,259.003,66.5,267.336,66.5C275.669,66.5,284.003,66.5,295.359,68.982C306.716,71.465,321.097,76.43,328.287,78.912L335.477,81.395"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P2_B1_0" d="M213.48,264.9L218.29,264.9C223.099,264.9,232.717,264.9,241.693,264.9C250.669,264.9,259.003,264.9,267.336,264.9C275.669,264.9,284.003,264.9,292.755,264.9C301.508,264.9,310.68,264.9,315.266,264.9L319.852,264.9"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P3_B0_0" d="M217.336,163.5L221.503,163.5C225.669,163.5,234.003,163.5,242.336,163.5C250.669,163.5,259.003,163.5,267.336,163.5C275.669,163.5,284.003,163.5,295.359,161.018C306.716,158.535,321.097,153.57,328.287,151.088L335.477,148.605"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(125.16796875, 66.5)" id="flowchart-P1-0" class="node default"><rect height="47" width="176.625" y="-23.5" x="-88.3125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-6</tspan></tspan></text></g></g></g><g transform="translate(125.16796875, 264.8999996185303)" id="flowchart-P2-1" class="node default"><rect height="47" width="176.625" y="-23.5" x="-88.3125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-4</tspan></tspan></text></g></g></g><g transform="translate(125.16796875, 163.5)" id="flowchart-P3-2" class="node default"><rect height="47" width="184.3359375" y="-23.5" x="-92.16796875" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 6-11</tspan></tspan></text></g></g></g><g transform="translate(432.8125, 115)" id="flowchart-B0-3" class="node default"><rect height="64.5999984741211" width="230.953125" y="-32.29999923706055" x="-115.4765625" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (original):</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">World'</tspan></tspan></text></g></g></g><g transform="translate(432.8125, 264.8999996185303)" id="flowchart-B1-4" class="node default"><rect height="47" width="217.921875" y="-23.5" x="-108.9609375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (added):</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Big</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> '</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>Document now reads: "Hello Big World"</p>
<p>The original file content in Buffer 0 was never modified or copied.</p>
<h2 id="lazy-loading">Lazy Loading</h2>
<p>For large files, Fresh doesn't load the entire file into memory. Buffers can be <strong>unloaded</strong> - they store a file path and byte range instead of actual data.</p>
<p>This is actually how the original <a href="https://computerhistory.org/blog/microsoft-word-for-windows-1-1a-source-code/">Word 1.1a</a> piece table worked: pieces pointed directly to spans in the original file on disk, loading content only when needed. VS Code's 2018 implementation loads files fully into memory; Fresh returns to the original memory-conscious design.</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 835.59375 312.79998779296875" style="max-width: 835.594px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="149.8000030517578" width="607.578125" y="155" x="96.0078125" style=""/><g transform="translate(374.59375, 155)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="97" width="819.59375" y="8" x="8" style=""/><g transform="translate(401.59375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M143.266,80L143.266,84.167C143.266,88.333,143.266,96.667,143.266,105C143.266,113.333,143.266,121.667,143.266,130C143.266,138.333,143.266,146.667,168.583,158.056C193.9,169.446,244.535,183.892,269.852,191.115L295.169,198.338"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P2_B0_0" d="M405.797,80L405.797,84.167C405.797,88.333,405.797,96.667,405.797,105C405.797,113.333,405.797,121.667,405.797,130C405.797,138.333,405.797,146.667,405.797,154.333C405.797,162,405.797,169,405.797,172.5L405.797,176"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P3_B0_0" d="M680.328,80L680.328,84.167C680.328,88.333,680.328,96.667,680.328,105C680.328,113.333,680.328,121.667,680.328,130C680.328,138.333,680.328,146.667,653.013,158.286C625.698,169.905,571.067,184.809,543.752,192.262L516.437,199.714"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(143.265625, 56.5)" id="flowchart-P1-0" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(405.796875, 56.5)" id="flowchart-P2-1" class="node default"><rect height="47" width="224.53125" y="-23.5" x="-112.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1MB-2MB</tspan></tspan></text></g></g></g><g transform="translate(680.328125, 56.5)" id="flowchart-P3-2" class="node default"><rect height="47" width="224.53125" y="-23.5" x="-112.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2MB-3MB</tspan></tspan></text></g></g></g><g transform="translate(405.796875, 229.9000015258789)" id="flowchart-B0-3" class="node default"><rect height="99.80000305175781" width="213.5625" y="-49.900001525878906" x="-106.78125" style="" class="basic label-container"/><g transform="translate(0, -34.900001525878906)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">file:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> /path/to/large.txt</tspan></tspan><tspan dy="1.1em" y="2.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">offset:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0</tspan></tspan><tspan dy="1.1em" y="3.2em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 3MB</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>When you scroll to a region, Fresh loads only that chunk from disk:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 315.53125 397.3999938964844" style="max-width: 315.531px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"/><g class="edgeLabels"/><g class="nodes"><g transform="translate(0, 0)" class="root"><g class="clusters"><g data-look="classic" id="subGraph0" class="cluster"><rect height="381.3999938964844" width="299.53125" y="8" x="8" style=""/><g transform="translate(74.55859375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">After</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> scrolling</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> to</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> middle</tspan></tspan></text></g></g></g></g><g class="edgePaths"/><g class="edgeLabels"/><g class="nodes"><g transform="translate(157.765625, 75.29999923706055)" id="flowchart-B0_new-0" class="node default"><rect height="64.5999984741211" width="213.5625" y="-32.29999923706055" x="-106.78125" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">(0-1MB)</tspan></tspan></text></g></g></g><g transform="translate(157.765625, 198.6999969482422)" id="flowchart-B1_new-1" class="node default"><rect height="82.19999694824219" width="224.53125" y="-41.099998474121094" x="-112.265625" style="" class="basic label-container"/><g transform="translate(0, -26.099998474121094)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> LOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">(1MB-2MB)</tspan></tspan><tspan dy="1.1em" y="2.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">actual</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> in</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> memory</tspan></tspan></text></g></g></g><g transform="translate(157.765625, 322.0999946594238)" id="flowchart-B2_new-2" class="node default"><rect height="64.5999984741211" width="213.5625" y="-32.29999923706055" x="-106.78125" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">(2MB-3MB)</tspan></tspan></text></g></g></g></g></g></g></g></g></svg></p>
<h2 id="zero-copy-reads">Zero-Copy Reads</h2>
<p>When reading text for display, Fresh doesn't copy bytes. It returns slices pointing directly into the buffers:</p>
<pre class="rust"><code>// Returns &amp;[u8] pointing into buffer memory
// No allocation, no copy
let text = buffer.get_text_range(100, 200);</code></pre>
<p>Multiple pieces can reference the same buffer region. Displaying the same text twice doesn't double memory usage.</p>
<h2 id="the-tree-structure">The Tree Structure</h2>
<p>The pieces are organized in a balanced binary tree for fast lookups:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 507.453125 294.20001220703125" style="max-width: 507.453px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_I2_0" d="M248.328,73.6L240.675,77.767C233.021,81.933,217.714,90.267,210.06,97.933C202.406,105.6,202.406,112.6,202.406,116.1L202.406,119.6"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_L3_0" d="M368.828,73.6L376.482,77.767C384.135,81.933,399.443,90.267,407.096,99.483C414.75,108.7,414.75,118.8,414.75,123.85L414.75,128.9"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L1_0" d="M140.153,189.2L132.244,193.367C124.336,197.533,108.52,205.867,100.611,213.533C92.703,221.2,92.703,228.2,92.703,231.7L92.703,235.2"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L2_0" d="M264.66,189.2L272.568,193.367C280.476,197.533,296.293,205.867,304.201,213.533C312.109,221.2,312.109,228.2,312.109,231.7L312.109,235.2"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(308.578125, 40.79999923706055)" id="flowchart-I1-0" class="node default"><rect height="65.5999984741211" width="164.1796875" y="-32.79999923706055" x="-82.08984375" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 100</tspan></tspan></text></g></g></g><g transform="translate(202.40625, 156.39999771118164)" id="flowchart-I2-2" class="node default"><rect height="65.5999984741211" width="155.28125" y="-32.79999923706055" x="-77.640625" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan></tspan></text></g></g></g><g transform="translate(414.75, 156.39999771118164)" id="flowchart-L3-4" class="node default"><rect height="47" width="169.40625" y="-23.5" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan></text></g></g></g><g transform="translate(92.703125, 262.6999969482422)" id="flowchart-L1-6" class="node default"><rect height="47" width="169.40625" y="-23.5" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan></text></g></g></g><g transform="translate(312.109375, 262.6999969482422)" id="flowchart-L2-8" class="node default"><rect height="47" width="169.40625" y="-23.5" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>Each internal node caches the total bytes in its left subtree. To find byte offset 75:</p>
<ol type="1">
<li>Root has <code>left_bytes: 100</code>, and 75 &lt; 100, so go left</li>
<li>Internal has <code>left_bytes: 50</code>, and 75 &gt;= 50, so go right with offset 75-50=25</li>
<li>Piece has 50 bytes, offset 25 is within it</li>
</ol>
<p>This is O(log P) where P is the number of pieces.</p>
<h2 id="line-feed-tracking">Line Feed Tracking</h2>
<p>Text editors need fast line-based operations: "go to line 1000", "what line is byte offset 50000 on?", or simply displaying line numbers. Scanning the entire document for newlines would be O(N) - too slow for large files.</p>
<p>Fresh tracks line feeds the same way it tracks bytes. Each piece stores its newline count, and internal nodes cache the count for their left subtree:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 507.453125 348" style="max-width: 507.453px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_I2_0" d="M242.261,91.2L235.618,95.367C228.976,99.533,215.691,107.867,209.049,115.533C202.406,123.2,202.406,130.2,202.406,133.7L202.406,137.2"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_L3_0" d="M374.896,91.2L381.538,95.367C388.18,99.533,401.465,107.867,408.108,117C414.75,126.133,414.75,136.067,414.75,141.033L414.75,146"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L1_0" d="M133.883,224.4L127.02,228.567C120.156,232.733,106.43,241.067,99.566,248.733C92.703,256.4,92.703,263.4,92.703,266.9L92.703,270.4"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L2_0" d="M270.93,224.4L277.793,228.567C284.656,232.733,298.383,241.067,305.246,248.733C312.109,256.4,312.109,263.4,312.109,266.9L312.109,270.4"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(308.578125, 49.599998474121094)" id="flowchart-I1-0" class="node default"><rect height="83.19999694824219" width="164.1796875" y="-41.599998474121094" x="-82.08984375" style="" class="basic label-container"/><g transform="translate(0, -26.599998474121094)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 100</tspan></tspan><tspan dy="1.1em" y="2.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">lf_left:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 3</tspan></tspan></text></g></g></g><g transform="translate(202.40625, 182.79999542236328)" id="flowchart-I2-2" class="node default"><rect height="83.19999694824219" width="155.28125" y="-41.599998474121094" x="-77.640625" style="" class="basic label-container"/><g transform="translate(0, -26.599998474121094)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan></tspan><tspan dy="1.1em" y="2.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">lf_left:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2</tspan></tspan></text></g></g></g><g transform="translate(414.75, 182.79999542236328)" id="flowchart-L3-4" class="node default"><rect height="65.5999984741211" width="169.40625" y="-32.79999923706055" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">line_feeds:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1</tspan></tspan></text></g></g></g><g transform="translate(92.703125, 307.1999931335449)" id="flowchart-L1-6" class="node default"><rect height="65.5999984741211" width="169.40625" y="-32.79999923706055" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 30</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">line_feeds:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2</tspan></tspan></text></g></g></g><g transform="translate(312.109375, 307.1999931335449)" id="flowchart-L2-8" class="node default"><rect height="65.5999984741211" width="169.40625" y="-32.79999923706055" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 20</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">line_feeds:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>To find which piece contains line 3:</p>
<ol type="1">
<li>Root has <code>lf_left: 3</code>, and 3 &gt;= 3, so go right with line 3-3=0</li>
<li>Piece L3 has <code>line_feeds: 1</code>, line 0 is within it</li>
</ol>
<p>This enables O(log P) line-to-offset conversion. The same structure supports offset-to-line lookup by accumulating line counts while traversing.</p>
<p>For large files where line indexing hasn't been computed (lazy loading), these counts are <code>None</code> and Fresh falls back to scanning. Once a region is loaded and indexed, the counts become available.</p>
<h2 id="immutable-tree-structure">Immutable Tree Structure</h2>
<p>Fresh uses immutable nodes - once created, a node is never modified. Edits create new nodes instead.</p>
<blockquote>
<p><strong>Implementation note:</strong> Fresh is written in Rust. Nodes are wrapped in <code>Arc&lt;T&gt;</code> (Atomic Reference Counted pointer) - think of it as a pointer that tracks how many things reference it. Multiple parts of the code (even different threads) can safely hold the same <code>Arc</code>, and the data is automatically freed when the last reference is dropped. We'll gloss over this detail going forward - just know that "sharing" a node is cheap and thread-safe.</p>
</blockquote>
<p>After an edit, old tree versions remain valid:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 550.396484375 210" style="max-width: 550.396px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="subGraph1" class="cluster"><rect height="194" width="197.9140625" y="8" x="8" style=""/><g transform="translate(34.91015625, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Version</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (after</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> edit)</tspan></tspan></text></g></g></g><g data-look="classic" id="subGraph0" class="cluster"><rect height="194" width="316.482421875" y="8" x="225.9140625" style=""/><g transform="translate(305.4365234375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Version</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (before</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> edit)</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V1_Root_V1_L_0" d="M348.281,80L342.157,84.167C336.032,88.333,323.784,96.667,317.659,104.333C311.535,112,311.535,119,311.535,122.5L311.535,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V1_Root_V1_R_0" d="M417.363,80L423.488,84.167C429.612,88.333,441.861,96.667,447.985,104.333C454.109,112,454.109,119,454.109,122.5L454.109,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V2_Root_V1_L_0" d="M130.428,80L133.624,84.167C136.82,88.333,143.212,96.667,165.487,106.548C187.763,116.429,225.923,127.858,245.002,133.573L264.082,139.287"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V2_Root_V2_R_0" d="M107.557,80L106.698,84.167C105.839,88.333,104.121,96.667,103.261,104.333C102.402,112,102.402,119,102.402,122.5L102.402,126"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(382.822265625, 56.5)" id="flowchart-V1_Root-0" class="node default"><rect height="47" width="115.2421875" y="-23.5" x="-57.62109375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Root</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> v1</tspan></tspan></text></g></g></g><g transform="translate(311.53515625, 153.5)" id="flowchart-V1_L-1" class="node default"><rect height="47" width="87.2421875" y="-23.5" x="-43.62109375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Left</tspan></tspan></text></g></g></g><g transform="translate(454.109375, 153.5)" id="flowchart-V1_R-3" class="node default"><rect height="47" width="97.90625" y="-23.5" x="-48.953125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Right</tspan></tspan></text></g></g></g><g transform="translate(112.40234375, 56.5)" id="flowchart-V2_Root-4" class="node default"><rect height="47" width="115.2421875" y="-23.5" x="-57.62109375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Root</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> v2</tspan></tspan></text></g></g></g><g transform="translate(102.40234375, 153.5)" id="flowchart-V2_R-7" class="node default"><rect height="47" width="118.8046875" y="-23.5" x="-59.40234375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Right</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> v2</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>Version 2 shares the unchanged left subtree with Version 1. This enables:</p>
<ul>
<li>Undo/redo by keeping old root references</li>
<li>Concurrent reads without locks</li>
<li>Cheap snapshots</li>
</ul>
<h2 id="fresh-vs-vs-code">Fresh vs VS Code</h2>
<p><a href="https://github.com/microsoft/vscode-textbuffer">VS Code also uses a piece tree</a>. The core data structure is nearly identical - both cache byte counts and line counts per node for O(log N) lookups. The key difference is in tree mutability.</p>
<p><strong>VS Code</strong>: Mutable tree. Pieces themselves are immutable, but tree nodes are modified in place during rebalancing. After an edit, VS Code propagates size and line-count changes up to the root. Undo/redo requires a separate operation log.</p>
<p><strong>Fresh</strong>: Fully immutable tree. Edits produce new tree versions via path-copying - only nodes along the modified path are recreated, while unchanged subtrees are shared between versions. (This is a <a href="https://en.wikipedia.org/wiki/Persistent_data_structure">persistent data structure</a>.)</p>
<h3 id="inherent-trade-offs">Inherent Trade-offs</h3>
<p><strong>Immutable (Fresh):</strong></p>
<ul>
<li>Old tree versions stay valid - enables cheap snapshots and structural sharing</li>
<li>Concurrent reads need no synchronization</li>
<li>Undo can be "keep the old root" instead of "replay operations backward"</li>
<li>More allocations per edit (new nodes along modified path)</li>
</ul>
<p><strong>Mutable (VS Code):</strong></p>
<ul>
<li>Edits modify in place - less allocation overhead</li>
<li>Has a search cache to accelerate repeated position lookups</li>
<li>Requires separate undo infrastructure</li>
<li>Concurrent access needs synchronization</li>
</ul>
<p><strong>Lazy loading</strong> is orthogonal to mutability, but Fresh implements it and VS Code doesn't. Fresh can leave file regions on disk until accessed; VS Code loads the entire file into memory.</p>
<h2 id="comparison-piece-tree-vs-rope">Comparison: Piece Tree vs Rope</h2>
<p>Different editors use different text storage structures:</p>
<ul>
<li><strong>Piece tree</strong>: VS Code, Fresh</li>
<li><strong>Rope</strong>: Helix (uses <a href="https://github.com/cessen/ropey">Ropey</a>), Zed (custom <a href="https://zed.dev/blog/zed-decoded-rope-sumtree">SumTree</a>)</li>
<li><strong>Gap buffer</strong>: Emacs</li>
<li><strong>Line array</strong>: Vim, Neovim</li>
</ul>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Piece Tree (Fresh, VS Code)</th>
<th>Rope (Helix, Zed)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Node contents</td>
<td>Pointer to buffer</td>
<td>Actual text (~1KB chunks)</td>
</tr>
<tr>
<td>Insert</td>
<td>Append to buffer, add piece</td>
<td>May copy/split chunk</td>
</tr>
<tr>
<td>Original file</td>
<td>Preserved in buffer 0</td>
<td>Reorganized into chunks</td>
</tr>
<tr>
<td>Large files</td>
<td>Lazy load regions (Fresh, Word 1.1a)</td>
<td>Must load or stream</td>
</tr>
<tr>
<td>Memory for edits</td>
<td>Minimal (just pointers)</td>
<td>Copies chunk data</td>
</tr>
</tbody>
</table>
<h2 id="trade-offs">Trade-offs</h2>
<p><strong>Advantages:</strong></p>
<ul>
<li>Original file content preserved (useful for diffs, minimal saves)</li>
<li>Inserts never copy existing text</li>
<li>Natural lazy loading for large files</li>
<li>Pieces are small (~24 bytes) - more fit in CPU cache during tree traversal</li>
</ul>
<p><strong>Disadvantages:</strong></p>
<ul>
<li>Extra indirection: find piece, then fetch from buffer</li>
<li>Buffer fragmentation over many edits (many small buffers)</li>
<li>Cache locality for text is poor (data scattered across buffers)</li>
<li>No automatic chunk coalescing (piece count grows with edits)</li>
</ul>
<p><em>(Note: Fresh's current implementation doesn't fully exploit immutability - it rebuilds the entire tree on each edit rather than path-copying, making edits O(P) instead of O(log P). VS Code has additional optimizations like search caching and line content caching that Fresh lacks. These are implementation gaps, not inherent to the designs.)</em></p>
<h2 id="further-reading">Further Reading</h2>
<ul>
<li><a href="https://sinelaw.github.io/fresh/">Fresh</a> - The editor discussed in this post (<a href="https://github.com/sinelaw/fresh">source on GitHub</a>)</li>
<li><a href="https://computerhistory.org/blog/microsoft-word-for-windows-1-1a-source-code/">Microsoft Word 1.1a Source Code</a> - Original piece table implementation from 1990</li>
<li><a href="https://code.visualstudio.com/blogs/2018/03/23/text-buffer-reimplementation">VS Code's Piece Table</a> - Microsoft's 2018 write-up on reviving piece tables</li>
<li><a href="https://zed.dev/blog/zed-decoded-rope-sumtree">Zed's Rope &amp; SumTree</a> - How Zed implements ropes with B+ trees</li>
<li><a href="https://coredumped.dev/2023/08/09/text-showdown-gap-buffers-vs-ropes/">Text Showdown: Gap Buffers vs Ropes</a> - Performance comparison</li>
<li><a href="https://www.cs.unm.edu/~crowley/papers/sds.pdf">Data Structures for Text Sequences</a> - Charles Crowley, 1998 (academic survey)</li>
</ul>
]]></content><author><name></name></author></entry><entry><title type="html">How Fresh Loads Huge Files Fast</title><link href="/blog/2025/12/08/how-fresh-loads-huge-files-fast.html" rel="alternate" type="text/html" title="How Fresh Loads Huge Files Fast" /><published>2025-12-08T23:10:20+00:00</published><updated>2025-12-08T23:10:20+00:00</updated><id>/blog/2025/12/08/how-fresh-loads-huge-files-fast.html</id><content type="html" xml:base="/blog/2025/12/08/how-fresh-loads-huge-files-fast.html"><![CDATA[<h1 id="how-fresh-loads-huge-files-fast">How Fresh Loads Huge Files Fast</h1>
<p>Fresh uses a <strong>piece tree</strong> (also called a piece table) for text storage. The piece table originated in the early 1970s - first in <a href="https://www.computerhistory.org/collections/catalog/102740449">J. Strother Moore and Bob Boyer's "77-Editor" at Edinburgh</a> (1971-1973), where they applied structure-sharing techniques from their theorem proving research to text editing. Moore later brought the idea to Xerox PARC, where Charles Simonyi adopted it for the <a href="https://en.wikipedia.org/wiki/Bravo_(editor)">Bravo editor</a> (1974). Simonyi later <a href="https://www.tiny.cloud/blog/wysiwyg-development-history/">brought it to Microsoft Word</a> (1983). The design minimizes memory copying by never modifying original file content - critical for early systems with limited RAM. <a href="https://code.visualstudio.com/blogs/2018/03/23/text-buffer-reimplementation">VS Code revived this approach in 2018</a>.</p>
<p><a href="https://sinelaw.github.io/fresh/">Fresh</a>'s implementation adds immutable nodes (for concurrency and cheap snapshots) and lazy loading (for large files). (<a href="https://github.com/sinelaw/fresh">GitHub</a>)</p>
<h2 id="the-core-idea">The Core Idea</h2>
<p>Instead of storing text in the tree, store <strong>pointers</strong> to text that lives elsewhere.</p>
<h3 id="rope-helix-zed">Rope (<a href="https://github.com/helix-editor/helix/blob/master/docs/architecture.md">Helix</a>, <a href="https://zed.dev/blog/zed-decoded-rope-sumtree">Zed</a>)</h3>
<p>Text lives inside tree nodes:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 360.703125 160" style="max-width: 360.703px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_L_0" d="M132.395,55L123.918,59.167C115.44,63.333,98.486,71.667,90.009,79.333C81.531,87,81.531,94,81.531,97.5L81.531,101"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_R_0" d="M228.019,55L236.496,59.167C244.974,63.333,261.928,71.667,270.406,79.333C278.883,87,278.883,94,278.883,97.5L278.883,101"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(180.20703125, 31.5)" id="flowchart-Root-0" class="node default"><rect height="47" width="156.171875" y="-23.5" x="-78.0859375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> Node</tspan></tspan></text></g></g></g><g transform="translate(81.53125, 128.5)" id="flowchart-L-2" class="node default"><rect height="47" width="147.0625" y="-23.5" x="-73.53125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Leaf:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> '</tspan></tspan></text></g></g></g><g transform="translate(278.8828125, 128.5)" id="flowchart-R-4" class="node default"><rect height="47" width="147.640625" y="-23.5" x="-73.8203125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Leaf:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'World'</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<h3 id="piece-tree-fresh">Piece Tree (Fresh)</h3>
<p>Tree nodes point to separate buffers:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 644.46875 374.6000061035156" style="max-width: 644.469px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="97" width="475.8203125" y="269.5999984741211" x="79.32421875" style=""/><g transform="translate(292.03125, 269.5999984741211)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="211.5999984741211" width="628.46875" y="8" x="8" style=""/><g transform="translate(306.03125, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_L_0" d="M248.528,80L235.46,84.167C222.391,88.333,196.254,96.667,183.186,104.333C170.117,112,170.117,119,170.117,122.5L170.117,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_R_0" d="M395.941,80L409.009,84.167C422.078,88.333,448.215,96.667,461.283,104.333C474.352,112,474.352,119,474.352,122.5L474.352,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_L_B0_0" d="M170.117,194.6L170.117,198.767C170.117,202.933,170.117,211.267,170.117,219.6C170.117,227.933,170.117,236.267,170.117,244.6C170.117,252.933,170.117,261.267,182.551,269.397C194.984,277.528,219.85,285.457,232.284,289.421L244.717,293.385"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_R_B0_0" d="M474.352,194.6L474.352,198.767C474.352,202.933,474.352,211.267,474.352,219.6C474.352,227.933,474.352,236.267,474.352,244.6C474.352,252.933,474.352,261.267,461.918,269.397C449.485,277.528,424.618,285.457,412.185,289.421L399.752,293.385"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(322.234375, 56.5)" id="flowchart-Root-0" class="node default"><rect height="47" width="156.171875" y="-23.5" x="-78.0859375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> Node</tspan></tspan></text></g></g></g><g transform="translate(170.1171875, 162.29999923706055)" id="flowchart-L-2" class="node default"><rect height="64.5999984741211" width="254.234375" y="-32.29999923706055" x="-127.1171875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> offset</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> len</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">6</tspan></tspan></text></g></g></g><g transform="translate(474.3515625, 162.29999923706055)" id="flowchart-R-4" class="node default"><rect height="64.5999984741211" width="254.234375" y="-32.29999923706055" x="-127.1171875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> offset</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 6,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> len</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">5</tspan></tspan></text></g></g></g><g transform="translate(322.234375, 318.0999984741211)" id="flowchart-B0-5" class="node default"><rect height="47" width="213.171875" y="-23.5" x="-106.5859375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> World'</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>A <strong>piece</strong> is just three numbers: which buffer, starting offset, and length.</p>
<h2 id="what-happens-when-you-edit">What Happens When You Edit</h2>
<p>When you type or paste, Fresh appends to a new buffer and creates a piece pointing to it. The original buffer stays untouched.</p>
<h3 id="before-file-contains-hello-world">Before: File contains "Hello World"</h3>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 581.2890625 150.59999084472656" style="max-width: 581.289px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="134.5999984741211" width="280.953125" y="8" x="292.3359375" style=""/><g transform="translate(407.609375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="117" width="234.3359375" y="16.799999237060547" x="8" style=""/><g transform="translate(108.96484375, 16.799999237060547)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M217.336,75.3L221.503,75.3C225.669,75.3,234.003,75.3,242.336,75.3C250.669,75.3,259.003,75.3,267.336,75.3C275.669,75.3,284.003,75.3,291.669,75.3C299.336,75.3,306.336,75.3,309.836,75.3L313.336,75.3"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(125.16796875, 75.29999923706055)" id="flowchart-P1-0" class="node default"><rect height="47" width="184.3359375" y="-23.5" x="-92.16796875" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-11</tspan></tspan></text></g></g></g><g transform="translate(432.8125, 75.29999923706055)" id="flowchart-B0-1" class="node default"><rect height="64.5999984741211" width="230.953125" y="-32.29999923706055" x="-115.4765625" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (original):</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">World'</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<h3 id="after-insert-big--at-position-6">After: Insert "Big " at position 6</h3>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 581.2890625 331.3999938964844" style="max-width: 581.289px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="310.54999923706055" width="280.953125" y="12.850000381469727" x="292.3359375" style=""/><g transform="translate(407.609375, 12.850000381469727)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="315.3999996185303" width="234.3359375" y="8" x="8" style=""/><g transform="translate(108.96484375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M213.48,66.5L218.29,66.5C223.099,66.5,232.717,66.5,241.693,66.5C250.669,66.5,259.003,66.5,267.336,66.5C275.669,66.5,284.003,66.5,295.359,68.982C306.716,71.465,321.097,76.43,328.287,78.912L335.477,81.395"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P2_B1_0" d="M213.48,264.9L218.29,264.9C223.099,264.9,232.717,264.9,241.693,264.9C250.669,264.9,259.003,264.9,267.336,264.9C275.669,264.9,284.003,264.9,292.755,264.9C301.508,264.9,310.68,264.9,315.266,264.9L319.852,264.9"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P3_B0_0" d="M217.336,163.5L221.503,163.5C225.669,163.5,234.003,163.5,242.336,163.5C250.669,163.5,259.003,163.5,267.336,163.5C275.669,163.5,284.003,163.5,295.359,161.018C306.716,158.535,321.097,153.57,328.287,151.088L335.477,148.605"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(125.16796875, 66.5)" id="flowchart-P1-0" class="node default"><rect height="47" width="176.625" y="-23.5" x="-88.3125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-6</tspan></tspan></text></g></g></g><g transform="translate(125.16796875, 264.8999996185303)" id="flowchart-P2-1" class="node default"><rect height="47" width="176.625" y="-23.5" x="-88.3125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-4</tspan></tspan></text></g></g></g><g transform="translate(125.16796875, 163.5)" id="flowchart-P3-2" class="node default"><rect height="47" width="184.3359375" y="-23.5" x="-92.16796875" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 6-11</tspan></tspan></text></g></g></g><g transform="translate(432.8125, 115)" id="flowchart-B0-3" class="node default"><rect height="64.5999984741211" width="230.953125" y="-32.29999923706055" x="-115.4765625" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (original):</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">World'</tspan></tspan></text></g></g></g><g transform="translate(432.8125, 264.8999996185303)" id="flowchart-B1-4" class="node default"><rect height="47" width="217.921875" y="-23.5" x="-108.9609375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (added):</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Big</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> '</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>Document now reads: "Hello Big World"</p>
<p>The original file content in Buffer 0 was never modified or copied.</p>
<h2 id="lazy-loading">Lazy Loading</h2>
<p>For large files, Fresh doesn't load the entire file into memory. Buffers can be <strong>unloaded</strong> - they store a file path and byte range instead of actual data.</p>
<p>This is actually how the original <a href="https://computerhistory.org/blog/microsoft-word-for-windows-1-1a-source-code/">Word 1.1a</a> piece table worked: pieces pointed directly to spans in the original file on disk, loading content only when needed. VS Code's 2018 implementation loads files fully into memory; Fresh returns to the original memory-conscious design.</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 835.59375 312.79998779296875" style="max-width: 835.594px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="149.8000030517578" width="607.578125" y="155" x="96.0078125" style=""/><g transform="translate(374.59375, 155)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="97" width="819.59375" y="8" x="8" style=""/><g transform="translate(401.59375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M143.266,80L143.266,84.167C143.266,88.333,143.266,96.667,143.266,105C143.266,113.333,143.266,121.667,143.266,130C143.266,138.333,143.266,146.667,168.583,158.056C193.9,169.446,244.535,183.892,269.852,191.115L295.169,198.338"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P2_B0_0" d="M405.797,80L405.797,84.167C405.797,88.333,405.797,96.667,405.797,105C405.797,113.333,405.797,121.667,405.797,130C405.797,138.333,405.797,146.667,405.797,154.333C405.797,162,405.797,169,405.797,172.5L405.797,176"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P3_B0_0" d="M680.328,80L680.328,84.167C680.328,88.333,680.328,96.667,680.328,105C680.328,113.333,680.328,121.667,680.328,130C680.328,138.333,680.328,146.667,653.013,158.286C625.698,169.905,571.067,184.809,543.752,192.262L516.437,199.714"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(143.265625, 56.5)" id="flowchart-P1-0" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(405.796875, 56.5)" id="flowchart-P2-1" class="node default"><rect height="47" width="224.53125" y="-23.5" x="-112.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1MB-2MB</tspan></tspan></text></g></g></g><g transform="translate(680.328125, 56.5)" id="flowchart-P3-2" class="node default"><rect height="47" width="224.53125" y="-23.5" x="-112.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2MB-3MB</tspan></tspan></text></g></g></g><g transform="translate(405.796875, 229.9000015258789)" id="flowchart-B0-3" class="node default"><rect height="99.80000305175781" width="213.5625" y="-49.900001525878906" x="-106.78125" style="" class="basic label-container"/><g transform="translate(0, -34.900001525878906)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">file:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> /path/to/large.txt</tspan></tspan><tspan dy="1.1em" y="2.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">offset:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0</tspan></tspan><tspan dy="1.1em" y="3.2em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 3MB</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>When you scroll to a region, Fresh loads only that chunk from disk:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 315.53125 397.3999938964844" style="max-width: 315.531px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"/><g class="edgeLabels"/><g class="nodes"><g transform="translate(0, 0)" class="root"><g class="clusters"><g data-look="classic" id="subGraph0" class="cluster"><rect height="381.3999938964844" width="299.53125" y="8" x="8" style=""/><g transform="translate(74.55859375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">After</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> scrolling</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> to</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> middle</tspan></tspan></text></g></g></g></g><g class="edgePaths"/><g class="edgeLabels"/><g class="nodes"><g transform="translate(157.765625, 75.29999923706055)" id="flowchart-B0_new-0" class="node default"><rect height="64.5999984741211" width="213.5625" y="-32.29999923706055" x="-106.78125" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">(0-1MB)</tspan></tspan></text></g></g></g><g transform="translate(157.765625, 198.6999969482422)" id="flowchart-B1_new-1" class="node default"><rect height="82.19999694824219" width="224.53125" y="-41.099998474121094" x="-112.265625" style="" class="basic label-container"/><g transform="translate(0, -26.099998474121094)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> LOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">(1MB-2MB)</tspan></tspan><tspan dy="1.1em" y="2.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">actual</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> in</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> memory</tspan></tspan></text></g></g></g><g transform="translate(157.765625, 322.0999946594238)" id="flowchart-B2_new-2" class="node default"><rect height="64.5999984741211" width="213.5625" y="-32.29999923706055" x="-106.78125" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">(2MB-3MB)</tspan></tspan></text></g></g></g></g></g></g></g></g></svg></p>
<h2 id="zero-copy-reads">Zero-Copy Reads</h2>
<p>When reading text for display, Fresh doesn't copy bytes. It returns slices pointing directly into the buffers:</p>
<pre class="rust"><code>// Returns &amp;[u8] pointing into buffer memory
// No allocation, no copy
let text = buffer.get_text_range(100, 200);</code></pre>
<p>Multiple pieces can reference the same buffer region. Displaying the same text twice doesn't double memory usage.</p>
<h2 id="the-tree-structure">The Tree Structure</h2>
<p>The pieces are organized in a balanced binary tree for fast lookups:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 507.453125 294.20001220703125" style="max-width: 507.453px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_I2_0" d="M248.328,73.6L240.675,77.767C233.021,81.933,217.714,90.267,210.06,97.933C202.406,105.6,202.406,112.6,202.406,116.1L202.406,119.6"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_L3_0" d="M368.828,73.6L376.482,77.767C384.135,81.933,399.443,90.267,407.096,99.483C414.75,108.7,414.75,118.8,414.75,123.85L414.75,128.9"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L1_0" d="M140.153,189.2L132.244,193.367C124.336,197.533,108.52,205.867,100.611,213.533C92.703,221.2,92.703,228.2,92.703,231.7L92.703,235.2"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L2_0" d="M264.66,189.2L272.568,193.367C280.476,197.533,296.293,205.867,304.201,213.533C312.109,221.2,312.109,228.2,312.109,231.7L312.109,235.2"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(308.578125, 40.79999923706055)" id="flowchart-I1-0" class="node default"><rect height="65.5999984741211" width="164.1796875" y="-32.79999923706055" x="-82.08984375" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 100</tspan></tspan></text></g></g></g><g transform="translate(202.40625, 156.39999771118164)" id="flowchart-I2-2" class="node default"><rect height="65.5999984741211" width="155.28125" y="-32.79999923706055" x="-77.640625" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan></tspan></text></g></g></g><g transform="translate(414.75, 156.39999771118164)" id="flowchart-L3-4" class="node default"><rect height="47" width="169.40625" y="-23.5" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan></text></g></g></g><g transform="translate(92.703125, 262.6999969482422)" id="flowchart-L1-6" class="node default"><rect height="47" width="169.40625" y="-23.5" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan></text></g></g></g><g transform="translate(312.109375, 262.6999969482422)" id="flowchart-L2-8" class="node default"><rect height="47" width="169.40625" y="-23.5" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>Each internal node caches the total bytes in its left subtree. To find byte offset 75:</p>
<ol type="1">
<li>Root has <code>left_bytes: 100</code>, and 75 &lt; 100, so go left</li>
<li>Internal has <code>left_bytes: 50</code>, and 75 &gt;= 50, so go right with offset 75-50=25</li>
<li>Piece has 50 bytes, offset 25 is within it</li>
</ol>
<p>This is O(log P) where P is the number of pieces.</p>
<h2 id="line-feed-tracking">Line Feed Tracking</h2>
<p>Text editors need fast line-based operations: "go to line 1000", "what line is byte offset 50000 on?", or simply displaying line numbers. Scanning the entire document for newlines would be O(N) - too slow for large files.</p>
<p>Fresh tracks line feeds the same way it tracks bytes. Each piece stores its newline count, and internal nodes cache the count for their left subtree:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 507.453125 348" style="max-width: 507.453px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_I2_0" d="M242.261,91.2L235.618,95.367C228.976,99.533,215.691,107.867,209.049,115.533C202.406,123.2,202.406,130.2,202.406,133.7L202.406,137.2"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_L3_0" d="M374.896,91.2L381.538,95.367C388.18,99.533,401.465,107.867,408.108,117C414.75,126.133,414.75,136.067,414.75,141.033L414.75,146"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L1_0" d="M133.883,224.4L127.02,228.567C120.156,232.733,106.43,241.067,99.566,248.733C92.703,256.4,92.703,263.4,92.703,266.9L92.703,270.4"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L2_0" d="M270.93,224.4L277.793,228.567C284.656,232.733,298.383,241.067,305.246,248.733C312.109,256.4,312.109,263.4,312.109,266.9L312.109,270.4"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(308.578125, 49.599998474121094)" id="flowchart-I1-0" class="node default"><rect height="83.19999694824219" width="164.1796875" y="-41.599998474121094" x="-82.08984375" style="" class="basic label-container"/><g transform="translate(0, -26.599998474121094)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 100</tspan></tspan><tspan dy="1.1em" y="2.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">lf_left:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 3</tspan></tspan></text></g></g></g><g transform="translate(202.40625, 182.79999542236328)" id="flowchart-I2-2" class="node default"><rect height="83.19999694824219" width="155.28125" y="-41.599998474121094" x="-77.640625" style="" class="basic label-container"/><g transform="translate(0, -26.599998474121094)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan></tspan><tspan dy="1.1em" y="2.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">lf_left:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2</tspan></tspan></text></g></g></g><g transform="translate(414.75, 182.79999542236328)" id="flowchart-L3-4" class="node default"><rect height="65.5999984741211" width="169.40625" y="-32.79999923706055" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">line_feeds:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1</tspan></tspan></text></g></g></g><g transform="translate(92.703125, 307.1999931335449)" id="flowchart-L1-6" class="node default"><rect height="65.5999984741211" width="169.40625" y="-32.79999923706055" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 30</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">line_feeds:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2</tspan></tspan></text></g></g></g><g transform="translate(312.109375, 307.1999931335449)" id="flowchart-L2-8" class="node default"><rect height="65.5999984741211" width="169.40625" y="-32.79999923706055" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 20</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">line_feeds:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>To find which piece contains line 3:</p>
<ol type="1">
<li>Root has <code>lf_left: 3</code>, and 3 &gt;= 3, so go right with line 3-3=0</li>
<li>Piece L3 has <code>line_feeds: 1</code>, line 0 is within it</li>
</ol>
<p>This enables O(log P) line-to-offset conversion. The same structure supports offset-to-line lookup by accumulating line counts while traversing.</p>
<p>For large files where line indexing hasn't been computed (lazy loading), these counts are <code>None</code> and Fresh falls back to scanning. Once a region is loaded and indexed, the counts become available.</p>
<h2 id="immutable-tree-structure">Immutable Tree Structure</h2>
<p>Fresh uses immutable nodes - once created, a node is never modified. Edits create new nodes instead.</p>
<blockquote>
<p><strong>Implementation note:</strong> Fresh is written in Rust. Nodes are wrapped in <code>Arc&lt;T&gt;</code> (Atomic Reference Counted pointer) - think of it as a pointer that tracks how many things reference it. Multiple parts of the code (even different threads) can safely hold the same <code>Arc</code>, and the data is automatically freed when the last reference is dropped. We'll gloss over this detail going forward - just know that "sharing" a node is cheap and thread-safe.</p>
</blockquote>
<p>After an edit, old tree versions remain valid:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 550.396484375 210" style="max-width: 550.396px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="subGraph1" class="cluster"><rect height="194" width="197.9140625" y="8" x="8" style=""/><g transform="translate(34.91015625, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Version</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (after</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> edit)</tspan></tspan></text></g></g></g><g data-look="classic" id="subGraph0" class="cluster"><rect height="194" width="316.482421875" y="8" x="225.9140625" style=""/><g transform="translate(305.4365234375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Version</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (before</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> edit)</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V1_Root_V1_L_0" d="M348.281,80L342.157,84.167C336.032,88.333,323.784,96.667,317.659,104.333C311.535,112,311.535,119,311.535,122.5L311.535,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V1_Root_V1_R_0" d="M417.363,80L423.488,84.167C429.612,88.333,441.861,96.667,447.985,104.333C454.109,112,454.109,119,454.109,122.5L454.109,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V2_Root_V1_L_0" d="M130.428,80L133.624,84.167C136.82,88.333,143.212,96.667,165.487,106.548C187.763,116.429,225.923,127.858,245.002,133.573L264.082,139.287"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V2_Root_V2_R_0" d="M107.557,80L106.698,84.167C105.839,88.333,104.121,96.667,103.261,104.333C102.402,112,102.402,119,102.402,122.5L102.402,126"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(382.822265625, 56.5)" id="flowchart-V1_Root-0" class="node default"><rect height="47" width="115.2421875" y="-23.5" x="-57.62109375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Root</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> v1</tspan></tspan></text></g></g></g><g transform="translate(311.53515625, 153.5)" id="flowchart-V1_L-1" class="node default"><rect height="47" width="87.2421875" y="-23.5" x="-43.62109375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Left</tspan></tspan></text></g></g></g><g transform="translate(454.109375, 153.5)" id="flowchart-V1_R-3" class="node default"><rect height="47" width="97.90625" y="-23.5" x="-48.953125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Right</tspan></tspan></text></g></g></g><g transform="translate(112.40234375, 56.5)" id="flowchart-V2_Root-4" class="node default"><rect height="47" width="115.2421875" y="-23.5" x="-57.62109375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Root</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> v2</tspan></tspan></text></g></g></g><g transform="translate(102.40234375, 153.5)" id="flowchart-V2_R-7" class="node default"><rect height="47" width="118.8046875" y="-23.5" x="-59.40234375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Right</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> v2</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>Version 2 shares the unchanged left subtree with Version 1. This enables:</p>
<ul>
<li>Undo/redo by keeping old root references</li>
<li>Concurrent reads without locks</li>
<li>Cheap snapshots</li>
</ul>
<h2 id="fresh-vs-vs-code">Fresh vs VS Code</h2>
<p><a href="https://github.com/microsoft/vscode-textbuffer">VS Code also uses a piece tree</a>. The core data structure is nearly identical - both track <code>size_left</code>/<code>left_bytes</code> and <code>lf_left</code> per node for O(log N) lookups. The key difference is in tree mutability.</p>
<p><strong>VS Code</strong>: Mutable red-black tree. Pieces themselves are immutable (edits create new <code>Piece</code> objects), but tree nodes are modified in place during rotations. After an edit, VS Code calls <code>updateTreeMetadata()</code> to propagate size/line-count deltas up to the root. Undo/redo requires a separate operation log.</p>
<p><strong>Fresh</strong>: Fully immutable (persistent) tree. Both pieces and tree nodes are wrapped in <code>Arc&lt;T&gt;</code>. Edits produce new tree versions via path-copying - only nodes along the modified path are recreated, while unchanged subtrees are shared. (This is a <a href="https://en.wikipedia.org/wiki/Persistent_data_structure">persistent data structure</a> in CS literature.)</p>
<h3 id="inherent-trade-offs">Inherent Trade-offs</h3>
<p><strong>Immutable (Fresh):</strong></p>
<ul>
<li>Old tree versions stay valid - enables cheap snapshots and structural sharing</li>
<li>Concurrent reads need no synchronization (each thread can hold its own <code>Arc</code> to any version)</li>
<li>Undo can be "keep the old root" instead of "replay operations backward"</li>
<li>More allocations per edit (new nodes along modified path)</li>
</ul>
<p><strong>Mutable (VS Code):</strong></p>
<ul>
<li>Edits modify in place - less allocation overhead</li>
<li>Has a search cache (<code>PieceTreeSearchCache</code>) to accelerate repeated position lookups</li>
<li>Requires separate undo infrastructure</li>
<li>Concurrent access needs synchronization</li>
</ul>
<p><strong>Lazy loading</strong> is orthogonal to mutability, but Fresh implements it and VS Code doesn't. Fresh can leave file regions on disk until accessed; VS Code loads the entire file into memory. (The VS Code blog notes this as a limitation: "each time we receive a 64KB chunk from disk, we push it directly to the buffers array.")</p>
<h2 id="comparison-piece-tree-vs-rope">Comparison: Piece Tree vs Rope</h2>
<p>Different editors use different text storage structures:</p>
<ul>
<li><strong>Piece tree</strong>: VS Code, Fresh</li>
<li><strong>Rope</strong>: Helix (uses <a href="https://github.com/cessen/ropey">Ropey</a>), Zed (custom <a href="https://zed.dev/blog/zed-decoded-rope-sumtree">SumTree</a>)</li>
<li><strong>Gap buffer</strong>: Emacs</li>
<li><strong>Line array</strong>: Vim, Neovim</li>
</ul>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Piece Tree (Fresh, VS Code)</th>
<th>Rope (Helix, Zed)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Node contents</td>
<td>Pointer to buffer</td>
<td>Actual text (~1KB chunks)</td>
</tr>
<tr>
<td>Insert</td>
<td>Append to buffer, add piece</td>
<td>May copy/split chunk</td>
</tr>
<tr>
<td>Original file</td>
<td>Preserved in buffer 0</td>
<td>Reorganized into chunks</td>
</tr>
<tr>
<td>Large files</td>
<td>Lazy load regions (Fresh, Word 1.1a)</td>
<td>Must load or stream</td>
</tr>
<tr>
<td>Memory for edits</td>
<td>Minimal (just pointers)</td>
<td>Copies chunk data</td>
</tr>
</tbody>
</table>
<h2 id="trade-offs">Trade-offs</h2>
<p><strong>Advantages:</strong></p>
<ul>
<li>Original file content preserved (useful for diffs, minimal saves)</li>
<li>Inserts never copy existing text</li>
<li>Natural lazy loading for large files</li>
<li>Pieces are small (~24 bytes) - more fit in CPU cache during tree traversal</li>
</ul>
<p><strong>Disadvantages:</strong></p>
<ul>
<li>Extra indirection: find piece, then fetch from buffer</li>
<li>Buffer fragmentation over many edits (many small buffers)</li>
<li>Cache locality for text is poor (data scattered across buffers)</li>
<li>No automatic chunk coalescing (piece count grows with edits)</li>
</ul>
<p><em>(Note: Fresh's current implementation doesn't fully exploit immutability - it rebuilds the entire tree on each edit rather than path-copying, making edits O(P) instead of O(log P). VS Code has additional optimizations like search caching and line content caching that Fresh lacks. These are implementation gaps, not inherent to the designs.)</em></p>
<h2 id="further-reading">Further Reading</h2>
<ul>
<li><a href="https://sinelaw.github.io/fresh/">Fresh</a> - The editor discussed in this post (<a href="https://github.com/sinelaw/fresh">source on GitHub</a>)</li>
<li><a href="https://computerhistory.org/blog/microsoft-word-for-windows-1-1a-source-code/">Microsoft Word 1.1a Source Code</a> - Original piece table implementation from 1990</li>
<li><a href="https://code.visualstudio.com/blogs/2018/03/23/text-buffer-reimplementation">VS Code's Piece Table</a> - Microsoft's 2018 write-up on reviving piece tables</li>
<li><a href="https://zed.dev/blog/zed-decoded-rope-sumtree">Zed's Rope &amp; SumTree</a> - How Zed implements ropes with B+ trees</li>
<li><a href="https://coredumped.dev/2023/08/09/text-showdown-gap-buffers-vs-ropes/">Text Showdown: Gap Buffers vs Ropes</a> - Performance comparison</li>
<li><a href="https://www.cs.unm.edu/~crowley/papers/sds.pdf">Data Structures for Text Sequences</a> - Charles Crowley, 1998 (academic survey)</li>
</ul>
]]></content><author><name></name></author></entry><entry><title type="html">How Fresh Loads Huge Files Fast</title><link href="/blog/2025/12/08/how-fresh-loads-huge-files-fast.html" rel="alternate" type="text/html" title="How Fresh Loads Huge Files Fast" /><published>2025-12-08T23:08:00+00:00</published><updated>2025-12-08T23:08:00+00:00</updated><id>/blog/2025/12/08/how-fresh-loads-huge-files-fast.html</id><content type="html" xml:base="/blog/2025/12/08/how-fresh-loads-huge-files-fast.html"><![CDATA[<h1 id="how-fresh-loads-huge-files-fast">How Fresh Loads Huge Files Fast</h1>
<p>Fresh uses a <strong>piece tree</strong> (also called a piece table) for text storage. The piece table originated in the early 1970s - first in <a href="https://www.computerhistory.org/collections/catalog/102740449">J. Strother Moore and Bob Boyer's "77-Editor" at Edinburgh</a> (1971-1973), where they applied structure-sharing techniques from their theorem proving research to text editing. Moore later brought the idea to Xerox PARC, where Charles Simonyi adopted it for the <a href="https://en.wikipedia.org/wiki/Bravo_(editor)">Bravo editor</a> (1974). Simonyi later <a href="https://www.tiny.cloud/blog/wysiwyg-development-history/">brought it to Microsoft Word</a> (1983). The design minimizes memory copying by never modifying original file content - critical for early systems with limited RAM. <a href="https://code.visualstudio.com/blogs/2018/03/23/text-buffer-reimplementation">VS Code revived this approach in 2018</a>.</p>
<p><a href="https://sinelaw.github.io/fresh/">Fresh</a>'s implementation adds immutable nodes (for concurrency and cheap snapshots) and lazy loading (for large files). (<a href="https://github.com/sinelaw/fresh">GitHub</a>)</p>
<h2 id="the-core-idea">The Core Idea</h2>
<p>Instead of storing text in the tree, store <strong>pointers</strong> to text that lives elsewhere.</p>
<h3 id="rope-helix-zed">Rope (<a href="https://github.com/helix-editor/helix/blob/master/docs/architecture.md">Helix</a>, <a href="https://zed.dev/blog/zed-decoded-rope-sumtree">Zed</a>)</h3>
<p>Text lives inside tree nodes:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 360.703125 160" style="max-width: 360.703px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_L_0" d="M132.395,55L123.918,59.167C115.44,63.333,98.486,71.667,90.009,79.333C81.531,87,81.531,94,81.531,97.5L81.531,101"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_R_0" d="M228.019,55L236.496,59.167C244.974,63.333,261.928,71.667,270.406,79.333C278.883,87,278.883,94,278.883,97.5L278.883,101"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(180.20703125, 31.5)" id="flowchart-Root-0" class="node default"><rect height="47" width="156.171875" y="-23.5" x="-78.0859375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> Node</tspan></tspan></text></g></g></g><g transform="translate(81.53125, 128.5)" id="flowchart-L-2" class="node default"><rect height="47" width="147.0625" y="-23.5" x="-73.53125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Leaf:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> '</tspan></tspan></text></g></g></g><g transform="translate(278.8828125, 128.5)" id="flowchart-R-4" class="node default"><rect height="47" width="147.640625" y="-23.5" x="-73.8203125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Leaf:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'World'</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<h3 id="piece-tree-fresh">Piece Tree (Fresh)</h3>
<p>Tree nodes point to separate buffers:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 644.46875 374.6000061035156" style="max-width: 644.469px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="97" width="475.8203125" y="269.5999984741211" x="79.32421875" style=""/><g transform="translate(292.03125, 269.5999984741211)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="211.5999984741211" width="628.46875" y="8" x="8" style=""/><g transform="translate(306.03125, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_L_0" d="M248.528,80L235.46,84.167C222.391,88.333,196.254,96.667,183.186,104.333C170.117,112,170.117,119,170.117,122.5L170.117,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_R_0" d="M395.941,80L409.009,84.167C422.078,88.333,448.215,96.667,461.283,104.333C474.352,112,474.352,119,474.352,122.5L474.352,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_L_B0_0" d="M170.117,194.6L170.117,198.767C170.117,202.933,170.117,211.267,170.117,219.6C170.117,227.933,170.117,236.267,170.117,244.6C170.117,252.933,170.117,261.267,182.551,269.397C194.984,277.528,219.85,285.457,232.284,289.421L244.717,293.385"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_R_B0_0" d="M474.352,194.6L474.352,198.767C474.352,202.933,474.352,211.267,474.352,219.6C474.352,227.933,474.352,236.267,474.352,244.6C474.352,252.933,474.352,261.267,461.918,269.397C449.485,277.528,424.618,285.457,412.185,289.421L399.752,293.385"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(322.234375, 56.5)" id="flowchart-Root-0" class="node default"><rect height="47" width="156.171875" y="-23.5" x="-78.0859375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> Node</tspan></tspan></text></g></g></g><g transform="translate(170.1171875, 162.29999923706055)" id="flowchart-L-2" class="node default"><rect height="64.5999984741211" width="254.234375" y="-32.29999923706055" x="-127.1171875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> offset</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> len</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">6</tspan></tspan></text></g></g></g><g transform="translate(474.3515625, 162.29999923706055)" id="flowchart-R-4" class="node default"><rect height="64.5999984741211" width="254.234375" y="-32.29999923706055" x="-127.1171875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> offset</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 6,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> len</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">5</tspan></tspan></text></g></g></g><g transform="translate(322.234375, 318.0999984741211)" id="flowchart-B0-5" class="node default"><rect height="47" width="213.171875" y="-23.5" x="-106.5859375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> World'</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>A <strong>piece</strong> is just three numbers: which buffer, starting offset, and length.</p>
<h2 id="what-happens-when-you-edit">What Happens When You Edit</h2>
<p>When you type or paste, Fresh appends to a new buffer and creates a piece pointing to it. The original buffer stays untouched.</p>
<h3 id="before-file-contains-hello-world">Before: File contains "Hello World"</h3>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 581.2890625 150.59999084472656" style="max-width: 581.289px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="134.5999984741211" width="280.953125" y="8" x="292.3359375" style=""/><g transform="translate(407.609375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="117" width="234.3359375" y="16.799999237060547" x="8" style=""/><g transform="translate(108.96484375, 16.799999237060547)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M217.336,75.3L221.503,75.3C225.669,75.3,234.003,75.3,242.336,75.3C250.669,75.3,259.003,75.3,267.336,75.3C275.669,75.3,284.003,75.3,291.669,75.3C299.336,75.3,306.336,75.3,309.836,75.3L313.336,75.3"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(125.16796875, 75.29999923706055)" id="flowchart-P1-0" class="node default"><rect height="47" width="184.3359375" y="-23.5" x="-92.16796875" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-11</tspan></tspan></text></g></g></g><g transform="translate(432.8125, 75.29999923706055)" id="flowchart-B0-1" class="node default"><rect height="64.5999984741211" width="230.953125" y="-32.29999923706055" x="-115.4765625" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (original):</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">World'</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<h3 id="after-insert-big--at-position-6">After: Insert "Big " at position 6</h3>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 581.2890625 331.3999938964844" style="max-width: 581.289px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="310.54999923706055" width="280.953125" y="12.850000381469727" x="292.3359375" style=""/><g transform="translate(407.609375, 12.850000381469727)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="315.3999996185303" width="234.3359375" y="8" x="8" style=""/><g transform="translate(108.96484375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M213.48,66.5L218.29,66.5C223.099,66.5,232.717,66.5,241.693,66.5C250.669,66.5,259.003,66.5,267.336,66.5C275.669,66.5,284.003,66.5,295.359,68.982C306.716,71.465,321.097,76.43,328.287,78.912L335.477,81.395"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P2_B1_0" d="M213.48,264.9L218.29,264.9C223.099,264.9,232.717,264.9,241.693,264.9C250.669,264.9,259.003,264.9,267.336,264.9C275.669,264.9,284.003,264.9,292.755,264.9C301.508,264.9,310.68,264.9,315.266,264.9L319.852,264.9"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P3_B0_0" d="M217.336,163.5L221.503,163.5C225.669,163.5,234.003,163.5,242.336,163.5C250.669,163.5,259.003,163.5,267.336,163.5C275.669,163.5,284.003,163.5,295.359,161.018C306.716,158.535,321.097,153.57,328.287,151.088L335.477,148.605"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(125.16796875, 66.5)" id="flowchart-P1-0" class="node default"><rect height="47" width="176.625" y="-23.5" x="-88.3125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-6</tspan></tspan></text></g></g></g><g transform="translate(125.16796875, 264.8999996185303)" id="flowchart-P2-1" class="node default"><rect height="47" width="176.625" y="-23.5" x="-88.3125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-4</tspan></tspan></text></g></g></g><g transform="translate(125.16796875, 163.5)" id="flowchart-P3-2" class="node default"><rect height="47" width="184.3359375" y="-23.5" x="-92.16796875" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 6-11</tspan></tspan></text></g></g></g><g transform="translate(432.8125, 115)" id="flowchart-B0-3" class="node default"><rect height="64.5999984741211" width="230.953125" y="-32.29999923706055" x="-115.4765625" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (original):</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">World'</tspan></tspan></text></g></g></g><g transform="translate(432.8125, 264.8999996185303)" id="flowchart-B1-4" class="node default"><rect height="47" width="217.921875" y="-23.5" x="-108.9609375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (added):</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Big</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> '</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>Document now reads: "Hello Big World"</p>
<p>The original file content in Buffer 0 was never modified or copied.</p>
<h2 id="lazy-loading">Lazy Loading</h2>
<p>For large files, Fresh doesn't load the entire file into memory. Buffers can be <strong>unloaded</strong> - they store a file path and byte range instead of actual data.</p>
<p>This is actually how the original <a href="https://computerhistory.org/blog/microsoft-word-for-windows-1-1a-source-code/">Word 1.1a</a> piece table worked: pieces pointed directly to spans in the original file on disk, loading content only when needed. VS Code's 2018 implementation loads files fully into memory; Fresh returns to the original memory-conscious design.</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 835.59375 312.79998779296875" style="max-width: 835.594px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="149.8000030517578" width="607.578125" y="155" x="96.0078125" style=""/><g transform="translate(374.59375, 155)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="97" width="819.59375" y="8" x="8" style=""/><g transform="translate(401.59375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M143.266,80L143.266,84.167C143.266,88.333,143.266,96.667,143.266,105C143.266,113.333,143.266,121.667,143.266,130C143.266,138.333,143.266,146.667,168.583,158.056C193.9,169.446,244.535,183.892,269.852,191.115L295.169,198.338"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P2_B0_0" d="M405.797,80L405.797,84.167C405.797,88.333,405.797,96.667,405.797,105C405.797,113.333,405.797,121.667,405.797,130C405.797,138.333,405.797,146.667,405.797,154.333C405.797,162,405.797,169,405.797,172.5L405.797,176"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P3_B0_0" d="M680.328,80L680.328,84.167C680.328,88.333,680.328,96.667,680.328,105C680.328,113.333,680.328,121.667,680.328,130C680.328,138.333,680.328,146.667,653.013,158.286C625.698,169.905,571.067,184.809,543.752,192.262L516.437,199.714"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(143.265625, 56.5)" id="flowchart-P1-0" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(405.796875, 56.5)" id="flowchart-P2-1" class="node default"><rect height="47" width="224.53125" y="-23.5" x="-112.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1MB-2MB</tspan></tspan></text></g></g></g><g transform="translate(680.328125, 56.5)" id="flowchart-P3-2" class="node default"><rect height="47" width="224.53125" y="-23.5" x="-112.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2MB-3MB</tspan></tspan></text></g></g></g><g transform="translate(405.796875, 229.9000015258789)" id="flowchart-B0-3" class="node default"><rect height="99.80000305175781" width="213.5625" y="-49.900001525878906" x="-106.78125" style="" class="basic label-container"/><g transform="translate(0, -34.900001525878906)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">file:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> /path/to/large.txt</tspan></tspan><tspan dy="1.1em" y="2.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">offset:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0</tspan></tspan><tspan dy="1.1em" y="3.2em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 3MB</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>When you scroll to a region, Fresh loads only that chunk from disk:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 315.53125 397.3999938964844" style="max-width: 315.531px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"/><g class="edgeLabels"/><g class="nodes"><g transform="translate(0, 0)" class="root"><g class="clusters"><g data-look="classic" id="subGraph0" class="cluster"><rect height="381.3999938964844" width="299.53125" y="8" x="8" style=""/><g transform="translate(74.55859375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">After</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> scrolling</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> to</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> middle</tspan></tspan></text></g></g></g></g><g class="edgePaths"/><g class="edgeLabels"/><g class="nodes"><g transform="translate(157.765625, 75.29999923706055)" id="flowchart-B0_new-0" class="node default"><rect height="64.5999984741211" width="213.5625" y="-32.29999923706055" x="-106.78125" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">(0-1MB)</tspan></tspan></text></g></g></g><g transform="translate(157.765625, 198.6999969482422)" id="flowchart-B1_new-1" class="node default"><rect height="82.19999694824219" width="224.53125" y="-41.099998474121094" x="-112.265625" style="" class="basic label-container"/><g transform="translate(0, -26.099998474121094)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> LOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">(1MB-2MB)</tspan></tspan><tspan dy="1.1em" y="2.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">actual</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> in</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> memory</tspan></tspan></text></g></g></g><g transform="translate(157.765625, 322.0999946594238)" id="flowchart-B2_new-2" class="node default"><rect height="64.5999984741211" width="213.5625" y="-32.29999923706055" x="-106.78125" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">(2MB-3MB)</tspan></tspan></text></g></g></g></g></g></g></g></g></svg></p>
<h2 id="zero-copy-reads">Zero-Copy Reads</h2>
<p>When reading text for display, Fresh doesn't copy bytes. It returns slices pointing directly into the buffers:</p>
<pre class="rust"><code>// Returns &amp;[u8] pointing into buffer memory
// No allocation, no copy
let text = buffer.get_text_range(100, 200);</code></pre>
<p>Multiple pieces can reference the same buffer region. Displaying the same text twice doesn't double memory usage.</p>
<h2 id="the-tree-structure">The Tree Structure</h2>
<p>The pieces are organized in a balanced binary tree for fast lookups:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 507.453125 294.20001220703125" style="max-width: 507.453px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_I2_0" d="M248.328,73.6L240.675,77.767C233.021,81.933,217.714,90.267,210.06,97.933C202.406,105.6,202.406,112.6,202.406,116.1L202.406,119.6"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_L3_0" d="M368.828,73.6L376.482,77.767C384.135,81.933,399.443,90.267,407.096,99.483C414.75,108.7,414.75,118.8,414.75,123.85L414.75,128.9"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L1_0" d="M140.153,189.2L132.244,193.367C124.336,197.533,108.52,205.867,100.611,213.533C92.703,221.2,92.703,228.2,92.703,231.7L92.703,235.2"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L2_0" d="M264.66,189.2L272.568,193.367C280.476,197.533,296.293,205.867,304.201,213.533C312.109,221.2,312.109,228.2,312.109,231.7L312.109,235.2"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(308.578125, 40.79999923706055)" id="flowchart-I1-0" class="node default"><rect height="65.5999984741211" width="164.1796875" y="-32.79999923706055" x="-82.08984375" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 100</tspan></tspan></text></g></g></g><g transform="translate(202.40625, 156.39999771118164)" id="flowchart-I2-2" class="node default"><rect height="65.5999984741211" width="155.28125" y="-32.79999923706055" x="-77.640625" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan></tspan></text></g></g></g><g transform="translate(414.75, 156.39999771118164)" id="flowchart-L3-4" class="node default"><rect height="47" width="169.40625" y="-23.5" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan></text></g></g></g><g transform="translate(92.703125, 262.6999969482422)" id="flowchart-L1-6" class="node default"><rect height="47" width="169.40625" y="-23.5" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan></text></g></g></g><g transform="translate(312.109375, 262.6999969482422)" id="flowchart-L2-8" class="node default"><rect height="47" width="169.40625" y="-23.5" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>Each internal node caches the total bytes in its left subtree. To find byte offset 75:</p>
<ol type="1">
<li>Root has <code>left_bytes: 100</code>, and 75 &lt; 100, so go left</li>
<li>Internal has <code>left_bytes: 50</code>, and 75 &gt;= 50, so go right with offset 75-50=25</li>
<li>Piece has 50 bytes, offset 25 is within it</li>
</ol>
<p>This is O(log P) where P is the number of pieces.</p>
<h2 id="line-feed-tracking">Line Feed Tracking</h2>
<p>Text editors need fast line-based operations: "go to line 1000", "what line is byte offset 50000 on?", or simply displaying line numbers. Scanning the entire document for newlines would be O(N) - too slow for large files.</p>
<p>Fresh tracks line feeds the same way it tracks bytes. Each piece stores its newline count, and internal nodes cache the count for their left subtree:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 507.453125 348" style="max-width: 507.453px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_I2_0" d="M242.261,91.2L235.618,95.367C228.976,99.533,215.691,107.867,209.049,115.533C202.406,123.2,202.406,130.2,202.406,133.7L202.406,137.2"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_L3_0" d="M374.896,91.2L381.538,95.367C388.18,99.533,401.465,107.867,408.108,117C414.75,126.133,414.75,136.067,414.75,141.033L414.75,146"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L1_0" d="M133.883,224.4L127.02,228.567C120.156,232.733,106.43,241.067,99.566,248.733C92.703,256.4,92.703,263.4,92.703,266.9L92.703,270.4"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L2_0" d="M270.93,224.4L277.793,228.567C284.656,232.733,298.383,241.067,305.246,248.733C312.109,256.4,312.109,263.4,312.109,266.9L312.109,270.4"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(308.578125, 49.599998474121094)" id="flowchart-I1-0" class="node default"><rect height="83.19999694824219" width="164.1796875" y="-41.599998474121094" x="-82.08984375" style="" class="basic label-container"/><g transform="translate(0, -26.599998474121094)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 100</tspan></tspan><tspan dy="1.1em" y="2.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">lf_left:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 3</tspan></tspan></text></g></g></g><g transform="translate(202.40625, 182.79999542236328)" id="flowchart-I2-2" class="node default"><rect height="83.19999694824219" width="155.28125" y="-41.599998474121094" x="-77.640625" style="" class="basic label-container"/><g transform="translate(0, -26.599998474121094)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan></tspan><tspan dy="1.1em" y="2.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">lf_left:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2</tspan></tspan></text></g></g></g><g transform="translate(414.75, 182.79999542236328)" id="flowchart-L3-4" class="node default"><rect height="65.5999984741211" width="169.40625" y="-32.79999923706055" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">line_feeds:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1</tspan></tspan></text></g></g></g><g transform="translate(92.703125, 307.1999931335449)" id="flowchart-L1-6" class="node default"><rect height="65.5999984741211" width="169.40625" y="-32.79999923706055" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 30</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">line_feeds:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2</tspan></tspan></text></g></g></g><g transform="translate(312.109375, 307.1999931335449)" id="flowchart-L2-8" class="node default"><rect height="65.5999984741211" width="169.40625" y="-32.79999923706055" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 20</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">line_feeds:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>To find which piece contains line 3:</p>
<ol type="1">
<li>Root has <code>lf_left: 3</code>, and 3 &gt;= 3, so go right with line 3-3=0</li>
<li>Piece L3 has <code>line_feeds: 1</code>, line 0 is within it</li>
</ol>
<p>This enables O(log P) line-to-offset conversion. The same structure supports offset-to-line lookup by accumulating line counts while traversing.</p>
<p>For large files where line indexing hasn't been computed (lazy loading), these counts are <code>None</code> and Fresh falls back to scanning. Once a region is loaded and indexed, the counts become available.</p>
<h2 id="immutable-tree-structure">Immutable Tree Structure</h2>
<p>Fresh uses immutable nodes - once created, a node is never modified. Edits create new nodes instead.</p>
<blockquote>
<p><strong>Implementation note:</strong> Fresh is written in Rust. Nodes are wrapped in <code>Arc&lt;T&gt;</code> (Atomic Reference Counted pointer) - think of it as a pointer that tracks how many things reference it. Multiple parts of the code (even different threads) can safely hold the same <code>Arc</code>, and the data is automatically freed when the last reference is dropped. We'll gloss over this detail going forward - just know that "sharing" a node is cheap and thread-safe.</p>
</blockquote>
<p>After an edit, old tree versions remain valid:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 550.396484375 210" style="max-width: 550.396px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="subGraph1" class="cluster"><rect height="194" width="197.9140625" y="8" x="8" style=""/><g transform="translate(34.91015625, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Version</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (after</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> edit)</tspan></tspan></text></g></g></g><g data-look="classic" id="subGraph0" class="cluster"><rect height="194" width="316.482421875" y="8" x="225.9140625" style=""/><g transform="translate(305.4365234375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Version</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (before</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> edit)</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V1_Root_V1_L_0" d="M348.281,80L342.157,84.167C336.032,88.333,323.784,96.667,317.659,104.333C311.535,112,311.535,119,311.535,122.5L311.535,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V1_Root_V1_R_0" d="M417.363,80L423.488,84.167C429.612,88.333,441.861,96.667,447.985,104.333C454.109,112,454.109,119,454.109,122.5L454.109,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V2_Root_V1_L_0" d="M130.428,80L133.624,84.167C136.82,88.333,143.212,96.667,165.487,106.548C187.763,116.429,225.923,127.858,245.002,133.573L264.082,139.287"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V2_Root_V2_R_0" d="M107.557,80L106.698,84.167C105.839,88.333,104.121,96.667,103.261,104.333C102.402,112,102.402,119,102.402,122.5L102.402,126"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(382.822265625, 56.5)" id="flowchart-V1_Root-0" class="node default"><rect height="47" width="115.2421875" y="-23.5" x="-57.62109375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Root</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> v1</tspan></tspan></text></g></g></g><g transform="translate(311.53515625, 153.5)" id="flowchart-V1_L-1" class="node default"><rect height="47" width="87.2421875" y="-23.5" x="-43.62109375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Left</tspan></tspan></text></g></g></g><g transform="translate(454.109375, 153.5)" id="flowchart-V1_R-3" class="node default"><rect height="47" width="97.90625" y="-23.5" x="-48.953125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Right</tspan></tspan></text></g></g></g><g transform="translate(112.40234375, 56.5)" id="flowchart-V2_Root-4" class="node default"><rect height="47" width="115.2421875" y="-23.5" x="-57.62109375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Root</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> v2</tspan></tspan></text></g></g></g><g transform="translate(102.40234375, 153.5)" id="flowchart-V2_R-7" class="node default"><rect height="47" width="118.8046875" y="-23.5" x="-59.40234375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Right</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> v2</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>Version 2 shares the unchanged left subtree with Version 1. This enables:</p>
<ul>
<li>Undo/redo by keeping old root references</li>
<li>Concurrent reads without locks</li>
<li>Cheap snapshots</li>
</ul>
<h2 id="fresh-vs-vs-code">Fresh vs VS Code</h2>
<p>VS Code also uses a piece tree. The core idea is identical, but the designs diverge on one key question: mutable or immutable nodes?</p>
<p><strong>VS Code</strong>: Mutable tree. Edits modify nodes in place using red-black tree rotations. Undo/redo is handled by a separate layer that stores edit operations.</p>
<p><strong>Fresh</strong>: Immutable nodes. Edits produce new tree versions while old versions remain valid, with unchanged subtrees shared between versions. (This is known as a <a href="https://en.wikipedia.org/wiki/Persistent_data_structure">persistent data structure</a> in CS literature.)</p>
<h3 id="inherent-trade-offs">Inherent Trade-offs</h3>
<p><strong>Immutable (Fresh):</strong></p>
<ul>
<li>Old tree versions stay valid - enables cheap snapshots and structural sharing</li>
<li>Concurrent reads need no synchronization</li>
<li>Undo can be "keep the old root" instead of "replay operations backward"</li>
<li>More allocations per edit (new nodes along modified path)</li>
</ul>
<p><strong>Mutable (VS Code):</strong></p>
<ul>
<li>Edits modify in place - less allocation overhead</li>
<li>Requires separate undo infrastructure</li>
<li>Concurrent access needs care</li>
</ul>
<p><strong>Lazy loading</strong> is orthogonal to mutability, but Fresh implements it and VS Code doesn't. Fresh can leave file regions on disk until accessed; VS Code loads the entire file.</p>
<h2 id="comparison-piece-tree-vs-rope">Comparison: Piece Tree vs Rope</h2>
<p>Different editors use different text storage structures:</p>
<ul>
<li><strong>Piece tree</strong>: VS Code, Fresh</li>
<li><strong>Rope</strong>: Helix (uses <a href="https://github.com/cessen/ropey">Ropey</a>), Zed (custom <a href="https://zed.dev/blog/zed-decoded-rope-sumtree">SumTree</a>)</li>
<li><strong>Gap buffer</strong>: Emacs</li>
<li><strong>Line array</strong>: Vim, Neovim</li>
</ul>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Piece Tree (Fresh, VS Code)</th>
<th>Rope (Helix, Zed)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Node contents</td>
<td>Pointer to buffer</td>
<td>Actual text (~1KB chunks)</td>
</tr>
<tr>
<td>Insert</td>
<td>Append to buffer, add piece</td>
<td>May copy/split chunk</td>
</tr>
<tr>
<td>Original file</td>
<td>Preserved in buffer 0</td>
<td>Reorganized into chunks</td>
</tr>
<tr>
<td>Large files</td>
<td>Lazy load regions (Fresh, Word 1.1a)</td>
<td>Must load or stream</td>
</tr>
<tr>
<td>Memory for edits</td>
<td>Minimal (just pointers)</td>
<td>Copies chunk data</td>
</tr>
</tbody>
</table>
<h2 id="trade-offs">Trade-offs</h2>
<p><strong>Advantages:</strong></p>
<ul>
<li>Original file content preserved (useful for diffs, minimal saves)</li>
<li>Inserts never copy existing text</li>
<li>Natural lazy loading for large files</li>
<li>Pieces are small (~24 bytes) - more fit in CPU cache during tree traversal</li>
</ul>
<p><strong>Disadvantages:</strong></p>
<ul>
<li>Extra indirection: find piece, then fetch from buffer</li>
<li>Buffer fragmentation over many edits (many small buffers)</li>
<li>Cache locality for text is poor (data scattered across buffers)</li>
<li>No automatic chunk coalescing (piece count grows with edits)</li>
</ul>
<p><em>(Note: Fresh's current implementation doesn't fully exploit immutability - it rebuilds the entire tree on each edit rather than path-copying, making edits O(P) instead of O(log P). VS Code has additional optimizations like search caching and line content caching that Fresh lacks. These are implementation gaps, not inherent to the designs.)</em></p>
<h2 id="further-reading">Further Reading</h2>
<ul>
<li><a href="https://sinelaw.github.io/fresh/">Fresh</a> - The editor discussed in this post (<a href="https://github.com/sinelaw/fresh">source on GitHub</a>)</li>
<li><a href="https://computerhistory.org/blog/microsoft-word-for-windows-1-1a-source-code/">Microsoft Word 1.1a Source Code</a> - Original piece table implementation from 1990</li>
<li><a href="https://code.visualstudio.com/blogs/2018/03/23/text-buffer-reimplementation">VS Code's Piece Table</a> - Microsoft's 2018 write-up on reviving piece tables</li>
<li><a href="https://zed.dev/blog/zed-decoded-rope-sumtree">Zed's Rope &amp; SumTree</a> - How Zed implements ropes with B+ trees</li>
<li><a href="https://coredumped.dev/2023/08/09/text-showdown-gap-buffers-vs-ropes/">Text Showdown: Gap Buffers vs Ropes</a> - Performance comparison</li>
<li><a href="https://www.cs.unm.edu/~crowley/papers/sds.pdf">Data Structures for Text Sequences</a> - Charles Crowley, 1998 (academic survey)</li>
</ul>
]]></content><author><name></name></author></entry><entry><title type="html">How Fresh Loads Huge Files Fast</title><link href="/blog/2025/12/08/how-fresh-loads-huge-files-fast.html" rel="alternate" type="text/html" title="How Fresh Loads Huge Files Fast" /><published>2025-12-08T22:54:13+00:00</published><updated>2025-12-08T22:54:13+00:00</updated><id>/blog/2025/12/08/how-fresh-loads-huge-files-fast.html</id><content type="html" xml:base="/blog/2025/12/08/how-fresh-loads-huge-files-fast.html"><![CDATA[<h1 id="how-fresh-loads-huge-files-fast">How Fresh Loads Huge Files Fast</h1>
<p>Fresh uses a <strong>piece tree</strong> (also called a piece table) for text storage. The piece table originated in the early 1970s - first in <a href="https://www.computerhistory.org/collections/catalog/102740449">J. Strother Moore's work at Edinburgh</a>, then in the <a href="https://en.wikipedia.org/wiki/Bravo_(editor)">Bravo editor</a> at Xerox PARC (1974) by Butler Lampson and Charles Simonyi. Simonyi later <a href="https://www.tiny.cloud/blog/wysiwyg-development-history/">brought it to Microsoft Word</a> (1983). The design minimizes memory copying by never modifying original file content - critical for early systems with limited RAM. <a href="https://code.visualstudio.com/blogs/2018/03/23/text-buffer-reimplementation">VS Code revived this approach in 2018</a>.</p>
<p><a href="https://sinelaw.github.io/fresh/">Fresh</a>'s implementation adds immutable nodes (for concurrency and cheap snapshots) and lazy loading (for large files). (<a href="https://github.com/sinelaw/fresh">GitHub</a>)</p>
<h2 id="the-core-idea">The Core Idea</h2>
<p>Instead of storing text in the tree, store <strong>pointers</strong> to text that lives elsewhere.</p>
<h3 id="rope-helix-zed">Rope (<a href="https://github.com/helix-editor/helix/blob/master/docs/architecture.md">Helix</a>, <a href="https://zed.dev/blog/zed-decoded-rope-sumtree">Zed</a>)</h3>
<p>Text lives inside tree nodes:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 360.703125 160" style="max-width: 360.703px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_L_0" d="M132.395,55L123.918,59.167C115.44,63.333,98.486,71.667,90.009,79.333C81.531,87,81.531,94,81.531,97.5L81.531,101"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_R_0" d="M228.019,55L236.496,59.167C244.974,63.333,261.928,71.667,270.406,79.333C278.883,87,278.883,94,278.883,97.5L278.883,101"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(180.20703125, 31.5)" id="flowchart-Root-0" class="node default"><rect height="47" width="156.171875" y="-23.5" x="-78.0859375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> Node</tspan></tspan></text></g></g></g><g transform="translate(81.53125, 128.5)" id="flowchart-L-2" class="node default"><rect height="47" width="147.0625" y="-23.5" x="-73.53125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Leaf:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> '</tspan></tspan></text></g></g></g><g transform="translate(278.8828125, 128.5)" id="flowchart-R-4" class="node default"><rect height="47" width="147.640625" y="-23.5" x="-73.8203125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Leaf:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'World'</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<h3 id="piece-tree-fresh">Piece Tree (Fresh)</h3>
<p>Tree nodes point to separate buffers:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 644.46875 374.6000061035156" style="max-width: 644.469px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="97" width="475.8203125" y="269.5999984741211" x="79.32421875" style=""/><g transform="translate(292.03125, 269.5999984741211)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="211.5999984741211" width="628.46875" y="8" x="8" style=""/><g transform="translate(306.03125, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_L_0" d="M248.528,80L235.46,84.167C222.391,88.333,196.254,96.667,183.186,104.333C170.117,112,170.117,119,170.117,122.5L170.117,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_R_0" d="M395.941,80L409.009,84.167C422.078,88.333,448.215,96.667,461.283,104.333C474.352,112,474.352,119,474.352,122.5L474.352,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_L_B0_0" d="M170.117,194.6L170.117,198.767C170.117,202.933,170.117,211.267,170.117,219.6C170.117,227.933,170.117,236.267,170.117,244.6C170.117,252.933,170.117,261.267,182.551,269.397C194.984,277.528,219.85,285.457,232.284,289.421L244.717,293.385"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_R_B0_0" d="M474.352,194.6L474.352,198.767C474.352,202.933,474.352,211.267,474.352,219.6C474.352,227.933,474.352,236.267,474.352,244.6C474.352,252.933,474.352,261.267,461.918,269.397C449.485,277.528,424.618,285.457,412.185,289.421L399.752,293.385"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(322.234375, 56.5)" id="flowchart-Root-0" class="node default"><rect height="47" width="156.171875" y="-23.5" x="-78.0859375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> Node</tspan></tspan></text></g></g></g><g transform="translate(170.1171875, 162.29999923706055)" id="flowchart-L-2" class="node default"><rect height="64.5999984741211" width="254.234375" y="-32.29999923706055" x="-127.1171875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> offset</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> len</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">6</tspan></tspan></text></g></g></g><g transform="translate(474.3515625, 162.29999923706055)" id="flowchart-R-4" class="node default"><rect height="64.5999984741211" width="254.234375" y="-32.29999923706055" x="-127.1171875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> offset</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 6,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> len</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">5</tspan></tspan></text></g></g></g><g transform="translate(322.234375, 318.0999984741211)" id="flowchart-B0-5" class="node default"><rect height="47" width="213.171875" y="-23.5" x="-106.5859375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> World'</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>A <strong>piece</strong> is just three numbers: which buffer, starting offset, and length.</p>
<h2 id="what-happens-when-you-edit">What Happens When You Edit</h2>
<p>When you type or paste, Fresh appends to a new buffer and creates a piece pointing to it. The original buffer stays untouched.</p>
<h3 id="before-file-contains-hello-world">Before: File contains "Hello World"</h3>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 581.2890625 150.59999084472656" style="max-width: 581.289px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="134.5999984741211" width="280.953125" y="8" x="292.3359375" style=""/><g transform="translate(407.609375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="117" width="234.3359375" y="16.799999237060547" x="8" style=""/><g transform="translate(108.96484375, 16.799999237060547)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M217.336,75.3L221.503,75.3C225.669,75.3,234.003,75.3,242.336,75.3C250.669,75.3,259.003,75.3,267.336,75.3C275.669,75.3,284.003,75.3,291.669,75.3C299.336,75.3,306.336,75.3,309.836,75.3L313.336,75.3"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(125.16796875, 75.29999923706055)" id="flowchart-P1-0" class="node default"><rect height="47" width="184.3359375" y="-23.5" x="-92.16796875" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-11</tspan></tspan></text></g></g></g><g transform="translate(432.8125, 75.29999923706055)" id="flowchart-B0-1" class="node default"><rect height="64.5999984741211" width="230.953125" y="-32.29999923706055" x="-115.4765625" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (original):</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">World'</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<h3 id="after-insert-big--at-position-6">After: Insert "Big " at position 6</h3>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 581.2890625 331.3999938964844" style="max-width: 581.289px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="310.54999923706055" width="280.953125" y="12.850000381469727" x="292.3359375" style=""/><g transform="translate(407.609375, 12.850000381469727)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="315.3999996185303" width="234.3359375" y="8" x="8" style=""/><g transform="translate(108.96484375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M213.48,66.5L218.29,66.5C223.099,66.5,232.717,66.5,241.693,66.5C250.669,66.5,259.003,66.5,267.336,66.5C275.669,66.5,284.003,66.5,295.359,68.982C306.716,71.465,321.097,76.43,328.287,78.912L335.477,81.395"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P2_B1_0" d="M213.48,264.9L218.29,264.9C223.099,264.9,232.717,264.9,241.693,264.9C250.669,264.9,259.003,264.9,267.336,264.9C275.669,264.9,284.003,264.9,292.755,264.9C301.508,264.9,310.68,264.9,315.266,264.9L319.852,264.9"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P3_B0_0" d="M217.336,163.5L221.503,163.5C225.669,163.5,234.003,163.5,242.336,163.5C250.669,163.5,259.003,163.5,267.336,163.5C275.669,163.5,284.003,163.5,295.359,161.018C306.716,158.535,321.097,153.57,328.287,151.088L335.477,148.605"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(125.16796875, 66.5)" id="flowchart-P1-0" class="node default"><rect height="47" width="176.625" y="-23.5" x="-88.3125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-6</tspan></tspan></text></g></g></g><g transform="translate(125.16796875, 264.8999996185303)" id="flowchart-P2-1" class="node default"><rect height="47" width="176.625" y="-23.5" x="-88.3125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-4</tspan></tspan></text></g></g></g><g transform="translate(125.16796875, 163.5)" id="flowchart-P3-2" class="node default"><rect height="47" width="184.3359375" y="-23.5" x="-92.16796875" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 6-11</tspan></tspan></text></g></g></g><g transform="translate(432.8125, 115)" id="flowchart-B0-3" class="node default"><rect height="64.5999984741211" width="230.953125" y="-32.29999923706055" x="-115.4765625" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (original):</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">World'</tspan></tspan></text></g></g></g><g transform="translate(432.8125, 264.8999996185303)" id="flowchart-B1-4" class="node default"><rect height="47" width="217.921875" y="-23.5" x="-108.9609375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (added):</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Big</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> '</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>Document now reads: "Hello Big World"</p>
<p>The original file content in Buffer 0 was never modified or copied.</p>
<h2 id="lazy-loading">Lazy Loading</h2>
<p>For large files, Fresh doesn't load the entire file into memory. Buffers can be <strong>unloaded</strong> - they store a file path and byte range instead of actual data.</p>
<p>This is actually how the original <a href="https://computerhistory.org/blog/microsoft-word-for-windows-1-1a-source-code/">Word 1.1a</a> piece table worked: pieces pointed directly to spans in the original file on disk, loading content only when needed. VS Code's 2018 implementation loads files fully into memory; Fresh returns to the original memory-conscious design.</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 835.59375 312.79998779296875" style="max-width: 835.594px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="149.8000030517578" width="607.578125" y="155" x="96.0078125" style=""/><g transform="translate(374.59375, 155)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="97" width="819.59375" y="8" x="8" style=""/><g transform="translate(401.59375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M143.266,80L143.266,84.167C143.266,88.333,143.266,96.667,143.266,105C143.266,113.333,143.266,121.667,143.266,130C143.266,138.333,143.266,146.667,168.583,158.056C193.9,169.446,244.535,183.892,269.852,191.115L295.169,198.338"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P2_B0_0" d="M405.797,80L405.797,84.167C405.797,88.333,405.797,96.667,405.797,105C405.797,113.333,405.797,121.667,405.797,130C405.797,138.333,405.797,146.667,405.797,154.333C405.797,162,405.797,169,405.797,172.5L405.797,176"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P3_B0_0" d="M680.328,80L680.328,84.167C680.328,88.333,680.328,96.667,680.328,105C680.328,113.333,680.328,121.667,680.328,130C680.328,138.333,680.328,146.667,653.013,158.286C625.698,169.905,571.067,184.809,543.752,192.262L516.437,199.714"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(143.265625, 56.5)" id="flowchart-P1-0" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(405.796875, 56.5)" id="flowchart-P2-1" class="node default"><rect height="47" width="224.53125" y="-23.5" x="-112.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1MB-2MB</tspan></tspan></text></g></g></g><g transform="translate(680.328125, 56.5)" id="flowchart-P3-2" class="node default"><rect height="47" width="224.53125" y="-23.5" x="-112.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2MB-3MB</tspan></tspan></text></g></g></g><g transform="translate(405.796875, 229.9000015258789)" id="flowchart-B0-3" class="node default"><rect height="99.80000305175781" width="213.5625" y="-49.900001525878906" x="-106.78125" style="" class="basic label-container"/><g transform="translate(0, -34.900001525878906)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">file:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> /path/to/large.txt</tspan></tspan><tspan dy="1.1em" y="2.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">offset:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0</tspan></tspan><tspan dy="1.1em" y="3.2em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 3MB</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>When you scroll to a region, Fresh loads only that chunk from disk:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 315.53125 397.3999938964844" style="max-width: 315.531px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"/><g class="edgeLabels"/><g class="nodes"><g transform="translate(0, 0)" class="root"><g class="clusters"><g data-look="classic" id="subGraph0" class="cluster"><rect height="381.3999938964844" width="299.53125" y="8" x="8" style=""/><g transform="translate(74.55859375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">After</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> scrolling</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> to</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> middle</tspan></tspan></text></g></g></g></g><g class="edgePaths"/><g class="edgeLabels"/><g class="nodes"><g transform="translate(157.765625, 75.29999923706055)" id="flowchart-B0_new-0" class="node default"><rect height="64.5999984741211" width="213.5625" y="-32.29999923706055" x="-106.78125" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">(0-1MB)</tspan></tspan></text></g></g></g><g transform="translate(157.765625, 198.6999969482422)" id="flowchart-B1_new-1" class="node default"><rect height="82.19999694824219" width="224.53125" y="-41.099998474121094" x="-112.265625" style="" class="basic label-container"/><g transform="translate(0, -26.099998474121094)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> LOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">(1MB-2MB)</tspan></tspan><tspan dy="1.1em" y="2.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">actual</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> in</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> memory</tspan></tspan></text></g></g></g><g transform="translate(157.765625, 322.0999946594238)" id="flowchart-B2_new-2" class="node default"><rect height="64.5999984741211" width="213.5625" y="-32.29999923706055" x="-106.78125" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">(2MB-3MB)</tspan></tspan></text></g></g></g></g></g></g></g></g></svg></p>
<h2 id="zero-copy-reads">Zero-Copy Reads</h2>
<p>When reading text for display, Fresh doesn't copy bytes. It returns slices pointing directly into the buffers:</p>
<pre class="rust"><code>// Returns &amp;[u8] pointing into buffer memory
// No allocation, no copy
let text = buffer.get_text_range(100, 200);</code></pre>
<p>Multiple pieces can reference the same buffer region. Displaying the same text twice doesn't double memory usage.</p>
<h2 id="the-tree-structure">The Tree Structure</h2>
<p>The pieces are organized in a balanced binary tree for fast lookups:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 507.453125 294.20001220703125" style="max-width: 507.453px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_I2_0" d="M248.328,73.6L240.675,77.767C233.021,81.933,217.714,90.267,210.06,97.933C202.406,105.6,202.406,112.6,202.406,116.1L202.406,119.6"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_L3_0" d="M368.828,73.6L376.482,77.767C384.135,81.933,399.443,90.267,407.096,99.483C414.75,108.7,414.75,118.8,414.75,123.85L414.75,128.9"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L1_0" d="M140.153,189.2L132.244,193.367C124.336,197.533,108.52,205.867,100.611,213.533C92.703,221.2,92.703,228.2,92.703,231.7L92.703,235.2"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L2_0" d="M264.66,189.2L272.568,193.367C280.476,197.533,296.293,205.867,304.201,213.533C312.109,221.2,312.109,228.2,312.109,231.7L312.109,235.2"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(308.578125, 40.79999923706055)" id="flowchart-I1-0" class="node default"><rect height="65.5999984741211" width="164.1796875" y="-32.79999923706055" x="-82.08984375" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 100</tspan></tspan></text></g></g></g><g transform="translate(202.40625, 156.39999771118164)" id="flowchart-I2-2" class="node default"><rect height="65.5999984741211" width="155.28125" y="-32.79999923706055" x="-77.640625" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan></tspan></text></g></g></g><g transform="translate(414.75, 156.39999771118164)" id="flowchart-L3-4" class="node default"><rect height="47" width="169.40625" y="-23.5" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan></text></g></g></g><g transform="translate(92.703125, 262.6999969482422)" id="flowchart-L1-6" class="node default"><rect height="47" width="169.40625" y="-23.5" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan></text></g></g></g><g transform="translate(312.109375, 262.6999969482422)" id="flowchart-L2-8" class="node default"><rect height="47" width="169.40625" y="-23.5" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>Each internal node caches the total bytes in its left subtree. To find byte offset 75:</p>
<ol type="1">
<li>Root has <code>left_bytes: 100</code>, and 75 &lt; 100, so go left</li>
<li>Internal has <code>left_bytes: 50</code>, and 75 &gt;= 50, so go right with offset 75-50=25</li>
<li>Piece has 50 bytes, offset 25 is within it</li>
</ol>
<p>This is O(log P) where P is the number of pieces.</p>
<h2 id="line-feed-tracking">Line Feed Tracking</h2>
<p>Text editors need fast line-based operations: "go to line 1000", "what line is byte offset 50000 on?", or simply displaying line numbers. Scanning the entire document for newlines would be O(N) - too slow for large files.</p>
<p>Fresh tracks line feeds the same way it tracks bytes. Each piece stores its newline count, and internal nodes cache the count for their left subtree:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 507.453125 348" style="max-width: 507.453px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_I2_0" d="M242.261,91.2L235.618,95.367C228.976,99.533,215.691,107.867,209.049,115.533C202.406,123.2,202.406,130.2,202.406,133.7L202.406,137.2"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_L3_0" d="M374.896,91.2L381.538,95.367C388.18,99.533,401.465,107.867,408.108,117C414.75,126.133,414.75,136.067,414.75,141.033L414.75,146"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L1_0" d="M133.883,224.4L127.02,228.567C120.156,232.733,106.43,241.067,99.566,248.733C92.703,256.4,92.703,263.4,92.703,266.9L92.703,270.4"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L2_0" d="M270.93,224.4L277.793,228.567C284.656,232.733,298.383,241.067,305.246,248.733C312.109,256.4,312.109,263.4,312.109,266.9L312.109,270.4"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(308.578125, 49.599998474121094)" id="flowchart-I1-0" class="node default"><rect height="83.19999694824219" width="164.1796875" y="-41.599998474121094" x="-82.08984375" style="" class="basic label-container"/><g transform="translate(0, -26.599998474121094)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 100</tspan></tspan><tspan dy="1.1em" y="2.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">lf_left:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 3</tspan></tspan></text></g></g></g><g transform="translate(202.40625, 182.79999542236328)" id="flowchart-I2-2" class="node default"><rect height="83.19999694824219" width="155.28125" y="-41.599998474121094" x="-77.640625" style="" class="basic label-container"/><g transform="translate(0, -26.599998474121094)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan></tspan><tspan dy="1.1em" y="2.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">lf_left:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2</tspan></tspan></text></g></g></g><g transform="translate(414.75, 182.79999542236328)" id="flowchart-L3-4" class="node default"><rect height="65.5999984741211" width="169.40625" y="-32.79999923706055" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">line_feeds:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1</tspan></tspan></text></g></g></g><g transform="translate(92.703125, 307.1999931335449)" id="flowchart-L1-6" class="node default"><rect height="65.5999984741211" width="169.40625" y="-32.79999923706055" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 30</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">line_feeds:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2</tspan></tspan></text></g></g></g><g transform="translate(312.109375, 307.1999931335449)" id="flowchart-L2-8" class="node default"><rect height="65.5999984741211" width="169.40625" y="-32.79999923706055" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 20</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">line_feeds:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>To find which piece contains line 3:</p>
<ol type="1">
<li>Root has <code>lf_left: 3</code>, and 3 &gt;= 3, so go right with line 3-3=0</li>
<li>Piece L3 has <code>line_feeds: 1</code>, line 0 is within it</li>
</ol>
<p>This enables O(log P) line-to-offset conversion. The same structure supports offset-to-line lookup by accumulating line counts while traversing.</p>
<p>For large files where line indexing hasn't been computed (lazy loading), these counts are <code>None</code> and Fresh falls back to scanning. Once a region is loaded and indexed, the counts become available.</p>
<h2 id="immutable-tree-structure">Immutable Tree Structure</h2>
<p>Fresh uses immutable nodes - once created, a node is never modified. Edits create new nodes instead.</p>
<blockquote>
<p><strong>Implementation note:</strong> Fresh is written in Rust. Nodes are wrapped in <code>Arc&lt;T&gt;</code> (Atomic Reference Counted pointer) - think of it as a pointer that tracks how many things reference it. Multiple parts of the code (even different threads) can safely hold the same <code>Arc</code>, and the data is automatically freed when the last reference is dropped. We'll gloss over this detail going forward - just know that "sharing" a node is cheap and thread-safe.</p>
</blockquote>
<p>After an edit, old tree versions remain valid:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 550.396484375 210" style="max-width: 550.396px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="subGraph1" class="cluster"><rect height="194" width="197.9140625" y="8" x="8" style=""/><g transform="translate(34.91015625, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Version</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (after</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> edit)</tspan></tspan></text></g></g></g><g data-look="classic" id="subGraph0" class="cluster"><rect height="194" width="316.482421875" y="8" x="225.9140625" style=""/><g transform="translate(305.4365234375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Version</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (before</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> edit)</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V1_Root_V1_L_0" d="M348.281,80L342.157,84.167C336.032,88.333,323.784,96.667,317.659,104.333C311.535,112,311.535,119,311.535,122.5L311.535,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V1_Root_V1_R_0" d="M417.363,80L423.488,84.167C429.612,88.333,441.861,96.667,447.985,104.333C454.109,112,454.109,119,454.109,122.5L454.109,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V2_Root_V1_L_0" d="M130.428,80L133.624,84.167C136.82,88.333,143.212,96.667,165.487,106.548C187.763,116.429,225.923,127.858,245.002,133.573L264.082,139.287"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V2_Root_V2_R_0" d="M107.557,80L106.698,84.167C105.839,88.333,104.121,96.667,103.261,104.333C102.402,112,102.402,119,102.402,122.5L102.402,126"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(382.822265625, 56.5)" id="flowchart-V1_Root-0" class="node default"><rect height="47" width="115.2421875" y="-23.5" x="-57.62109375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Root</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> v1</tspan></tspan></text></g></g></g><g transform="translate(311.53515625, 153.5)" id="flowchart-V1_L-1" class="node default"><rect height="47" width="87.2421875" y="-23.5" x="-43.62109375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Left</tspan></tspan></text></g></g></g><g transform="translate(454.109375, 153.5)" id="flowchart-V1_R-3" class="node default"><rect height="47" width="97.90625" y="-23.5" x="-48.953125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Right</tspan></tspan></text></g></g></g><g transform="translate(112.40234375, 56.5)" id="flowchart-V2_Root-4" class="node default"><rect height="47" width="115.2421875" y="-23.5" x="-57.62109375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Root</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> v2</tspan></tspan></text></g></g></g><g transform="translate(102.40234375, 153.5)" id="flowchart-V2_R-7" class="node default"><rect height="47" width="118.8046875" y="-23.5" x="-59.40234375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Right</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> v2</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>Version 2 shares the unchanged left subtree with Version 1. This enables:</p>
<ul>
<li>Undo/redo by keeping old root references</li>
<li>Concurrent reads without locks</li>
<li>Cheap snapshots</li>
</ul>
<h2 id="fresh-vs-vs-code">Fresh vs VS Code</h2>
<p>VS Code also uses a piece tree. The core idea is identical, but the designs diverge on one key question: mutable or immutable nodes?</p>
<p><strong>VS Code</strong>: Mutable tree. Edits modify nodes in place using red-black tree rotations. Undo/redo is handled by a separate layer that stores edit operations.</p>
<p><strong>Fresh</strong>: Immutable nodes. Edits produce new tree versions while old versions remain valid, with unchanged subtrees shared between versions. (This is known as a <a href="https://en.wikipedia.org/wiki/Persistent_data_structure">persistent data structure</a> in CS literature.)</p>
<h3 id="inherent-trade-offs">Inherent Trade-offs</h3>
<p><strong>Immutable (Fresh):</strong></p>
<ul>
<li>Old tree versions stay valid - enables cheap snapshots and structural sharing</li>
<li>Concurrent reads need no synchronization</li>
<li>Undo can be "keep the old root" instead of "replay operations backward"</li>
<li>More allocations per edit (new nodes along modified path)</li>
</ul>
<p><strong>Mutable (VS Code):</strong></p>
<ul>
<li>Edits modify in place - less allocation overhead</li>
<li>Requires separate undo infrastructure</li>
<li>Concurrent access needs care</li>
</ul>
<p><strong>Lazy loading</strong> is orthogonal to mutability, but Fresh implements it and VS Code doesn't. Fresh can leave file regions on disk until accessed; VS Code loads the entire file.</p>
<h2 id="comparison-piece-tree-vs-rope">Comparison: Piece Tree vs Rope</h2>
<p>Different editors use different text storage structures:</p>
<ul>
<li><strong>Piece tree</strong>: VS Code, Fresh</li>
<li><strong>Rope</strong>: Helix (uses <a href="https://github.com/cessen/ropey">Ropey</a>), Zed (custom <a href="https://zed.dev/blog/zed-decoded-rope-sumtree">SumTree</a>)</li>
<li><strong>Gap buffer</strong>: Emacs</li>
<li><strong>Line array</strong>: Vim, Neovim</li>
</ul>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Piece Tree (Fresh, VS Code)</th>
<th>Rope (Helix, Zed)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Node contents</td>
<td>Pointer to buffer</td>
<td>Actual text (~1KB chunks)</td>
</tr>
<tr>
<td>Insert</td>
<td>Append to buffer, add piece</td>
<td>May copy/split chunk</td>
</tr>
<tr>
<td>Original file</td>
<td>Preserved in buffer 0</td>
<td>Reorganized into chunks</td>
</tr>
<tr>
<td>Large files</td>
<td>Lazy load regions (Fresh, Word 1.1a)</td>
<td>Must load or stream</td>
</tr>
<tr>
<td>Memory for edits</td>
<td>Minimal (just pointers)</td>
<td>Copies chunk data</td>
</tr>
</tbody>
</table>
<h2 id="trade-offs">Trade-offs</h2>
<p><strong>Advantages:</strong></p>
<ul>
<li>Original file content preserved (useful for diffs, minimal saves)</li>
<li>Inserts never copy existing text</li>
<li>Natural lazy loading for large files</li>
<li>Pieces are small (~24 bytes) - more fit in CPU cache during tree traversal</li>
</ul>
<p><strong>Disadvantages:</strong></p>
<ul>
<li>Extra indirection: find piece, then fetch from buffer</li>
<li>Buffer fragmentation over many edits (many small buffers)</li>
<li>Cache locality for text is poor (data scattered across buffers)</li>
<li>No automatic chunk coalescing (piece count grows with edits)</li>
</ul>
<p><em>(Note: Fresh's current implementation doesn't fully exploit immutability - it rebuilds the entire tree on each edit rather than path-copying, making edits O(P) instead of O(log P). VS Code has additional optimizations like search caching and line content caching that Fresh lacks. These are implementation gaps, not inherent to the designs.)</em></p>
<h2 id="further-reading">Further Reading</h2>
<ul>
<li><a href="https://sinelaw.github.io/fresh/">Fresh</a> - The editor discussed in this post (<a href="https://github.com/sinelaw/fresh">source on GitHub</a>)</li>
<li><a href="https://computerhistory.org/blog/microsoft-word-for-windows-1-1a-source-code/">Microsoft Word 1.1a Source Code</a> - Original piece table implementation from 1990</li>
<li><a href="https://code.visualstudio.com/blogs/2018/03/23/text-buffer-reimplementation">VS Code's Piece Table</a> - Microsoft's 2018 write-up on reviving piece tables</li>
<li><a href="https://zed.dev/blog/zed-decoded-rope-sumtree">Zed's Rope &amp; SumTree</a> - How Zed implements ropes with B+ trees</li>
<li><a href="https://coredumped.dev/2023/08/09/text-showdown-gap-buffers-vs-ropes/">Text Showdown: Gap Buffers vs Ropes</a> - Performance comparison</li>
<li><a href="https://www.cs.unm.edu/~crowley/papers/sds.pdf">Data Structures for Text Sequences</a> - Charles Crowley, 1998 (academic survey)</li>
</ul>
]]></content><author><name></name></author></entry><entry><title type="html">How Fresh Loads Huge Files Fast</title><link href="/blog/2025/12/08/how-fresh-loads-huge-files-fast.html" rel="alternate" type="text/html" title="How Fresh Loads Huge Files Fast" /><published>2025-12-08T22:52:15+00:00</published><updated>2025-12-08T22:52:15+00:00</updated><id>/blog/2025/12/08/how-fresh-loads-huge-files-fast.html</id><content type="html" xml:base="/blog/2025/12/08/how-fresh-loads-huge-files-fast.html"><![CDATA[<h1 id="how-fresh-loads-huge-files-fast">How Fresh Loads Huge Files Fast</h1>
<p>Fresh uses a <strong>piece tree</strong> (also called a piece table) for text storage. The piece table originated in the early 1970s - first in <a href="https://www.computerhistory.org/collections/catalog/102740449">J. Strother Moore's work at Edinburgh</a>, then in the <a href="https://en.wikipedia.org/wiki/Bravo_(editor)">Bravo editor</a> at Xerox PARC (1974) by Butler Lampson and Charles Simonyi. Simonyi later <a href="https://www.tiny.cloud/blog/wysiwyg-development-history/">brought it to Microsoft Word</a> (1983). The design minimizes memory copying by never modifying original file content - critical for early systems with limited RAM. <a href="https://code.visualstudio.com/blogs/2018/03/23/text-buffer-reimplementation">VS Code revived this approach in 2018</a>.</p>
<p><a href="https://sinelaw.github.io/fresh/">Fresh</a>'s implementation adds immutable nodes (for concurrency and cheap snapshots) and lazy loading (for large files). (<a href="https://github.com/sinelaw/fresh">GitHub</a>)</p>
<h2 id="the-core-idea">The Core Idea</h2>
<p>Instead of storing text in the tree, store <strong>pointers</strong> to text that lives elsewhere.</p>
<h3 id="rope-helix-zed">Rope (<a href="https://github.com/helix-editor/helix/blob/master/docs/architecture.md">Helix</a>, <a href="https://zed.dev/blog/zed-decoded-rope-sumtree">Zed</a>)</h3>
<p>Text lives inside tree nodes:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 360.6875 174" style="max-width: 360.688px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_L_0" d="M128.962,62L121.055,66.167C113.149,70.333,97.336,78.667,89.43,86.333C81.523,94,81.523,101,81.523,104.5L81.523,108"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_R_0" d="M231.429,62L239.335,66.167C247.242,70.333,263.054,78.667,270.961,86.333C278.867,94,278.867,101,278.867,104.5L278.867,108"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(180.1953125, 35)" id="flowchart-Root-0" class="node default"><rect height="54" width="156.0625" y="-27" x="-78.03125" style="" class="basic label-container"/><g transform="translate(-48.03125, -12)" style="" class="label"><rect/><foreignObject height="24" width="96.0625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Internal Node</p></span></div></foreignObject></g></g><g transform="translate(81.5234375, 139)" id="flowchart-L-2" class="node default"><rect height="54" width="147.046875" y="-27" x="-73.5234375" style="" class="basic label-container"/><g transform="translate(-43.5234375, -12)" style="" class="label"><rect/><foreignObject height="24" width="87.046875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Leaf: 'Hello '</p></span></div></foreignObject></g></g><g transform="translate(278.8671875, 139)" id="flowchart-R-4" class="node default"><rect height="54" width="147.640625" y="-27" x="-73.8203125" style="" class="basic label-container"/><g transform="translate(-43.8203125, -12)" style="" class="label"><rect/><foreignObject height="24" width="87.640625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Leaf: 'World'</p></span></div></foreignObject></g></g></g></g></g></svg></p>
<h3 id="piece-tree-fresh">Piece Tree (Fresh)</h3>
<p>Tree nodes point to separate buffers:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 656 402" style="max-width: 656px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="104" width="481.5703125" y="290" x="82.21484375" style=""/><g transform="translate(297.796875, 290)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="232" width="640" y="8" x="8" style=""/><g transform="translate(311.796875, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_L_0" d="M249.969,86.178L237.141,90.482C224.313,94.785,198.656,103.393,185.828,111.196C173,119,173,126,173,129.5L173,133"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_R_0" d="M406.031,86.178L418.859,90.482C431.688,94.785,457.344,103.393,470.172,111.196C483,119,483,126,483,129.5L483,133"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_L_B0_0" d="M173,215L173,219.167C173,223.333,173,231.667,173,240C173,248.333,173,256.667,173,265C173,273.333,173,281.667,184.788,289.788C196.576,297.909,220.151,305.819,231.939,309.773L243.727,313.728"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_R_B0_0" d="M483,215L483,219.167C483,223.333,483,231.667,483,240C483,248.333,483,256.667,483,265C483,273.333,483,281.667,471.212,289.788C459.424,297.909,435.849,305.819,424.061,309.773L412.273,313.728"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(328, 60)" id="flowchart-Root-0" class="node default"><rect height="54" width="156.0625" y="-27" x="-78.03125" style="" class="basic label-container"/><g transform="translate(-48.03125, -12)" style="" class="label"><rect/><foreignObject height="24" width="96.0625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Internal Node</p></span></div></foreignObject></g></g><g transform="translate(173, 176)" id="flowchart-L-2" class="node default"><rect height="78" width="260" y="-39" x="-130" style="" class="basic label-container"/><g transform="translate(-100, -24)" style="" class="label"><rect/><foreignObject height="48" width="200"><div style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: buffer 0, offset 0, len 6</p></span></div></foreignObject></g></g><g transform="translate(483, 176)" id="flowchart-R-4" class="node default"><rect height="78" width="260" y="-39" x="-130" style="" class="basic label-container"/><g transform="translate(-100, -24)" style="" class="label"><rect/><foreignObject height="48" width="200"><div style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: buffer 0, offset 6, len 5</p></span></div></foreignObject></g></g><g transform="translate(328, 342)" id="flowchart-B0-5" class="node default"><rect height="54" width="213.140625" y="-27" x="-106.5703125" style="" class="basic label-container"/><g transform="translate(-76.5703125, -12)" style="" class="label"><rect/><foreignObject height="24" width="153.140625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffer 0: 'Hello World'</p></span></div></foreignObject></g></g></g></g></g></svg></p>
<p>A <strong>piece</strong> is just three numbers: which buffer, starting offset, and length.</p>
<h2 id="what-happens-when-you-edit">What Happens When You Edit</h2>
<p>When you type or paste, Fresh appends to a new buffer and creates a piece pointing to it. The original buffer stays untouched.</p>
<h3 id="before-file-contains-hello-world">Before: File contains "Hello World"</h3>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 610.234375 164" style="max-width: 610.234px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="148" width="310" y="8" x="292.234375" style=""/><g transform="translate(422.03125, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="124" width="234.234375" y="20" x="8" style=""/><g transform="translate(108.9140625, 20)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M217.234,82L221.401,82C225.568,82,233.901,82,242.234,82C250.568,82,258.901,82,267.234,82C275.568,82,283.901,82,291.568,82C299.234,82,306.234,82,309.734,82L313.234,82"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(125.1171875, 82)" id="flowchart-P1-0" class="node default"><rect height="54" width="184.234375" y="-27" x="-92.1171875" style="" class="basic label-container"/><g transform="translate(-62.1171875, -12)" style="" class="label"><rect/><foreignObject height="24" width="124.234375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: buf 0, 0-11</p></span></div></foreignObject></g></g><g transform="translate(447.234375, 82)" id="flowchart-B0-1" class="node default"><rect height="78" width="260" y="-39" x="-130" style="" class="basic label-container"/><g transform="translate(-100, -24)" style="" class="label"><rect/><foreignObject height="48" width="200"><div style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffer 0 (original): 'Hello World'</p></span></div></foreignObject></g></g></g></g></g></svg></p>
<h3 id="after-insert-big--at-position-6">After: Insert "Big " at position 6</h3>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 610.234375 354" style="max-width: 610.234px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="333" width="310" y="13" x="292.234375" style=""/><g transform="translate(422.03125, 13)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="338" width="234.234375" y="8" x="8" style=""/><g transform="translate(108.9140625, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M213.375,70L218.185,70C222.995,70,232.615,70,241.591,70C250.568,70,258.901,70,267.234,70C275.568,70,283.901,70,293.894,71.955C303.887,73.909,315.54,77.819,321.366,79.773L327.192,81.728"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P2_B1_0" d="M213.375,284L218.185,284C222.995,284,232.615,284,241.591,284C250.568,284,258.901,284,267.234,284C275.568,284,283.901,284,295.076,284C306.25,284,320.266,284,327.273,284L334.281,284"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P3_B0_0" d="M217.234,174L221.401,174C225.568,174,233.901,174,242.234,174C250.568,174,258.901,174,267.234,174C275.568,174,283.901,174,293.894,172.045C303.887,170.091,315.54,166.181,321.366,164.227L327.192,162.272"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(125.1171875, 70)" id="flowchart-P1-0" class="node default"><rect height="54" width="176.515625" y="-27" x="-88.2578125" style="" class="basic label-container"/><g transform="translate(-58.2578125, -12)" style="" class="label"><rect/><foreignObject height="24" width="116.515625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: buf 0, 0-6</p></span></div></foreignObject></g></g><g transform="translate(125.1171875, 284)" id="flowchart-P2-1" class="node default"><rect height="54" width="176.515625" y="-27" x="-88.2578125" style="" class="basic label-container"/><g transform="translate(-58.2578125, -12)" style="" class="label"><rect/><foreignObject height="24" width="116.515625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: buf 1, 0-4</p></span></div></foreignObject></g></g><g transform="translate(125.1171875, 174)" id="flowchart-P3-2" class="node default"><rect height="54" width="184.234375" y="-27" x="-92.1171875" style="" class="basic label-container"/><g transform="translate(-62.1171875, -12)" style="" class="label"><rect/><foreignObject height="24" width="124.234375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: buf 0, 6-11</p></span></div></foreignObject></g></g><g transform="translate(447.234375, 122)" id="flowchart-B0-3" class="node default"><rect height="78" width="260" y="-39" x="-130" style="" class="basic label-container"/><g transform="translate(-100, -24)" style="" class="label"><rect/><foreignObject height="48" width="200"><div style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffer 0 (original): 'Hello World'</p></span></div></foreignObject></g></g><g transform="translate(447.234375, 284)" id="flowchart-B1-4" class="node default"><rect height="54" width="217.90625" y="-27" x="-108.953125" style="" class="basic label-container"/><g transform="translate(-78.953125, -12)" style="" class="label"><rect/><foreignObject height="24" width="157.90625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffer 1 (added): 'Big '</p></span></div></foreignObject></g></g></g></g></g></svg></p>
<p>Document now reads: "Hello Big World"</p>
<p>The original file content in Buffer 0 was never modified or copied.</p>
<h2 id="lazy-loading">Lazy Loading</h2>
<p>For large files, Fresh doesn't load the entire file into memory. Buffers can be <strong>unloaded</strong> - they store a file path and byte range instead of actual data.</p>
<p>This is actually how the original <a href="https://computerhistory.org/blog/microsoft-word-for-windows-1-1a-source-code/">Word 1.1a</a> piece table worked: pieces pointed directly to spans in the original file on disk, loading content only when needed. VS Code's 2018 implementation loads files fully into memory; Fresh returns to the original memory-conscious design.</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 835.546875 346" style="max-width: 835.547px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="176" width="607.546875" y="162" x="96" style=""/><g transform="translate(374.5703125, 162)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="104" width="819.546875" y="8" x="8" style=""/><g transform="translate(401.5703125, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M143.258,87L143.258,91.167C143.258,95.333,143.258,103.667,143.258,112C143.258,120.333,143.258,128.667,143.258,137C143.258,145.333,143.258,153.667,168.583,166.323C193.908,178.979,244.558,195.958,269.882,204.447L295.207,212.936"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P2_B0_0" d="M405.773,87L405.773,91.167C405.773,95.333,405.773,103.667,405.773,112C405.773,120.333,405.773,128.667,405.773,137C405.773,145.333,405.773,153.667,405.773,161.333C405.773,169,405.773,176,405.773,179.5L405.773,183"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P3_B0_0" d="M680.289,87L680.289,91.167C680.289,95.333,680.289,103.667,680.289,112C680.289,120.333,680.289,128.667,680.289,137C680.289,145.333,680.289,153.667,652.967,166.592C625.645,179.517,571,197.034,543.678,205.793L516.356,214.551"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(143.2578125, 60)" id="flowchart-P1-0" class="node default"><rect height="54" width="200.515625" y="-27" x="-100.2578125" style="" class="basic label-container"/><g transform="translate(-70.2578125, -12)" style="" class="label"><rect/><foreignObject height="24" width="140.515625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: buf 0, 0-1MB</p></span></div></foreignObject></g></g><g transform="translate(405.7734375, 60)" id="flowchart-P2-1" class="node default"><rect height="54" width="224.515625" y="-27" x="-112.2578125" style="" class="basic label-container"/><g transform="translate(-82.2578125, -12)" style="" class="label"><rect/><foreignObject height="24" width="164.515625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: buf 0, 1MB-2MB</p></span></div></foreignObject></g></g><g transform="translate(680.2890625, 60)" id="flowchart-P3-2" class="node default"><rect height="54" width="224.515625" y="-27" x="-112.2578125" style="" class="basic label-container"/><g transform="translate(-82.2578125, -12)" style="" class="label"><rect/><foreignObject height="24" width="164.515625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: buf 0, 2MB-3MB</p></span></div></foreignObject></g></g><g transform="translate(405.7734375, 250)" id="flowchart-B0-3" class="node default"><rect height="126" width="213.546875" y="-63" x="-106.7734375" style="" class="basic label-container"/><g transform="translate(-76.7734375, -48)" style="" class="label"><rect/><foreignObject height="96" width="153.546875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffer 0: UNLOADED<br />file: /path/to/large.txt<br />offset: 0<br />bytes: 3MB</p></span></div></foreignObject></g></g></g></g></g></svg></p>
<p>When you scroll to a region, Fresh loads only that chunk from disk:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 351 444" style="max-width: 351px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"/><g class="edgeLabels"/><g class="nodes"><g transform="translate(0, 0)" class="root"><g class="clusters"><g data-look="classic" id="subGraph0" class="cluster"><rect height="428" width="335" y="8" x="8" style=""/><g transform="translate(92.29296875, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">After</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> scrolling</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> to</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> middle</tspan></tspan></text></g></g></g></g><g class="edgePaths"/><g class="edgeLabels"/><g class="nodes"><g transform="translate(175.5, 82)" id="flowchart-B0_new-0" class="node default"><rect height="78" width="260" y="-39" x="-130" style="" class="basic label-container"/><g transform="translate(-100, -24)" style="" class="label"><rect/><foreignObject height="48" width="200"><div style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffer 0: UNLOADED (0-1MB)</p></span></div></foreignObject></g></g><g transform="translate(175.5, 222)" id="flowchart-B1_new-1" class="node default"><rect height="102" width="260" y="-51" x="-130" style="" class="basic label-container"/><g transform="translate(-100, -36)" style="" class="label"><rect/><foreignObject height="72" width="200"><div style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffer 1: LOADED (1MB-2MB)<br />actual bytes in memory</p></span></div></foreignObject></g></g><g transform="translate(175.5, 362)" id="flowchart-B2_new-2" class="node default"><rect height="78" width="260" y="-39" x="-130" style="" class="basic label-container"/><g transform="translate(-100, -24)" style="" class="label"><rect/><foreignObject height="48" width="200"><div style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffer 2: UNLOADED (2MB-3MB)</p></span></div></foreignObject></g></g></g></g></g></g></g></svg></p>
<h2 id="zero-copy-reads">Zero-Copy Reads</h2>
<p>When reading text for display, Fresh doesn't copy bytes. It returns slices pointing directly into the buffers:</p>
<pre class="rust"><code>// Returns &amp;[u8] pointing into buffer memory
// No allocation, no copy
let text = buffer.get_text_range(100, 200);</code></pre>
<p>Multiple pieces can reference the same buffer region. Displaying the same text twice doesn't double memory usage.</p>
<h2 id="the-tree-structure">The Tree Structure</h2>
<p>The pieces are organized in a balanced binary tree for fast lookups:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 507.3984375 326" style="max-width: 507.398px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_I2_0" d="M243.869,86L236.959,90.167C230.048,94.333,216.227,102.667,209.317,110.333C202.406,118,202.406,125,202.406,128.5L202.406,132"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_L3_0" d="M373.233,86L380.143,90.167C387.054,94.333,400.874,102.667,407.785,112.333C414.695,122,414.695,133,414.695,138.5L414.695,144"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L1_0" d="M135.556,214L128.414,218.167C121.272,222.333,106.987,230.667,99.845,238.333C92.703,246,92.703,253,92.703,256.5L92.703,260"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L2_0" d="M269.257,214L276.399,218.167C283.541,222.333,297.825,230.667,304.967,238.333C312.109,246,312.109,253,312.109,256.5L312.109,260"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(308.55078125, 47)" id="flowchart-I1-0" class="node default"><rect height="78" width="164.078125" y="-39" x="-82.0390625" style="" class="basic label-container"/><g transform="translate(-52.0390625, -24)" style="" class="label"><rect/><foreignObject height="48" width="104.078125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Internal<br />left_bytes: 100</p></span></div></foreignObject></g></g><g transform="translate(202.40625, 175)" id="flowchart-I2-2" class="node default"><rect height="78" width="155.171875" y="-39" x="-77.5859375" style="" class="basic label-container"/><g transform="translate(-47.5859375, -24)" style="" class="label"><rect/><foreignObject height="48" width="95.171875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Internal<br />left_bytes: 50</p></span></div></foreignObject></g></g><g transform="translate(414.6953125, 175)" id="flowchart-L3-4" class="node default"><rect height="54" width="169.40625" y="-27" x="-84.703125" style="" class="basic label-container"/><g transform="translate(-54.703125, -12)" style="" class="label"><rect/><foreignObject height="24" width="109.40625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: 50 bytes</p></span></div></foreignObject></g></g><g transform="translate(92.703125, 291)" id="flowchart-L1-6" class="node default"><rect height="54" width="169.40625" y="-27" x="-84.703125" style="" class="basic label-container"/><g transform="translate(-54.703125, -12)" style="" class="label"><rect/><foreignObject height="24" width="109.40625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: 50 bytes</p></span></div></foreignObject></g></g><g transform="translate(312.109375, 291)" id="flowchart-L2-8" class="node default"><rect height="54" width="169.40625" y="-27" x="-84.703125" style="" class="basic label-container"/><g transform="translate(-54.703125, -12)" style="" class="label"><rect/><foreignObject height="24" width="109.40625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: 50 bytes</p></span></div></foreignObject></g></g></g></g></g></svg></p>
<p>Each internal node caches the total bytes in its left subtree. To find byte offset 75:</p>
<ol type="1">
<li>Root has <code>left_bytes: 100</code>, and 75 &lt; 100, so go left</li>
<li>Internal has <code>left_bytes: 50</code>, and 75 &gt;= 50, so go right with offset 75-50=25</li>
<li>Piece has 50 bytes, offset 25 is within it</li>
</ol>
<p>This is O(log P) where P is the number of pieces.</p>
<h2 id="line-feed-tracking">Line Feed Tracking</h2>
<p>Text editors need fast line-based operations: "go to line 1000", "what line is byte offset 50000 on?", or simply displaying line numbers. Scanning the entire document for newlines would be O(N) - too slow for large files.</p>
<p>Fresh tracks line feeds the same way it tracks bytes. Each piece stores its newline count, and internal nodes cache the count for their left subtree:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 507.3984375 398" style="max-width: 507.398px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_I2_0" d="M237.322,110L231.503,114.167C225.684,118.333,214.045,126.667,208.226,134.333C202.406,142,202.406,149,202.406,152.5L202.406,156"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_L3_0" d="M379.779,110L385.599,114.167C391.418,118.333,403.057,126.667,408.876,136.333C414.695,146,414.695,157,414.695,162.5L414.695,168"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L1_0" d="M128.79,262L122.775,266.167C116.761,270.333,104.732,278.667,98.718,286.333C92.703,294,92.703,301,92.703,304.5L92.703,308"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L2_0" d="M276.023,262L282.037,266.167C288.052,270.333,300.081,278.667,306.095,286.333C312.109,294,312.109,301,312.109,304.5L312.109,308"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(308.55078125, 59)" id="flowchart-I1-0" class="node default"><rect height="102" width="164.078125" y="-51" x="-82.0390625" style="" class="basic label-container"/><g transform="translate(-52.0390625, -36)" style="" class="label"><rect/><foreignObject height="72" width="104.078125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Internal<br />left_bytes: 100<br />lf_left: 3</p></span></div></foreignObject></g></g><g transform="translate(202.40625, 211)" id="flowchart-I2-2" class="node default"><rect height="102" width="155.171875" y="-51" x="-77.5859375" style="" class="basic label-container"/><g transform="translate(-47.5859375, -36)" style="" class="label"><rect/><foreignObject height="72" width="95.171875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Internal<br />left_bytes: 50<br />lf_left: 2</p></span></div></foreignObject></g></g><g transform="translate(414.6953125, 211)" id="flowchart-L3-4" class="node default"><rect height="78" width="169.40625" y="-39" x="-84.703125" style="" class="basic label-container"/><g transform="translate(-54.703125, -24)" style="" class="label"><rect/><foreignObject height="48" width="109.40625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: 50 bytes<br />line_feeds: 1</p></span></div></foreignObject></g></g><g transform="translate(92.703125, 351)" id="flowchart-L1-6" class="node default"><rect height="78" width="169.40625" y="-39" x="-84.703125" style="" class="basic label-container"/><g transform="translate(-54.703125, -24)" style="" class="label"><rect/><foreignObject height="48" width="109.40625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: 30 bytes<br />line_feeds: 2</p></span></div></foreignObject></g></g><g transform="translate(312.109375, 351)" id="flowchart-L2-8" class="node default"><rect height="78" width="169.40625" y="-39" x="-84.703125" style="" class="basic label-container"/><g transform="translate(-54.703125, -24)" style="" class="label"><rect/><foreignObject height="48" width="109.40625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: 20 bytes<br />line_feeds: 0</p></span></div></foreignObject></g></g></g></g></g></svg></p>
<p>To find which piece contains line 3:</p>
<ol type="1">
<li>Root has <code>lf_left: 3</code>, and 3 &gt;= 3, so go right with line 3-3=0</li>
<li>Piece L3 has <code>line_feeds: 1</code>, line 0 is within it</li>
</ol>
<p>This enables O(log P) line-to-offset conversion. The same structure supports offset-to-line lookup by accumulating line counts while traversing.</p>
<p>For large files where line indexing hasn't been computed (lazy loading), these counts are <code>None</code> and Fresh falls back to scanning. Once a region is loaded and indexed, the counts become available.</p>
<h2 id="immutable-tree-structure">Immutable Tree Structure</h2>
<p>Fresh uses immutable nodes - once created, a node is never modified. Edits create new nodes instead.</p>
<blockquote>
<p><strong>Implementation note:</strong> Fresh is written in Rust. Nodes are wrapped in <code>Arc&lt;T&gt;</code> (Atomic Reference Counted pointer) - think of it as a pointer that tracks how many things reference it. Multiple parts of the code (even different threads) can safely hold the same <code>Arc</code>, and the data is automatically freed when the last reference is dropped. We'll gloss over this detail going forward - just know that "sharing" a node is cheap and thread-safe.</p>
</blockquote>
<p>After an edit, old tree versions remain valid:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 549.41796875 224" style="max-width: 549.418px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="subGraph1" class="cluster"><rect height="208" width="197.8125" y="8" x="8" style=""/><g transform="translate(34.859375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Version</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (after</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> edit)</tspan></tspan></text></g></g></g><g data-look="classic" id="subGraph0" class="cluster"><rect height="208" width="315.60546875" y="8" x="225.8125" style=""/><g transform="translate(304.896484375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Version</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (before</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> edit)</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V1_Root_V1_L_0" d="M345.41,87L339.72,91.167C334.03,95.333,322.65,103.667,316.96,111.333C311.27,119,311.27,126,311.27,129.5L311.27,133"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V1_Root_V1_R_0" d="M419.153,87L424.843,91.167C430.533,95.333,441.913,103.667,447.603,111.333C453.293,119,453.293,126,453.293,129.5L453.293,133"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V2_Root_V1_L_0" d="M131.654,87L134.633,91.167C137.612,95.333,143.57,103.667,165.647,113.973C187.724,124.28,225.921,136.56,245.019,142.701L264.118,148.841"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V2_Root_V2_R_0" d="M107.159,87L106.358,91.167C105.557,95.333,103.954,103.667,103.153,111.333C102.352,119,102.352,126,102.352,129.5L102.352,133"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(382.28125, 60)" id="flowchart-V1_Root-0" class="node default"><rect height="54" width="115.140625" y="-27" x="-57.5703125" style="" class="basic label-container"/><g transform="translate(-27.5703125, -12)" style="" class="label"><rect/><foreignObject height="24" width="55.140625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Root v1</p></span></div></foreignObject></g></g><g transform="translate(311.26953125, 164)" id="flowchart-V1_L-1" class="node default"><rect height="54" width="86.6875" y="-27" x="-43.34375" style="" class="basic label-container"/><g transform="translate(-13.34375, -12)" style="" class="label"><rect/><foreignObject height="24" width="26.6875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Left</p></span></div></foreignObject></g></g><g transform="translate(453.29296875, 164)" id="flowchart-V1_R-3" class="node default"><rect height="54" width="97.359375" y="-27" x="-48.6796875" style="" class="basic label-container"/><g transform="translate(-18.6796875, -12)" style="" class="label"><rect/><foreignObject height="24" width="37.359375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Right</p></span></div></foreignObject></g></g><g transform="translate(112.3515625, 60)" id="flowchart-V2_Root-4" class="node default"><rect height="54" width="115.140625" y="-27" x="-57.5703125" style="" class="basic label-container"/><g transform="translate(-27.5703125, -12)" style="" class="label"><rect/><foreignObject height="24" width="55.140625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Root v2</p></span></div></foreignObject></g></g><g transform="translate(102.3515625, 164)" id="flowchart-V2_R-7" class="node default"><rect height="54" width="118.703125" y="-27" x="-59.3515625" style="" class="basic label-container"/><g transform="translate(-29.3515625, -12)" style="" class="label"><rect/><foreignObject height="24" width="58.703125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Right v2</p></span></div></foreignObject></g></g></g></g></g></svg></p>
<p>Version 2 shares the unchanged left subtree with Version 1. This enables:</p>
<ul>
<li>Undo/redo by keeping old root references</li>
<li>Concurrent reads without locks</li>
<li>Cheap snapshots</li>
</ul>
<h2 id="fresh-vs-vs-code">Fresh vs VS Code</h2>
<p>VS Code also uses a piece tree. The core idea is identical, but the designs diverge on one key question: mutable or immutable nodes?</p>
<p><strong>VS Code</strong>: Mutable tree. Edits modify nodes in place using red-black tree rotations. Undo/redo is handled by a separate layer that stores edit operations.</p>
<p><strong>Fresh</strong>: Immutable nodes. Edits produce new tree versions while old versions remain valid, with unchanged subtrees shared between versions. (This is known as a <a href="https://en.wikipedia.org/wiki/Persistent_data_structure">persistent data structure</a> in CS literature.)</p>
<h3 id="inherent-trade-offs">Inherent Trade-offs</h3>
<p><strong>Immutable (Fresh):</strong></p>
<ul>
<li>Old tree versions stay valid - enables cheap snapshots and structural sharing</li>
<li>Concurrent reads need no synchronization</li>
<li>Undo can be "keep the old root" instead of "replay operations backward"</li>
<li>More allocations per edit (new nodes along modified path)</li>
</ul>
<p><strong>Mutable (VS Code):</strong></p>
<ul>
<li>Edits modify in place - less allocation overhead</li>
<li>Requires separate undo infrastructure</li>
<li>Concurrent access needs care</li>
</ul>
<p><strong>Lazy loading</strong> is orthogonal to mutability, but Fresh implements it and VS Code doesn't. Fresh can leave file regions on disk until accessed; VS Code loads the entire file.</p>
<h2 id="comparison-piece-tree-vs-rope">Comparison: Piece Tree vs Rope</h2>
<p>Different editors use different text storage structures:</p>
<ul>
<li><strong>Piece tree</strong>: VS Code, Fresh</li>
<li><strong>Rope</strong>: Helix (uses <a href="https://github.com/cessen/ropey">Ropey</a>), Zed (custom <a href="https://zed.dev/blog/zed-decoded-rope-sumtree">SumTree</a>)</li>
<li><strong>Gap buffer</strong>: Emacs</li>
<li><strong>Line array</strong>: Vim, Neovim</li>
</ul>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Piece Tree (Fresh, VS Code)</th>
<th>Rope (Helix, Zed)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Node contents</td>
<td>Pointer to buffer</td>
<td>Actual text (~1KB chunks)</td>
</tr>
<tr>
<td>Insert</td>
<td>Append to buffer, add piece</td>
<td>May copy/split chunk</td>
</tr>
<tr>
<td>Original file</td>
<td>Preserved in buffer 0</td>
<td>Reorganized into chunks</td>
</tr>
<tr>
<td>Large files</td>
<td>Lazy load regions (Fresh, Word 1.1a)</td>
<td>Must load or stream</td>
</tr>
<tr>
<td>Memory for edits</td>
<td>Minimal (just pointers)</td>
<td>Copies chunk data</td>
</tr>
</tbody>
</table>
<h2 id="trade-offs">Trade-offs</h2>
<p><strong>Advantages:</strong></p>
<ul>
<li>Original file content preserved (useful for diffs, minimal saves)</li>
<li>Inserts never copy existing text</li>
<li>Natural lazy loading for large files</li>
<li>Pieces are small (~24 bytes) - more fit in CPU cache during tree traversal</li>
</ul>
<p><strong>Disadvantages:</strong></p>
<ul>
<li>Extra indirection: find piece, then fetch from buffer</li>
<li>Buffer fragmentation over many edits (many small buffers)</li>
<li>Cache locality for text is poor (data scattered across buffers)</li>
<li>No automatic chunk coalescing (piece count grows with edits)</li>
</ul>
<p><em>(Note: Fresh's current implementation doesn't fully exploit immutability - it rebuilds the entire tree on each edit rather than path-copying, making edits O(P) instead of O(log P). VS Code has additional optimizations like search caching and line content caching that Fresh lacks. These are implementation gaps, not inherent to the designs.)</em></p>
<h2 id="further-reading">Further Reading</h2>
<ul>
<li><a href="https://sinelaw.github.io/fresh/">Fresh</a> - The editor discussed in this post (<a href="https://github.com/sinelaw/fresh">source on GitHub</a>)</li>
<li><a href="https://computerhistory.org/blog/microsoft-word-for-windows-1-1a-source-code/">Microsoft Word 1.1a Source Code</a> - Original piece table implementation from 1990</li>
<li><a href="https://code.visualstudio.com/blogs/2018/03/23/text-buffer-reimplementation">VS Code's Piece Table</a> - Microsoft's 2018 write-up on reviving piece tables</li>
<li><a href="https://zed.dev/blog/zed-decoded-rope-sumtree">Zed's Rope &amp; SumTree</a> - How Zed implements ropes with B+ trees</li>
<li><a href="https://coredumped.dev/2023/08/09/text-showdown-gap-buffers-vs-ropes/">Text Showdown: Gap Buffers vs Ropes</a> - Performance comparison</li>
<li><a href="https://www.cs.unm.edu/~crowley/papers/sds.pdf">Data Structures for Text Sequences</a> - Charles Crowley, 1998 (academic survey)</li>
</ul>
]]></content><author><name></name></author></entry><entry><title type="html">How Fresh Loads Huge Files Fast</title><link href="/blog/2025/12/08/how-fresh-loads-huge-files-fast.html" rel="alternate" type="text/html" title="How Fresh Loads Huge Files Fast" /><published>2025-12-08T22:48:12+00:00</published><updated>2025-12-08T22:48:12+00:00</updated><id>/blog/2025/12/08/how-fresh-loads-huge-files-fast.html</id><content type="html" xml:base="/blog/2025/12/08/how-fresh-loads-huge-files-fast.html"><![CDATA[<h1 id="how-fresh-loads-huge-files-fast">How Fresh Loads Huge Files Fast</h1>
<p>Fresh uses a <strong>piece tree</strong> (also called a piece table) for text storage. The piece table originated in the early 1970s - first in <a href="https://www.computerhistory.org/collections/catalog/102740449">J. Strother Moore's work at Edinburgh</a>, then in the <a href="https://en.wikipedia.org/wiki/Bravo_(editor)">Bravo editor</a> at Xerox PARC (1974) by Butler Lampson and Charles Simonyi. Simonyi later <a href="https://www.tiny.cloud/blog/wysiwyg-development-history/">brought it to Microsoft Word</a> (1983). The design minimizes memory copying by never modifying original file content - critical for early systems with limited RAM. <a href="https://code.visualstudio.com/blogs/2018/03/23/text-buffer-reimplementation">VS Code revived this approach in 2018</a>.</p>
<p><a href="https://sinelaw.github.io/fresh/">Fresh</a>'s implementation adds immutable nodes (for concurrency and cheap snapshots) and lazy loading (for large files). (<a href="https://github.com/sinelaw/fresh">GitHub</a>)</p>
<h2 id="the-core-idea">The Core Idea</h2>
<p>Instead of storing text in the tree, store <strong>pointers</strong> to text that lives elsewhere.</p>
<h3 id="rope-helix-zed">Rope (<a href="https://github.com/helix-editor/helix/blob/master/docs/architecture.md">Helix</a>, <a href="https://zed.dev/blog/zed-decoded-rope-sumtree">Zed</a>)</h3>
<p>Text lives inside tree nodes:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 360.6875 174" style="max-width: 360.688px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_L_0" d="M128.962,62L121.055,66.167C113.149,70.333,97.336,78.667,89.43,86.333C81.523,94,81.523,101,81.523,104.5L81.523,108"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_R_0" d="M231.429,62L239.335,66.167C247.242,70.333,263.054,78.667,270.961,86.333C278.867,94,278.867,101,278.867,104.5L278.867,108"/></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(180.1953125, 35)" id="flowchart-Root-0" class="node default"><rect height="54" width="156.0625" y="-27" x="-78.03125" style="" class="basic label-container"/><g transform="translate(-48.03125, -12)" style="" class="label"><rect/><foreignObject height="24" width="96.0625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Internal Node</p></span></div></foreignObject></g></g><g transform="translate(81.5234375, 139)" id="flowchart-L-2" class="node default"><rect height="54" width="147.046875" y="-27" x="-73.5234375" style="" class="basic label-container"/><g transform="translate(-43.5234375, -12)" style="" class="label"><rect/><foreignObject height="24" width="87.046875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Leaf: 'Hello '</p></span></div></foreignObject></g></g><g transform="translate(278.8671875, 139)" id="flowchart-R-4" class="node default"><rect height="54" width="147.640625" y="-27" x="-73.8203125" style="" class="basic label-container"/><g transform="translate(-43.8203125, -12)" style="" class="label"><rect/><foreignObject height="24" width="87.640625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Leaf: 'World'</p></span></div></foreignObject></g></g></g></g></g></svg></p>
<h3 id="piece-tree-fresh">Piece Tree (Fresh)</h3>
<p>Tree nodes point to separate buffers:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 656 402" style="max-width: 656px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="104" width="481.5703125" y="290" x="82.21484375" style=""/><g transform="translate(297.796875, 290)" class="cluster-label"><foreignObject height="24" width="50.40625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffers</p></span></div></foreignObject></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="232" width="640" y="8" x="8" style=""/><g transform="translate(311.84375, 8)" class="cluster-label"><foreignObject height="24" width="32.3125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Tree</p></span></div></foreignObject></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_L_0" d="M249.969,86.178L237.141,90.482C224.313,94.785,198.656,103.393,185.828,111.196C173,119,173,126,173,129.5L173,133"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_R_0" d="M406.031,86.178L418.859,90.482C431.688,94.785,457.344,103.393,470.172,111.196C483,119,483,126,483,129.5L483,133"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_L_B0_0" d="M173,215L173,219.167C173,223.333,173,231.667,173,240C173,248.333,173,256.667,173,265C173,273.333,173,281.667,184.788,289.788C196.576,297.909,220.151,305.819,231.939,309.773L243.727,313.728"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_R_B0_0" d="M483,215L483,219.167C483,223.333,483,231.667,483,240C483,248.333,483,256.667,483,265C483,273.333,483,281.667,471.212,289.788C459.424,297.909,435.849,305.819,424.061,309.773L412.273,313.728"/></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(328, 60)" id="flowchart-Root-0" class="node default"><rect height="54" width="156.0625" y="-27" x="-78.03125" style="" class="basic label-container"/><g transform="translate(-48.03125, -12)" style="" class="label"><rect/><foreignObject height="24" width="96.0625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Internal Node</p></span></div></foreignObject></g></g><g transform="translate(173, 176)" id="flowchart-L-2" class="node default"><rect height="78" width="260" y="-39" x="-130" style="" class="basic label-container"/><g transform="translate(-100, -24)" style="" class="label"><rect/><foreignObject height="48" width="200"><div style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: buffer 0, offset 0, len 6</p></span></div></foreignObject></g></g><g transform="translate(483, 176)" id="flowchart-R-4" class="node default"><rect height="78" width="260" y="-39" x="-130" style="" class="basic label-container"/><g transform="translate(-100, -24)" style="" class="label"><rect/><foreignObject height="48" width="200"><div style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: buffer 0, offset 6, len 5</p></span></div></foreignObject></g></g><g transform="translate(328, 342)" id="flowchart-B0-5" class="node default"><rect height="54" width="213.140625" y="-27" x="-106.5703125" style="" class="basic label-container"/><g transform="translate(-76.5703125, -12)" style="" class="label"><rect/><foreignObject height="24" width="153.140625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffer 0: 'Hello World'</p></span></div></foreignObject></g></g></g></g></g></svg></p>
<p>A <strong>piece</strong> is just three numbers: which buffer, starting offset, and length.</p>
<h2 id="what-happens-when-you-edit">What Happens When You Edit</h2>
<p>When you type or paste, Fresh appends to a new buffer and creates a piece pointing to it. The original buffer stays untouched.</p>
<h3 id="before-file-contains-hello-world">Before: File contains "Hello World"</h3>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 610.234375 164" style="max-width: 610.234px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="148" width="310" y="8" x="292.234375" style=""/><g transform="translate(422.03125, 8)" class="cluster-label"><foreignObject height="24" width="50.40625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffers</p></span></div></foreignObject></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="124" width="234.234375" y="20" x="8" style=""/><g transform="translate(108.9609375, 20)" class="cluster-label"><foreignObject height="24" width="32.3125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Tree</p></span></div></foreignObject></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M217.234,82L221.401,82C225.568,82,233.901,82,242.234,82C250.568,82,258.901,82,267.234,82C275.568,82,283.901,82,291.568,82C299.234,82,306.234,82,309.734,82L313.234,82"/></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(125.1171875, 82)" id="flowchart-P1-0" class="node default"><rect height="54" width="184.234375" y="-27" x="-92.1171875" style="" class="basic label-container"/><g transform="translate(-62.1171875, -12)" style="" class="label"><rect/><foreignObject height="24" width="124.234375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: buf 0, 0-11</p></span></div></foreignObject></g></g><g transform="translate(447.234375, 82)" id="flowchart-B0-1" class="node default"><rect height="78" width="260" y="-39" x="-130" style="" class="basic label-container"/><g transform="translate(-100, -24)" style="" class="label"><rect/><foreignObject height="48" width="200"><div style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffer 0 (original): 'Hello World'</p></span></div></foreignObject></g></g></g></g></g></svg></p>
<h3 id="after-insert-big--at-position-6">After: Insert "Big " at position 6</h3>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 610.234375 354" style="max-width: 610.234px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="333" width="310" y="13" x="292.234375" style=""/><g transform="translate(422.03125, 13)" class="cluster-label"><foreignObject height="24" width="50.40625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffers</p></span></div></foreignObject></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="338" width="234.234375" y="8" x="8" style=""/><g transform="translate(108.9609375, 8)" class="cluster-label"><foreignObject height="24" width="32.3125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Tree</p></span></div></foreignObject></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M213.375,70L218.185,70C222.995,70,232.615,70,241.591,70C250.568,70,258.901,70,267.234,70C275.568,70,283.901,70,293.894,71.955C303.887,73.909,315.54,77.819,321.366,79.773L327.192,81.728"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P2_B1_0" d="M213.375,284L218.185,284C222.995,284,232.615,284,241.591,284C250.568,284,258.901,284,267.234,284C275.568,284,283.901,284,295.076,284C306.25,284,320.266,284,327.273,284L334.281,284"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P3_B0_0" d="M217.234,174L221.401,174C225.568,174,233.901,174,242.234,174C250.568,174,258.901,174,267.234,174C275.568,174,283.901,174,293.894,172.045C303.887,170.091,315.54,166.181,321.366,164.227L327.192,162.272"/></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(125.1171875, 70)" id="flowchart-P1-0" class="node default"><rect height="54" width="176.515625" y="-27" x="-88.2578125" style="" class="basic label-container"/><g transform="translate(-58.2578125, -12)" style="" class="label"><rect/><foreignObject height="24" width="116.515625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: buf 0, 0-6</p></span></div></foreignObject></g></g><g transform="translate(125.1171875, 284)" id="flowchart-P2-1" class="node default"><rect height="54" width="176.515625" y="-27" x="-88.2578125" style="" class="basic label-container"/><g transform="translate(-58.2578125, -12)" style="" class="label"><rect/><foreignObject height="24" width="116.515625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: buf 1, 0-4</p></span></div></foreignObject></g></g><g transform="translate(125.1171875, 174)" id="flowchart-P3-2" class="node default"><rect height="54" width="184.234375" y="-27" x="-92.1171875" style="" class="basic label-container"/><g transform="translate(-62.1171875, -12)" style="" class="label"><rect/><foreignObject height="24" width="124.234375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: buf 0, 6-11</p></span></div></foreignObject></g></g><g transform="translate(447.234375, 122)" id="flowchart-B0-3" class="node default"><rect height="78" width="260" y="-39" x="-130" style="" class="basic label-container"/><g transform="translate(-100, -24)" style="" class="label"><rect/><foreignObject height="48" width="200"><div style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffer 0 (original): 'Hello World'</p></span></div></foreignObject></g></g><g transform="translate(447.234375, 284)" id="flowchart-B1-4" class="node default"><rect height="54" width="217.90625" y="-27" x="-108.953125" style="" class="basic label-container"/><g transform="translate(-78.953125, -12)" style="" class="label"><rect/><foreignObject height="24" width="157.90625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffer 1 (added): 'Big '</p></span></div></foreignObject></g></g></g></g></g></svg></p>
<p>Document now reads: "Hello Big World"</p>
<p>The original file content in Buffer 0 was never modified or copied.</p>
<h2 id="lazy-loading">Lazy Loading</h2>
<p>For large files, Fresh doesn't load the entire file into memory. Buffers can be <strong>unloaded</strong> - they store a file path and byte range instead of actual data.</p>
<p>This is actually how the original <a href="https://computerhistory.org/blog/microsoft-word-for-windows-1-1a-source-code/">Word 1.1a</a> piece table worked: pieces pointed directly to spans in the original file on disk, loading content only when needed. VS Code's 2018 implementation loads files fully into memory; Fresh returns to the original memory-conscious design.</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 835.546875 346" style="max-width: 835.547px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="176" width="607.546875" y="162" x="96" style=""/><g transform="translate(374.5703125, 162)" class="cluster-label"><foreignObject height="24" width="50.40625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffers</p></span></div></foreignObject></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="104" width="819.546875" y="8" x="8" style=""/><g transform="translate(401.6171875, 8)" class="cluster-label"><foreignObject height="24" width="32.3125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Tree</p></span></div></foreignObject></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M143.258,87L143.258,91.167C143.258,95.333,143.258,103.667,143.258,112C143.258,120.333,143.258,128.667,143.258,137C143.258,145.333,143.258,153.667,168.583,166.323C193.908,178.979,244.558,195.958,269.882,204.447L295.207,212.936"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P2_B0_0" d="M405.773,87L405.773,91.167C405.773,95.333,405.773,103.667,405.773,112C405.773,120.333,405.773,128.667,405.773,137C405.773,145.333,405.773,153.667,405.773,161.333C405.773,169,405.773,176,405.773,179.5L405.773,183"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P3_B0_0" d="M680.289,87L680.289,91.167C680.289,95.333,680.289,103.667,680.289,112C680.289,120.333,680.289,128.667,680.289,137C680.289,145.333,680.289,153.667,652.967,166.592C625.645,179.517,571,197.034,543.678,205.793L516.356,214.551"/></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(143.2578125, 60)" id="flowchart-P1-0" class="node default"><rect height="54" width="200.515625" y="-27" x="-100.2578125" style="" class="basic label-container"/><g transform="translate(-70.2578125, -12)" style="" class="label"><rect/><foreignObject height="24" width="140.515625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: buf 0, 0-1MB</p></span></div></foreignObject></g></g><g transform="translate(405.7734375, 60)" id="flowchart-P2-1" class="node default"><rect height="54" width="224.515625" y="-27" x="-112.2578125" style="" class="basic label-container"/><g transform="translate(-82.2578125, -12)" style="" class="label"><rect/><foreignObject height="24" width="164.515625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: buf 0, 1MB-2MB</p></span></div></foreignObject></g></g><g transform="translate(680.2890625, 60)" id="flowchart-P3-2" class="node default"><rect height="54" width="224.515625" y="-27" x="-112.2578125" style="" class="basic label-container"/><g transform="translate(-82.2578125, -12)" style="" class="label"><rect/><foreignObject height="24" width="164.515625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: buf 0, 2MB-3MB</p></span></div></foreignObject></g></g><g transform="translate(405.7734375, 250)" id="flowchart-B0-3" class="node default"><rect height="126" width="213.546875" y="-63" x="-106.7734375" style="" class="basic label-container"/><g transform="translate(-76.7734375, -48)" style="" class="label"><rect/><foreignObject height="96" width="153.546875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffer 0: UNLOADED<br />file: /path/to/large.txt<br />offset: 0<br />bytes: 3MB</p></span></div></foreignObject></g></g></g></g></g></svg></p>
<p>When you scroll to a region, Fresh loads only that chunk from disk:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 351 444" style="max-width: 351px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"/><g class="edgeLabels"/><g class="nodes"><g transform="translate(0, 0)" class="root"><g class="clusters"><g data-look="classic" id="subGraph0" class="cluster"><rect height="428" width="335" y="8" x="8" style=""/><g transform="translate(92.3515625, 8)" class="cluster-label"><foreignObject height="24" width="166.296875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>After scrolling to middle</p></span></div></foreignObject></g></g></g><g class="edgePaths"/><g class="edgeLabels"/><g class="nodes"><g transform="translate(175.5, 82)" id="flowchart-B0_new-0" class="node default"><rect height="78" width="260" y="-39" x="-130" style="" class="basic label-container"/><g transform="translate(-100, -24)" style="" class="label"><rect/><foreignObject height="48" width="200"><div style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffer 0: UNLOADED (0-1MB)</p></span></div></foreignObject></g></g><g transform="translate(175.5, 222)" id="flowchart-B1_new-1" class="node default"><rect height="102" width="260" y="-51" x="-130" style="" class="basic label-container"/><g transform="translate(-100, -36)" style="" class="label"><rect/><foreignObject height="72" width="200"><div style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffer 1: LOADED (1MB-2MB)<br />actual bytes in memory</p></span></div></foreignObject></g></g><g transform="translate(175.5, 362)" id="flowchart-B2_new-2" class="node default"><rect height="78" width="260" y="-39" x="-130" style="" class="basic label-container"/><g transform="translate(-100, -24)" style="" class="label"><rect/><foreignObject height="48" width="200"><div style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffer 2: UNLOADED (2MB-3MB)</p></span></div></foreignObject></g></g></g></g></g></g></g></svg></p>
<h2 id="zero-copy-reads">Zero-Copy Reads</h2>
<p>When reading text for display, Fresh doesn't copy bytes. It returns slices pointing directly into the buffers:</p>
<pre class="rust"><code>// Returns &amp;[u8] pointing into buffer memory
// No allocation, no copy
let text = buffer.get_text_range(100, 200);</code></pre>
<p>Multiple pieces can reference the same buffer region. Displaying the same text twice doesn't double memory usage.</p>
<h2 id="the-tree-structure">The Tree Structure</h2>
<p>The pieces are organized in a balanced binary tree for fast lookups:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 507.3984375 326" style="max-width: 507.398px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_I2_0" d="M243.869,86L236.959,90.167C230.048,94.333,216.227,102.667,209.317,110.333C202.406,118,202.406,125,202.406,128.5L202.406,132"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_L3_0" d="M373.233,86L380.143,90.167C387.054,94.333,400.874,102.667,407.785,112.333C414.695,122,414.695,133,414.695,138.5L414.695,144"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L1_0" d="M135.556,214L128.414,218.167C121.272,222.333,106.987,230.667,99.845,238.333C92.703,246,92.703,253,92.703,256.5L92.703,260"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L2_0" d="M269.257,214L276.399,218.167C283.541,222.333,297.825,230.667,304.967,238.333C312.109,246,312.109,253,312.109,256.5L312.109,260"/></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(308.55078125, 47)" id="flowchart-I1-0" class="node default"><rect height="78" width="164.078125" y="-39" x="-82.0390625" style="" class="basic label-container"/><g transform="translate(-52.0390625, -24)" style="" class="label"><rect/><foreignObject height="48" width="104.078125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Internal<br />left_bytes: 100</p></span></div></foreignObject></g></g><g transform="translate(202.40625, 175)" id="flowchart-I2-2" class="node default"><rect height="78" width="155.171875" y="-39" x="-77.5859375" style="" class="basic label-container"/><g transform="translate(-47.5859375, -24)" style="" class="label"><rect/><foreignObject height="48" width="95.171875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Internal<br />left_bytes: 50</p></span></div></foreignObject></g></g><g transform="translate(414.6953125, 175)" id="flowchart-L3-4" class="node default"><rect height="54" width="169.40625" y="-27" x="-84.703125" style="" class="basic label-container"/><g transform="translate(-54.703125, -12)" style="" class="label"><rect/><foreignObject height="24" width="109.40625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: 50 bytes</p></span></div></foreignObject></g></g><g transform="translate(92.703125, 291)" id="flowchart-L1-6" class="node default"><rect height="54" width="169.40625" y="-27" x="-84.703125" style="" class="basic label-container"/><g transform="translate(-54.703125, -12)" style="" class="label"><rect/><foreignObject height="24" width="109.40625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: 50 bytes</p></span></div></foreignObject></g></g><g transform="translate(312.109375, 291)" id="flowchart-L2-8" class="node default"><rect height="54" width="169.40625" y="-27" x="-84.703125" style="" class="basic label-container"/><g transform="translate(-54.703125, -12)" style="" class="label"><rect/><foreignObject height="24" width="109.40625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: 50 bytes</p></span></div></foreignObject></g></g></g></g></g></svg></p>
<p>Each internal node caches the total bytes in its left subtree. To find byte offset 75:</p>
<ol type="1">
<li>Root has <code>left_bytes: 100</code>, and 75 &lt; 100, so go left</li>
<li>Internal has <code>left_bytes: 50</code>, and 75 &gt;= 50, so go right with offset 75-50=25</li>
<li>Piece has 50 bytes, offset 25 is within it</li>
</ol>
<p>This is O(log P) where P is the number of pieces.</p>
<h2 id="line-feed-tracking">Line Feed Tracking</h2>
<p>Text editors need fast line-based operations: "go to line 1000", "what line is byte offset 50000 on?", or simply displaying line numbers. Scanning the entire document for newlines would be O(N) - too slow for large files.</p>
<p>Fresh tracks line feeds the same way it tracks bytes. Each piece stores its newline count, and internal nodes cache the count for their left subtree:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 507.3984375 398" style="max-width: 507.398px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_I2_0" d="M237.322,110L231.503,114.167C225.684,118.333,214.045,126.667,208.226,134.333C202.406,142,202.406,149,202.406,152.5L202.406,156"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_L3_0" d="M379.779,110L385.599,114.167C391.418,118.333,403.057,126.667,408.876,136.333C414.695,146,414.695,157,414.695,162.5L414.695,168"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L1_0" d="M128.79,262L122.775,266.167C116.761,270.333,104.732,278.667,98.718,286.333C92.703,294,92.703,301,92.703,304.5L92.703,308"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L2_0" d="M276.023,262L282.037,266.167C288.052,270.333,300.081,278.667,306.095,286.333C312.109,294,312.109,301,312.109,304.5L312.109,308"/></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(308.55078125, 59)" id="flowchart-I1-0" class="node default"><rect height="102" width="164.078125" y="-51" x="-82.0390625" style="" class="basic label-container"/><g transform="translate(-52.0390625, -36)" style="" class="label"><rect/><foreignObject height="72" width="104.078125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Internal<br />left_bytes: 100<br />lf_left: 3</p></span></div></foreignObject></g></g><g transform="translate(202.40625, 211)" id="flowchart-I2-2" class="node default"><rect height="102" width="155.171875" y="-51" x="-77.5859375" style="" class="basic label-container"/><g transform="translate(-47.5859375, -36)" style="" class="label"><rect/><foreignObject height="72" width="95.171875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Internal<br />left_bytes: 50<br />lf_left: 2</p></span></div></foreignObject></g></g><g transform="translate(414.6953125, 211)" id="flowchart-L3-4" class="node default"><rect height="78" width="169.40625" y="-39" x="-84.703125" style="" class="basic label-container"/><g transform="translate(-54.703125, -24)" style="" class="label"><rect/><foreignObject height="48" width="109.40625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: 50 bytes<br />line_feeds: 1</p></span></div></foreignObject></g></g><g transform="translate(92.703125, 351)" id="flowchart-L1-6" class="node default"><rect height="78" width="169.40625" y="-39" x="-84.703125" style="" class="basic label-container"/><g transform="translate(-54.703125, -24)" style="" class="label"><rect/><foreignObject height="48" width="109.40625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: 30 bytes<br />line_feeds: 2</p></span></div></foreignObject></g></g><g transform="translate(312.109375, 351)" id="flowchart-L2-8" class="node default"><rect height="78" width="169.40625" y="-39" x="-84.703125" style="" class="basic label-container"/><g transform="translate(-54.703125, -24)" style="" class="label"><rect/><foreignObject height="48" width="109.40625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: 20 bytes<br />line_feeds: 0</p></span></div></foreignObject></g></g></g></g></g></svg></p>
<p>To find which piece contains line 3:</p>
<ol type="1">
<li>Root has <code>lf_left: 3</code>, and 3 &gt;= 3, so go right with line 3-3=0</li>
<li>Piece L3 has <code>line_feeds: 1</code>, line 0 is within it</li>
</ol>
<p>This enables O(log P) line-to-offset conversion. The same structure supports offset-to-line lookup by accumulating line counts while traversing.</p>
<p>For large files where line indexing hasn't been computed (lazy loading), these counts are <code>None</code> and Fresh falls back to scanning. Once a region is loaded and indexed, the counts become available.</p>
<h2 id="immutable-tree-structure">Immutable Tree Structure</h2>
<p>Fresh uses immutable nodes - once created, a node is never modified. Edits create new nodes instead.</p>
<blockquote>
<p><strong>Implementation note:</strong> Fresh is written in Rust. Nodes are wrapped in <code>Arc&lt;T&gt;</code> (Atomic Reference Counted pointer) - think of it as a pointer that tracks how many things reference it. Multiple parts of the code (even different threads) can safely hold the same <code>Arc</code>, and the data is automatically freed when the last reference is dropped. We'll gloss over this detail going forward - just know that "sharing" a node is cheap and thread-safe.</p>
</blockquote>
<p>After an edit, old tree versions remain valid:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 549.41796875 224" style="max-width: 549.418px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="subGraph1" class="cluster"><rect height="208" width="197.8125" y="8" x="8" style=""/><g transform="translate(34.8671875, 8)" class="cluster-label"><foreignObject height="24" width="144.078125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Version 2 (after edit)</p></span></div></foreignObject></g></g><g data-look="classic" id="subGraph0" class="cluster"><rect height="208" width="315.60546875" y="8" x="225.8125" style=""/><g transform="translate(304.904296875, 8)" class="cluster-label"><foreignObject height="24" width="157.421875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Version 1 (before edit)</p></span></div></foreignObject></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V1_Root_V1_L_0" d="M345.41,87L339.72,91.167C334.03,95.333,322.65,103.667,316.96,111.333C311.27,119,311.27,126,311.27,129.5L311.27,133"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V1_Root_V1_R_0" d="M419.153,87L424.843,91.167C430.533,95.333,441.913,103.667,447.603,111.333C453.293,119,453.293,126,453.293,129.5L453.293,133"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V2_Root_V1_L_0" d="M131.654,87L134.633,91.167C137.612,95.333,143.57,103.667,165.647,113.973C187.724,124.28,225.921,136.56,245.019,142.701L264.118,148.841"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V2_Root_V2_R_0" d="M107.159,87L106.358,91.167C105.557,95.333,103.954,103.667,103.153,111.333C102.352,119,102.352,126,102.352,129.5L102.352,133"/></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(382.28125, 60)" id="flowchart-V1_Root-0" class="node default"><rect height="54" width="115.140625" y="-27" x="-57.5703125" style="" class="basic label-container"/><g transform="translate(-27.5703125, -12)" style="" class="label"><rect/><foreignObject height="24" width="55.140625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Root v1</p></span></div></foreignObject></g></g><g transform="translate(311.26953125, 164)" id="flowchart-V1_L-1" class="node default"><rect height="54" width="86.6875" y="-27" x="-43.34375" style="" class="basic label-container"/><g transform="translate(-13.34375, -12)" style="" class="label"><rect/><foreignObject height="24" width="26.6875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Left</p></span></div></foreignObject></g></g><g transform="translate(453.29296875, 164)" id="flowchart-V1_R-3" class="node default"><rect height="54" width="97.359375" y="-27" x="-48.6796875" style="" class="basic label-container"/><g transform="translate(-18.6796875, -12)" style="" class="label"><rect/><foreignObject height="24" width="37.359375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Right</p></span></div></foreignObject></g></g><g transform="translate(112.3515625, 60)" id="flowchart-V2_Root-4" class="node default"><rect height="54" width="115.140625" y="-27" x="-57.5703125" style="" class="basic label-container"/><g transform="translate(-27.5703125, -12)" style="" class="label"><rect/><foreignObject height="24" width="55.140625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Root v2</p></span></div></foreignObject></g></g><g transform="translate(102.3515625, 164)" id="flowchart-V2_R-7" class="node default"><rect height="54" width="118.703125" y="-27" x="-59.3515625" style="" class="basic label-container"/><g transform="translate(-29.3515625, -12)" style="" class="label"><rect/><foreignObject height="24" width="58.703125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Right v2</p></span></div></foreignObject></g></g></g></g></g></svg></p>
<p>Version 2 shares the unchanged left subtree with Version 1. This enables:</p>
<ul>
<li>Undo/redo by keeping old root references</li>
<li>Concurrent reads without locks</li>
<li>Cheap snapshots</li>
</ul>
<h2 id="fresh-vs-vs-code">Fresh vs VS Code</h2>
<p>VS Code also uses a piece tree. The core idea is identical, but the designs diverge on one key question: mutable or immutable nodes?</p>
<p><strong>VS Code</strong>: Mutable tree. Edits modify nodes in place using red-black tree rotations. Undo/redo is handled by a separate layer that stores edit operations.</p>
<p><strong>Fresh</strong>: Immutable nodes. Edits produce new tree versions while old versions remain valid, with unchanged subtrees shared between versions. (This is known as a <a href="https://en.wikipedia.org/wiki/Persistent_data_structure">persistent data structure</a> in CS literature.)</p>
<h3 id="inherent-trade-offs">Inherent Trade-offs</h3>
<p><strong>Immutable (Fresh):</strong></p>
<ul>
<li>Old tree versions stay valid - enables cheap snapshots and structural sharing</li>
<li>Concurrent reads need no synchronization</li>
<li>Undo can be "keep the old root" instead of "replay operations backward"</li>
<li>More allocations per edit (new nodes along modified path)</li>
</ul>
<p><strong>Mutable (VS Code):</strong></p>
<ul>
<li>Edits modify in place - less allocation overhead</li>
<li>Requires separate undo infrastructure</li>
<li>Concurrent access needs care</li>
</ul>
<p><strong>Lazy loading</strong> is orthogonal to mutability, but Fresh implements it and VS Code doesn't. Fresh can leave file regions on disk until accessed; VS Code loads the entire file.</p>
<h2 id="comparison-piece-tree-vs-rope">Comparison: Piece Tree vs Rope</h2>
<p>Different editors use different text storage structures:</p>
<ul>
<li><strong>Piece tree</strong>: VS Code, Fresh</li>
<li><strong>Rope</strong>: Helix (uses <a href="https://github.com/cessen/ropey">Ropey</a>), Zed (custom <a href="https://zed.dev/blog/zed-decoded-rope-sumtree">SumTree</a>)</li>
<li><strong>Gap buffer</strong>: Emacs</li>
<li><strong>Line array</strong>: Vim, Neovim</li>
</ul>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Piece Tree (Fresh, VS Code)</th>
<th>Rope (Helix, Zed)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Node contents</td>
<td>Pointer to buffer</td>
<td>Actual text (~1KB chunks)</td>
</tr>
<tr>
<td>Insert</td>
<td>Append to buffer, add piece</td>
<td>May copy/split chunk</td>
</tr>
<tr>
<td>Original file</td>
<td>Preserved in buffer 0</td>
<td>Reorganized into chunks</td>
</tr>
<tr>
<td>Large files</td>
<td>Lazy load regions (Fresh, Word 1.1a)</td>
<td>Must load or stream</td>
</tr>
<tr>
<td>Memory for edits</td>
<td>Minimal (just pointers)</td>
<td>Copies chunk data</td>
</tr>
</tbody>
</table>
<h2 id="trade-offs">Trade-offs</h2>
<p><strong>Advantages:</strong></p>
<ul>
<li>Original file content preserved (useful for diffs, minimal saves)</li>
<li>Inserts never copy existing text</li>
<li>Natural lazy loading for large files</li>
<li>Pieces are small (~24 bytes) - more fit in CPU cache during tree traversal</li>
</ul>
<p><strong>Disadvantages:</strong></p>
<ul>
<li>Extra indirection: find piece, then fetch from buffer</li>
<li>Buffer fragmentation over many edits (many small buffers)</li>
<li>Cache locality for text is poor (data scattered across buffers)</li>
<li>No automatic chunk coalescing (piece count grows with edits)</li>
</ul>
<p><em>(Note: Fresh's current implementation doesn't fully exploit immutability - it rebuilds the entire tree on each edit rather than path-copying, making edits O(P) instead of O(log P). VS Code has additional optimizations like search caching and line content caching that Fresh lacks. These are implementation gaps, not inherent to the designs.)</em></p>
<h2 id="further-reading">Further Reading</h2>
<ul>
<li><a href="https://sinelaw.github.io/fresh/">Fresh</a> - The editor discussed in this post (<a href="https://github.com/sinelaw/fresh">source on GitHub</a>)</li>
<li><a href="https://computerhistory.org/blog/microsoft-word-for-windows-1-1a-source-code/">Microsoft Word 1.1a Source Code</a> - Original piece table implementation from 1990</li>
<li><a href="https://code.visualstudio.com/blogs/2018/03/23/text-buffer-reimplementation">VS Code's Piece Table</a> - Microsoft's 2018 write-up on reviving piece tables</li>
<li><a href="https://zed.dev/blog/zed-decoded-rope-sumtree">Zed's Rope &amp; SumTree</a> - How Zed implements ropes with B+ trees</li>
<li><a href="https://coredumped.dev/2023/08/09/text-showdown-gap-buffers-vs-ropes/">Text Showdown: Gap Buffers vs Ropes</a> - Performance comparison</li>
<li><a href="https://www.cs.unm.edu/~crowley/papers/sds.pdf">Data Structures for Text Sequences</a> - Charles Crowley, 1998 (academic survey)</li>
</ul>
]]></content><author><name></name></author></entry><entry><title type="html">How Fresh Loads Huge Files Fast</title><link href="/blog/2025/12/08/how-fresh-loads-huge-files-fast.html" rel="alternate" type="text/html" title="How Fresh Loads Huge Files Fast" /><published>2025-12-08T22:44:29+00:00</published><updated>2025-12-08T22:44:29+00:00</updated><id>/blog/2025/12/08/how-fresh-loads-huge-files-fast.html</id><content type="html" xml:base="/blog/2025/12/08/how-fresh-loads-huge-files-fast.html"><![CDATA[<h1 id="how-fresh-loads-huge-files-fast">How Fresh Loads Huge Files Fast</h1>
<p>Fresh uses a <strong>piece tree</strong> (also called a piece table) for text storage. The piece table originated in the early 1970s - first in <a href="https://www.computerhistory.org/collections/catalog/102740449">J. Strother Moore's work at Edinburgh</a>, then in the <a href="https://en.wikipedia.org/wiki/Bravo_(editor)">Bravo editor</a> at Xerox PARC (1974) by Butler Lampson and Charles Simonyi. Simonyi later <a href="https://www.tiny.cloud/blog/wysiwyg-development-history/">brought it to Microsoft Word</a> (1983). The design minimizes memory copying by never modifying original file content - critical for early systems with limited RAM. <a href="https://code.visualstudio.com/blogs/2018/03/23/text-buffer-reimplementation">VS Code revived this approach in 2018</a>.</p>
<p><a href="https://sinelaw.github.io/fresh/">Fresh</a>'s implementation adds immutable nodes (for concurrency and cheap snapshots) and lazy loading (for large files). (<a href="https://github.com/sinelaw/fresh">GitHub</a>)</p>
<h2 id="the-core-idea">The Core Idea</h2>
<p>Instead of storing text in the tree, store <strong>pointers</strong> to text that lives elsewhere.</p>
<h3 id="rope-helix-zed">Rope (<a href="https://github.com/helix-editor/helix/blob/master/docs/architecture.md">Helix</a>, <a href="https://zed.dev/blog/zed-decoded-rope-sumtree">Zed</a>)</h3>
<p>Text lives inside tree nodes:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="4 4 385.6875 179" style="max-width: 385.688px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker></g><g class="subgraphs"/><g class="nodes"><g transform="translate(124.8671875, 44)" id="flowchart-Root-0" class="node default"><rect height="64" width="176.0625" y="-32" x="-88.03125" style="" class="basic label-container"/><g transform="translate(-48.03125, -12)" style="" class="label"><rect/><foreignObject height="24" width="96.0625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Internal Node</p></span></div></foreignObject></g></g><g transform="translate(95.5234375, 143)" id="flowchart-L-2" class="node default"><rect height="64" width="167.046875" y="-32" x="-83.5234375" style="" class="basic label-container"/><g transform="translate(-43.5234375, -12)" style="" class="label"><rect/><foreignObject height="24" width="87.046875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Leaf: 'Hello '</p></span></div></foreignObject></g></g><g transform="translate(297.8671875, 143)" id="flowchart-R-4" class="node default"><rect height="64" width="167.640625" y="-32" x="-83.8203125" style="" class="basic label-container"/><g transform="translate(-43.8203125, -12)" style="" class="label"><rect/><foreignObject height="24" width="87.640625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Leaf: 'World'</p></span></div></foreignObject></g></g></g><g class="edges edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_L_0_0" d="M95.523,76L95.523,107"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_R_0_0" d="M154.211,76L154.211,78.083C154.211,80.167,154.211,84.333,154.573,86.888C154.935,89.443,155.659,90.386,156.492,91.219C157.325,92.052,158.268,92.776,181.016,93.138C203.763,93.5,248.315,93.5,271.063,93.862C293.81,94.224,294.753,94.948,295.586,95.781C296.419,96.614,297.143,97.557,297.505,99.445C297.867,101.333,297.867,104.167,297.867,105.583L297.867,107"/></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g></svg></p>
<h3 id="piece-tree-fresh">Piece Tree (Fresh)</h3>
<p>Tree nodes point to separate buffers:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="4 4 590 384" style="max-width: 590px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker></g><g class="subgraphs"><g class="subgraph"><g data-look="classic" id="Buffers" class="cluster"><rect height="105" width="237.140625" y="275" x="70.953125" style=""/><g transform="translate(164.3203125, 275)" class="cluster-label"><foreignObject height="24" width="50.40625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffers</p></span></div></foreignObject></g></g></g><g class="subgraph"><g data-look="classic" id="Tree" class="cluster"><rect height="213" width="574" y="12" x="12" style=""/><g transform="translate(282.84375, 12)" class="cluster-label"><foreignObject height="24" width="32.3125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Tree</p></span></div></foreignObject></g></g></g></g><g class="nodes"><g transform="translate(189.5234375, 341)" id="flowchart-B0-5" class="node default"><rect height="54" width="213.140625" y="-27" x="-106.5703125" style="" class="basic label-container"/><g transform="translate(-76.5703125, -12)" style="" class="label"><rect/><foreignObject height="24" width="153.140625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffer 0: 'Hello World'</p></span></div></foreignObject></g></g><g transform="translate(180.01041666666666, 78)" id="flowchart-Root-0" class="node default"><rect height="54" width="156.0625" y="-27" x="-78.03125" style="" class="basic label-container"/><g transform="translate(-48.03125, -12)" style="" class="label"><rect/><foreignObject height="24" width="96.0625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Internal Node</p></span></div></foreignObject></g></g><g transform="translate(444, 174)" id="flowchart-L-2" class="node default"><rect height="78" width="260" y="-39" x="-130" style="" class="basic label-container"/><g transform="translate(-100, -24)" style="" class="label"><rect/><foreignObject height="48" width="200"><div style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: buffer 0, offset 0, len 6</p></span></div></foreignObject></g></g><g transform="translate(154, 174)" id="flowchart-R-4" class="node default"><rect height="78" width="260" y="-39" x="-130" style="" class="basic label-container"/><g transform="translate(-100, -24)" style="" class="label"><rect/><foreignObject height="48" width="200"><div style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: buffer 0, offset 6, len 5</p></span></div></foreignObject></g></g></g><g class="edges edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_L_0_0" d="M206.021,105L206.021,106.667C206.021,108.333,206.021,111.667,206.383,113.805C206.745,115.943,207.469,116.886,208.302,117.719C209.135,118.552,210.078,119.276,248.546,119.638C287.014,120,363.007,120,401.475,120.362C439.943,120.724,440.886,121.448,441.719,122.281C442.552,123.114,443.276,124.057,443.638,125.529C444,127,444,129,444,130L444,131"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_R_0_0" d="M154,105L154,131"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_L_B0_0_0" d="M444,213L444,216.25C444,219.5,444,226,444,231.333C444,236.667,444,240.833,443.638,243.388C443.276,245.943,442.552,246.886,441.719,247.719C440.886,248.552,439.943,249.276,404.646,249.638C369.349,250,299.698,250,264.401,250.362C229.104,250.724,228.161,251.448,227.328,252.281C226.495,253.114,225.771,254.057,225.409,256.612C225.047,259.167,225.047,263.333,225.047,272.5C225.047,281.667,225.047,295.833,225.047,302.917L225.047,310"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_R_B0_0_0" d="M154,213L154,216.25C154,219.5,154,226,154,235.083C154,244.167,154,255.833,154,268.75C154,281.667,154,295.833,154,302.917L154,310"/></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g></svg></p>
<p>A <strong>piece</strong> is just three numbers: which buffer, starting offset, and length.</p>
<h2 id="what-happens-when-you-edit">What Happens When You Edit</h2>
<p>When you type or paste, Fresh appends to a new buffer and creates a piece pointing to it. The original buffer stays untouched.</p>
<h3 id="before-file-contains-hello-world">Before: File contains "Hello World"</h3>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="4 4 558.234375 145" style="max-width: 558.234px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker></g><g class="subgraphs"><g class="subgraph"><g data-look="classic" id="Buffers" class="cluster"><rect height="129" width="284" y="12" x="270.234375" style=""/><g transform="translate(387.03125, 12)" class="cluster-label"><foreignObject height="24" width="50.40625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffers</p></span></div></foreignObject></g></g></g><g class="subgraph"><g data-look="classic" id="Tree" class="cluster"><rect height="105" width="208.234375" y="24" x="12" style=""/><g transform="translate(99.9609375, 24)" class="cluster-label"><foreignObject height="24" width="32.3125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Tree</p></span></div></foreignObject></g></g></g></g><g class="nodes"><g transform="translate(412.234375, 90)" id="flowchart-B0-1" class="node default"><rect height="78" width="260" y="-39" x="-130" style="" class="basic label-container"/><g transform="translate(-100, -24)" style="" class="label"><rect/><foreignObject height="48" width="200"><div style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffer 0 (original): 'Hello World'</p></span></div></foreignObject></g></g><g transform="translate(116.1171875, 90)" id="flowchart-P1-0" class="node default"><rect height="54" width="184.234375" y="-27" x="-92.1171875" style="" class="basic label-container"/><g transform="translate(-62.1171875, -12)" style="" class="label"><rect/><foreignObject height="24" width="124.234375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: buf 0, 0-11</p></span></div></foreignObject></g></g></g><g class="edges edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0_0" d="M208.234,90L211.484,90C214.734,90,221.234,90,230.318,90C239.401,90,251.068,90,259.484,90C267.901,90,273.068,90,275.651,90L278.234,90"/></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g></svg></p>
<h3 id="after-insert-big--at-position-6">After: Insert "Big " at position 6</h3>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="4 4 558.234375 289" style="max-width: 558.234px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker></g><g class="subgraphs"><g class="subgraph"><g data-look="classic" id="Buffers" class="cluster"><rect height="213" width="284" y="13" x="270.234375" style=""/><g transform="translate(387.03125, 13)" class="cluster-label"><foreignObject height="24" width="50.40625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffers</p></span></div></foreignObject></g></g></g><g class="subgraph"><g data-look="classic" id="Tree" class="cluster"><rect height="273" width="208.234375" y="12" x="12" style=""/><g transform="translate(99.9609375, 12)" class="cluster-label"><foreignObject height="24" width="32.3125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Tree</p></span></div></foreignObject></g></g></g></g><g class="nodes"><g transform="translate(412.234375, 91)" id="flowchart-B0-3" class="node default"><rect height="78" width="260" y="-39" x="-130" style="" class="basic label-container"/><g transform="translate(-100, -24)" style="" class="label"><rect/><foreignObject height="48" width="200"><div style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffer 0 (original): 'Hello World'</p></span></div></foreignObject></g></g><g transform="translate(391.1875, 187)" id="flowchart-B1-4" class="node default"><rect height="54" width="217.90625" y="-27" x="-108.953125" style="" class="basic label-container"/><g transform="translate(-78.953125, -12)" style="" class="label"><rect/><foreignObject height="24" width="157.90625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffer 1 (added): 'Big '</p></span></div></foreignObject></g></g><g transform="translate(119.9765625, 162)" id="flowchart-P1-0" class="node default"><rect height="54" width="176.515625" y="-27" x="-88.2578125" style="" class="basic label-container"/><g transform="translate(-58.2578125, -12)" style="" class="label"><rect/><foreignObject height="24" width="116.515625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: buf 0, 0-6</p></span></div></foreignObject></g></g><g transform="translate(119.9765625, 246)" id="flowchart-P2-1" class="node default"><rect height="54" width="176.515625" y="-27" x="-88.2578125" style="" class="basic label-container"/><g transform="translate(-58.2578125, -12)" style="" class="label"><rect/><foreignObject height="24" width="116.515625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: buf 1, 0-4</p></span></div></foreignObject></g></g><g transform="translate(116.1171875, 78)" id="flowchart-P3-2" class="node default"><rect height="54" width="184.234375" y="-27" x="-92.1171875" style="" class="basic label-container"/><g transform="translate(-62.1171875, -12)" style="" class="label"><rect/><foreignObject height="24" width="124.234375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: buf 0, 6-11</p></span></div></foreignObject></g></g></g><g class="edges edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0_0" d="M208.234,162L211.484,162C214.734,162,221.234,162,226.568,162C231.901,162,236.068,162,238.622,161.638C241.177,161.276,242.12,160.552,242.953,159.719C243.787,158.886,244.511,157.943,244.872,149.471C245.234,141,245.234,125,245.596,116.529C245.958,108.057,246.682,107.114,247.515,106.281C248.349,105.448,249.292,104.724,251.846,104.362C254.401,104,258.568,104,263.234,104C267.901,104,273.068,104,275.651,104L278.234,104"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P2_B1_0_0" d="M208.234,246L211.484,246C214.734,246,221.234,246,226.568,246C231.901,246,236.068,246,238.622,245.638C241.177,245.276,242.12,244.552,242.953,243.719C243.787,242.886,244.511,241.943,244.872,233.305C245.234,224.667,245.234,208.333,245.596,199.695C245.958,191.057,246.682,190.114,247.515,189.281C248.349,188.448,249.292,187.724,251.846,187.362C254.401,187,258.568,187,263.234,187C267.901,187,273.068,187,275.651,187L278.234,187"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P3_B0_0_0" d="M208.234,78L211.484,78C214.734,78,221.234,78,230.318,78C239.401,78,251.068,78,259.484,78C267.901,78,273.068,78,275.651,78L278.234,78"/></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g></svg></p>
<p>Document now reads: "Hello Big World"</p>
<p>The original file content in Buffer 0 was never modified or copied.</p>
<h2 id="lazy-loading">Lazy Loading</h2>
<p>For large files, Fresh doesn't load the entire file into memory. Buffers can be <strong>unloaded</strong> - they store a file path and byte range instead of actual data.</p>
<p>This is actually how the original <a href="https://computerhistory.org/blog/microsoft-word-for-windows-1-1a-source-code/">Word 1.1a</a> piece table worked: pieces pointed directly to spans in the original file on disk, loading content only when needed. VS Code's 2018 implementation loads files fully into memory; Fresh returns to the original memory-conscious design.</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="4 4 749.546875 365.5" style="max-width: 749.547px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker></g><g class="subgraphs"><g class="subgraph"><g data-look="classic" id="Buffers" class="cluster"><rect height="177" width="237.546875" y="184.5" x="70.87109375" style=""/><g transform="translate(164.44140625, 184.5)" class="cluster-label"><foreignObject height="24" width="50.40625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffers</p></span></div></foreignObject></g></g></g><g class="subgraph"><g data-look="classic" id="Tree" class="cluster"><rect height="105" width="733.546875" y="12" x="12" style=""/><g transform="translate(362.6171875, 12)" class="cluster-label"><foreignObject height="24" width="32.3125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Tree</p></span></div></foreignObject></g></g></g></g><g class="nodes"><g transform="translate(189.64453125, 286.5)" id="flowchart-B0-3" class="node default"><rect height="126" width="213.546875" y="-63" x="-106.7734375" style="" class="basic label-container"/><g transform="translate(-76.7734375, -48)" style="" class="label"><rect/><foreignObject height="96" width="153.546875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffer 0: UNLOADED<br />file: /path/to/large.txt<br />offset: 0<br />bytes: 3MB</p></span></div></foreignObject></g></g><g transform="translate(633.2890625, 78)" id="flowchart-P1-0" class="node default"><rect height="54" width="200.515625" y="-27" x="-100.2578125" style="" class="basic label-container"/><g transform="translate(-70.2578125, -12)" style="" class="label"><rect/><foreignObject height="24" width="140.515625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: buf 0, 0-1MB</p></span></div></foreignObject></g></g><g transform="translate(390.7734375, 78)" id="flowchart-P2-1" class="node default"><rect height="54" width="224.515625" y="-27" x="-112.2578125" style="" class="basic label-container"/><g transform="translate(-82.2578125, -12)" style="" class="label"><rect/><foreignObject height="24" width="164.515625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: buf 0, 1MB-2MB</p></span></div></foreignObject></g></g><g transform="translate(136.2578125, 78)" id="flowchart-P3-2" class="node default"><rect height="54" width="224.515625" y="-27" x="-112.2578125" style="" class="basic label-container"/><g transform="translate(-82.2578125, -12)" style="" class="label"><rect/><foreignObject height="24" width="164.515625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: buf 0, 2MB-3MB</p></span></div></foreignObject></g></g></g><g class="edges edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0_0" d="M633.289,105L633.289,108.25C633.289,111.5,633.289,118,633.289,126.25C633.289,134.5,633.289,144.5,632.927,149.971C632.565,155.443,631.841,156.386,631.008,157.219C630.175,158.052,629.232,158.776,565.384,159.138C501.536,159.5,374.784,159.5,310.936,159.862C247.088,160.224,246.146,160.948,245.312,161.781C244.479,162.614,243.755,163.557,243.393,166.112C243.031,168.667,243.031,172.833,243.031,182C243.031,191.167,243.031,205.333,243.031,212.417L243.031,219.5"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P2_B0_0_0" d="M390.773,105L390.773,108.25C390.773,111.5,390.773,118,390.773,123.333C390.773,128.667,390.773,132.833,390.412,135.388C390.05,137.943,389.326,138.886,388.492,139.719C387.659,140.552,386.716,141.276,354.39,141.638C322.064,142,258.354,142,226.028,142.362C193.702,142.724,192.759,143.448,191.926,144.281C191.092,145.114,190.368,146.057,190.006,151.529C189.645,157,189.645,167,189.645,179.083C189.645,191.167,189.645,205.333,189.645,212.417L189.645,219.5"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P3_B0_0_0" d="M136.258,105L136.258,108.25C136.258,111.5,136.258,118,136.258,130C136.258,142,136.258,159.5,136.258,175.333C136.258,191.167,136.258,205.333,136.258,212.417L136.258,219.5"/></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g></svg></p>
<p>When you scroll to a region, Fresh loads only that chunk from disk:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="4 4 880 169" style="max-width: 880px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker></g><g class="subgraphs"><g class="subgraph"><g data-look="classic" id="subGraph0" class="cluster"><rect height="153" width="864" y="12" x="12" style=""/><g transform="translate(360.8515625, 12)" class="cluster-label"><foreignObject height="24" width="166.296875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>After scrolling to middle</p></span></div></foreignObject></g></g></g></g><g class="nodes"><g transform="translate(444, 102)" id="flowchart-B0_new-0" class="node default"><rect height="78" width="260" y="-39" x="-130" style="" class="basic label-container"/><g transform="translate(-100, -24)" style="" class="label"><rect/><foreignObject height="48" width="200"><div style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffer 0: UNLOADED (0-1MB)</p></span></div></foreignObject></g></g><g transform="translate(734, 102)" id="flowchart-B1_new-1" class="node default"><rect height="102" width="260" y="-51" x="-130" style="" class="basic label-container"/><g transform="translate(-100, -36)" style="" class="label"><rect/><foreignObject height="72" width="200"><div style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffer 1: LOADED (1MB-2MB)<br />actual bytes in memory</p></span></div></foreignObject></g></g><g transform="translate(154, 102)" id="flowchart-B2_new-2" class="node default"><rect height="78" width="260" y="-39" x="-130" style="" class="basic label-container"/><g transform="translate(-100, -24)" style="" class="label"><rect/><foreignObject height="48" width="200"><div style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffer 2: UNLOADED (2MB-3MB)</p></span></div></foreignObject></g></g></g><g class="edges edgePaths"/><g class="edgeLabels"/></svg></p>
<h2 id="zero-copy-reads">Zero-Copy Reads</h2>
<p>When reading text for display, Fresh doesn't copy bytes. It returns slices pointing directly into the buffers:</p>
<pre class="rust"><code>// Returns &amp;[u8] pointing into buffer memory
// No allocation, no copy
let text = buffer.get_text_range(100, 200);</code></pre>
<p>Multiple pieces can reference the same buffer region. Displaying the same text twice doesn't double memory usage.</p>
<h2 id="the-tree-structure">The Tree Structure</h2>
<p>The pieces are organized in a balanced binary tree for fast lookups:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="4 4 408.5572814941406 296" style="max-width: 408.557px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker></g><g class="subgraphs"/><g class="nodes"><g transform="translate(149.91145833333331, 51)" id="flowchart-I1-0" class="node default"><rect height="78" width="164.078125" y="-39" x="-82.0390625" style="" class="basic label-container"/><g transform="translate(-52.0390625, -24)" style="" class="label"><rect/><foreignObject height="48" width="104.078125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Internal<br />left_bytes: 100</p></span></div></foreignObject></g></g><g transform="translate(122.56510416666666, 164)" id="flowchart-I2-2" class="node default"><rect height="78" width="155.171875" y="-39" x="-77.5859375" style="" class="basic label-container"/><g transform="translate(-47.5859375, -24)" style="" class="label"><rect/><foreignObject height="48" width="95.171875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Internal<br />left_bytes: 50</p></span></div></foreignObject></g></g><g transform="translate(319.85416666666663, 152)" id="flowchart-L3-4" class="node default"><rect height="54" width="169.40625" y="-27" x="-84.703125" style="" class="basic label-container"/><g transform="translate(-54.703125, -12)" style="" class="label"><rect/><foreignObject height="24" width="109.40625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: 50 bytes</p></span></div></foreignObject></g></g><g transform="translate(96.703125, 265)" id="flowchart-L1-6" class="node default"><rect height="54" width="169.40625" y="-27" x="-84.703125" style="" class="basic label-container"/><g transform="translate(-54.703125, -12)" style="" class="label"><rect/><foreignObject height="24" width="109.40625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: 50 bytes</p></span></div></foreignObject></g></g><g transform="translate(301.109375, 265)" id="flowchart-L2-8" class="node default"><rect height="54" width="169.40625" y="-27" x="-84.703125" style="" class="basic label-container"/><g transform="translate(-54.703125, -12)" style="" class="label"><rect/><foreignObject height="24" width="109.40625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: 50 bytes</p></span></div></foreignObject></g></g></g><g class="edges edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_I2_0_0" d="M122.565,90L122.565,121"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_L3_0_0" d="M177.258,90L177.258,92.083C177.258,94.167,177.258,98.333,177.62,100.888C177.982,103.443,178.706,104.386,179.539,105.219C180.372,106.052,181.315,106.776,203.886,107.138C226.457,107.5,270.655,107.5,293.226,107.862C315.797,108.224,316.74,108.948,317.573,109.781C318.406,110.614,319.13,111.557,319.492,113.445C319.854,115.333,319.854,118.167,319.854,119.583L319.854,121"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L1_0_0" d="M96.703,203L96.703,234"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L2_0_0" d="M148.427,203L148.427,205.083C148.427,207.167,148.427,211.333,148.789,213.888C149.151,216.443,149.875,217.386,150.708,218.219C151.541,219.052,152.484,219.776,176.736,220.138C200.988,220.5,248.549,220.5,272.8,220.862C297.052,221.224,297.995,221.948,298.828,222.781C299.662,223.614,300.386,224.557,300.747,226.445C301.109,228.333,301.109,231.167,301.109,232.583L301.109,234"/></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g></svg></p>
<p>Each internal node caches the total bytes in its left subtree. To find byte offset 75:</p>
<ol type="1">
<li>Root has <code>left_bytes: 100</code>, and 75 &lt; 100, so go left</li>
<li>Internal has <code>left_bytes: 50</code>, and 75 &gt;= 50, so go right with offset 75-50=25</li>
<li>Piece has 50 bytes, offset 25 is within it</li>
</ol>
<p>This is O(log P) where P is the number of pieces.</p>
<h2 id="line-feed-tracking">Line Feed Tracking</h2>
<p>Text editors need fast line-based operations: "go to line 1000", "what line is byte offset 50000 on?", or simply displaying line numbers. Scanning the entire document for newlines would be O(N) - too slow for large files.</p>
<p>Fresh tracks line feeds the same way it tracks bytes. Each piece stores its newline count, and internal nodes cache the count for their left subtree:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="4 4 408.5572814941406 368" style="max-width: 408.557px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker></g><g class="subgraphs"/><g class="nodes"><g transform="translate(149.91145833333331, 63)" id="flowchart-I1-0" class="node default"><rect height="102" width="164.078125" y="-51" x="-82.0390625" style="" class="basic label-container"/><g transform="translate(-52.0390625, -36)" style="" class="label"><rect/><foreignObject height="72" width="104.078125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Internal<br />left_bytes: 100<br />lf_left: 3</p></span></div></foreignObject></g></g><g transform="translate(122.56510416666666, 200)" id="flowchart-I2-2" class="node default"><rect height="102" width="155.171875" y="-51" x="-77.5859375" style="" class="basic label-container"/><g transform="translate(-47.5859375, -36)" style="" class="label"><rect/><foreignObject height="72" width="95.171875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Internal<br />left_bytes: 50<br />lf_left: 2</p></span></div></foreignObject></g></g><g transform="translate(319.85416666666663, 188)" id="flowchart-L3-4" class="node default"><rect height="78" width="169.40625" y="-39" x="-84.703125" style="" class="basic label-container"/><g transform="translate(-54.703125, -24)" style="" class="label"><rect/><foreignObject height="48" width="109.40625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: 50 bytes<br />line_feeds: 1</p></span></div></foreignObject></g></g><g transform="translate(96.703125, 325)" id="flowchart-L1-6" class="node default"><rect height="78" width="169.40625" y="-39" x="-84.703125" style="" class="basic label-container"/><g transform="translate(-54.703125, -24)" style="" class="label"><rect/><foreignObject height="48" width="109.40625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: 30 bytes<br />line_feeds: 2</p></span></div></foreignObject></g></g><g transform="translate(301.109375, 325)" id="flowchart-L2-8" class="node default"><rect height="78" width="169.40625" y="-39" x="-84.703125" style="" class="basic label-container"/><g transform="translate(-54.703125, -24)" style="" class="label"><rect/><foreignObject height="48" width="109.40625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: 20 bytes<br />line_feeds: 0</p></span></div></foreignObject></g></g></g><g class="edges edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_I2_0_0" d="M122.565,114L122.565,145"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_L3_0_0" d="M177.258,114L177.258,116.083C177.258,118.167,177.258,122.333,177.62,124.888C177.982,127.443,178.706,128.386,179.539,129.219C180.372,130.052,181.315,130.776,203.886,131.138C226.457,131.5,270.655,131.5,293.226,131.862C315.797,132.224,316.74,132.948,317.573,133.781C318.406,134.614,319.13,135.557,319.492,137.445C319.854,139.333,319.854,142.167,319.854,143.583L319.854,145"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L1_0_0" d="M96.703,251L96.703,282"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L2_0_0" d="M148.427,251L148.427,253.083C148.427,255.167,148.427,259.333,148.789,261.888C149.151,264.443,149.875,265.386,150.708,266.219C151.541,267.052,152.484,267.776,176.736,268.138C200.988,268.5,248.549,268.5,272.8,268.862C297.052,269.224,297.995,269.948,298.828,270.781C299.662,271.614,300.386,272.557,300.747,274.445C301.109,276.333,301.109,279.167,301.109,280.583L301.109,282"/></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g></svg></p>
<p>To find which piece contains line 3:</p>
<ol type="1">
<li>Root has <code>lf_left: 3</code>, and 3 &gt;= 3, so go right with line 3-3=0</li>
<li>Piece L3 has <code>line_feeds: 1</code>, line 0 is within it</li>
</ol>
<p>This enables O(log P) line-to-offset conversion. The same structure supports offset-to-line lookup by accumulating line counts while traversing.</p>
<p>For large files where line indexing hasn't been computed (lazy loading), these counts are <code>None</code> and Fresh falls back to scanning. Once a region is loaded and indexed, the counts become available.</p>
<h2 id="immutable-tree-structure">Immutable Tree Structure</h2>
<p>Fresh uses immutable nodes - once created, a node is never modified. Edits create new nodes instead.</p>
<blockquote>
<p><strong>Implementation note:</strong> Fresh is written in Rust. Nodes are wrapped in <code>Arc&lt;T&gt;</code> (Atomic Reference Counted pointer) - think of it as a pointer that tracks how many things reference it. Multiple parts of the code (even different threads) can safely hold the same <code>Arc</code>, and the data is automatically freed when the last reference is dropped. We'll gloss over this detail going forward - just know that "sharing" a node is cheap and thread-safe.</p>
</blockquote>
<p>After an edit, old tree versions remain valid:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="4 4 358.8541564941406 444" style="max-width: 358.854px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker></g><g class="subgraphs"><g class="subgraph"><g data-look="classic" id="subGraph1" class="cluster"><rect height="189" width="160.11197916666669" y="12" x="12" style=""/><g transform="translate(20.016927083333343, 12)" class="cluster-label"><foreignObject height="24" width="144.078125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Version 2 (after edit)</p></span></div></foreignObject></g></g></g><g class="subgraph"><g data-look="classic" id="subGraph0" class="cluster"><rect height="189" width="238.046875" y="251" x="116.80729166666666" style=""/><g transform="translate(157.11979166666666, 251)" class="cluster-label"><foreignObject height="24" width="157.421875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Version 1 (before edit)</p></span></div></foreignObject></g></g></g></g><g class="nodes"><g transform="translate(102.54166666666667, 78)" id="flowchart-V2_Root-4" class="node default"><rect height="54" width="115.140625" y="-27" x="-57.5703125" style="" class="basic label-container"/><g transform="translate(-27.5703125, -12)" style="" class="label"><rect/><foreignObject height="24" width="55.140625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Root v2</p></span></div></foreignObject></g></g><g transform="translate(83.3515625, 162)" id="flowchart-V2_R-7" class="node default"><rect height="54" width="118.703125" y="-27" x="-59.3515625" style="" class="basic label-container"/><g transform="translate(-29.3515625, -12)" style="" class="label"><rect/><foreignObject height="24" width="58.703125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Right v2</p></span></div></foreignObject></g></g><g transform="translate(274.984375, 317)" id="flowchart-V1_Root-0" class="node default"><rect height="54" width="115.140625" y="-27" x="-57.5703125" style="" class="basic label-container"/><g transform="translate(-27.5703125, -12)" style="" class="label"><rect/><foreignObject height="24" width="55.140625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Root v1</p></span></div></foreignObject></g></g><g transform="translate(172.15104166666666, 401)" id="flowchart-V1_L-1" class="node default"><rect height="54" width="86.6875" y="-27" x="-43.34375" style="" class="basic label-container"/><g transform="translate(-13.34375, -12)" style="" class="label"><rect/><foreignObject height="24" width="26.6875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Left</p></span></div></foreignObject></g></g><g transform="translate(294.17447916666663, 401)" id="flowchart-V1_R-3" class="node default"><rect height="54" width="97.359375" y="-27" x="-48.6796875" style="" class="basic label-container"/><g transform="translate(-18.6796875, -12)" style="" class="label"><rect/><foreignObject height="24" width="37.359375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Right</p></span></div></foreignObject></g></g></g><g class="edges edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V1_Root_V1_L_0_0" d="M255.794,344L255.794,345.667C255.794,347.333,255.794,350.667,255.432,352.805C255.07,354.943,254.347,355.886,253.513,356.719C252.68,357.552,251.737,358.276,241.4,358.638C231.063,359,211.331,359,200.993,359.362C190.656,359.724,189.713,360.448,188.88,361.281C188.047,362.114,187.323,363.057,186.961,364.529C186.599,366,186.599,368,186.599,369L186.599,370"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V1_Root_V1_R_0_0" d="M294.174,344L294.174,370"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V2_Root_V1_L_0_0" d="M121.732,105L121.732,106.667C121.732,108.333,121.732,111.667,122.094,113.805C122.456,115.943,123.179,116.886,124.013,117.719C124.846,118.552,125.789,119.276,130.589,119.638C135.389,120,144.046,120,148.846,120.362C153.646,120.724,154.589,121.448,155.422,122.281C156.255,123.114,156.979,124.057,157.341,138.445C157.703,152.833,157.703,180.667,157.703,200.417C157.703,220.167,157.703,231.833,157.703,258.75C157.703,285.667,157.703,327.833,157.703,348.917L157.703,370"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V2_Root_V2_R_0_0" d="M83.352,105L83.352,131"/></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g></svg></p>
<p>Version 2 shares the unchanged left subtree with Version 1. This enables:</p>
<ul>
<li>Undo/redo by keeping old root references</li>
<li>Concurrent reads without locks</li>
<li>Cheap snapshots</li>
</ul>
<h2 id="fresh-vs-vs-code">Fresh vs VS Code</h2>
<p>VS Code also uses a piece tree. The core idea is identical, but the designs diverge on one key question: mutable or immutable nodes?</p>
<p><strong>VS Code</strong>: Mutable tree. Edits modify nodes in place using red-black tree rotations. Undo/redo is handled by a separate layer that stores edit operations.</p>
<p><strong>Fresh</strong>: Immutable nodes. Edits produce new tree versions while old versions remain valid, with unchanged subtrees shared between versions. (This is known as a <a href="https://en.wikipedia.org/wiki/Persistent_data_structure">persistent data structure</a> in CS literature.)</p>
<h3 id="inherent-trade-offs">Inherent Trade-offs</h3>
<p><strong>Immutable (Fresh):</strong></p>
<ul>
<li>Old tree versions stay valid - enables cheap snapshots and structural sharing</li>
<li>Concurrent reads need no synchronization</li>
<li>Undo can be "keep the old root" instead of "replay operations backward"</li>
<li>More allocations per edit (new nodes along modified path)</li>
</ul>
<p><strong>Mutable (VS Code):</strong></p>
<ul>
<li>Edits modify in place - less allocation overhead</li>
<li>Requires separate undo infrastructure</li>
<li>Concurrent access needs care</li>
</ul>
<p><strong>Lazy loading</strong> is orthogonal to mutability, but Fresh implements it and VS Code doesn't. Fresh can leave file regions on disk until accessed; VS Code loads the entire file.</p>
<h2 id="comparison-piece-tree-vs-rope">Comparison: Piece Tree vs Rope</h2>
<p>Different editors use different text storage structures:</p>
<ul>
<li><strong>Piece tree</strong>: VS Code, Fresh</li>
<li><strong>Rope</strong>: Helix (uses <a href="https://github.com/cessen/ropey">Ropey</a>), Zed (custom <a href="https://zed.dev/blog/zed-decoded-rope-sumtree">SumTree</a>)</li>
<li><strong>Gap buffer</strong>: Emacs</li>
<li><strong>Line array</strong>: Vim, Neovim</li>
</ul>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Piece Tree (Fresh, VS Code)</th>
<th>Rope (Helix, Zed)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Node contents</td>
<td>Pointer to buffer</td>
<td>Actual text (~1KB chunks)</td>
</tr>
<tr>
<td>Insert</td>
<td>Append to buffer, add piece</td>
<td>May copy/split chunk</td>
</tr>
<tr>
<td>Original file</td>
<td>Preserved in buffer 0</td>
<td>Reorganized into chunks</td>
</tr>
<tr>
<td>Large files</td>
<td>Lazy load regions (Fresh, Word 1.1a)</td>
<td>Must load or stream</td>
</tr>
<tr>
<td>Memory for edits</td>
<td>Minimal (just pointers)</td>
<td>Copies chunk data</td>
</tr>
</tbody>
</table>
<h2 id="trade-offs">Trade-offs</h2>
<p><strong>Advantages:</strong></p>
<ul>
<li>Original file content preserved (useful for diffs, minimal saves)</li>
<li>Inserts never copy existing text</li>
<li>Natural lazy loading for large files</li>
<li>Pieces are small (~24 bytes) - more fit in CPU cache during tree traversal</li>
</ul>
<p><strong>Disadvantages:</strong></p>
<ul>
<li>Extra indirection: find piece, then fetch from buffer</li>
<li>Buffer fragmentation over many edits (many small buffers)</li>
<li>Cache locality for text is poor (data scattered across buffers)</li>
<li>No automatic chunk coalescing (piece count grows with edits)</li>
</ul>
<p><em>(Note: Fresh's current implementation doesn't fully exploit immutability - it rebuilds the entire tree on each edit rather than path-copying, making edits O(P) instead of O(log P). VS Code has additional optimizations like search caching and line content caching that Fresh lacks. These are implementation gaps, not inherent to the designs.)</em></p>
<h2 id="further-reading">Further Reading</h2>
<ul>
<li><a href="https://sinelaw.github.io/fresh/">Fresh</a> - The editor discussed in this post (<a href="https://github.com/sinelaw/fresh">source on GitHub</a>)</li>
<li><a href="https://computerhistory.org/blog/microsoft-word-for-windows-1-1a-source-code/">Microsoft Word 1.1a Source Code</a> - Original piece table implementation from 1990</li>
<li><a href="https://code.visualstudio.com/blogs/2018/03/23/text-buffer-reimplementation">VS Code's Piece Table</a> - Microsoft's 2018 write-up on reviving piece tables</li>
<li><a href="https://zed.dev/blog/zed-decoded-rope-sumtree">Zed's Rope &amp; SumTree</a> - How Zed implements ropes with B+ trees</li>
<li><a href="https://coredumped.dev/2023/08/09/text-showdown-gap-buffers-vs-ropes/">Text Showdown: Gap Buffers vs Ropes</a> - Performance comparison</li>
<li><a href="https://www.cs.unm.edu/~crowley/papers/sds.pdf">Data Structures for Text Sequences</a> - Charles Crowley, 1998 (academic survey)</li>
</ul>
]]></content><author><name></name></author></entry><entry><title type="html">How Fresh Loads Huge Files Fast</title><link href="/blog/2025/12/08/how-fresh-loads-huge-files-fast.html" rel="alternate" type="text/html" title="How Fresh Loads Huge Files Fast" /><published>2025-12-08T22:31:21+00:00</published><updated>2025-12-08T22:31:21+00:00</updated><id>/blog/2025/12/08/how-fresh-loads-huge-files-fast.html</id><content type="html" xml:base="/blog/2025/12/08/how-fresh-loads-huge-files-fast.html"><![CDATA[<h1 id="how-fresh-loads-huge-files-fast">How Fresh Loads Huge Files Fast</h1>
<p>Fresh uses a <strong>piece tree</strong> (also called a piece table) for text storage. The piece table originated in the early 1970s - first in <a href="https://www.computerhistory.org/collections/catalog/102740449">J. Strother Moore's work at Edinburgh</a>, then in the <a href="https://en.wikipedia.org/wiki/Bravo_(editor)">Bravo editor</a> at Xerox PARC (1974) by Butler Lampson and Charles Simonyi. Simonyi later <a href="https://www.tiny.cloud/blog/wysiwyg-development-history/">brought it to Microsoft Word</a> (1983). The design minimizes memory copying by never modifying original file content - critical for early systems with limited RAM. <a href="https://code.visualstudio.com/blogs/2018/03/23/text-buffer-reimplementation">VS Code revived this approach in 2018</a>.</p>
<p><a href="https://sinelaw.github.io/fresh/">Fresh</a>'s implementation adds immutable nodes (for concurrency and cheap snapshots) and lazy loading (for large files). (<a href="https://github.com/sinelaw/fresh">GitHub</a>)</p>
<h2 id="the-core-idea">The Core Idea</h2>
<p>Instead of storing text in the tree, store <strong>pointers</strong> to text that lives elsewhere.</p>
<h3 id="rope-helix-zed">Rope (<a href="https://github.com/helix-editor/helix/blob/master/docs/architecture.md">Helix</a>, <a href="https://zed.dev/blog/zed-decoded-rope-sumtree">Zed</a>)</h3>
<p>Text lives inside tree nodes:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="4 4 345.6875 159" style="max-width: 345.688px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker></g><g class="subgraphs"/><g class="nodes"><g transform="translate(111.53385416666666, 39)" id="flowchart-Root-0" class="node default"><rect height="54" width="156.0625" y="-27" x="-78.03125" style="" class="basic label-container"/><g transform="translate(-48.03125, -12)" style="" class="label"><rect/><foreignObject height="24" width="96.0625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Internal Node</p></span></div></foreignObject></g></g><g transform="translate(85.5234375, 128)" id="flowchart-L-2" class="node default"><rect height="54" width="147.046875" y="-27" x="-73.5234375" style="" class="basic label-container"/><g transform="translate(-43.5234375, -12)" style="" class="label"><rect/><foreignObject height="24" width="87.046875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Leaf: 'Hello '</p></span></div></foreignObject></g></g><g transform="translate(267.8671875, 128)" id="flowchart-R-4" class="node default"><rect height="54" width="147.640625" y="-27" x="-73.8203125" style="" class="basic label-container"/><g transform="translate(-43.8203125, -12)" style="" class="label"><rect/><foreignObject height="24" width="87.640625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Leaf: 'World'</p></span></div></foreignObject></g></g></g><g class="edges edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_L_0_0" d="M85.523,66L85.523,97"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_R_0_0" d="M137.544,66L137.544,68.083C137.544,70.167,137.544,74.333,137.906,76.888C138.268,79.443,138.992,80.386,139.825,81.219C140.659,82.052,141.601,82.776,162.127,83.138C182.652,83.5,222.76,83.5,243.285,83.862C263.81,84.224,264.753,84.948,265.586,85.781C266.419,86.614,267.143,87.557,267.505,89.445C267.867,91.333,267.867,94.167,267.867,95.583L267.867,97"/></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g></svg></p>
<h3 id="piece-tree-fresh">Piece Tree (Fresh)</h3>
<p>Tree nodes point to separate buffers:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="4 4 590 384" style="max-width: 590px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker></g><g class="subgraphs"><g class="subgraph"><g data-look="classic" id="Buffers" class="cluster"><rect height="105" width="237.140625" y="275" x="70.953125" style=""/><g transform="translate(164.3203125, 275)" class="cluster-label"><foreignObject height="24" width="50.40625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffers</p></span></div></foreignObject></g></g></g><g class="subgraph"><g data-look="classic" id="Tree" class="cluster"><rect height="213" width="574" y="12" x="12" style=""/><g transform="translate(282.84375, 12)" class="cluster-label"><foreignObject height="24" width="32.3125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Tree</p></span></div></foreignObject></g></g></g></g><g class="nodes"><g transform="translate(189.5234375, 341)" id="flowchart-B0-5" class="node default"><rect height="54" width="213.140625" y="-27" x="-106.5703125" style="" class="basic label-container"/><g transform="translate(-76.5703125, -12)" style="" class="label"><rect/><foreignObject height="24" width="153.140625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffer 0: 'Hello World'</p></span></div></foreignObject></g></g><g transform="translate(180.01041666666666, 78)" id="flowchart-Root-0" class="node default"><rect height="54" width="156.0625" y="-27" x="-78.03125" style="" class="basic label-container"/><g transform="translate(-48.03125, -12)" style="" class="label"><rect/><foreignObject height="24" width="96.0625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Internal Node</p></span></div></foreignObject></g></g><g transform="translate(444, 174)" id="flowchart-L-2" class="node default"><rect height="78" width="260" y="-39" x="-130" style="" class="basic label-container"/><g transform="translate(-100, -24)" style="" class="label"><rect/><foreignObject height="48" width="200"><div style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: buffer 0, offset 0, len 6</p></span></div></foreignObject></g></g><g transform="translate(154, 174)" id="flowchart-R-4" class="node default"><rect height="78" width="260" y="-39" x="-130" style="" class="basic label-container"/><g transform="translate(-100, -24)" style="" class="label"><rect/><foreignObject height="48" width="200"><div style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: buffer 0, offset 6, len 5</p></span></div></foreignObject></g></g></g><g class="edges edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_L_0_0" d="M206.021,105L206.021,106.667C206.021,108.333,206.021,111.667,206.383,113.805C206.745,115.943,207.469,116.886,208.302,117.719C209.135,118.552,210.078,119.276,248.546,119.638C287.014,120,363.007,120,401.475,120.362C439.943,120.724,440.886,121.448,441.719,122.281C442.552,123.114,443.276,124.057,443.638,125.529C444,127,444,129,444,130L444,131"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_R_0_0" d="M154,105L154,131"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_L_B0_0_0" d="M444,213L444,216.25C444,219.5,444,226,444,231.333C444,236.667,444,240.833,443.638,243.388C443.276,245.943,442.552,246.886,441.719,247.719C440.886,248.552,439.943,249.276,404.646,249.638C369.349,250,299.698,250,264.401,250.362C229.104,250.724,228.161,251.448,227.328,252.281C226.495,253.114,225.771,254.057,225.409,256.612C225.047,259.167,225.047,263.333,225.047,272.5C225.047,281.667,225.047,295.833,225.047,302.917L225.047,310"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_R_B0_0_0" d="M154,213L154,216.25C154,219.5,154,226,154,235.083C154,244.167,154,255.833,154,268.75C154,281.667,154,295.833,154,302.917L154,310"/></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g></svg></p>
<p>A <strong>piece</strong> is just three numbers: which buffer, starting offset, and length.</p>
<h2 id="what-happens-when-you-edit">What Happens When You Edit</h2>
<p>When you type or paste, Fresh appends to a new buffer and creates a piece pointing to it. The original buffer stays untouched.</p>
<h3 id="before-file-contains-hello-world">Before: File contains "Hello World"</h3>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="4 4 558.234375 145" style="max-width: 558.234px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker></g><g class="subgraphs"><g class="subgraph"><g data-look="classic" id="Buffers" class="cluster"><rect height="129" width="284" y="12" x="270.234375" style=""/><g transform="translate(387.03125, 12)" class="cluster-label"><foreignObject height="24" width="50.40625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffers</p></span></div></foreignObject></g></g></g><g class="subgraph"><g data-look="classic" id="Tree" class="cluster"><rect height="105" width="208.234375" y="24" x="12" style=""/><g transform="translate(99.9609375, 24)" class="cluster-label"><foreignObject height="24" width="32.3125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Tree</p></span></div></foreignObject></g></g></g></g><g class="nodes"><g transform="translate(412.234375, 90)" id="flowchart-B0-1" class="node default"><rect height="78" width="260" y="-39" x="-130" style="" class="basic label-container"/><g transform="translate(-100, -24)" style="" class="label"><rect/><foreignObject height="48" width="200"><div style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffer 0 (original): 'Hello World'</p></span></div></foreignObject></g></g><g transform="translate(116.1171875, 90)" id="flowchart-P1-0" class="node default"><rect height="54" width="184.234375" y="-27" x="-92.1171875" style="" class="basic label-container"/><g transform="translate(-62.1171875, -12)" style="" class="label"><rect/><foreignObject height="24" width="124.234375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: buf 0, 0-11</p></span></div></foreignObject></g></g></g><g class="edges edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0_0" d="M208.234,90L211.484,90C214.734,90,221.234,90,230.318,90C239.401,90,251.068,90,259.484,90C267.901,90,273.068,90,275.651,90L278.234,90"/></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g></svg></p>
<h3 id="after-insert-big--at-position-6">After: Insert "Big " at position 6</h3>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="4 4 558.234375 289" style="max-width: 558.234px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker></g><g class="subgraphs"><g class="subgraph"><g data-look="classic" id="Buffers" class="cluster"><rect height="213" width="284" y="13" x="270.234375" style=""/><g transform="translate(387.03125, 13)" class="cluster-label"><foreignObject height="24" width="50.40625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffers</p></span></div></foreignObject></g></g></g><g class="subgraph"><g data-look="classic" id="Tree" class="cluster"><rect height="273" width="208.234375" y="12" x="12" style=""/><g transform="translate(99.9609375, 12)" class="cluster-label"><foreignObject height="24" width="32.3125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Tree</p></span></div></foreignObject></g></g></g></g><g class="nodes"><g transform="translate(412.234375, 91)" id="flowchart-B0-3" class="node default"><rect height="78" width="260" y="-39" x="-130" style="" class="basic label-container"/><g transform="translate(-100, -24)" style="" class="label"><rect/><foreignObject height="48" width="200"><div style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffer 0 (original): 'Hello World'</p></span></div></foreignObject></g></g><g transform="translate(391.1875, 187)" id="flowchart-B1-4" class="node default"><rect height="54" width="217.90625" y="-27" x="-108.953125" style="" class="basic label-container"/><g transform="translate(-78.953125, -12)" style="" class="label"><rect/><foreignObject height="24" width="157.90625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffer 1 (added): 'Big '</p></span></div></foreignObject></g></g><g transform="translate(119.9765625, 162)" id="flowchart-P1-0" class="node default"><rect height="54" width="176.515625" y="-27" x="-88.2578125" style="" class="basic label-container"/><g transform="translate(-58.2578125, -12)" style="" class="label"><rect/><foreignObject height="24" width="116.515625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: buf 0, 0-6</p></span></div></foreignObject></g></g><g transform="translate(119.9765625, 246)" id="flowchart-P2-1" class="node default"><rect height="54" width="176.515625" y="-27" x="-88.2578125" style="" class="basic label-container"/><g transform="translate(-58.2578125, -12)" style="" class="label"><rect/><foreignObject height="24" width="116.515625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: buf 1, 0-4</p></span></div></foreignObject></g></g><g transform="translate(116.1171875, 78)" id="flowchart-P3-2" class="node default"><rect height="54" width="184.234375" y="-27" x="-92.1171875" style="" class="basic label-container"/><g transform="translate(-62.1171875, -12)" style="" class="label"><rect/><foreignObject height="24" width="124.234375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: buf 0, 6-11</p></span></div></foreignObject></g></g></g><g class="edges edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0_0" d="M208.234,162L211.484,162C214.734,162,221.234,162,226.568,162C231.901,162,236.068,162,238.622,161.638C241.177,161.276,242.12,160.552,242.953,159.719C243.787,158.886,244.511,157.943,244.872,149.471C245.234,141,245.234,125,245.596,116.529C245.958,108.057,246.682,107.114,247.515,106.281C248.349,105.448,249.292,104.724,251.846,104.362C254.401,104,258.568,104,263.234,104C267.901,104,273.068,104,275.651,104L278.234,104"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P2_B1_0_0" d="M208.234,246L211.484,246C214.734,246,221.234,246,226.568,246C231.901,246,236.068,246,238.622,245.638C241.177,245.276,242.12,244.552,242.953,243.719C243.787,242.886,244.511,241.943,244.872,233.305C245.234,224.667,245.234,208.333,245.596,199.695C245.958,191.057,246.682,190.114,247.515,189.281C248.349,188.448,249.292,187.724,251.846,187.362C254.401,187,258.568,187,263.234,187C267.901,187,273.068,187,275.651,187L278.234,187"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P3_B0_0_0" d="M208.234,78L211.484,78C214.734,78,221.234,78,230.318,78C239.401,78,251.068,78,259.484,78C267.901,78,273.068,78,275.651,78L278.234,78"/></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g></svg></p>
<p>Document now reads: "Hello Big World"</p>
<p>The original file content in Buffer 0 was never modified or copied.</p>
<h2 id="lazy-loading">Lazy Loading</h2>
<p>For large files, Fresh doesn't load the entire file into memory. Buffers can be <strong>unloaded</strong> - they store a file path and byte range instead of actual data.</p>
<p>This is actually how the original <a href="https://computerhistory.org/blog/microsoft-word-for-windows-1-1a-source-code/">Word 1.1a</a> piece table worked: pieces pointed directly to spans in the original file on disk, loading content only when needed. VS Code's 2018 implementation loads files fully into memory; Fresh returns to the original memory-conscious design.</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="4 4 749.546875 365.5" style="max-width: 749.547px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker></g><g class="subgraphs"><g class="subgraph"><g data-look="classic" id="Buffers" class="cluster"><rect height="177" width="237.546875" y="184.5" x="70.87109375" style=""/><g transform="translate(164.44140625, 184.5)" class="cluster-label"><foreignObject height="24" width="50.40625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffers</p></span></div></foreignObject></g></g></g><g class="subgraph"><g data-look="classic" id="Tree" class="cluster"><rect height="105" width="733.546875" y="12" x="12" style=""/><g transform="translate(362.6171875, 12)" class="cluster-label"><foreignObject height="24" width="32.3125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Tree</p></span></div></foreignObject></g></g></g></g><g class="nodes"><g transform="translate(189.64453125, 286.5)" id="flowchart-B0-3" class="node default"><rect height="126" width="213.546875" y="-63" x="-106.7734375" style="" class="basic label-container"/><g transform="translate(-76.7734375, -48)" style="" class="label"><rect/><foreignObject height="96" width="153.546875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffer 0: UNLOADED<br />file: /path/to/large.txt<br />offset: 0<br />bytes: 3MB</p></span></div></foreignObject></g></g><g transform="translate(633.2890625, 78)" id="flowchart-P1-0" class="node default"><rect height="54" width="200.515625" y="-27" x="-100.2578125" style="" class="basic label-container"/><g transform="translate(-70.2578125, -12)" style="" class="label"><rect/><foreignObject height="24" width="140.515625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: buf 0, 0-1MB</p></span></div></foreignObject></g></g><g transform="translate(390.7734375, 78)" id="flowchart-P2-1" class="node default"><rect height="54" width="224.515625" y="-27" x="-112.2578125" style="" class="basic label-container"/><g transform="translate(-82.2578125, -12)" style="" class="label"><rect/><foreignObject height="24" width="164.515625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: buf 0, 1MB-2MB</p></span></div></foreignObject></g></g><g transform="translate(136.2578125, 78)" id="flowchart-P3-2" class="node default"><rect height="54" width="224.515625" y="-27" x="-112.2578125" style="" class="basic label-container"/><g transform="translate(-82.2578125, -12)" style="" class="label"><rect/><foreignObject height="24" width="164.515625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: buf 0, 2MB-3MB</p></span></div></foreignObject></g></g></g><g class="edges edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0_0" d="M633.289,105L633.289,108.25C633.289,111.5,633.289,118,633.289,126.25C633.289,134.5,633.289,144.5,632.927,149.971C632.565,155.443,631.841,156.386,631.008,157.219C630.175,158.052,629.232,158.776,565.384,159.138C501.536,159.5,374.784,159.5,310.936,159.862C247.088,160.224,246.146,160.948,245.312,161.781C244.479,162.614,243.755,163.557,243.393,166.112C243.031,168.667,243.031,172.833,243.031,182C243.031,191.167,243.031,205.333,243.031,212.417L243.031,219.5"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P2_B0_0_0" d="M390.773,105L390.773,108.25C390.773,111.5,390.773,118,390.773,123.333C390.773,128.667,390.773,132.833,390.412,135.388C390.05,137.943,389.326,138.886,388.492,139.719C387.659,140.552,386.716,141.276,354.39,141.638C322.064,142,258.354,142,226.028,142.362C193.702,142.724,192.759,143.448,191.926,144.281C191.092,145.114,190.368,146.057,190.006,151.529C189.645,157,189.645,167,189.645,179.083C189.645,191.167,189.645,205.333,189.645,212.417L189.645,219.5"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P3_B0_0_0" d="M136.258,105L136.258,108.25C136.258,111.5,136.258,118,136.258,130C136.258,142,136.258,159.5,136.258,175.333C136.258,191.167,136.258,205.333,136.258,212.417L136.258,219.5"/></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g></svg></p>
<p>When you scroll to a region, Fresh loads only that chunk from disk:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="4 4 880 169" style="max-width: 880px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker></g><g class="subgraphs"><g class="subgraph"><g data-look="classic" id="subGraph0" class="cluster"><rect height="153" width="864" y="12" x="12" style=""/><g transform="translate(360.8515625, 12)" class="cluster-label"><foreignObject height="24" width="166.296875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>After scrolling to middle</p></span></div></foreignObject></g></g></g></g><g class="nodes"><g transform="translate(444, 102)" id="flowchart-B0_new-0" class="node default"><rect height="78" width="260" y="-39" x="-130" style="" class="basic label-container"/><g transform="translate(-100, -24)" style="" class="label"><rect/><foreignObject height="48" width="200"><div style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffer 0: UNLOADED (0-1MB)</p></span></div></foreignObject></g></g><g transform="translate(734, 102)" id="flowchart-B1_new-1" class="node default"><rect height="102" width="260" y="-51" x="-130" style="" class="basic label-container"/><g transform="translate(-100, -36)" style="" class="label"><rect/><foreignObject height="72" width="200"><div style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffer 1: LOADED (1MB-2MB)<br />actual bytes in memory</p></span></div></foreignObject></g></g><g transform="translate(154, 102)" id="flowchart-B2_new-2" class="node default"><rect height="78" width="260" y="-39" x="-130" style="" class="basic label-container"/><g transform="translate(-100, -24)" style="" class="label"><rect/><foreignObject height="48" width="200"><div style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffer 2: UNLOADED (2MB-3MB)</p></span></div></foreignObject></g></g></g><g class="edges edgePaths"/><g class="edgeLabels"/></svg></p>
<h2 id="zero-copy-reads">Zero-Copy Reads</h2>
<p>When reading text for display, Fresh doesn't copy bytes. It returns slices pointing directly into the buffers:</p>
<pre class="rust"><code>// Returns &amp;[u8] pointing into buffer memory
// No allocation, no copy
let text = buffer.get_text_range(100, 200);</code></pre>
<p>Multiple pieces can reference the same buffer region. Displaying the same text twice doesn't double memory usage.</p>
<h2 id="the-tree-structure">The Tree Structure</h2>
<p>The pieces are organized in a balanced binary tree for fast lookups:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="4 4 408.5572814941406 296" style="max-width: 408.557px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker></g><g class="subgraphs"/><g class="nodes"><g transform="translate(149.91145833333331, 51)" id="flowchart-I1-0" class="node default"><rect height="78" width="164.078125" y="-39" x="-82.0390625" style="" class="basic label-container"/><g transform="translate(-52.0390625, -24)" style="" class="label"><rect/><foreignObject height="48" width="104.078125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Internal<br />left_bytes: 100</p></span></div></foreignObject></g></g><g transform="translate(122.56510416666666, 164)" id="flowchart-I2-2" class="node default"><rect height="78" width="155.171875" y="-39" x="-77.5859375" style="" class="basic label-container"/><g transform="translate(-47.5859375, -24)" style="" class="label"><rect/><foreignObject height="48" width="95.171875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Internal<br />left_bytes: 50</p></span></div></foreignObject></g></g><g transform="translate(319.85416666666663, 152)" id="flowchart-L3-4" class="node default"><rect height="54" width="169.40625" y="-27" x="-84.703125" style="" class="basic label-container"/><g transform="translate(-54.703125, -12)" style="" class="label"><rect/><foreignObject height="24" width="109.40625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: 50 bytes</p></span></div></foreignObject></g></g><g transform="translate(96.703125, 265)" id="flowchart-L1-6" class="node default"><rect height="54" width="169.40625" y="-27" x="-84.703125" style="" class="basic label-container"/><g transform="translate(-54.703125, -12)" style="" class="label"><rect/><foreignObject height="24" width="109.40625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: 50 bytes</p></span></div></foreignObject></g></g><g transform="translate(301.109375, 265)" id="flowchart-L2-8" class="node default"><rect height="54" width="169.40625" y="-27" x="-84.703125" style="" class="basic label-container"/><g transform="translate(-54.703125, -12)" style="" class="label"><rect/><foreignObject height="24" width="109.40625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: 50 bytes</p></span></div></foreignObject></g></g></g><g class="edges edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_I2_0_0" d="M122.565,90L122.565,121"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_L3_0_0" d="M177.258,90L177.258,92.083C177.258,94.167,177.258,98.333,177.62,100.888C177.982,103.443,178.706,104.386,179.539,105.219C180.372,106.052,181.315,106.776,203.886,107.138C226.457,107.5,270.655,107.5,293.226,107.862C315.797,108.224,316.74,108.948,317.573,109.781C318.406,110.614,319.13,111.557,319.492,113.445C319.854,115.333,319.854,118.167,319.854,119.583L319.854,121"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L1_0_0" d="M96.703,203L96.703,234"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L2_0_0" d="M148.427,203L148.427,205.083C148.427,207.167,148.427,211.333,148.789,213.888C149.151,216.443,149.875,217.386,150.708,218.219C151.541,219.052,152.484,219.776,176.736,220.138C200.988,220.5,248.549,220.5,272.8,220.862C297.052,221.224,297.995,221.948,298.828,222.781C299.662,223.614,300.386,224.557,300.747,226.445C301.109,228.333,301.109,231.167,301.109,232.583L301.109,234"/></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g></svg></p>
<p>Each internal node caches the total bytes in its left subtree. To find byte offset 75:</p>
<ol type="1">
<li>Root has <code>left_bytes: 100</code>, and 75 &lt; 100, so go left</li>
<li>Internal has <code>left_bytes: 50</code>, and 75 &gt;= 50, so go right with offset 75-50=25</li>
<li>Piece has 50 bytes, offset 25 is within it</li>
</ol>
<p>This is O(log P) where P is the number of pieces.</p>
<h2 id="immutable-tree-structure">Immutable Tree Structure</h2>
<p>Fresh uses immutable nodes - once created, a node is never modified. Edits create new nodes instead.</p>
<blockquote>
<p><strong>Implementation note:</strong> Fresh is written in Rust. Nodes are wrapped in <code>Arc&lt;T&gt;</code> (Atomic Reference Counted pointer) - think of it as a pointer that tracks how many things reference it. Multiple parts of the code (even different threads) can safely hold the same <code>Arc</code>, and the data is automatically freed when the last reference is dropped. We'll gloss over this detail going forward - just know that "sharing" a node is cheap and thread-safe.</p>
</blockquote>
<p>After an edit, old tree versions remain valid:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="4 4 358.8541564941406 444" style="max-width: 358.854px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker></g><g class="subgraphs"><g class="subgraph"><g data-look="classic" id="subGraph1" class="cluster"><rect height="189" width="160.11197916666669" y="12" x="12" style=""/><g transform="translate(20.016927083333343, 12)" class="cluster-label"><foreignObject height="24" width="144.078125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Version 2 (after edit)</p></span></div></foreignObject></g></g></g><g class="subgraph"><g data-look="classic" id="subGraph0" class="cluster"><rect height="189" width="238.046875" y="251" x="116.80729166666666" style=""/><g transform="translate(157.11979166666666, 251)" class="cluster-label"><foreignObject height="24" width="157.421875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Version 1 (before edit)</p></span></div></foreignObject></g></g></g></g><g class="nodes"><g transform="translate(102.54166666666667, 78)" id="flowchart-V2_Root-4" class="node default"><rect height="54" width="115.140625" y="-27" x="-57.5703125" style="" class="basic label-container"/><g transform="translate(-27.5703125, -12)" style="" class="label"><rect/><foreignObject height="24" width="55.140625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Root v2</p></span></div></foreignObject></g></g><g transform="translate(83.3515625, 162)" id="flowchart-V2_R-7" class="node default"><rect height="54" width="118.703125" y="-27" x="-59.3515625" style="" class="basic label-container"/><g transform="translate(-29.3515625, -12)" style="" class="label"><rect/><foreignObject height="24" width="58.703125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Right v2</p></span></div></foreignObject></g></g><g transform="translate(274.984375, 317)" id="flowchart-V1_Root-0" class="node default"><rect height="54" width="115.140625" y="-27" x="-57.5703125" style="" class="basic label-container"/><g transform="translate(-27.5703125, -12)" style="" class="label"><rect/><foreignObject height="24" width="55.140625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Root v1</p></span></div></foreignObject></g></g><g transform="translate(172.15104166666666, 401)" id="flowchart-V1_L-1" class="node default"><rect height="54" width="86.6875" y="-27" x="-43.34375" style="" class="basic label-container"/><g transform="translate(-13.34375, -12)" style="" class="label"><rect/><foreignObject height="24" width="26.6875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Left</p></span></div></foreignObject></g></g><g transform="translate(294.17447916666663, 401)" id="flowchart-V1_R-3" class="node default"><rect height="54" width="97.359375" y="-27" x="-48.6796875" style="" class="basic label-container"/><g transform="translate(-18.6796875, -12)" style="" class="label"><rect/><foreignObject height="24" width="37.359375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Right</p></span></div></foreignObject></g></g></g><g class="edges edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V1_Root_V1_L_0_0" d="M255.794,344L255.794,345.667C255.794,347.333,255.794,350.667,255.432,352.805C255.07,354.943,254.347,355.886,253.513,356.719C252.68,357.552,251.737,358.276,241.4,358.638C231.063,359,211.331,359,200.993,359.362C190.656,359.724,189.713,360.448,188.88,361.281C188.047,362.114,187.323,363.057,186.961,364.529C186.599,366,186.599,368,186.599,369L186.599,370"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V1_Root_V1_R_0_0" d="M294.174,344L294.174,370"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V2_Root_V1_L_0_0" d="M121.732,105L121.732,106.667C121.732,108.333,121.732,111.667,122.094,113.805C122.456,115.943,123.179,116.886,124.013,117.719C124.846,118.552,125.789,119.276,130.589,119.638C135.389,120,144.046,120,148.846,120.362C153.646,120.724,154.589,121.448,155.422,122.281C156.255,123.114,156.979,124.057,157.341,138.445C157.703,152.833,157.703,180.667,157.703,200.417C157.703,220.167,157.703,231.833,157.703,258.75C157.703,285.667,157.703,327.833,157.703,348.917L157.703,370"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V2_Root_V2_R_0_0" d="M83.352,105L83.352,131"/></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g></svg></p>
<p>Version 2 shares the unchanged left subtree with Version 1. This enables:</p>
<ul>
<li>Undo/redo by keeping old root references</li>
<li>Concurrent reads without locks</li>
<li>Cheap snapshots</li>
</ul>
<h2 id="fresh-vs-vs-code">Fresh vs VS Code</h2>
<p>VS Code also uses a piece tree. The core idea is identical, but the designs diverge on one key question: mutable or immutable nodes?</p>
<p><strong>VS Code</strong>: Mutable tree. Edits modify nodes in place using red-black tree rotations. Undo/redo is handled by a separate layer that stores edit operations.</p>
<p><strong>Fresh</strong>: Immutable nodes. Edits produce new tree versions while old versions remain valid, with unchanged subtrees shared between versions. (This is known as a <a href="https://en.wikipedia.org/wiki/Persistent_data_structure">persistent data structure</a> in CS literature.)</p>
<h3 id="inherent-trade-offs">Inherent Trade-offs</h3>
<p><strong>Immutable (Fresh):</strong></p>
<ul>
<li>Old tree versions stay valid - enables cheap snapshots and structural sharing</li>
<li>Concurrent reads need no synchronization</li>
<li>Undo can be "keep the old root" instead of "replay operations backward"</li>
<li>More allocations per edit (new nodes along modified path)</li>
</ul>
<p><strong>Mutable (VS Code):</strong></p>
<ul>
<li>Edits modify in place - less allocation overhead</li>
<li>Requires separate undo infrastructure</li>
<li>Concurrent access needs care</li>
</ul>
<p><strong>Lazy loading</strong> is orthogonal to mutability, but Fresh implements it and VS Code doesn't. Fresh can leave file regions on disk until accessed; VS Code loads the entire file.</p>
<h2 id="comparison-piece-tree-vs-rope">Comparison: Piece Tree vs Rope</h2>
<p>Different editors use different text storage structures:</p>
<ul>
<li><strong>Piece tree</strong>: VS Code, Fresh</li>
<li><strong>Rope</strong>: Helix (uses <a href="https://github.com/cessen/ropey">Ropey</a>), Zed (custom <a href="https://zed.dev/blog/zed-decoded-rope-sumtree">SumTree</a>)</li>
<li><strong>Gap buffer</strong>: Emacs</li>
<li><strong>Line array</strong>: Vim, Neovim</li>
</ul>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Piece Tree (Fresh, VS Code)</th>
<th>Rope (Helix, Zed)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Node contents</td>
<td>Pointer to buffer</td>
<td>Actual text (~1KB chunks)</td>
</tr>
<tr>
<td>Insert</td>
<td>Append to buffer, add piece</td>
<td>May copy/split chunk</td>
</tr>
<tr>
<td>Original file</td>
<td>Preserved in buffer 0</td>
<td>Reorganized into chunks</td>
</tr>
<tr>
<td>Large files</td>
<td>Lazy load regions (Fresh, Word 1.1a)</td>
<td>Must load or stream</td>
</tr>
<tr>
<td>Memory for edits</td>
<td>Minimal (just pointers)</td>
<td>Copies chunk data</td>
</tr>
</tbody>
</table>
<h2 id="trade-offs">Trade-offs</h2>
<p><strong>Advantages:</strong></p>
<ul>
<li>Original file content preserved (useful for diffs, minimal saves)</li>
<li>Inserts never copy existing text</li>
<li>Natural lazy loading for large files</li>
<li>Pieces are small (~24 bytes) - more fit in CPU cache during tree traversal</li>
</ul>
<p><strong>Disadvantages:</strong></p>
<ul>
<li>Extra indirection: find piece, then fetch from buffer</li>
<li>Buffer fragmentation over many edits (many small buffers)</li>
<li>Cache locality for text is poor (data scattered across buffers)</li>
<li>No automatic chunk coalescing (piece count grows with edits)</li>
</ul>
<p><em>(Note: Fresh's current implementation doesn't fully exploit immutability - it rebuilds the entire tree on each edit rather than path-copying, making edits O(P) instead of O(log P). VS Code has additional optimizations like search caching and line content caching that Fresh lacks. These are implementation gaps, not inherent to the designs.)</em></p>
<h2 id="further-reading">Further Reading</h2>
<ul>
<li><a href="https://sinelaw.github.io/fresh/">Fresh</a> - The editor discussed in this post (<a href="https://github.com/sinelaw/fresh">source on GitHub</a>)</li>
<li><a href="https://computerhistory.org/blog/microsoft-word-for-windows-1-1a-source-code/">Microsoft Word 1.1a Source Code</a> - Original piece table implementation from 1990</li>
<li><a href="https://code.visualstudio.com/blogs/2018/03/23/text-buffer-reimplementation">VS Code's Piece Table</a> - Microsoft's 2018 write-up on reviving piece tables</li>
<li><a href="https://zed.dev/blog/zed-decoded-rope-sumtree">Zed's Rope &amp; SumTree</a> - How Zed implements ropes with B+ trees</li>
<li><a href="https://coredumped.dev/2023/08/09/text-showdown-gap-buffers-vs-ropes/">Text Showdown: Gap Buffers vs Ropes</a> - Performance comparison</li>
<li><a href="https://www.cs.unm.edu/~crowley/papers/sds.pdf">Data Structures for Text Sequences</a> - Charles Crowley, 1998 (academic survey)</li>
</ul>
]]></content><author><name></name></author></entry><entry><title type="html">How Fresh Loads Huge Files Fast</title><link href="/blog/2025/12/08/how-fresh-loads-huge-files-fast.html" rel="alternate" type="text/html" title="How Fresh Loads Huge Files Fast" /><published>2025-12-08T22:27:25+00:00</published><updated>2025-12-08T22:27:25+00:00</updated><id>/blog/2025/12/08/how-fresh-loads-huge-files-fast.html</id><content type="html" xml:base="/blog/2025/12/08/how-fresh-loads-huge-files-fast.html"><![CDATA[<h1 id="how-fresh-loads-huge-files-fast">How Fresh Loads Huge Files Fast</h1>
<p>Fresh uses a <strong>piece tree</strong> (also called a piece table) for text storage. The piece table originated in the early 1970s - first in <a href="https://www.computerhistory.org/collections/catalog/102740449">J. Strother Moore's work at Edinburgh</a>, then in the <a href="https://en.wikipedia.org/wiki/Bravo_(editor)">Bravo editor</a> at Xerox PARC (1974) by Butler Lampson and Charles Simonyi. Simonyi later <a href="https://www.tiny.cloud/blog/wysiwyg-development-history/">brought it to Microsoft Word</a> (1983). The design minimizes memory copying by never modifying original file content - critical for early systems with limited RAM. <a href="https://code.visualstudio.com/blogs/2018/03/23/text-buffer-reimplementation">VS Code revived this approach in 2018</a>.</p>
<p>Fresh's implementation adds immutable nodes (for concurrency and cheap snapshots) and lazy loading (for large files).</p>
<h2 id="the-core-idea">The Core Idea</h2>
<p>Instead of storing text in the tree, store <strong>pointers</strong> to text that lives elsewhere.</p>
<h3 id="rope-helix-zed">Rope (<a href="https://github.com/helix-editor/helix/blob/master/docs/architecture.md">Helix</a>, <a href="https://zed.dev/blog/zed-decoded-rope-sumtree">Zed</a>)</h3>
<p>Text lives inside tree nodes:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 360.6875 174" style="max-width: 360.688px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_L_0" d="M128.962,62L121.055,66.167C113.149,70.333,97.336,78.667,89.43,86.333C81.523,94,81.523,101,81.523,104.5L81.523,108"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_R_0" d="M231.429,62L239.335,66.167C247.242,70.333,263.054,78.667,270.961,86.333C278.867,94,278.867,101,278.867,104.5L278.867,108"/></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(180.1953125, 35)" id="flowchart-Root-0" class="node default"><rect height="54" width="156.0625" y="-27" x="-78.03125" style="" class="basic label-container"/><g transform="translate(-48.03125, -12)" style="" class="label"><rect/><foreignObject height="24" width="96.0625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Internal Node</p></span></div></foreignObject></g></g><g transform="translate(81.5234375, 139)" id="flowchart-L-2" class="node default"><rect height="54" width="147.046875" y="-27" x="-73.5234375" style="" class="basic label-container"/><g transform="translate(-43.5234375, -12)" style="" class="label"><rect/><foreignObject height="24" width="87.046875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Leaf: 'Hello '</p></span></div></foreignObject></g></g><g transform="translate(278.8671875, 139)" id="flowchart-R-4" class="node default"><rect height="54" width="147.640625" y="-27" x="-73.8203125" style="" class="basic label-container"/><g transform="translate(-43.8203125, -12)" style="" class="label"><rect/><foreignObject height="24" width="87.640625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Leaf: 'World'</p></span></div></foreignObject></g></g></g></g></g></svg></p>
<h3 id="piece-tree-fresh">Piece Tree (Fresh)</h3>
<p>Tree nodes point to separate buffers:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 656 402" style="max-width: 656px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="104" width="481.5703125" y="290" x="82.21484375" style=""/><g transform="translate(297.796875, 290)" class="cluster-label"><foreignObject height="24" width="50.40625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffers</p></span></div></foreignObject></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="232" width="640" y="8" x="8" style=""/><g transform="translate(311.84375, 8)" class="cluster-label"><foreignObject height="24" width="32.3125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Tree</p></span></div></foreignObject></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_L_0" d="M249.969,86.178L237.141,90.482C224.313,94.785,198.656,103.393,185.828,111.196C173,119,173,126,173,129.5L173,133"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_R_0" d="M406.031,86.178L418.859,90.482C431.688,94.785,457.344,103.393,470.172,111.196C483,119,483,126,483,129.5L483,133"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_L_B0_0" d="M173,215L173,219.167C173,223.333,173,231.667,173,240C173,248.333,173,256.667,173,265C173,273.333,173,281.667,184.788,289.788C196.576,297.909,220.151,305.819,231.939,309.773L243.727,313.728"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_R_B0_0" d="M483,215L483,219.167C483,223.333,483,231.667,483,240C483,248.333,483,256.667,483,265C483,273.333,483,281.667,471.212,289.788C459.424,297.909,435.849,305.819,424.061,309.773L412.273,313.728"/></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(328, 60)" id="flowchart-Root-0" class="node default"><rect height="54" width="156.0625" y="-27" x="-78.03125" style="" class="basic label-container"/><g transform="translate(-48.03125, -12)" style="" class="label"><rect/><foreignObject height="24" width="96.0625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Internal Node</p></span></div></foreignObject></g></g><g transform="translate(173, 176)" id="flowchart-L-2" class="node default"><rect height="78" width="260" y="-39" x="-130" style="" class="basic label-container"/><g transform="translate(-100, -24)" style="" class="label"><rect/><foreignObject height="48" width="200"><div style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: buffer 0, offset 0, len 6</p></span></div></foreignObject></g></g><g transform="translate(483, 176)" id="flowchart-R-4" class="node default"><rect height="78" width="260" y="-39" x="-130" style="" class="basic label-container"/><g transform="translate(-100, -24)" style="" class="label"><rect/><foreignObject height="48" width="200"><div style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: buffer 0, offset 6, len 5</p></span></div></foreignObject></g></g><g transform="translate(328, 342)" id="flowchart-B0-5" class="node default"><rect height="54" width="213.140625" y="-27" x="-106.5703125" style="" class="basic label-container"/><g transform="translate(-76.5703125, -12)" style="" class="label"><rect/><foreignObject height="24" width="153.140625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffer 0: 'Hello World'</p></span></div></foreignObject></g></g></g></g></g></svg></p>
<p>A <strong>piece</strong> is just three numbers: which buffer, starting offset, and length.</p>
<h2 id="what-happens-when-you-edit">What Happens When You Edit</h2>
<p>When you type or paste, Fresh appends to a new buffer and creates a piece pointing to it. The original buffer stays untouched.</p>
<h3 id="before-file-contains-hello-world">Before: File contains "Hello World"</h3>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 610.234375 164" style="max-width: 610.234px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="148" width="310" y="8" x="292.234375" style=""/><g transform="translate(422.03125, 8)" class="cluster-label"><foreignObject height="24" width="50.40625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffers</p></span></div></foreignObject></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="124" width="234.234375" y="20" x="8" style=""/><g transform="translate(108.9609375, 20)" class="cluster-label"><foreignObject height="24" width="32.3125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Tree</p></span></div></foreignObject></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M217.234,82L221.401,82C225.568,82,233.901,82,242.234,82C250.568,82,258.901,82,267.234,82C275.568,82,283.901,82,291.568,82C299.234,82,306.234,82,309.734,82L313.234,82"/></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(125.1171875, 82)" id="flowchart-P1-0" class="node default"><rect height="54" width="184.234375" y="-27" x="-92.1171875" style="" class="basic label-container"/><g transform="translate(-62.1171875, -12)" style="" class="label"><rect/><foreignObject height="24" width="124.234375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: buf 0, 0-11</p></span></div></foreignObject></g></g><g transform="translate(447.234375, 82)" id="flowchart-B0-1" class="node default"><rect height="78" width="260" y="-39" x="-130" style="" class="basic label-container"/><g transform="translate(-100, -24)" style="" class="label"><rect/><foreignObject height="48" width="200"><div style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffer 0 (original): 'Hello World'</p></span></div></foreignObject></g></g></g></g></g></svg></p>
<h3 id="after-insert-big--at-position-6">After: Insert "Big " at position 6</h3>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 610.234375 354" style="max-width: 610.234px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="333" width="310" y="13" x="292.234375" style=""/><g transform="translate(422.03125, 13)" class="cluster-label"><foreignObject height="24" width="50.40625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffers</p></span></div></foreignObject></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="338" width="234.234375" y="8" x="8" style=""/><g transform="translate(108.9609375, 8)" class="cluster-label"><foreignObject height="24" width="32.3125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Tree</p></span></div></foreignObject></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M213.375,70L218.185,70C222.995,70,232.615,70,241.591,70C250.568,70,258.901,70,267.234,70C275.568,70,283.901,70,293.894,71.955C303.887,73.909,315.54,77.819,321.366,79.773L327.192,81.728"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P2_B1_0" d="M213.375,284L218.185,284C222.995,284,232.615,284,241.591,284C250.568,284,258.901,284,267.234,284C275.568,284,283.901,284,295.076,284C306.25,284,320.266,284,327.273,284L334.281,284"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P3_B0_0" d="M217.234,174L221.401,174C225.568,174,233.901,174,242.234,174C250.568,174,258.901,174,267.234,174C275.568,174,283.901,174,293.894,172.045C303.887,170.091,315.54,166.181,321.366,164.227L327.192,162.272"/></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(125.1171875, 70)" id="flowchart-P1-0" class="node default"><rect height="54" width="176.515625" y="-27" x="-88.2578125" style="" class="basic label-container"/><g transform="translate(-58.2578125, -12)" style="" class="label"><rect/><foreignObject height="24" width="116.515625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: buf 0, 0-6</p></span></div></foreignObject></g></g><g transform="translate(125.1171875, 284)" id="flowchart-P2-1" class="node default"><rect height="54" width="176.515625" y="-27" x="-88.2578125" style="" class="basic label-container"/><g transform="translate(-58.2578125, -12)" style="" class="label"><rect/><foreignObject height="24" width="116.515625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: buf 1, 0-4</p></span></div></foreignObject></g></g><g transform="translate(125.1171875, 174)" id="flowchart-P3-2" class="node default"><rect height="54" width="184.234375" y="-27" x="-92.1171875" style="" class="basic label-container"/><g transform="translate(-62.1171875, -12)" style="" class="label"><rect/><foreignObject height="24" width="124.234375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: buf 0, 6-11</p></span></div></foreignObject></g></g><g transform="translate(447.234375, 122)" id="flowchart-B0-3" class="node default"><rect height="78" width="260" y="-39" x="-130" style="" class="basic label-container"/><g transform="translate(-100, -24)" style="" class="label"><rect/><foreignObject height="48" width="200"><div style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffer 0 (original): 'Hello World'</p></span></div></foreignObject></g></g><g transform="translate(447.234375, 284)" id="flowchart-B1-4" class="node default"><rect height="54" width="217.90625" y="-27" x="-108.953125" style="" class="basic label-container"/><g transform="translate(-78.953125, -12)" style="" class="label"><rect/><foreignObject height="24" width="157.90625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffer 1 (added): 'Big '</p></span></div></foreignObject></g></g></g></g></g></svg></p>
<p>Document now reads: "Hello Big World"</p>
<p>The original file content in Buffer 0 was never modified or copied.</p>
<h2 id="lazy-loading">Lazy Loading</h2>
<p>For large files, Fresh doesn't load the entire file into memory. Buffers can be <strong>unloaded</strong> - they store a file path and byte range instead of actual data.</p>
<p>This is actually how the original <a href="https://computerhistory.org/blog/microsoft-word-for-windows-1-1a-source-code/">Word 1.1a</a> piece table worked: pieces pointed directly to spans in the original file on disk, loading content only when needed. VS Code's 2018 implementation loads files fully into memory; Fresh returns to the original memory-conscious design.</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 835.546875 346" style="max-width: 835.547px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="176" width="607.546875" y="162" x="96" style=""/><g transform="translate(374.5703125, 162)" class="cluster-label"><foreignObject height="24" width="50.40625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffers</p></span></div></foreignObject></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="104" width="819.546875" y="8" x="8" style=""/><g transform="translate(401.6171875, 8)" class="cluster-label"><foreignObject height="24" width="32.3125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Tree</p></span></div></foreignObject></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M143.258,87L143.258,91.167C143.258,95.333,143.258,103.667,143.258,112C143.258,120.333,143.258,128.667,143.258,137C143.258,145.333,143.258,153.667,168.583,166.323C193.908,178.979,244.558,195.958,269.882,204.447L295.207,212.936"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P2_B0_0" d="M405.773,87L405.773,91.167C405.773,95.333,405.773,103.667,405.773,112C405.773,120.333,405.773,128.667,405.773,137C405.773,145.333,405.773,153.667,405.773,161.333C405.773,169,405.773,176,405.773,179.5L405.773,183"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P3_B0_0" d="M680.289,87L680.289,91.167C680.289,95.333,680.289,103.667,680.289,112C680.289,120.333,680.289,128.667,680.289,137C680.289,145.333,680.289,153.667,652.967,166.592C625.645,179.517,571,197.034,543.678,205.793L516.356,214.551"/></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(143.2578125, 60)" id="flowchart-P1-0" class="node default"><rect height="54" width="200.515625" y="-27" x="-100.2578125" style="" class="basic label-container"/><g transform="translate(-70.2578125, -12)" style="" class="label"><rect/><foreignObject height="24" width="140.515625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: buf 0, 0-1MB</p></span></div></foreignObject></g></g><g transform="translate(405.7734375, 60)" id="flowchart-P2-1" class="node default"><rect height="54" width="224.515625" y="-27" x="-112.2578125" style="" class="basic label-container"/><g transform="translate(-82.2578125, -12)" style="" class="label"><rect/><foreignObject height="24" width="164.515625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: buf 0, 1MB-2MB</p></span></div></foreignObject></g></g><g transform="translate(680.2890625, 60)" id="flowchart-P3-2" class="node default"><rect height="54" width="224.515625" y="-27" x="-112.2578125" style="" class="basic label-container"/><g transform="translate(-82.2578125, -12)" style="" class="label"><rect/><foreignObject height="24" width="164.515625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: buf 0, 2MB-3MB</p></span></div></foreignObject></g></g><g transform="translate(405.7734375, 250)" id="flowchart-B0-3" class="node default"><rect height="126" width="213.546875" y="-63" x="-106.7734375" style="" class="basic label-container"/><g transform="translate(-76.7734375, -48)" style="" class="label"><rect/><foreignObject height="96" width="153.546875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffer 0: UNLOADED<br />file: /path/to/large.txt<br />offset: 0<br />bytes: 3MB</p></span></div></foreignObject></g></g></g></g></g></svg></p>
<p>When you scroll to a region, Fresh loads only that chunk from disk:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 351 444" style="max-width: 351px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"/><g class="edgeLabels"/><g class="nodes"><g transform="translate(0, 0)" class="root"><g class="clusters"><g data-look="classic" id="subGraph0" class="cluster"><rect height="428" width="335" y="8" x="8" style=""/><g transform="translate(92.3515625, 8)" class="cluster-label"><foreignObject height="24" width="166.296875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>After scrolling to middle</p></span></div></foreignObject></g></g></g><g class="edgePaths"/><g class="edgeLabels"/><g class="nodes"><g transform="translate(175.5, 82)" id="flowchart-B0_new-0" class="node default"><rect height="78" width="260" y="-39" x="-130" style="" class="basic label-container"/><g transform="translate(-100, -24)" style="" class="label"><rect/><foreignObject height="48" width="200"><div style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffer 0: UNLOADED (0-1MB)</p></span></div></foreignObject></g></g><g transform="translate(175.5, 222)" id="flowchart-B1_new-1" class="node default"><rect height="102" width="260" y="-51" x="-130" style="" class="basic label-container"/><g transform="translate(-100, -36)" style="" class="label"><rect/><foreignObject height="72" width="200"><div style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffer 1: LOADED (1MB-2MB)<br />actual bytes in memory</p></span></div></foreignObject></g></g><g transform="translate(175.5, 362)" id="flowchart-B2_new-2" class="node default"><rect height="78" width="260" y="-39" x="-130" style="" class="basic label-container"/><g transform="translate(-100, -24)" style="" class="label"><rect/><foreignObject height="48" width="200"><div style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Buffer 2: UNLOADED (2MB-3MB)</p></span></div></foreignObject></g></g></g></g></g></g></g></svg></p>
<h2 id="zero-copy-reads">Zero-Copy Reads</h2>
<p>When reading text for display, Fresh doesn't copy bytes. It returns slices pointing directly into the buffers:</p>
<pre class="rust"><code>// Returns &amp;[u8] pointing into buffer memory
// No allocation, no copy
let text = buffer.get_text_range(100, 200);</code></pre>
<p>Multiple pieces can reference the same buffer region. Displaying the same text twice doesn't double memory usage.</p>
<h2 id="the-tree-structure">The Tree Structure</h2>
<p>The pieces are organized in a balanced binary tree for fast lookups:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 507.3984375 326" style="max-width: 507.398px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_I2_0" d="M243.869,86L236.959,90.167C230.048,94.333,216.227,102.667,209.317,110.333C202.406,118,202.406,125,202.406,128.5L202.406,132"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_L3_0" d="M373.233,86L380.143,90.167C387.054,94.333,400.874,102.667,407.785,112.333C414.695,122,414.695,133,414.695,138.5L414.695,144"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L1_0" d="M135.556,214L128.414,218.167C121.272,222.333,106.987,230.667,99.845,238.333C92.703,246,92.703,253,92.703,256.5L92.703,260"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L2_0" d="M269.257,214L276.399,218.167C283.541,222.333,297.825,230.667,304.967,238.333C312.109,246,312.109,253,312.109,256.5L312.109,260"/></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(308.55078125, 47)" id="flowchart-I1-0" class="node default"><rect height="78" width="164.078125" y="-39" x="-82.0390625" style="" class="basic label-container"/><g transform="translate(-52.0390625, -24)" style="" class="label"><rect/><foreignObject height="48" width="104.078125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Internal<br />left_bytes: 100</p></span></div></foreignObject></g></g><g transform="translate(202.40625, 175)" id="flowchart-I2-2" class="node default"><rect height="78" width="155.171875" y="-39" x="-77.5859375" style="" class="basic label-container"/><g transform="translate(-47.5859375, -24)" style="" class="label"><rect/><foreignObject height="48" width="95.171875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Internal<br />left_bytes: 50</p></span></div></foreignObject></g></g><g transform="translate(414.6953125, 175)" id="flowchart-L3-4" class="node default"><rect height="54" width="169.40625" y="-27" x="-84.703125" style="" class="basic label-container"/><g transform="translate(-54.703125, -12)" style="" class="label"><rect/><foreignObject height="24" width="109.40625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: 50 bytes</p></span></div></foreignObject></g></g><g transform="translate(92.703125, 291)" id="flowchart-L1-6" class="node default"><rect height="54" width="169.40625" y="-27" x="-84.703125" style="" class="basic label-container"/><g transform="translate(-54.703125, -12)" style="" class="label"><rect/><foreignObject height="24" width="109.40625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: 50 bytes</p></span></div></foreignObject></g></g><g transform="translate(312.109375, 291)" id="flowchart-L2-8" class="node default"><rect height="54" width="169.40625" y="-27" x="-84.703125" style="" class="basic label-container"/><g transform="translate(-54.703125, -12)" style="" class="label"><rect/><foreignObject height="24" width="109.40625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Piece: 50 bytes</p></span></div></foreignObject></g></g></g></g></g></svg></p>
<p>Each internal node caches the total bytes in its left subtree. To find byte offset 75:</p>
<ol type="1">
<li>Root has <code>left_bytes: 100</code>, and 75 &lt; 100, so go left</li>
<li>Internal has <code>left_bytes: 50</code>, and 75 &gt;= 50, so go right with offset 75-50=25</li>
<li>Piece has 50 bytes, offset 25 is within it</li>
</ol>
<p>This is O(log P) where P is the number of pieces.</p>
<h2 id="immutable-tree-structure">Immutable Tree Structure</h2>
<p>Fresh uses immutable nodes - once created, a node is never modified. Edits create new nodes instead.</p>
<blockquote>
<p><strong>Implementation note:</strong> Fresh is written in Rust. Nodes are wrapped in <code>Arc&lt;T&gt;</code> (Atomic Reference Counted pointer) - think of it as a pointer that tracks how many things reference it. Multiple parts of the code (even different threads) can safely hold the same <code>Arc</code>, and the data is automatically freed when the last reference is dropped. We'll gloss over this detail going forward - just know that "sharing" a node is cheap and thread-safe.</p>
</blockquote>
<p>After an edit, old tree versions remain valid:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 549.41796875 224" style="max-width: 549.418px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="subGraph1" class="cluster"><rect height="208" width="197.8125" y="8" x="8" style=""/><g transform="translate(34.8671875, 8)" class="cluster-label"><foreignObject height="24" width="144.078125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Version 2 (after edit)</p></span></div></foreignObject></g></g><g data-look="classic" id="subGraph0" class="cluster"><rect height="208" width="315.60546875" y="8" x="225.8125" style=""/><g transform="translate(304.904296875, 8)" class="cluster-label"><foreignObject height="24" width="157.421875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Version 1 (before edit)</p></span></div></foreignObject></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V1_Root_V1_L_0" d="M345.41,87L339.72,91.167C334.03,95.333,322.65,103.667,316.96,111.333C311.27,119,311.27,126,311.27,129.5L311.27,133"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V1_Root_V1_R_0" d="M419.153,87L424.843,91.167C430.533,95.333,441.913,103.667,447.603,111.333C453.293,119,453.293,126,453.293,129.5L453.293,133"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V2_Root_V1_L_0" d="M131.654,87L134.633,91.167C137.612,95.333,143.57,103.667,165.647,113.973C187.724,124.28,225.921,136.56,245.019,142.701L264.118,148.841"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V2_Root_V2_R_0" d="M107.159,87L106.358,91.167C105.557,95.333,103.954,103.667,103.153,111.333C102.352,119,102.352,126,102.352,129.5L102.352,133"/></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(382.28125, 60)" id="flowchart-V1_Root-0" class="node default"><rect height="54" width="115.140625" y="-27" x="-57.5703125" style="" class="basic label-container"/><g transform="translate(-27.5703125, -12)" style="" class="label"><rect/><foreignObject height="24" width="55.140625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Root v1</p></span></div></foreignObject></g></g><g transform="translate(311.26953125, 164)" id="flowchart-V1_L-1" class="node default"><rect height="54" width="86.6875" y="-27" x="-43.34375" style="" class="basic label-container"/><g transform="translate(-13.34375, -12)" style="" class="label"><rect/><foreignObject height="24" width="26.6875"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Left</p></span></div></foreignObject></g></g><g transform="translate(453.29296875, 164)" id="flowchart-V1_R-3" class="node default"><rect height="54" width="97.359375" y="-27" x="-48.6796875" style="" class="basic label-container"/><g transform="translate(-18.6796875, -12)" style="" class="label"><rect/><foreignObject height="24" width="37.359375"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Right</p></span></div></foreignObject></g></g><g transform="translate(112.3515625, 60)" id="flowchart-V2_Root-4" class="node default"><rect height="54" width="115.140625" y="-27" x="-57.5703125" style="" class="basic label-container"/><g transform="translate(-27.5703125, -12)" style="" class="label"><rect/><foreignObject height="24" width="55.140625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Root v2</p></span></div></foreignObject></g></g><g transform="translate(102.3515625, 164)" id="flowchart-V2_R-7" class="node default"><rect height="54" width="118.703125" y="-27" x="-59.3515625" style="" class="basic label-container"/><g transform="translate(-29.3515625, -12)" style="" class="label"><rect/><foreignObject height="24" width="58.703125"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>Right v2</p></span></div></foreignObject></g></g></g></g></g></svg></p>
<p>Version 2 shares the unchanged left subtree with Version 1. This enables:</p>
<ul>
<li>Undo/redo by keeping old root references</li>
<li>Concurrent reads without locks</li>
<li>Cheap snapshots</li>
</ul>
<h2 id="fresh-vs-vs-code">Fresh vs VS Code</h2>
<p>VS Code also uses a piece tree. The core idea is identical, but the designs diverge on one key question: mutable or immutable nodes?</p>
<p><strong>VS Code</strong>: Mutable tree. Edits modify nodes in place using red-black tree rotations. Undo/redo is handled by a separate layer that stores edit operations.</p>
<p><strong>Fresh</strong>: Immutable nodes. Edits produce new tree versions while old versions remain valid, with unchanged subtrees shared between versions. (This is known as a <a href="https://en.wikipedia.org/wiki/Persistent_data_structure">persistent data structure</a> in CS literature.)</p>
<h3 id="inherent-trade-offs">Inherent Trade-offs</h3>
<p><strong>Immutable (Fresh):</strong></p>
<ul>
<li>Old tree versions stay valid - enables cheap snapshots and structural sharing</li>
<li>Concurrent reads need no synchronization</li>
<li>Undo can be "keep the old root" instead of "replay operations backward"</li>
<li>More allocations per edit (new nodes along modified path)</li>
</ul>
<p><strong>Mutable (VS Code):</strong></p>
<ul>
<li>Edits modify in place - less allocation overhead</li>
<li>Requires separate undo infrastructure</li>
<li>Concurrent access needs care</li>
</ul>
<p><strong>Lazy loading</strong> is orthogonal to mutability, but Fresh implements it and VS Code doesn't. Fresh can leave file regions on disk until accessed; VS Code loads the entire file.</p>
<h2 id="comparison-piece-tree-vs-rope">Comparison: Piece Tree vs Rope</h2>
<p>Different editors use different text storage structures:</p>
<ul>
<li><strong>Piece tree</strong>: VS Code, Fresh</li>
<li><strong>Rope</strong>: Helix (uses <a href="https://github.com/cessen/ropey">Ropey</a>), Zed (custom <a href="https://zed.dev/blog/zed-decoded-rope-sumtree">SumTree</a>)</li>
<li><strong>Gap buffer</strong>: Emacs</li>
<li><strong>Line array</strong>: Vim, Neovim</li>
</ul>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Piece Tree (Fresh, VS Code)</th>
<th>Rope (Helix, Zed)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Node contents</td>
<td>Pointer to buffer</td>
<td>Actual text (~1KB chunks)</td>
</tr>
<tr>
<td>Insert</td>
<td>Append to buffer, add piece</td>
<td>May copy/split chunk</td>
</tr>
<tr>
<td>Original file</td>
<td>Preserved in buffer 0</td>
<td>Reorganized into chunks</td>
</tr>
<tr>
<td>Large files</td>
<td>Lazy load regions (Fresh, Word 1.1a)</td>
<td>Must load or stream</td>
</tr>
<tr>
<td>Memory for edits</td>
<td>Minimal (just pointers)</td>
<td>Copies chunk data</td>
</tr>
</tbody>
</table>
<h2 id="trade-offs">Trade-offs</h2>
<p><strong>Advantages:</strong></p>
<ul>
<li>Original file content preserved (useful for diffs, minimal saves)</li>
<li>Inserts never copy existing text</li>
<li>Natural lazy loading for large files</li>
<li>Pieces are small (~24 bytes) - more fit in CPU cache during tree traversal</li>
</ul>
<p><strong>Disadvantages:</strong></p>
<ul>
<li>Extra indirection: find piece, then fetch from buffer</li>
<li>Buffer fragmentation over many edits (many small buffers)</li>
<li>Cache locality for text is poor (data scattered across buffers)</li>
<li>No automatic chunk coalescing (piece count grows with edits)</li>
</ul>
<p><em>(Note: Fresh's current implementation doesn't fully exploit immutability - it rebuilds the entire tree on each edit rather than path-copying, making edits O(P) instead of O(log P). VS Code has additional optimizations like search caching and line content caching that Fresh lacks. These are implementation gaps, not inherent to the designs.)</em></p>
<h2 id="further-reading">Further Reading</h2>
<ul>
<li><a href="https://computerhistory.org/blog/microsoft-word-for-windows-1-1a-source-code/">Microsoft Word 1.1a Source Code</a> - Original piece table implementation from 1990</li>
<li><a href="https://code.visualstudio.com/blogs/2018/03/23/text-buffer-reimplementation">VS Code's Piece Table</a> - Microsoft's 2018 write-up on reviving piece tables</li>
<li><a href="https://zed.dev/blog/zed-decoded-rope-sumtree">Zed's Rope &amp; SumTree</a> - How Zed implements ropes with B+ trees</li>
<li><a href="https://coredumped.dev/2023/08/09/text-showdown-gap-buffers-vs-ropes/">Text Showdown: Gap Buffers vs Ropes</a> - Performance comparison</li>
<li><a href="https://www.cs.unm.edu/~crowley/papers/sds.pdf">Data Structures for Text Sequences</a> - Charles Crowley, 1998 (academic survey)</li>
</ul>
]]></content><author><name></name></author></entry><entry><title type="html">How Fresh Loads Huge Files Fast</title><link href="/blog/2025/12/08/how-fresh-loads-huge-files-fast.html" rel="alternate" type="text/html" title="How Fresh Loads Huge Files Fast" /><published>2025-12-08T22:13:12+00:00</published><updated>2025-12-08T22:13:12+00:00</updated><id>/blog/2025/12/08/how-fresh-loads-huge-files-fast.html</id><content type="html" xml:base="/blog/2025/12/08/how-fresh-loads-huge-files-fast.html"><![CDATA[<h1 id="how-fresh-loads-huge-files-fast">How Fresh Loads Huge Files Fast</h1>
<p>Fresh uses a <strong>piece tree</strong> (also called a piece table) for text storage. The piece table originated in the early 1970s - first in <a href="https://www.computerhistory.org/collections/catalog/102740449">J. Strother Moore's work at Edinburgh</a>, then in the <a href="https://en.wikipedia.org/wiki/Bravo_(editor)">Bravo editor</a> at Xerox PARC (1974) by Butler Lampson and Charles Simonyi. Simonyi later <a href="https://www.tiny.cloud/blog/wysiwyg-development-history/">brought it to Microsoft Word</a> (1983). The design minimizes memory copying by never modifying original file content - critical for early systems with limited RAM. <a href="https://code.visualstudio.com/blogs/2018/03/23/text-buffer-reimplementation">VS Code revived this approach in 2018</a>.</p>
<p>Fresh's implementation adds immutable nodes (for concurrency and cheap snapshots) and lazy loading (for large files).</p>
<h2 id="the-core-idea">The Core Idea</h2>
<p>Instead of storing text in the tree, store <strong>pointers</strong> to text that lives elsewhere.</p>
<h3 id="rope-helix-zed">Rope (<a href="https://github.com/helix-editor/helix/blob/master/docs/architecture.md">Helix</a>, <a href="https://zed.dev/blog/zed-decoded-rope-sumtree">Zed</a>)</h3>
<p>Text lives inside tree nodes:</p>
<pre class="mermaid"><code>graph TD
    Root[Internal Node]
    Root --&gt; L[Leaf: &#39;Hello &#39;]
    Root --&gt; R[Leaf: &#39;World&#39;]</code></pre>
<h3 id="piece-tree-fresh">Piece Tree (Fresh)</h3>
<p>Tree nodes point to separate buffers:</p>
<pre class="mermaid"><code>graph TD
    subgraph Tree
        Root[Internal Node]
        Root --&gt; L[Piece: buffer 0, offset 0, len 6]
        Root --&gt; R[Piece: buffer 0, offset 6, len 5]
    end

    subgraph Buffers
        B0[Buffer 0: &#39;Hello World&#39;]
    end

    L -.-&gt; B0
    R -.-&gt; B0</code></pre>
<p>A <strong>piece</strong> is just three numbers: which buffer, starting offset, and length.</p>
<h2 id="what-happens-when-you-edit">What Happens When You Edit</h2>
<p>When you type or paste, Fresh appends to a new buffer and creates a piece pointing to it. The original buffer stays untouched.</p>
<h3 id="before-file-contains-hello-world">Before: File contains "Hello World"</h3>
<pre class="mermaid"><code>graph LR
    subgraph Tree
        P1[Piece: buf 0, 0-11]
    end

    subgraph Buffers
        B0[&quot;Buffer 0 (original): &#39;Hello World&#39;&quot;]
    end

    P1 -.-&gt; B0</code></pre>
<h3 id="after-insert-big--at-position-6">After: Insert "Big " at position 6</h3>
<pre class="mermaid"><code>graph LR
    subgraph Tree
        P1[Piece: buf 0, 0-6]
        P2[Piece: buf 1, 0-4]
        P3[Piece: buf 0, 6-11]
    end

    subgraph Buffers
        B0[&quot;Buffer 0 (original): &#39;Hello World&#39;&quot;]
        B1[&quot;Buffer 1 (added): &#39;Big &#39;&quot;]
    end

    P1 -.-&gt; B0
    P2 -.-&gt; B1
    P3 -.-&gt; B0</code></pre>
<p>Document now reads: "Hello Big World"</p>
<p>The original file content in Buffer 0 was never modified or copied.</p>
<h2 id="lazy-loading">Lazy Loading</h2>
<p>For large files, Fresh doesn't load the entire file into memory. Buffers can be <strong>unloaded</strong> - they store a file path and byte range instead of actual data.</p>
<p>This is actually how the original <a href="https://computerhistory.org/blog/microsoft-word-for-windows-1-1a-source-code/">Word 1.1a</a> piece table worked: pieces pointed directly to spans in the original file on disk, loading content only when needed. VS Code's 2018 implementation loads files fully into memory; Fresh returns to the original memory-conscious design.</p>
<pre class="mermaid"><code>graph TD
    subgraph Tree
        P1[Piece: buf 0, 0-1MB]
        P2[Piece: buf 0, 1MB-2MB]
        P3[Piece: buf 0, 2MB-3MB]
    end

    subgraph Buffers
        B0[&quot;Buffer 0: UNLOADED
        file: /path/to/large.txt
        offset: 0
        bytes: 3MB&quot;]
    end

    P1 -.-&gt; B0
    P2 -.-&gt; B0
    P3 -.-&gt; B0</code></pre>
<p>When you scroll to a region, Fresh loads only that chunk from disk:</p>
<pre class="mermaid"><code>graph TD
    subgraph &quot;After scrolling to middle&quot;
        B0_new[&quot;Buffer 0: UNLOADED (0-1MB)&quot;]
        B1_new[&quot;Buffer 1: LOADED (1MB-2MB)
        actual bytes in memory&quot;]
        B2_new[&quot;Buffer 2: UNLOADED (2MB-3MB)&quot;]
    end</code></pre>
<h2 id="zero-copy-reads">Zero-Copy Reads</h2>
<p>When reading text for display, Fresh doesn't copy bytes. It returns slices pointing directly into the buffers:</p>
<pre class="rust"><code>// Returns &amp;[u8] pointing into buffer memory
// No allocation, no copy
let text = buffer.get_text_range(100, 200);</code></pre>
<p>Multiple pieces can reference the same buffer region. Displaying the same text twice doesn't double memory usage.</p>
<h2 id="the-tree-structure">The Tree Structure</h2>
<p>The pieces are organized in a balanced binary tree for fast lookups:</p>
<pre class="mermaid"><code>graph TD
    I1[&quot;Internal
    left_bytes: 100&quot;]
    I1 --&gt; I2[&quot;Internal
    left_bytes: 50&quot;]
    I1 --&gt; L3[Piece: 50 bytes]

    I2 --&gt; L1[Piece: 50 bytes]
    I2 --&gt; L2[Piece: 50 bytes]</code></pre>
<p>Each internal node caches the total bytes in its left subtree. To find byte offset 75:</p>
<ol type="1">
<li>Root has <code>left_bytes: 100</code>, and 75 &lt; 100, so go left</li>
<li>Internal has <code>left_bytes: 50</code>, and 75 &gt;= 50, so go right with offset 75-50=25</li>
<li>Piece has 50 bytes, offset 25 is within it</li>
</ol>
<p>This is O(log P) where P is the number of pieces.</p>
<h2 id="immutable-tree-structure">Immutable Tree Structure</h2>
<p>Fresh uses immutable nodes - once created, a node is never modified. Edits create new nodes instead.</p>
<blockquote>
<p><strong>Implementation note:</strong> Fresh is written in Rust. Nodes are wrapped in <code>Arc&lt;T&gt;</code> (Atomic Reference Counted pointer) - think of it as a pointer that tracks how many things reference it. Multiple parts of the code (even different threads) can safely hold the same <code>Arc</code>, and the data is automatically freed when the last reference is dropped. We'll gloss over this detail going forward - just know that "sharing" a node is cheap and thread-safe.</p>
</blockquote>
<p>After an edit, old tree versions remain valid:</p>
<pre class="mermaid"><code>graph TD
    subgraph &quot;Version 1 (before edit)&quot;
        V1_Root[Root v1] --&gt; V1_L[Left]
        V1_Root --&gt; V1_R[Right]
    end

    subgraph &quot;Version 2 (after edit)&quot;
        V2_Root[Root v2] --&gt; V1_L
        V2_Root --&gt; V2_R[Right v2]
    end</code></pre>
<p>Version 2 shares the unchanged left subtree with Version 1. This enables:</p>
<ul>
<li>Undo/redo by keeping old root references</li>
<li>Concurrent reads without locks</li>
<li>Cheap snapshots</li>
</ul>
<h2 id="fresh-vs-vs-code">Fresh vs VS Code</h2>
<p>VS Code also uses a piece tree. The core idea is identical, but the designs diverge on one key question: mutable or immutable nodes?</p>
<p><strong>VS Code</strong>: Mutable tree. Edits modify nodes in place using red-black tree rotations. Undo/redo is handled by a separate layer that stores edit operations.</p>
<p><strong>Fresh</strong>: Immutable nodes. Edits produce new tree versions while old versions remain valid, with unchanged subtrees shared between versions. (This is known as a <a href="https://en.wikipedia.org/wiki/Persistent_data_structure">persistent data structure</a> in CS literature.)</p>
<h3 id="inherent-trade-offs">Inherent Trade-offs</h3>
<p><strong>Immutable (Fresh):</strong></p>
<ul>
<li>Old tree versions stay valid - enables cheap snapshots and structural sharing</li>
<li>Concurrent reads need no synchronization</li>
<li>Undo can be "keep the old root" instead of "replay operations backward"</li>
<li>More allocations per edit (new nodes along modified path)</li>
</ul>
<p><strong>Mutable (VS Code):</strong></p>
<ul>
<li>Edits modify in place - less allocation overhead</li>
<li>Requires separate undo infrastructure</li>
<li>Concurrent access needs care</li>
</ul>
<p><strong>Lazy loading</strong> is orthogonal to mutability, but Fresh implements it and VS Code doesn't. Fresh can leave file regions on disk until accessed; VS Code loads the entire file.</p>
<h2 id="comparison-piece-tree-vs-rope">Comparison: Piece Tree vs Rope</h2>
<p>Different editors use different text storage structures:</p>
<ul>
<li><strong>Piece tree</strong>: VS Code, Fresh</li>
<li><strong>Rope</strong>: Helix (uses <a href="https://github.com/cessen/ropey">Ropey</a>), Zed (custom <a href="https://zed.dev/blog/zed-decoded-rope-sumtree">SumTree</a>)</li>
<li><strong>Gap buffer</strong>: Emacs</li>
<li><strong>Line array</strong>: Vim, Neovim</li>
</ul>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Piece Tree (Fresh, VS Code)</th>
<th>Rope (Helix, Zed)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Node contents</td>
<td>Pointer to buffer</td>
<td>Actual text (~1KB chunks)</td>
</tr>
<tr>
<td>Insert</td>
<td>Append to buffer, add piece</td>
<td>May copy/split chunk</td>
</tr>
<tr>
<td>Original file</td>
<td>Preserved in buffer 0</td>
<td>Reorganized into chunks</td>
</tr>
<tr>
<td>Large files</td>
<td>Lazy load regions (Fresh, Word 1.1a)</td>
<td>Must load or stream</td>
</tr>
<tr>
<td>Memory for edits</td>
<td>Minimal (just pointers)</td>
<td>Copies chunk data</td>
</tr>
</tbody>
</table>
<h2 id="trade-offs">Trade-offs</h2>
<p><strong>Advantages:</strong></p>
<ul>
<li>Original file content preserved (useful for diffs, minimal saves)</li>
<li>Inserts never copy existing text</li>
<li>Natural lazy loading for large files</li>
<li>Pieces are small (~24 bytes) - more fit in CPU cache during tree traversal</li>
</ul>
<p><strong>Disadvantages:</strong></p>
<ul>
<li>Extra indirection: find piece, then fetch from buffer</li>
<li>Buffer fragmentation over many edits (many small buffers)</li>
<li>Cache locality for text is poor (data scattered across buffers)</li>
<li>No automatic chunk coalescing (piece count grows with edits)</li>
</ul>
<p><em>(Note: Fresh's current implementation doesn't fully exploit immutability - it rebuilds the entire tree on each edit rather than path-copying, making edits O(P) instead of O(log P). VS Code has additional optimizations like search caching and line content caching that Fresh lacks. These are implementation gaps, not inherent to the designs.)</em></p>
<h2 id="further-reading">Further Reading</h2>
<ul>
<li><a href="https://computerhistory.org/blog/microsoft-word-for-windows-1-1a-source-code/">Microsoft Word 1.1a Source Code</a> - Original piece table implementation from 1990</li>
<li><a href="https://code.visualstudio.com/blogs/2018/03/23/text-buffer-reimplementation">VS Code's Piece Table</a> - Microsoft's 2018 write-up on reviving piece tables</li>
<li><a href="https://zed.dev/blog/zed-decoded-rope-sumtree">Zed's Rope &amp; SumTree</a> - How Zed implements ropes with B+ trees</li>
<li><a href="https://coredumped.dev/2023/08/09/text-showdown-gap-buffers-vs-ropes/">Text Showdown: Gap Buffers vs Ropes</a> - Performance comparison</li>
<li><a href="https://www.cs.unm.edu/~crowley/papers/sds.pdf">Data Structures for Text Sequences</a> - Charles Crowley, 1998 (academic survey)</li>
</ul>
]]></content><author><name></name></author></entry><entry><title type="html">Fresh Piece Tree Architecture</title><link href="/blog/2025/12/08/fresh-piece-tree-architecture.html" rel="alternate" type="text/html" title="Fresh Piece Tree Architecture" /><published>2025-12-08T21:53:30+00:00</published><updated>2025-12-08T21:53:30+00:00</updated><id>/blog/2025/12/08/fresh-piece-tree-architecture.html</id><content type="html" xml:base="/blog/2025/12/08/fresh-piece-tree-architecture.html"><![CDATA[<h1 id="fresh-piece-tree-architecture">Fresh Piece Tree Architecture</h1>
<p>Fresh uses a <strong>piece tree</strong> (also called a piece table) for text storage. This differs from most editors which store text directly in tree nodes.</p>
<h2 id="the-core-idea">The Core Idea</h2>
<p>Instead of storing text in the tree, store <strong>pointers</strong> to text that lives elsewhere.</p>
<h3 id="traditional-rope-most-editors">Traditional Rope (most editors)</h3>
<p>Text lives inside tree nodes:</p>
<pre class="mermaid"><code>graph TD
    Root[Internal Node]
    Root --&gt; L[Leaf: &#39;Hello &#39;]
    Root --&gt; R[Leaf: &#39;World&#39;]</code></pre>
<h3 id="piece-tree-fresh">Piece Tree (Fresh)</h3>
<p>Tree nodes point to separate buffers:</p>
<pre class="mermaid"><code>graph TD
    subgraph Tree
        Root[Internal Node]
        Root --&gt; L[Piece: buffer 0, offset 0, len 6]
        Root --&gt; R[Piece: buffer 0, offset 6, len 5]
    end

    subgraph Buffers
        B0[Buffer 0: &#39;Hello World&#39;]
    end

    L -.-&gt; B0
    R -.-&gt; B0</code></pre>
<p>A <strong>piece</strong> is just three numbers: which buffer, starting offset, and length.</p>
<h2 id="what-happens-when-you-edit">What Happens When You Edit</h2>
<p>When you type or paste, Fresh appends to a new buffer and creates a piece pointing to it. The original buffer stays untouched.</p>
<h3 id="before-file-contains-hello-world">Before: File contains "Hello World"</h3>
<pre class="mermaid"><code>graph LR
    subgraph Tree
        P1[Piece: buf 0, 0-11]
    end

    subgraph Buffers
        B0[&quot;Buffer 0 (original): &#39;Hello World&#39;&quot;]
    end

    P1 -.-&gt; B0</code></pre>
<h3 id="after-insert-big--at-position-6">After: Insert "Big " at position 6</h3>
<pre class="mermaid"><code>graph LR
    subgraph Tree
        P1[Piece: buf 0, 0-6]
        P2[Piece: buf 1, 0-4]
        P3[Piece: buf 0, 6-11]
    end

    subgraph Buffers
        B0[&quot;Buffer 0 (original): &#39;Hello World&#39;&quot;]
        B1[&quot;Buffer 1 (added): &#39;Big &#39;&quot;]
    end

    P1 -.-&gt; B0
    P2 -.-&gt; B1
    P3 -.-&gt; B0</code></pre>
<p>Document now reads: "Hello Big World"</p>
<p>The original file content in Buffer 0 was never modified or copied.</p>
<h2 id="lazy-loading">Lazy Loading</h2>
<p>For large files, Fresh doesn't load the entire file into memory. Buffers can be <strong>unloaded</strong> - they store a file path and byte range instead of actual data.</p>
<pre class="mermaid"><code>graph TD
    subgraph Tree
        P1[Piece: buf 0, 0-1MB]
        P2[Piece: buf 0, 1MB-2MB]
        P3[Piece: buf 0, 2MB-3MB]
    end

    subgraph Buffers
        B0[&quot;Buffer 0: UNLOADED
        file: /path/to/large.txt
        offset: 0
        bytes: 3MB&quot;]
    end

    P1 -.-&gt; B0
    P2 -.-&gt; B0
    P3 -.-&gt; B0</code></pre>
<p>When you scroll to a region, Fresh loads only that chunk from disk:</p>
<pre class="mermaid"><code>graph TD
    subgraph &quot;After scrolling to middle&quot;
        B0_new[&quot;Buffer 0: UNLOADED (0-1MB)&quot;]
        B1_new[&quot;Buffer 1: LOADED (1MB-2MB)
        actual bytes in memory&quot;]
        B2_new[&quot;Buffer 2: UNLOADED (2MB-3MB)&quot;]
    end</code></pre>
<h2 id="zero-copy-reads">Zero-Copy Reads</h2>
<p>When reading text for display, Fresh doesn't copy bytes. It returns slices pointing directly into the buffers:</p>
<pre class="rust"><code>// Returns &amp;[u8] pointing into buffer memory
// No allocation, no copy
let text = buffer.get_text_range(100, 200);</code></pre>
<p>Multiple pieces can reference the same buffer region. Displaying the same text twice doesn't double memory usage.</p>
<h2 id="the-tree-structure">The Tree Structure</h2>
<p>The pieces are organized in a balanced binary tree for fast lookups:</p>
<pre class="mermaid"><code>graph TD
    I1[&quot;Internal
    left_bytes: 100&quot;]
    I1 --&gt; I2[&quot;Internal
    left_bytes: 50&quot;]
    I1 --&gt; L3[Piece: 50 bytes]

    I2 --&gt; L1[Piece: 50 bytes]
    I2 --&gt; L2[Piece: 50 bytes]</code></pre>
<p>Each internal node caches the total bytes in its left subtree. To find byte offset 75:</p>
<ol type="1">
<li>Root has <code>left_bytes: 100</code>, and 75 &lt; 100, so go left</li>
<li>Internal has <code>left_bytes: 50</code>, and 75 &gt;= 50, so go right with offset 75-50=25</li>
<li>Piece has 50 bytes, offset 25 is within it</li>
</ol>
<p>This is O(log P) where P is the number of pieces.</p>
<h2 id="immutable-tree-structure">Immutable Tree Structure</h2>
<p>Fresh uses immutable nodes - once created, a node is never modified. Edits create new nodes instead.</p>
<blockquote>
<p><strong>Implementation note:</strong> Fresh is written in Rust. Nodes are wrapped in <code>Arc&lt;T&gt;</code> (Atomic Reference Counted pointer) - think of it as a pointer that tracks how many things reference it. Multiple parts of the code (even different threads) can safely hold the same <code>Arc</code>, and the data is automatically freed when the last reference is dropped. We'll gloss over this detail going forward - just know that "sharing" a node is cheap and thread-safe.</p>
</blockquote>
<p>After an edit, old tree versions remain valid:</p>
<pre class="mermaid"><code>graph TD
    subgraph &quot;Version 1 (before edit)&quot;
        V1_Root[Root v1] --&gt; V1_L[Left]
        V1_Root --&gt; V1_R[Right]
    end

    subgraph &quot;Version 2 (after edit)&quot;
        V2_Root[Root v2] --&gt; V1_L
        V2_Root --&gt; V2_R[Right v2]
    end</code></pre>
<p>Version 2 shares the unchanged left subtree with Version 1. This enables:</p>
<ul>
<li>Undo/redo by keeping old root references</li>
<li>Concurrent reads without locks</li>
<li>Cheap snapshots</li>
</ul>
<h2 id="fresh-vs-vs-code">Fresh vs VS Code</h2>
<p>VS Code also uses a piece tree. The core idea is identical, but the designs diverge on one key question: mutable or immutable nodes?</p>
<p><strong>VS Code</strong>: Mutable tree. Edits modify nodes in place using red-black tree rotations. Undo/redo is handled by a separate layer that stores edit operations.</p>
<p><strong>Fresh</strong>: Immutable nodes. Edits produce new tree versions while old versions remain valid, with unchanged subtrees shared between versions. (This is known as a <a href="https://en.wikipedia.org/wiki/Persistent_data_structure">persistent data structure</a> in CS literature.)</p>
<h3 id="inherent-trade-offs">Inherent Trade-offs</h3>
<p><strong>Immutable (Fresh):</strong></p>
<ul>
<li>Old tree versions stay valid - enables cheap snapshots and structural sharing</li>
<li>Concurrent reads need no synchronization</li>
<li>Undo can be "keep the old root" instead of "replay operations backward"</li>
<li>More allocations per edit (new nodes along modified path)</li>
</ul>
<p><strong>Mutable (VS Code):</strong></p>
<ul>
<li>Edits modify in place - less allocation overhead</li>
<li>Requires separate undo infrastructure</li>
<li>Concurrent access needs care</li>
</ul>
<p><strong>Lazy loading</strong> is orthogonal to mutability, but Fresh implements it and VS Code doesn't. Fresh can leave file regions on disk until accessed; VS Code loads the entire file.</p>
<p><em>(Fresh's current implementation doesn't fully exploit immutability - it rebuilds the entire tree on each edit rather than path-copying. VS Code also has optimizations like search caching and line content caching that Fresh lacks. These are implementation gaps, not inherent to the designs.)</em></p>
<h2 id="comparison-piece-tree-vs-rope">Comparison: Piece Tree vs Rope</h2>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Piece Tree (Fresh)</th>
<th>Rope (most editors)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Node contents</td>
<td>Pointer to buffer</td>
<td>Actual text (~1KB)</td>
</tr>
<tr>
<td>Insert</td>
<td>Append to buffer, add piece</td>
<td>May copy/split chunk</td>
</tr>
<tr>
<td>Original file</td>
<td>Preserved in buffer 0</td>
<td>Reorganized into chunks</td>
</tr>
<tr>
<td>Large files</td>
<td>Lazy load regions</td>
<td>Must load or stream</td>
</tr>
<tr>
<td>Memory for edits</td>
<td>Minimal (just pointers)</td>
<td>Copies chunk data</td>
</tr>
</tbody>
</table>
<h2 id="trade-offs">Trade-offs</h2>
<p><strong>Advantages:</strong></p>
<ul>
<li>Original file content preserved (useful for diffs, minimal saves)</li>
<li>Inserts never copy existing text</li>
<li>Natural lazy loading for large files</li>
<li>Pieces are small (~24 bytes) - more fit in CPU cache during tree traversal</li>
</ul>
<p><strong>Disadvantages:</strong></p>
<ul>
<li>Extra indirection: find piece, then fetch from buffer</li>
<li>Buffer fragmentation over many edits (many small buffers)</li>
<li>Cache locality for text is poor (data scattered across buffers)</li>
<li>No automatic chunk coalescing (piece count grows with edits)</li>
</ul>
<p><em>(Note: Fresh's current implementation also rebuilds the entire tree on each edit - O(P) instead of O(log P). This is an implementation gap, not inherent to piece trees.)</em></p>
<h2 id="further-reading">Further Reading</h2>
<ul>
<li><a href="https://code.visualstudio.com/blogs/2018/03/23/text-buffer-reimplementation">VS Code's Piece Table</a> - Microsoft's write-up on adopting piece tables</li>
<li><a href="https://github.com/microsoft/vscode/blob/main/src/vs/editor/common/model/pieceTreeTextBuffer/pieceTreeBase.ts">VS Code Source: pieceTreeBase.ts</a> - The actual implementation</li>
<li><a href="https://www.cs.unm.edu/~crowley/papers/sds.pdf">Original Piece Table Paper</a> - J. Crowley, 1998</li>
</ul>
]]></content><author><name></name></author></entry><entry><title type="html">The Open-Source Libraries Powering Fresh</title><link href="/blog/2025/12/07/the-open-source-libraries-powering-fresh.html" rel="alternate" type="text/html" title="The Open-Source Libraries Powering Fresh" /><published>2025-12-07T21:26:53+00:00</published><updated>2025-12-07T21:26:53+00:00</updated><id>/blog/2025/12/07/the-open-source-libraries-powering-fresh.html</id><content type="html" xml:base="/blog/2025/12/07/the-open-source-libraries-powering-fresh.html"><![CDATA[<h1 id="the-open-source-libraries-powering-fresh">The Open-Source Libraries Powering Fresh</h1>
<p>Building <a href="https://sinelaw.github.io/fresh/">Fresh</a> would have been insanely hard if it weren't for these libraries.</p>
<p>Packages specifically useful for building a TUI text editor:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Crate</th>
<th style="text-align: left;">One-Line Summary</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><a href="https://crates.io/crates/arboard">arboard</a></td>
<td style="text-align: left;">Cross-platform acesss to the system clipboard (CTRL+C for the win)</td>
</tr>
<tr>
<td style="text-align: left;"><a href="https://crates.io/crates/crossterm">crossterm</a></td>
<td style="text-align: left;">Terminal manipulation, handling input, cursor movement, and colors across platforms (backend for ratatui)</td>
</tr>
<tr>
<td style="text-align: left;"><a href="https://crates.io/crates/deno_ast">deno</a></td>
<td style="text-align: left;">TypeScript/JavaScript embeddeble runtime, used for the plugin system (<code>deno_ast</code>, <code>deno_core</code>, etc.)</td>
</tr>
<tr>
<td style="text-align: left;"><a href="https://crates.io/crates/dirs">dirs</a></td>
<td style="text-align: left;">Abstracting away platform-specific user directories (like desktop, documents, cache)</td>
</tr>
<tr>
<td style="text-align: left;"><a href="https://crates.io/crates/ignore">ignore</a></td>
<td style="text-align: left;">Pattern matching for files, often using <code>.gitignore</code> syntax</td>
</tr>
<tr>
<td style="text-align: left;"><a href="https://crates.io/crates/lsp-types">lsp-types</a></td>
<td style="text-align: left;">Data structures corresponding to the types defined by the Language Server Protocol (LSP)</td>
</tr>
<tr>
<td style="text-align: left;"><a href="https://crates.io/crates/notify">notify</a></td>
<td style="text-align: left;">Cross-platform filesystem event monitor/watcher for detecting file system changes (for detecting changes and auto-reverting buffers)</td>
</tr>
<tr>
<td style="text-align: left;"><a href="https://crates.io/crates/pulldown-cmark">pulldown-cmark</a></td>
<td style="text-align: left;">Markdown parser (some LSP servers return markdown)</td>
</tr>
<tr>
<td style="text-align: left;"><a href="https://crates.io/crates/ratatui">ratatui</a></td>
<td style="text-align: left;">Full-featured Text User Interfaces (TUI) library, very cool!</td>
</tr>
<tr>
<td style="text-align: left;"><a href="https://crates.io/crates/syntect">syntect</a></td>
<td style="text-align: left;">Syntax highlighting based on Sublime Text syntax definitions</td>
</tr>
<tr>
<td style="text-align: left;"><a href="https://crates.io/crates/tree-sitter">tree-sitter</a></td>
<td style="text-align: left;">Incrementally parsing concrete syntax trees for various languages (used in auto-indent &amp; semantic highlighting)</td>
</tr>
</tbody>
</table>
<p>General purpose libraries:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Crate</th>
<th style="text-align: left;">One-Line Summary</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><a href="https://crates.io/crates/anyhow">anyhow</a></td>
<td style="text-align: left;">Makes it easy to align all your errors to a single type</td>
</tr>
<tr>
<td style="text-align: left;"><a href="https://crates.io/crates/async-trait">async-trait</a></td>
<td style="text-align: left;">Enables the use of <code>async</code> functions in Rust traits, which is currently unsupported natively</td>
</tr>
<tr>
<td style="text-align: left;"><a href="https://crates.io/crates/chrono">chrono</a></td>
<td style="text-align: left;">Date and time manipulation and formatting</td>
</tr>
<tr>
<td style="text-align: left;"><a href="https://crates.io/crates/clap">clap</a></td>
<td style="text-align: left;">command-line arguments parsing, auto-generated help messages, and more</td>
</tr>
<tr>
<td style="text-align: left;"><a href="https://crates.io/crates/libc">libc</a></td>
<td style="text-align: left;">Low-level bindings to OS-level C standard library</td>
</tr>
<tr>
<td style="text-align: left;"><a href="https://crates.io/crates/libloading">libloading</a></td>
<td style="text-align: left;">dlopen wrapper (used for libgpm dynamic loading)</td>
</tr>
<tr>
<td style="text-align: left;"><a href="https://crates.io/crates/lru">lru</a></td>
<td style="text-align: left;">Implements a simple, efficient Least Recently Used (LRU) cache based on a hash map and a linked list</td>
</tr>
<tr>
<td style="text-align: left;"><a href="https://crates.io/crates/nix">nix</a></td>
<td style="text-align: left;">Bindings to Unix-like OS APIs (e.g., processes, file descriptors)</td>
</tr>
<tr>
<td style="text-align: left;"><a href="https://crates.io/crates/regex">regex</a></td>
<td style="text-align: left;">Regular expression engine</td>
</tr>
<tr>
<td style="text-align: left;"><a href="https://crates.io/crates/schemars">schemars</a></td>
<td style="text-align: left;">Used for generating JSON Schema from Rust data structures for API validation and documentation (config.json autogenerated parser)</td>
</tr>
<tr>
<td style="text-align: left;"><a href="https://crates.io/crates/serde">serde</a></td>
<td style="text-align: left;">Serializing/deserializing data structures efficiently, including json (with sede_json)</td>
</tr>
<tr>
<td style="text-align: left;"><a href="https://crates.io/crates/sha2">sha2</a></td>
<td style="text-align: left;">SHA-256, SHA-512, etc.</td>
</tr>
<tr>
<td style="text-align: left;"><a href="https://crates.io/crates/tokio">tokio</a></td>
<td style="text-align: left;">Asynchronous runtime for concurrency (e.g. use it for async IO)</td>
</tr>
<tr>
<td style="text-align: left;"><a href="https://crates.io/crates/tracing">tracing</a></td>
<td style="text-align: left;">Tracing and structured logging (also using <code>tracing-subscriber</code>)</td>
</tr>
</tbody>
</table>
<p>Thanks to all these projects - and their maintainers :)</p>
]]></content><author><name></name></author></entry><entry><title type="html">The Open-Source Libraries Powering Fresh</title><link href="/blog/2025/12/07/the-open-source-libraries-powering-fresh.html" rel="alternate" type="text/html" title="The Open-Source Libraries Powering Fresh" /><published>2025-12-07T21:23:33+00:00</published><updated>2025-12-07T21:23:33+00:00</updated><id>/blog/2025/12/07/the-open-source-libraries-powering-fresh.html</id><content type="html" xml:base="/blog/2025/12/07/the-open-source-libraries-powering-fresh.html"><![CDATA[<h1 id="the-open-source-libraries-powering-fresh">The Open-Source Libraries Powering Fresh</h1>
<p>Building <a href="https://sinelaw.github.io/fresh/">Fresh</a> would have been insanely hard if it weren't for these libraries.</p>
<p>Packages specifically useful for building a TUI text editor:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Crate Name</th>
<th style="text-align: left;">One-Line Summary</th>
<th style="text-align: left;">crates.io Link</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>arboard</code></td>
<td style="text-align: left;">Cross-platform acesss to the system clipboard (CTRL+C for the win)</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/arboard](https://crates.io/crates/arboard)">https://crates.io/crates/arboard](https://crates.io/crates/arboard)</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>crossterm</code></td>
<td style="text-align: left;">Terminal manipulation, handling input, cursor movement, and colors across platforms (backend for ratatui)</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/crossterm](https://crates.io/crates/crossterm)">https://crates.io/crates/crossterm](https://crates.io/crates/crossterm)</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>deno</code></td>
<td style="text-align: left;">TypeScript/JavaScript embeddeble runtime, used for the plugin system (<code>deno_ast</code>, <code>deno_core</code>, etc.)</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/deno_ast](https://crates.io/crates/deno_ast)">https://crates.io/crates/deno_ast](https://crates.io/crates/deno_ast)</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>dirs</code></td>
<td style="text-align: left;">Abstracting away platform-specific user directories (like desktop, documents, cache)</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/dirs](https://crates.io/crates/dirs)">https://crates.io/crates/dirs](https://crates.io/crates/dirs)</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>ignore</code></td>
<td style="text-align: left;">Pattern matching for files, often using <code>.gitignore</code> syntax</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/ignore](https://crates.io/crates/ignore)">https://crates.io/crates/ignore](https://crates.io/crates/ignore)</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>lsp-types</code></td>
<td style="text-align: left;">Data structures corresponding to the types defined by the Language Server Protocol (LSP)</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/lsp-types](https://crates.io/crates/lsp-types)">https://crates.io/crates/lsp-types](https://crates.io/crates/lsp-types)</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>notify</code></td>
<td style="text-align: left;">Cross-platform filesystem event monitor/watcher for detecting file system changes (for detecting changes and auto-reverting buffers)</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/notify](https://crates.io/crates/notify)">https://crates.io/crates/notify](https://crates.io/crates/notify)</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>pulldown-cmark</code></td>
<td style="text-align: left;">Markdown parser (some LSP servers return markdown)</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/pulldown-cmark](https://crates.io/crates/pulldown-cmark)">https://crates.io/crates/pulldown-cmark](https://crates.io/crates/pulldown-cmark)</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>ratatui</code></td>
<td style="text-align: left;">Full-featured Text User Interfaces (TUI) library, very cool!</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/ratatui](https://crates.io/crates/ratatui)">https://crates.io/crates/ratatui](https://crates.io/crates/ratatui)</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>syntect</code></td>
<td style="text-align: left;">Syntax highlighting based on Sublime Text syntax definitions</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/syntect](https://crates.io/crates/syntect)">https://crates.io/crates/syntect](https://crates.io/crates/syntect)</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>tree-sitter</code></td>
<td style="text-align: left;">Incrementally parsing concrete syntax trees for various languages (used in auto-indent &amp; semantic highlighting)</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/tree-sitter](https://crates.io/crates/tree-sitter)">https://crates.io/crates/tree-sitter](https://crates.io/crates/tree-sitter)</a></td>
</tr>
</tbody>
</table>
<p>General purpose libraries:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Crate Name</th>
<th style="text-align: left;">One-Line Summary</th>
<th style="text-align: left;">crates.io Link</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>anyhow</code></td>
<td style="text-align: left;">Makes it easy to align all your errors to a single type</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/anyhow](https://crates.io/crates/anyhow)">https://crates.io/crates/anyhow](https://crates.io/crates/anyhow)</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>async-trait</code></td>
<td style="text-align: left;">Enables the use of <code>async</code> functions in Rust traits, which is currently unsupported natively</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/async-trait](https://crates.io/crates/async-trait)">https://crates.io/crates/async-trait](https://crates.io/crates/async-trait)</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>chrono</code></td>
<td style="text-align: left;">Date and time manipulation and formatting</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/chrono](https://crates.io/crates/chrono)">https://crates.io/crates/chrono](https://crates.io/crates/chrono)</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>clap</code></td>
<td style="text-align: left;">command-line arguments parsing, auto-generated help messages, and more</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/clap](https://crates.io/crates/clap)">https://crates.io/crates/clap](https://crates.io/crates/clap)</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>libc</code></td>
<td style="text-align: left;">Low-level bindings to OS-level C standard library</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/libc](https://crates.io/crates/libc)">https://crates.io/crates/libc](https://crates.io/crates/libc)</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>libloading</code></td>
<td style="text-align: left;">dlopen wrapper (used for libgpm dynamic loading)</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/libloading](https://crates.io/crates/libloading)">https://crates.io/crates/libloading](https://crates.io/crates/libloading)</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>lru</code></td>
<td style="text-align: left;">Implements a simple, efficient Least Recently Used (LRU) cache based on a hash map and a linked list</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/lru](https://crates.io/crates/lru)">https://crates.io/crates/lru](https://crates.io/crates/lru)</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>nix</code></td>
<td style="text-align: left;">Bindings to Unix-like OS APIs (e.g., processes, file descriptors)</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/nix](https://crates.io/crates/nix)">https://crates.io/crates/nix](https://crates.io/crates/nix)</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>regex</code></td>
<td style="text-align: left;">Regular expression engine</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/regex](https://crates.io/crates/regex)">https://crates.io/crates/regex](https://crates.io/crates/regex)</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>schemars</code></td>
<td style="text-align: left;">Used for generating JSON Schema from Rust data structures for API validation and documentation (config.json autogenerated parser)</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/schemars](https://crates.io/crates/schemars)">https://crates.io/crates/schemars](https://crates.io/crates/schemars)</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>serde</code></td>
<td style="text-align: left;">Serializing/deserializing data structures efficiently, including json (with sede_json)</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/serde](https://crates.io/crates/serde)">https://crates.io/crates/serde](https://crates.io/crates/serde)</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>sha2</code></td>
<td style="text-align: left;">SHA-256, SHA-512, etc.</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/sha2](https://crates.io/crates/sha2)">https://crates.io/crates/sha2](https://crates.io/crates/sha2)</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>tokio</code></td>
<td style="text-align: left;">Asynchronous runtime for concurrency (e.g. use it for async IO)</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/tokio](https://crates.io/crates/tokio)">https://crates.io/crates/tokio](https://crates.io/crates/tokio)</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>tracing</code></td>
<td style="text-align: left;">Tracing and structured logging (also using <code>tracing-subscriber</code>)</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/tracing](https://crates.io/crates/tracing)">https://crates.io/crates/tracing](https://crates.io/crates/tracing)</a></td>
</tr>
</tbody>
</table>
<p>Thanks to all these projects - and their maintainers :)</p>
]]></content><author><name></name></author></entry><entry><title type="html">The Open-Source Libraries Powering Fresh</title><link href="/blog/2025/12/07/the-open-source-libraries-powering-fresh.html" rel="alternate" type="text/html" title="The Open-Source Libraries Powering Fresh" /><published>2025-12-07T21:16:27+00:00</published><updated>2025-12-07T21:16:27+00:00</updated><id>/blog/2025/12/07/the-open-source-libraries-powering-fresh.html</id><content type="html" xml:base="/blog/2025/12/07/the-open-source-libraries-powering-fresh.html"><![CDATA[<h1 id="the-open-source-libraries-powering-fresh">The Open-Source Libraries Powering Fresh</h1>
<p>Building <a href="https://sinelaw.github.io/fresh/">Fresh</a> would have been insanely hard if it weren't for these libraries.</p>
<p>Packages specifically useful for building a TUI text editor:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Crate Name</th>
<th style="text-align: left;">One-Line Summary</th>
<th style="text-align: left;">crates.io Link</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>arboard</code></td>
<td style="text-align: left;">Cross-platform acesss to the system clipboard (CTRL+C for the win)</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/arboard](https://crates.io/crates/arboard)">https://crates.io/crates/arboard](https://crates.io/crates/arboard)</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>crossterm</code></td>
<td style="text-align: left;">Terminal manipulation, handling input, cursor movement, and colors across platforms (backend for ratatui)</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/crossterm](https://crates.io/crates/crossterm)">https://crates.io/crates/crossterm](https://crates.io/crates/crossterm)</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>deno</code></td>
<td style="text-align: left;">TypeScript/JavaScript embeddeble runtime, used for the plugin system (<code>deno_ast</code>, <code>deno_core</code>, etc.)</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/deno_ast](https://crates.io/crates/deno_ast)">https://crates.io/crates/deno_ast](https://crates.io/crates/deno_ast)</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>dirs</code></td>
<td style="text-align: left;">Abstracting away platform-specific user directories (like desktop, documents, cache)</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/dirs](https://crates.io/crates/dirs)">https://crates.io/crates/dirs](https://crates.io/crates/dirs)</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>ignore</code></td>
<td style="text-align: left;">Pattern matching for files, often using <code>.gitignore</code> syntax</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/ignore](https://crates.io/crates/ignore)">https://crates.io/crates/ignore](https://crates.io/crates/ignore)</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>lsp-types</code></td>
<td style="text-align: left;">Data structures corresponding to the types defined by the Language Server Protocol (LSP)</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/lsp-types](https://crates.io/crates/lsp-types)">https://crates.io/crates/lsp-types](https://crates.io/crates/lsp-types)</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>notify</code></td>
<td style="text-align: left;">Cross-platform filesystem event monitor/watcher for detecting file system changes (for detecting changes and auto-reverting buffers)</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/notify](https://crates.io/crates/notify)">https://crates.io/crates/notify](https://crates.io/crates/notify)</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>pulldown-cmark</code></td>
<td style="text-align: left;">Markdown parser (some LSP servers return markdown)</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/pulldown-cmark](https://crates.io/crates/pulldown-cmark)">https://crates.io/crates/pulldown-cmark](https://crates.io/crates/pulldown-cmark)</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>ratatui</code></td>
<td style="text-align: left;">Full-featured Text User Interfaces (TUI) library, very cool!</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/ratatui](https://crates.io/crates/ratatui)">https://crates.io/crates/ratatui](https://crates.io/crates/ratatui)</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>syntect</code></td>
<td style="text-align: left;">Syntax highlighting based on Sublime Text syntax definitions</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/syntect](https://crates.io/crates/syntect)">https://crates.io/crates/syntect](https://crates.io/crates/syntect)</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>tree-sitter</code></td>
<td style="text-align: left;">Incrementally parsing concrete syntax trees for various languages (used in auto-indent &amp; semantic highlighting)</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/tree-sitter](https://crates.io/crates/tree-sitter)">https://crates.io/crates/tree-sitter](https://crates.io/crates/tree-sitter)</a></td>
</tr>
</tbody>
</table>
<p>General purpose libraries:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Crate Name</th>
<th style="text-align: left;">One-Line Summary</th>
<th style="text-align: left;">crates.io Link</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>anyhow</code></td>
<td style="text-align: left;">Makes it easy to align all your errors to a single type</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/anyhow](https://crates.io/crates/anyhow)">https://crates.io/crates/anyhow](https://crates.io/crates/anyhow)</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>async-trait</code></td>
<td style="text-align: left;">Enables the use of <code>async</code> functions in Rust traits, which is currently unsupported natively</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/async-trait](https://crates.io/crates/async-trait)">https://crates.io/crates/async-trait](https://crates.io/crates/async-trait)</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>chrono</code></td>
<td style="text-align: left;">Date and time manipulation and formatting</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/chrono](https://crates.io/crates/chrono)">https://crates.io/crates/chrono](https://crates.io/crates/chrono)</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>clap</code></td>
<td style="text-align: left;">command-line arguments parsing, auto-generated help messages, and more</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/clap](https://crates.io/crates/clap)">https://crates.io/crates/clap](https://crates.io/crates/clap)</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>libc</code></td>
<td style="text-align: left;">Low-level bindings to OS-level C standard library</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/libc](https://crates.io/crates/libc)">https://crates.io/crates/libc](https://crates.io/crates/libc)</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>libloading</code></td>
<td style="text-align: left;">dlopen wrapper (used for libgpm dynamic loading)</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/libloading](https://crates.io/crates/libloading)">https://crates.io/crates/libloading](https://crates.io/crates/libloading)</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>lru</code></td>
<td style="text-align: left;">Implements a simple, efficient Least Recently Used (LRU) cache based on a hash map and a linked list</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/lru](https://crates.io/crates/lru)">https://crates.io/crates/lru](https://crates.io/crates/lru)</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>nix</code></td>
<td style="text-align: left;">Bindings to Unix-like OS APIs (e.g., processes, file descriptors)</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/nix](https://crates.io/crates/nix)">https://crates.io/crates/nix](https://crates.io/crates/nix)</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>regex</code></td>
<td style="text-align: left;">Regular expression engine</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/regex](https://crates.io/crates/regex)">https://crates.io/crates/regex](https://crates.io/crates/regex)</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>schemars</code></td>
<td style="text-align: left;">Used for generating JSON Schema from Rust data structures for API validation and documentation (config.json autogenerated parser)</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/schemars](https://crates.io/crates/schemars)">https://crates.io/crates/schemars](https://crates.io/crates/schemars)</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>serde</code></td>
<td style="text-align: left;">Serializing/deserializing data structures efficiently, including json (with sede_json)</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/serde](https://crates.io/crates/serde)">https://crates.io/crates/serde](https://crates.io/crates/serde)</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>sha2</code></td>
<td style="text-align: left;">SHA-256, SHA-512, etc.</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/sha2](https://crates.io/crates/sha2)">https://crates.io/crates/sha2](https://crates.io/crates/sha2)</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>tokio</code></td>
<td style="text-align: left;">Asynchronous runtime for concurrency (e.g. use it for async IO)</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/tokio](https://crates.io/crates/tokio)">https://crates.io/crates/tokio](https://crates.io/crates/tokio)</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>tracing</code></td>
<td style="text-align: left;">Tracing and structured logging (also using <code>tracing-subscriber</code>)</td>
<td style="text-align: left;">[<a href="https://crates.io/crates/tracing](https://crates.io/crates/tracing)">https://crates.io/crates/tracing](https://crates.io/crates/tracing)</a></td>
</tr>
</tbody>
</table>
<p>Thanks to all these projects - and their maintainers :)</p>
]]></content><author><name></name></author></entry><entry><title type="html">Type-safe enums in C, using a clang plugin</title><link href="/blog/2017/10/05/type-safe-enums-in-c-using-a-clang-plugin.html" rel="alternate" type="text/html" title="Type-safe enums in C, using a clang plugin" /><published>2017-10-05T00:00:00+03:00</published><updated>2017-10-05T00:00:00+03:00</updated><id>/blog/2017/10/05/type-safe-enums-in-c-using-a-clang-plugin</id><content type="html" xml:base="/blog/2017/10/05/type-safe-enums-in-c-using-a-clang-plugin.html"><![CDATA[<p>The C programming language generally treats enums as integers (see Appendix: For Language Lawyers for reference).</p>

<p>Wouldnt it be nice if we could do more with enums, and do it safely?</p>

<p>Some other languages have anything from integer-incompatible enums to full-blown sum types. It would be nice to have something like that in C.</p>

<p>I wrote the <a href="https://github.com/sinelaw/elfs-clang-plugins">enums_conversion clang plugin</a> aiming to do just that, by treating enums as incompatible with integers (except via explicit casting).</p>

<h2 id="a-motivating-example"><a href="https://github.com/sinelaw/elfs-clang-plugins/blob/docs/enums_conversion/README.md#a-motivating-example"></a>A motivating example</h2>

<p>Some people are surprised at the goals of this plugin. Here is a simple example to explain the motivation.</p>

<p>Consider the following (totally fabricated) API:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>enum OpGetResult {
    OP_GET_ERROR,
    OP_GET_OK,
};

enum OpGetResult get_items(void);

/* Implementation: */

enum OpGetResult get_items(void)
{
    /* ... do something with side effects ... */
    return OP_GET_OK;
}
</code></pre></div></div>

<p>So far so good. Save it as<code class="language-plaintext highlighter-rouge">test.c</code>and compile this program with gcc:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gcc -std=c11 -Wall -Wextra -Werror -c test.c
</code></pre></div></div>

<p>No errors, yay!</p>

<h3 id="a-simple-bug"><a href="https://github.com/sinelaw/elfs-clang-plugins/blob/docs/enums_conversion/README.md#a-simple-bug"></a>A simple bug</h3>

<p>Now, lets introduce a bug. Someone decided the API is no good, and<code class="language-plaintext highlighter-rouge">get_items</code>should just return the number of items it got. So the new API is:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/* This enum is in use elsewhere... */
enum OpGetResult {
    OP_GET_ERROR,
    OP_GET_OK,
};

int get_items(void); /* return value changed to 'int' */

/* Implementation: */

int get_items(void)
{
    /* ... do something with side effects ... */
    return OP_GET_OK; /* oops! forgot to change this */
}
</code></pre></div></div>

<p>The bug is that<code class="language-plaintext highlighter-rouge">get_items</code>still returns the enum value<code class="language-plaintext highlighter-rouge">OP_GET_OK</code>instead of a number.</p>

<p>Save as test2.c and compile (tested on gcc 6.3.0):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gcc -std=c11 -Wall -Wextra -Werror -c test2.c
</code></pre></div></div>

<p>Oh no! No error! Lets try with clang 5.0 and the wonderful<code class="language-plaintext highlighter-rouge">-Weverything</code>which enables all warnings:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>clang -std=c11 -Weverything -Werror  -c test2.c
</code></pre></div></div>

<p>Nope! Still no error.</p>

<p>The compilers are ok with this code<em>because its allowed</em>. However, its clearly not what we intended.</p>

<h3 id="a-bunch-of-other-possible-bugs"><a href="https://github.com/sinelaw/elfs-clang-plugins/blob/docs/enums_conversion/README.md#a-bunch-of-other-possible-bugs"></a>A bunch of other possible bugs</h3>

<p>Here is a snippet with different bad code examples: (for testing it can be appended to one of the previous files)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>int func(enum OpGetResult e, unsigned int x, unsigned int y);
int func(enum OpGetResult e, unsigned int x, unsigned int y)
{
  handle_result(x); /* passing arbitrary integer where one of several enum values was expected */

  enum OpGetResult e2 = x; /* assigning from arbitrary integer (which may not be a valid enum value) */

  if (e2 == y) { /* comparing enum to arbitrary integer */
  }

  return e; /* returning enum where arbitrary integer is expected by caller */
}
</code></pre></div></div>

<p>Neither gcc 6.3.0 nor clang 5.0 emit any kind of warning about the above code.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Let's try gcc with some extra warnings:
gcc -std=c11 -Wall -Wextra -Werror -Wconversion -Wenum-compare -Wswitch-enum -Wsign-conversion  -c test2.c

# clang with -Weverything:
clang -std=c11 -Weverything -Werror  -c test2.c
</code></pre></div></div>

<h3 id="clang-plugin-to-the-rescue"><a href="https://github.com/sinelaw/elfs-clang-plugins/blob/docs/enums_conversion/README.md#clang-plugin-to-the-rescue"></a>clang plugin to the rescue</h3>

<p>The<code class="language-plaintext highlighter-rouge">enums_converesion</code>clang plugin detects and warns about all of the above.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># clang -std=c11 -Weverything  -c test2.c -Xclang -load -Xclang ./clang_plugins.so -Xclang -add-plugin -Xclang enums_conversion
test2.c:22:23: error: enum conversion to or from enum OpGetResult
        handle_result(x); /* passing arbitrary integer where one of several enum values was expected */
                      ^
test2.c:24:31: error: enum conversion to or from enum OpGetResult
        enum OpGetResult e2 = x; /* assigning from arbitrary integer (which may not be a valid enum value) */
                              ^
test2.c:26:13: error: enum conversion to or from enum OpGetResult
        if (e2 == y) { /* comparing enum to arbitrary integer */
            ^
test2.c:29:16: error: enum conversion to or from enum OpGetResult
        return e; /* returning enum where arbitrary integer is expected by caller */
               ^
4 errors generated.
</code></pre></div></div>

<h2 id="frequently-asked-questions"><a href="https://github.com/sinelaw/elfs-clang-plugins/blob/docs/enums_conversion/README.md#frequently-asked-questions"></a>Frequently Asked Questions</h2>

<ol>
  <li>But this isnt standard C!</li>
</ol>

<p>Correct, it is a<em>restrictive subset</em>of C. Some valid C programs will be flagged by this plugin. I believe writing code in the spirit of this plugin will improve your codes readability while preventing a class of bugs from ever occurring.</p>

<ol>
  <li>How is this different from gccs<code class="language-plaintext highlighter-rouge">-Wenum-compare</code>?</li>
</ol>

<p>The warning flag<code class="language-plaintext highlighter-rouge">-Wenum-compare</code>find comparisons between different enums, but does not look at comparing enums to integers, implicit casting to/from integers, etc. In the following program only the second<code class="language-plaintext highlighter-rouge">if</code>is flagged by<code class="language-plaintext highlighter-rouge">-Wenum-compare</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>enum A { A_FIRST, A_SECOND };
enum B { B_FIRST, B_SECOND };

int foo(enum A a, unsigned int x);
int foo(enum A a, unsigned int x) {
      if (x == a) { // no warning emitted
          return 1;
      }
      if (B_FIRST == a) { // will cause warning: comparison between enum B and enum A
          return 2;
      }
      return 0;
}
</code></pre></div></div>

<ol>
  <li>How is this different from clangs<code class="language-plaintext highlighter-rouge">-Wenum-conversion</code>?</li>
</ol>

<p><code class="language-plaintext highlighter-rouge">-Wenum-conversion</code>doesnt catch implicit casts to/from integral types (the plugin does).</p>

<p><code class="language-plaintext highlighter-rouge">-Wenum-conversion</code>does catch conversion from one enum type to another, like so:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>enum EnumA { E_A };
enum EnumB { E_B };
enum EnumA do_something(void) {
    return E_B;
}
</code></pre></div></div>

<ol>
  <li>What about enums being used as combinable bits? Wont the plugin disallow them?</li>
</ol>

<p>A common pattern is using an enum to describe the allowed bits for an options value that can be ORed together. For example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>enum Flags {
    FLAG_NONE = 0,
    FLAG_READ = 1,
    FLAG_WRITE = 2,
};
enum Flags do_something(void);
enum Flags do_something(void) {
    return FLAG_WRITE | FLAG_READ;
}
</code></pre></div></div>

<p>The plugin is OK with this. clang -Weverything doesnt like this (-Wassign-enum):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>clang -std=c11 -c /tmp/test.c -Weverything
/tmp/test.c:8:12: warning: integer constant not in range of enumerated type 'enum Flags' [-Wassign-enum]
    return FLAG_WRITE | FLAG_READ;
           ^
1 warning generated.
</code></pre></div></div>

<table>
  <tbody>
    <tr>
      <td>Thats a false error (if you use</td>
      <td>with a runtime variable,<code class="language-plaintext highlighter-rouge">-Wassign-enum</code>seems to not flag this). However, the plugin does catch errors of putting an invalid value in the OR expression:</td>
    </tr>
  </tbody>
</table>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
return FLAG_WRITE | 5;
</code></pre></div></div>

<p>Now clang -Weverything doesnt complain (despite the possible bug).</p>

<p>Running with the plugin gives:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/tmp/test.c:10:16: error: enum conversion to or from enum Flags
        return FLAG_WRITE | 5;
</code></pre></div></div>

<ol>
  <li>Im afraid to use this in production.</li>
</ol>

<p>The plugin only analyzes the AST produced by clang, and does not affect the emitted code in any way.</p>

<ol>
  <li>I dont use clang! Can I benefit from this plugin?</li>
</ol>

<p>At<a href="http://elastifile.com/">elastifile</a>, the plugin is being used as part of the CI process. Code that is being merged into master must pass the plugins checks (as well as other plugins from this suite). The actual production executable is built by gcc (for various unrelated reasons).</p>

<p>The plugin is available as part of the <a href="https://github.com/sinelaw/elfs-clang-plugins">elfs-clang-plugins suite github.</a></p>

<h2 id="appendix-for-language-lawyers"><a href="https://github.com/sinelaw/elfs-clang-plugins/blob/docs/enums_conversion/README.md#appendix-for-language-lawyers"></a>Appendix: For Language Lawyers</h2>

<p>The<a href="http://www.open-std.org/jtc1/sc22/wg14/www/docs/n1570.pdf">C11 standard (draft)</a>says:</p>

<blockquote>
  <p>An enumeration comprises a set of named integer constant values. Each distinct enumeration constitutes a different enumerated type. The type char, the signed and unsigned integer types, and the enumerated types are collectively called integer types</p>
</blockquote>]]></content><author><name></name></author><summary type="html"><![CDATA[The C programming language generally treats enums as integers (see Appendix: For Language Lawyers for reference).]]></summary></entry><entry><title type="html">Safer C programming</title><link href="/blog/2017/08/11/safer-c-programming.html" rel="alternate" type="text/html" title="Safer C programming" /><published>2017-08-11T00:00:00+03:00</published><updated>2017-08-11T00:00:00+03:00</updated><id>/blog/2017/08/11/safer-c-programming</id><content type="html" xml:base="/blog/2017/08/11/safer-c-programming.html"><![CDATA[<p>TL;DR - check out <a href="https://github.com/sinelaw/elfs-clang-plugins">elfs-clang-plugins, cool plugins for clang</a> made at <a href="https://www.elastifile.com/">elastifile</a>.</p>

<p>Have you ever made the mistake of returning a bool instead of an enum?</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>enum Result do_something(void) {
    ...
    return true;
}
</code></pre></div></div>

<p>In C thats valid (in C++ you can use class enum to avoid it, but if you didnt youd have the same problem).</p>

<p>No compiler that I know of warns about this C code. One of our newly-open-sourced clang plugins, flags this (and many other) enum-related mistakes:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>clang -Xclang -load -Xclang ./clang_plugins.so \
      -Xclang -add-plugin -Xclang enums_conversion \
      -c /tmp/test.c
/tmp/test.c:7:12: error: enum conversion to or from enum Result
    return true;
           ^
1 error generated.
</code></pre></div></div>

<p>The package includes:</p>

<ul>
  <li>enums_conversion: Finds implicit casts to/from enums and integral types</li>
  <li>include_cleaner: Finds unused #includes</li>
  <li>large_assignment: Finds large copies in assignments and initializations (size is configurable)</li>
  <li>private: Prevents access to fields of structs that are defined in private.h files</li>
</ul>

<p>More information at https://github.com/sinelaw/elfs-clang-plugins</p>

<p>Because C is not so safe.</p>]]></content><author><name></name></author><summary type="html"><![CDATA[TL;DR - check out elfs-clang-plugins, cool plugins for clang made at elastifile.]]></summary></entry><entry><title type="html">Const when you need it</title><link href="/blog/2015/10/01/const-when-you-need-it.html" rel="alternate" type="text/html" title="Const when you need it" /><published>2015-10-01T00:00:00+03:00</published><updated>2015-10-01T00:00:00+03:00</updated><id>/blog/2015/10/01/const-when-you-need-it</id><content type="html" xml:base="/blog/2015/10/01/const-when-you-need-it.html"><![CDATA[<p><em>infernu uses row-type polymorphism to propagate read/write capabilities on record fields. Using row-type polymorphism to describe more than just which fields are present bears a vague resemblance to polymorphic constraints.</em></p>

<p>In C, a pointer to a field in a const struct is automatically consted:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>struct foo { int field; };

void useInt(const int *);

int main(void) {

    const struct foo x;

    useInt(&amp;x.field); // no warnings because &amp;x.field is 'const int *'

    return 0;
}

</code></pre></div></div>

<p>Thus, a function that extracts a pointer to a (possibly deep) field from a const struct, will also return a const pointer:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const int *getField(const struct foo *x) {

    return &amp;x-&gt;field;

}

</code></pre></div></div>

<p>(All the code compiles with `-Wall` and `-Wextra`)</p>

<p>But, what if I want to use `getField` on a non-const struct, to get an accessor to a field within it? Almost works:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>struct foo y;
int *bla = getField(&amp;y);
*bla = 2;

</code></pre></div></div>

<p>Uh oh. We get a warning:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>warning: initialization discards const qualifier 
from pointer target type [enabled by default]
     int *bla = getField(&amp;y);
                ^

</code></pre></div></div>

<p>The compiler is angry because `int *bla` should be `<strong>const</strong> int *bla`. But we dont want that! We just want to get an accessor - a writable accessor - to a field in our not-const struct value.</p>

<p>C++ (not C) does have a non-solution: <a href="http://en.cppreference.com/w/cpp/language/const_cast">const_cast</a>. That isnt what we want: its unsafe. What we want is, if a <strong>function doesnt get a const struct</strong>, the non-constness should propagate to the field accessor being returned (and vice versa: if the given struct was const, so should the accessor).</p>

<p>In fancier words, we need <strong>const polymorphism</strong>, which I imagine would be written with a constness type variable <code class="language-plaintext highlighter-rouge">C</code> like this made-up syntax:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const&lt;C&gt; int *getField(const&lt;C&gt; struct foo *x) {
    return &amp;x-&gt;field;
}

</code></pre></div></div>

<p>And then we would expect this to compile with no problems:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    struct foo y;
    int *bla = getField(&amp;y);

</code></pre></div></div>

<p>because, as y is not const, ergo the pointer returned from getField is not pointing at a const.</p>

<p>Unfortunately, no such thing. We could represent this in a type system in a number of ways. One simple way is to say that constness is a constraint on a type (using something like Haskells type classes). Another way is to have write into a field be a kind of a capability thats part of the type.</p>

<p>The latter, write-capability approach is what I use in <a href="http://sinelaw.github.io/infernu.org/s/">Infernu</a>. Here there are no structs (its JavaScript) but there are polymorphic records. The type system includes two flavors for each field label: Get and Set. If a field is only being read, the record (or object or row) that contains it only needs to have the Get accessor for that field. Heres infernus output for a simple example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//  obj :  { subObj:  { val: Number } }
var obj = { subObj: { val: 3 } };

</code></pre></div></div>

<p>Our object is simple. The comment is what infernu infers, a reasonably simple type.</p>

<p>In the notation I (shamelessly) invented, read-only fields have a prefix get in the type, and read/write fields dont have any prefix. So a read-only field bla would be: <code class="language-plaintext highlighter-rouge">{ get bla : t }</code>. If bla is required to be writable, the type is written as <code class="language-plaintext highlighter-rouge">{ bla : t }</code>. So in the above obj example, we see that literal objects are by default inferred to be writable (type annotations would allow you to control that).</p>

<p>Next lets make a function that only reads subObj:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//       readSubObj : ( { get subObj: h | g} -&gt; h)
function readSubObj(x) { return x.subObj; }

</code></pre></div></div>

<p>The type inferred says readSubObj is a function, that takes an object with a <strong>readable field subObj</strong>, (hence get subObj: it doesnt require the Set capability!). subObj has any type h, and the function returns that same type, h. (By the way, that <code class="language-plaintext highlighter-rouge">| g</code> means the passed object is allowed to contain also other fields, we dont care.)</p>

<p>Example of a nested read:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//       readVal : ( { get subObj:  { get val: d | c} | b} -&gt; d)
function readVal(x) { return x.subObj.val; }

</code></pre></div></div>

<p>Now we need to get subObj but subObj itself is an object with a readable field val of type d. The function returns a d.</p>

<p>We can use readSubObj on a writable object with no problems:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//  sub :  { val: Number }
var sub = readSubObj(obj);

</code></pre></div></div>

<p>When infernu supports type annotations (eventually) one could take advantage of this type-system feature by marking certain fields get.</p>

<p>While this isnt exactly the same as the problem we discussed with C const pointers, the same idea <em>could</em> be used to implement polymorphic constness.</p>

<p>The main idea here is that ideas from row-type polymorphism can be used to implement a certain kind of capabilities over types, constraints that are propagated. This may be a nicer way to implement (some kind of) <a href="http://stackoverflow.com/questions/12718268/polymorphic-constraint">polymorphic constraints</a>.</p>

<p>(For example, in a language that supports row extension/reduction, a function <code class="language-plaintext highlighter-rouge">{ x : Int | r } -&gt; { | r }</code> would retain the unspecified constraints from r. Im sure there are more interesting examples.)</p>

<p>If you can refer me to something like this, please do!</p>]]></content><author><name></name></author><category term="haskell" /><category term="infernu" /><category term="javascript" /><summary type="html"><![CDATA[infernu uses row-type polymorphism to propagate read/write capabilities on record fields. Using row-type polymorphism to describe more than just which fields are present bears a vague resemblance to polymorphic constraints.]]></summary></entry><entry><title type="html">Two implementations of DHM type inference</title><link href="/blog/2015/09/24/two-implementations-of-dhm-type-inference.html" rel="alternate" type="text/html" title="Two implementations of DHM type inference" /><published>2015-09-24T00:00:00+03:00</published><updated>2015-09-24T00:00:00+03:00</updated><id>/blog/2015/09/24/two-implementations-of-dhm-type-inference</id><content type="html" xml:base="/blog/2015/09/24/two-implementations-of-dhm-type-inference.html"><![CDATA[<p>Here are two simple implementations of Damas-Hindley-Milner type inference.</p>

<p>First, is <a href="https://github.com/sinelaw/fresh/blob/levels-lazy/Main.hs">my Haskell version of a region-based optimized type checker</a> as explained by Oleg Kiselyov, in his <a href="http://okmij.org/ftp/ML/generalization.html">excellent review of the optimizations to generalization used in OCaml</a>. Oleg gives <a href="http://okmij.org/ftp/ML/generalization/sound_lazy.ml">an SML implementation</a>, which Ive Haskellized rather mechanically (using ST instead of mutable references, etc.) The result is a bit ugly, but it does include all the optimizations explained by Oleg above (both lambda-depth / region / level fast generalization and instantiation, plus path compression on linked variables, and not doing expensive occurs checks by delaying them to whenever we traverse the types anyway).</p>

<p>Second, heres my <a href="https://github.com/sinelaw/fresh/blob/unification-fd/Main.hs">much shorter and more elegant implementation</a> using the neat <a href="https://hackage.haskell.org/package/unification-fd">unification-fd package</a> by Wren Romano. Its less optimized though - currently Im not doing regions or other optimizations. Im not entirely satisfied with how it looks: Im guessing this isnt how the author of unification-fd intended generalization to be implemented, but it works. Generalization does the expensive lookup of free metavariables in the type environment. Also the instantiate function is a bit clunky. The unification-fd package itself is doing inexpensive occurs checks as above, and path compression, but doesnt provide an easy way to keep track of lambda-depth so I skipped that part. Perhaps the Variable class should include a parameterized payload per variable, which could be used for (among other things) keeping track of lambda-depth.</p>]]></content><author><name></name></author><category term="haskell" /><summary type="html"><![CDATA[Here are two simple implementations of Damas-Hindley-Milner type inference.]]></summary></entry><entry><title type="html">In Python, dont initialize local variables unnecessarily</title><link href="/blog/2015/06/23/in-python-dont-initialize-local-variables-unnecessarily.html" rel="alternate" type="text/html" title="In Python, dont initialize local variables unnecessarily" /><published>2015-06-23T00:00:00+03:00</published><updated>2015-06-23T00:00:00+03:00</updated><id>/blog/2015/06/23/in-python-dont-initialize-local-variables-unnecessarily</id><content type="html" xml:base="/blog/2015/06/23/in-python-dont-initialize-local-variables-unnecessarily.html"><![CDATA[<p>A common pattern:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def foo():
    x = some value # but do we need this? (short answer: no)
    if something:
        # ... do stuff ...
        x = 'bla'
    else:
        x = 'blo'

</code></pre></div></div>

<p>The variable <code class="language-plaintext highlighter-rouge">x</code> is being initialized before the if/else, but the intention of the programmer is that its value will actually be determined by the if/else itself. If somebody later comes around and mistakenly removes one of the assignments (inside if or else), no runtime error will occur and <code class="language-plaintext highlighter-rouge">x</code> will remain initialized to a probably wrong value.</p>

<p><strong>Leaving out the initialization is better</strong> - in that case, forgetting to set <code class="language-plaintext highlighter-rouge">x</code> in one of the branches will cause an <code class="language-plaintext highlighter-rouge">UnboundLocalError</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt;&gt;&gt; def foo():
...     if False:
...         x = 0
...     return x
... 
&gt;&gt;&gt; foo()
Traceback (most recent call last):
  File "", line 1, in 
  File "", line 4, in foo
UnboundLocalError: local variable 'x' referenced before assignment

</code></pre></div></div>

<p>Errors are good! (when they flag buggy code)</p>

<p>Now, what if we <strong>also</strong> have an <code class="language-plaintext highlighter-rouge">x</code> declared in the global scope? Because of <a href="http://www.python-course.eu/python3_global_vs_local_variables.php">how Python handles variable scope</a>, the error will still happen (which is good).</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt;&gt;&gt; x = 1
&gt;&gt;&gt; def foo():
...     if False:
...         x = 0
...     return x
... 
&gt;&gt;&gt; foo()
Traceback (most recent call last):
..
UnboundLocalError: local variable 'x' referenced before assignment

</code></pre></div></div>

<p><strong>Summary</strong>: In Python, dont initialize variables until you know what value to assign to them.</p>]]></content><author><name></name></author><summary type="html"><![CDATA[A common pattern:]]></summary></entry><entry><title type="html">Beware of var in for loops, JS programmers</title><link href="/blog/javascript/2015/06/15/beware-of-var-in-for-loops-js-programmers.html" rel="alternate" type="text/html" title="Beware of var in for loops, JS programmers" /><published>2015-06-15T00:00:00+03:00</published><updated>2015-06-15T00:00:00+03:00</updated><id>/blog/javascript/2015/06/15/beware-of-var-in-for-loops-js-programmers</id><content type="html" xml:base="/blog/javascript/2015/06/15/beware-of-var-in-for-loops-js-programmers.html"><![CDATA[<p>Time and time again, I see people using var in the initialization part of a for loop. Example from <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/for">MDN (Mozilla Developer Network)</a>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for (var i = 0; i &lt; 9; i++) {
   console.log(i);
   // more statements
}

</code></pre></div></div>

<p>Whats wrong with <code class="language-plaintext highlighter-rouge">var i = 0</code> above? The problem is that <strong>variables declared in a for initialization have function scope</strong>, just like any <code class="language-plaintext highlighter-rouge">var</code> declaration does. In other words, they affect the scope of the entire function. Consider the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>function outer() {
    var x = 'outer';
    function inner() {
        x = 'inner';
        //
        // ... lots o' code
        //
        for (var x = 0; x &lt; 1; x++) {
            // in for
        }
    }
    inner();
}

</code></pre></div></div>

<p>In the inner function, <code class="language-plaintext highlighter-rouge">x</code> shadows the outer variable <strong>throughout</strong>, not just inside the for loop. So also the initial statement <code class="language-plaintext highlighter-rouge">x = 'inner'</code> at the head of inner affects only the locally scoped variable.</p>

<p>This is a classic example of <strong><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/var#var_hoisting">var hoisting</a></strong>, which should qualify as one of JavaScripts <a href="http://archive.oreilly.com/pub/a/javascript/excerpts/javascript-good-parts/awful-parts.html">awful parts</a>.</p>

<p><strong>Dont do it!</strong> Move all your var statements to the head of each function, please.</p>]]></content><author><name></name></author><category term="javascript" /><summary type="html"><![CDATA[Time and time again, I see people using var in the initialization part of a for loop. Example from MDN (Mozilla Developer Network):]]></summary></entry><entry><title type="html">A simple problem with recursive types and subtyping</title><link href="/blog/2015/06/02/a-simple-problem-with-recursive-types-and-subtyping.html" rel="alternate" type="text/html" title="A simple problem with recursive types and subtyping" /><published>2015-06-02T00:00:00+03:00</published><updated>2015-06-02T00:00:00+03:00</updated><id>/blog/2015/06/02/a-simple-problem-with-recursive-types-and-subtyping</id><content type="html" xml:base="/blog/2015/06/02/a-simple-problem-with-recursive-types-and-subtyping.html"><![CDATA[<p>Heres a simple example of recursive types interacting badly with subtyping: <code class="language-plaintext highlighter-rouge">T={ foo: T -&gt; A} U={ foo: U -&gt; B}</code> Consider <code class="language-plaintext highlighter-rouge">T &lt;: U</code>, therefore <code class="language-plaintext highlighter-rouge">(T -&gt; A) &lt;: (U -&gt; B)</code> Which implies: <code class="language-plaintext highlighter-rouge">U &lt;: T</code> So <code class="language-plaintext highlighter-rouge">T &lt;: U</code> but also <code class="language-plaintext highlighter-rouge">U &lt;: T</code>, which is true iff <code class="language-plaintext highlighter-rouge">A &lt;: B</code> and <code class="language-plaintext highlighter-rouge">B &lt;: A</code>.</p>

<p>In my case, the subtyping relation is polymorphic subsumption:<code class="language-plaintext highlighter-rouge">T</code> is subsumed by <code class="language-plaintext highlighter-rouge">U</code> iff <code class="language-plaintext highlighter-rouge">U</code> is more polymorphic, intuitively, it can be instantiated to all types that <code class="language-plaintext highlighter-rouge">T</code> can.</p>

<p>This situation arises in rather simple code, involving polymorphic vs. non-polymorphic row fields. For example, <code class="language-plaintext highlighter-rouge">A</code> is a row with a polymorphic method, whereas <code class="language-plaintext highlighter-rouge">B</code> is a row with a monomorphic (but compatible) method, such as: <code class="language-plaintext highlighter-rouge">A = { method: forall a. a -&gt; () } B = { method: String -&gt; () }</code> In this case subsumption (the form of subtyping in play) fails.</p>

<p>One way around this is to avoid subsumption issues altogether by keeping things rank-1, and not using higher-rank row fields. Unfortunately, throwing away polymorphic methods is very bad: consider a non-polymorphic <code class="language-plaintext highlighter-rouge">array.map</code> (in JS).</p>

<p>A slightly better workaround is to push the foralls all the way out, keeping all types (including row types) rank-1. Every time an object method is accessed via the property syntax <code class="language-plaintext highlighter-rouge">obj.method</code>, we end up instantiating the objects row type, and get a fresh type for the method. We get practically polymorphic methods. Thats the approach Im investigating for <strong><a href="https://github.com/sinelaw/infernu">infernu</a></strong>.</p>]]></content><author><name></name></author><category term="infernu" /><summary type="html"><![CDATA[Heres a simple example of recursive types interacting badly with subtyping: T={ foo: T -&gt; A} U={ foo: U -&gt; B} Consider T &lt;: U, therefore (T -&gt; A) &lt;: (U -&gt; B) Which implies: U &lt;: T So T &lt;: U but also U &lt;: T, which is true iff A &lt;: B and B &lt;: A.]]></summary></entry><entry><title type="html">infernu news</title><link href="/blog/2015/06/02/infernu-news.html" rel="alternate" type="text/html" title="infernu news" /><published>2015-06-02T00:00:00+03:00</published><updated>2015-06-02T00:00:00+03:00</updated><id>/blog/2015/06/02/infernu-news</id><content type="html" xml:base="/blog/2015/06/02/infernu-news.html"><![CDATA[<p>In the past month, most of the work on <a href="https://github.com/sinelaw/infernu">infernu</a> was to stabilize the type system, making decisions about some trade-offs. Heres a short summary:</p>

<ul>
  <li><strong>Colors!</strong> I refactored all the pretty printing code to use the ansi-wl-pprint package, which fixes indentation and formatting issues and also adds ansi colors to the output. One neat thing is that identical type variables have the same color: <a href="https://noamlewis.wordpress.com/wp-content/uploads/2015/06/infernu-colors.png"><img src="images/infernu-colors.png" alt="infernu-colors" /></a></li>
  <li>Changed the way constructor functions are treated. Until now, constructor functions were treated at definition site as regular functions. The difference between constructors and non-constructors only happened at new calls, where the expected this value was forced to be a closed row type. Unfortunately this breaks if you call new Foo() inside the definition of Foo. To avoid this issue, functions with uppercase names are now treated specially and the this row-type is forced to be closed when the function name is added to the environment. This allows maximum flexibility while defining Foo, while ensuring Foos type is closed outside the constructor to prevent junk code like <code class="language-plaintext highlighter-rouge">var x = new Foo(); x.myWrongProperty = 2;</code></li>
  <li>Explored the idea of Maybe (or optional) types, including having common JS APIs use them for stronger safety. For example, array access should return a Maybe value. Unfortunately, since there is no syntax to construct a Maybe-typed value (no Just), all values can be implicitly upgradeed to Maybe. In other words, there is an ambiguity that break type inference. So for now, not implementing Maybe types (perhaps with explicit annotations they can come back).</li>
  <li>Decided to disable generalization of row fields (object properties). This decision means that user-defined objects will by default <strong>not have polymorphic methods</strong>, although the object itself could be polymorphic (and thus different occurrences of the object in the program syntax, will allow instantiation to different types). The reason for this decision is that overly-polymorphic fields cause unexpected type errors, such as when passing objects that contain them as parameters to functions (contravariance can surprise you).</li>
  <li>Started a document sketching out denotational semantics of JS, <strong>as infernu decides these should be</strong>, which helped clarify a few issues in the JS -&gt; LC translator. The next step is to change all translations to preserve semantics, currently they only preserve types.</li>
  <li>Bug fixes: polymorphic subsumption checking, unification of recursive types.</li>
  <li>Increased compatibility: now using base-compat and a custom prelude to increase compatibility with different GHC versions (thanks to RyanGlScott for submitting a fix to use base-orphans which prompted me to do this).</li>
</ul>]]></content><author><name></name></author><category term="infernu" /><summary type="html"><![CDATA[In the past month, most of the work on infernu was to stabilize the type system, making decisions about some trade-offs. Heres a short summary:]]></summary></entry><entry><title type="html">Identity Crisis</title><link href="/blog/haskell/javascript/2015/04/15/543.html" rel="alternate" type="text/html" title="Identity Crisis" /><published>2015-04-15T00:00:00+03:00</published><updated>2015-04-15T00:00:00+03:00</updated><id>/blog/haskell/javascript/2015/04/15/543</id><content type="html" xml:base="/blog/haskell/javascript/2015/04/15/543.html"><![CDATA[<p>Compared to other tools adding static types to JavaScript, <a href="https://github.com/sinelaw/infernu">Infernus</a> main strengths are <strong>full type inference</strong> and <strong>strong type safety</strong>. Here are a few examples.</p>

<h1 id="identity-function">Identity Function</h1>

<p>Here is the simplest possible function:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>function id(x) {
  return x;
}
</code></pre></div></div>

<h2 id="typescript">TypeScript</h2>

<p><a href="http://www.typescriptlang.org">TypeScript</a>s compiler <code class="language-plaintext highlighter-rouge">tsc</code> can generate a <code class="language-plaintext highlighter-rouge">.d.ts</code> from that:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>declare function id(x: any): any;
</code></pre></div></div>

<p>Thats no good! We can pass <code class="language-plaintext highlighter-rouge">any</code> type we want to our function, but the return type is not tied to the argument type - it is treated as anything, basically untyped. So we can do this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var n = 'hi'; n = id(5);
</code></pre></div></div>

<p>And TypeScript will output the following <code class="language-plaintext highlighter-rouge">.d.ts</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>declare var n: string;
</code></pre></div></div>

<p>That seems wrong: n is assigned a number via <code class="language-plaintext highlighter-rouge">id(5)</code>. But wait - there is a way to turn off inference of <code class="language-plaintext highlighter-rouge">any</code> types (with <code class="language-plaintext highlighter-rouge">--noImplicitAny</code>). If we try that on our identity function, we get:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>id.ts(1,13): error TS7006: Parameter 'x' implicitly has an 'any' type.
</code></pre></div></div>

<h3 id="explicit-generics">Explicit Generics</h3>

<p>Oops. Ok, but TypeScript has generics! Lets try <em>that</em>: the <a href="http://www.typescriptlang.org/Handbook#generics-hello-world-of-generics">TypeScript handbook</a> gives exactly the example we need - we just <strong>write the type out explicitly</strong>, like so:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>function identity&lt;T&gt;(arg: T): T {
    return arg;
}
</code></pre></div></div>

<p>Great! We got what we needed, but without type inference.</p>

<h2 id="flow">Flow</h2>

<p>Facebooks <a href="http://flowtype.org/">Flow</a> has a type system thats (slightly?) different from TypeScripts, and apparently works differently. Lets try it. We can use the <code class="language-plaintext highlighter-rouge">flow suggest</code> command to get suggested typing (Im using version 0.7). Heres what we get for a single file containing only the identity function above: nothing. It doesnt suggest any type. Ok, lets try using our <code class="language-plaintext highlighter-rouge">id</code> in a way that makes no sense, to induce an error (after all, type checkers are used to find errors). Heres <code class="language-plaintext highlighter-rouge">bad_id.js</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/* @flow */
function id(x) { return x;}
var n = 'hi'; n = id(5);
var z = n; // added so we can see what flow says the type of n is here.

</code></pre></div></div>

<p>(Note: The <code class="language-plaintext highlighter-rouge">/* @flow */</code> header is used to tell flow that it should look at this file.) Run <code class="language-plaintext highlighter-rouge">flow suggest bad_id.js</code> and you get a diff-style output. Ive applied it to make it easier to read - heres what flow suggests:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>function id(x: number) : number{ return x;}
var n: string | number = 'hi'; n = id(5);
var z: number = n;

</code></pre></div></div>

<p>Interesting! We managed to get something without reverting to explicit type annotations. But we didnt get an error!</p>

<p>First, <code class="language-plaintext highlighter-rouge">id</code> was inferred to take and return <code class="language-plaintext highlighter-rouge">number</code>, apparently because thats the only way weve used it. It would be interesting to see what happens when we use <code class="language-plaintext highlighter-rouge">id</code> several times with different types - well try that soon.</p>

<p>Second, <code class="language-plaintext highlighter-rouge">n</code> was given a union type <code class="language-plaintext highlighter-rouge">string | number</code>, because it takes on both types during its lifetime. It may be a matter of taste, but <strong>I would rather not have the type checker deduce implicit union types</strong> in this case (<code class="language-plaintext highlighter-rouge">n = 'hi'; n = 5;</code>) - instead I would expect that to be an error.</p>

<p>The unique (and impressive) part is that flow is able to tell that <code class="language-plaintext highlighter-rouge">z</code> is only ever going to have <code class="language-plaintext highlighter-rouge">number</code> values, and so its safe to assign it that type. Thats probably a result of the flow analysis they do.</p>

<p>Now lets try calling <code class="language-plaintext highlighter-rouge">id</code> several times, with different types:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/* @flow */
function id(x) { return x;}
id(5); id('hi');

</code></pre></div></div>

<p>Flow suggests:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>function id(x: string | number) : string | number{ return x;}
</code></pre></div></div>

<p>Uh oh - does this means the argument and result types are no longer tied to each other? If I pass in a number, will the compiler check that I use the result only as a number (and not as a string)? Lets try using it, doing <code class="language-plaintext highlighter-rouge">var n = id(5)</code>, flow suggests:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var n: string | number = id(5);

</code></pre></div></div>

<p>Despite <code class="language-plaintext highlighter-rouge">n</code> only ever being assigned a number, it now has type <code class="language-plaintext highlighter-rouge">string | number</code>. So apparently, <strong>union types propagate implicitly</strong>, infecting everything on the way.</p>

<h3 id="explicit-generics-1">Explicit Generics</h3>

<p>Fortunately, flow too has generics, and again <a href="http://flowtype.org/docs/functions.html#_">straight out of the manual</a> we find:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/* @flow */
function foo(x: X): X { return x; }

</code></pre></div></div>

<p>Great! We got what we needed, but without type inference.</p>

<h1 id="infernu">Infernu</h1>

<p>Lets get down to business. Infernu says:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//       id : a.(b -&gt; b)
function id(x) { return x; }

</code></pre></div></div>

<p>Cool! Without any help from us, Infernu figured out the <a href="https://en.wikipedia.org/wiki/Principal_type">most generic type</a>. Take a type <code class="language-plaintext highlighter-rouge">b</code>, return the same type <code class="language-plaintext highlighter-rouge">b</code>. The magic of polymo<strong>Wait,</strong> whats that <code class="language-plaintext highlighter-rouge">a.</code> thing?</p>

<p>Well, JavaScript has this nice keyword called <code class="language-plaintext highlighter-rouge">this</code> which is <em>dynamically scoped</em>, meaning that <code class="language-plaintext highlighter-rouge">this</code> is bound to different things <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/this">depending on <strong>how your function is invoked</strong> and not on how its defined</a>. For example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var obj = { hat: { type: 'top' }, getHatType: function() { return this.hat.type; } };
obj.getHatType(); // ok.
var f = obj.getHatType;
f(); // oops! TypeError: Cannot read property 'type' of undefined

</code></pre></div></div>

<p>Nasty stuff. Every JavaScript programmer should know <code class="language-plaintext highlighter-rouge">this</code>.</p>

<p>Fortunately, Infernu is here to save you. It infers not only what arguments and return types a function has, but also what <code class="language-plaintext highlighter-rouge">this</code> must be for the function call to work, and verifies that you use it correctly.</p>

<p>Infernu type signatures for functions have the following format (subject to change without notice, bla bla bla):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>this.(arguments -&gt; result)
</code></pre></div></div>

<p>So for our <code class="language-plaintext highlighter-rouge">var f = obj.getHatType</code> example, Infernu says:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//  f : {hat: {type: d, ..f}, ..e}.(() -&gt; d)
var f = obj.getHatType;

</code></pre></div></div>

<p>Decomposing that type signature, we read that <code class="language-plaintext highlighter-rouge">this</code> is expected to be an object containing <em>at least</em> a property called hat which is an object with <em>at least</em> a property called type of some type <code class="language-plaintext highlighter-rouge">d</code>. The function takes no arguments (hence the empty <code class="language-plaintext highlighter-rouge">()</code>) and returns the same type <code class="language-plaintext highlighter-rouge">d</code> that was taken from the hat.type property of <code class="language-plaintext highlighter-rouge">this</code>. (The ellipsis stuff <code class="language-plaintext highlighter-rouge">..f</code> and <code class="language-plaintext highlighter-rouge">..e</code> is due to row-type polymorphism, which will be elaborated upon in a future blog post.)</p>

<p>Back to our identity function, we examine the signature again: <code class="language-plaintext highlighter-rouge">a.(b -&gt; b)</code> - the type of <code class="language-plaintext highlighter-rouge">this</code> is given an unconstrained type parameter <code class="language-plaintext highlighter-rouge">a</code> - so Infernu is telling us explicitly that <strong><code class="language-plaintext highlighter-rouge">this</code> is allowed to be anything</strong> for our identity function. Yippy!</p>

<h1 id="summary">Summary</h1>

<p>We saw that both TypeScript and Flow (and Google Closure too, which I havent shown) support generics that can express the identity function properly. They also offer weak forms of type inference that sometimes yields weakly-typed results. Infernu, on the other hand, will infer generic types automatically, and prefers to fail over giving weak typings.</p>

<p>There are many known discussions about subtyping (inheritance)-based type systems, represented here by TypeScript and Flow, vs. parametric polymorphism (being Infernu in this case). There are known pros and cons to both sides: but one important result is that type inference is <strong>just easier</strong> when there is no subtyping involved.</p>

<p>Infernu is designed to take advantage of that.</p>]]></content><author><name></name></author><category term="haskell" /><category term="javascript" /><category term="infernu" /><summary type="html"><![CDATA[Compared to other tools adding static types to JavaScript, Infernus main strengths are full type inference and strong type safety. Here are a few examples.]]></summary></entry><entry><title type="html">The wl-pprint package maintainer</title><link href="/blog/2015/04/14/the-wl-pprint-package-maintainer.html" rel="alternate" type="text/html" title="The wl-pprint package maintainer" /><published>2015-04-14T00:00:00+03:00</published><updated>2015-04-14T00:00:00+03:00</updated><id>/blog/2015/04/14/the-wl-pprint-package-maintainer</id><content type="html" xml:base="/blog/2015/04/14/the-wl-pprint-package-maintainer.html"><![CDATA[<p>is now me.</p>

<p>Ive talked to the previous maintainer who is no longer interested. There was a small change required to support the new ghc (7.10), so I also released a new version. Since the new version only benefits people who need a new ghc, I also added the <strong>source-repository</strong> field in the cabal file, despite it breaking cabals older than 1.6.</p>

<p>According to hackage, <a href="https://hackage.haskell.org/package/wl-pprint">wl-pprint</a> was authored by<a href="http://research.microsoft.com/en-us/people/daan/">Daan Leijen</a>. The new github repo is up at <a href="https://github.com/sinelaw/wl-pprint">https://github.com/sinelaw/wl-pprint</a>. Ive taken the liberty of forking based on someone elses patch for GHC 7.10 - thank you <a href="https://github.com/alexlegg">Alex Legg</a>!</p>

<p>Incidentally, on hackage, there are several packages with the substring wl-pprint in their names, some are newer and better maintained and have more features than others. This situation is rather confusing. wl-pprint itself is being used as a dependency by at least one package I need (language-ecmascript).</p>

<p>It would be nice if the community converged on a singleWadler-pretty-printer package. (Probably not wl-pprint - maybe <a href="https://hackage.haskell.org/package/ansi-wl-pprint">ansi-wl-pprint</a>?)</p>]]></content><author><name></name></author><summary type="html"><![CDATA[is now me.]]></summary></entry></feed>