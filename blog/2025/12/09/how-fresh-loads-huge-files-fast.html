<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>How Fresh Loads Huge Files Fast - Noam Lewis</title>
  <link rel="stylesheet" href="/blog/assets/blog.css">
  <link rel="alternate" type="application/atom+xml" title="Noam Lewis - The Blog" href="/blog/feed.xml">
</head>
<body>

<header class="site-header">
  <div class="wrapper">
    <a class="site-title" href="/blog/">Noam Lewis - The Blog</a>
    <nav class="site-nav">
      <a class="page-link" href="/blog/about/">About</a>
    </nav>
  </div>
</header>

<main class="wrapper">
  <article>
    <p class="post-meta" style="color: var(--color-text-light); margin-bottom: 30px;">December 9, 2025</p>
<h1 id="how-fresh-loads-huge-files-fast">How Fresh Loads Huge Files Fast</h1>
<p>Fresh uses a <strong>piece tree</strong> (also called a piece table) for text storage. The piece table originated in the early 1970s - first in <a href="https://www.computerhistory.org/collections/catalog/102740449">J. Strother Moore and Bob Boyer's "77-Editor" at Edinburgh</a> (1971-1973), where they applied structure-sharing techniques from their theorem proving research to text editing. Moore later brought the idea to Xerox PARC, where Charles Simonyi adopted it for the <a href="https://en.wikipedia.org/wiki/Bravo_(editor)">Bravo editor</a> (1974). Simonyi later <a href="https://www.tiny.cloud/blog/wysiwyg-development-history/">brought it to Microsoft Word</a> (1983). The design minimizes memory copying by never modifying original file content - critical for early systems with limited RAM. <a href="https://code.visualstudio.com/blogs/2018/03/23/text-buffer-reimplementation">VS Code adopted piece tables in 2018</a>, replacing their previous line-array implementation.</p>
<p><a href="https://sinelaw.github.io/fresh/">Fresh</a>'s implementation adds immutable nodes (for concurrency and cheap snapshots) and lazy loading (for large files). (<a href="https://github.com/sinelaw/fresh">GitHub</a>)</p>
<h2 id="the-core-idea">The Core Idea</h2>
<p>Instead of storing text in the tree, store <strong>pointers</strong> to text that lives elsewhere.</p>
<h3 id="rope-helix-zed">Rope (<a href="https://github.com/helix-editor/helix/blob/master/docs/architecture.md">Helix</a>, <a href="https://zed.dev/blog/zed-decoded-rope-sumtree">Zed</a>)</h3>
<p>Text lives inside tree nodes:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 360.703125 160" style="max-width: 360.703px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_L_0" d="M132.395,55L123.918,59.167C115.44,63.333,98.486,71.667,90.009,79.333C81.531,87,81.531,94,81.531,97.5L81.531,101"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_R_0" d="M228.019,55L236.496,59.167C244.974,63.333,261.928,71.667,270.406,79.333C278.883,87,278.883,94,278.883,97.5L278.883,101"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(180.20703125, 31.5)" id="flowchart-Root-0" class="node default"><rect height="47" width="156.171875" y="-23.5" x="-78.0859375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> Node</tspan></tspan></text></g></g></g><g transform="translate(81.53125, 128.5)" id="flowchart-L-2" class="node default"><rect height="47" width="147.0625" y="-23.5" x="-73.53125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Leaf:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> '</tspan></tspan></text></g></g></g><g transform="translate(278.8828125, 128.5)" id="flowchart-R-4" class="node default"><rect height="47" width="147.640625" y="-23.5" x="-73.8203125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Leaf:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'World'</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<h3 id="piece-tree-fresh">Piece Tree (Fresh)</h3>
<p>Tree nodes point to separate buffers:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 644.46875 374.6000061035156" style="max-width: 644.469px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="97" width="475.8203125" y="269.5999984741211" x="79.32421875" style=""/><g transform="translate(292.03125, 269.5999984741211)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="211.5999984741211" width="628.46875" y="8" x="8" style=""/><g transform="translate(306.03125, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_L_0" d="M248.528,80L235.46,84.167C222.391,88.333,196.254,96.667,183.186,104.333C170.117,112,170.117,119,170.117,122.5L170.117,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_Root_R_0" d="M395.941,80L409.009,84.167C422.078,88.333,448.215,96.667,461.283,104.333C474.352,112,474.352,119,474.352,122.5L474.352,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_L_B0_0" d="M170.117,194.6L170.117,198.767C170.117,202.933,170.117,211.267,170.117,219.6C170.117,227.933,170.117,236.267,170.117,244.6C170.117,252.933,170.117,261.267,182.551,269.397C194.984,277.528,219.85,285.457,232.284,289.421L244.717,293.385"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_R_B0_0" d="M474.352,194.6L474.352,198.767C474.352,202.933,474.352,211.267,474.352,219.6C474.352,227.933,474.352,236.267,474.352,244.6C474.352,252.933,474.352,261.267,461.918,269.397C449.485,277.528,424.618,285.457,412.185,289.421L399.752,293.385"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(322.234375, 56.5)" id="flowchart-Root-0" class="node default"><rect height="47" width="156.171875" y="-23.5" x="-78.0859375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> Node</tspan></tspan></text></g></g></g><g transform="translate(170.1171875, 162.29999923706055)" id="flowchart-L-2" class="node default"><rect height="64.5999984741211" width="254.234375" y="-32.29999923706055" x="-127.1171875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> offset</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> len</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">6</tspan></tspan></text></g></g></g><g transform="translate(474.3515625, 162.29999923706055)" id="flowchart-R-4" class="node default"><rect height="64.5999984741211" width="254.234375" y="-32.29999923706055" x="-127.1171875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> offset</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 6,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> len</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">5</tspan></tspan></text></g></g></g><g transform="translate(322.234375, 318.0999984741211)" id="flowchart-B0-5" class="node default"><rect height="47" width="213.171875" y="-23.5" x="-106.5859375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> World'</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>A <strong>piece</strong> is just three numbers: which buffer, starting offset, and length.</p>
<h2 id="what-happens-when-you-edit">What Happens When You Edit</h2>
<p>When you type or paste, Fresh appends to a new buffer and creates a piece pointing to it. The original buffer stays untouched.</p>
<h3 id="before-file-contains-hello-world">Before: File contains "Hello World"</h3>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 581.2890625 150.59999084472656" style="max-width: 581.289px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="134.5999984741211" width="280.953125" y="8" x="292.3359375" style=""/><g transform="translate(407.609375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="117" width="234.3359375" y="16.799999237060547" x="8" style=""/><g transform="translate(108.96484375, 16.799999237060547)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M217.336,75.3L221.503,75.3C225.669,75.3,234.003,75.3,242.336,75.3C250.669,75.3,259.003,75.3,267.336,75.3C275.669,75.3,284.003,75.3,291.669,75.3C299.336,75.3,306.336,75.3,309.836,75.3L313.336,75.3"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(125.16796875, 75.29999923706055)" id="flowchart-P1-0" class="node default"><rect height="47" width="184.3359375" y="-23.5" x="-92.16796875" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-11</tspan></tspan></text></g></g></g><g transform="translate(432.8125, 75.29999923706055)" id="flowchart-B0-1" class="node default"><rect height="64.5999984741211" width="230.953125" y="-32.29999923706055" x="-115.4765625" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (original):</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">World'</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<h3 id="after-insert-big--at-position-6">After: Insert "Big " at position 6</h3>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 581.2890625 331.3999938964844" style="max-width: 581.289px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="310.54999923706055" width="280.953125" y="12.850000381469727" x="292.3359375" style=""/><g transform="translate(407.609375, 12.850000381469727)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="315.3999996185303" width="234.3359375" y="8" x="8" style=""/><g transform="translate(108.96484375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M213.48,66.5L218.29,66.5C223.099,66.5,232.717,66.5,241.693,66.5C250.669,66.5,259.003,66.5,267.336,66.5C275.669,66.5,284.003,66.5,295.359,68.982C306.716,71.465,321.097,76.43,328.287,78.912L335.477,81.395"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P2_B1_0" d="M213.48,264.9L218.29,264.9C223.099,264.9,232.717,264.9,241.693,264.9C250.669,264.9,259.003,264.9,267.336,264.9C275.669,264.9,284.003,264.9,292.755,264.9C301.508,264.9,310.68,264.9,315.266,264.9L319.852,264.9"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P3_B0_0" d="M217.336,163.5L221.503,163.5C225.669,163.5,234.003,163.5,242.336,163.5C250.669,163.5,259.003,163.5,267.336,163.5C275.669,163.5,284.003,163.5,295.359,161.018C306.716,158.535,321.097,153.57,328.287,151.088L335.477,148.605"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(125.16796875, 66.5)" id="flowchart-P1-0" class="node default"><rect height="47" width="176.625" y="-23.5" x="-88.3125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-6</tspan></tspan></text></g></g></g><g transform="translate(125.16796875, 264.8999996185303)" id="flowchart-P2-1" class="node default"><rect height="47" width="176.625" y="-23.5" x="-88.3125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-4</tspan></tspan></text></g></g></g><g transform="translate(125.16796875, 163.5)" id="flowchart-P3-2" class="node default"><rect height="47" width="184.3359375" y="-23.5" x="-92.16796875" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 6-11</tspan></tspan></text></g></g></g><g transform="translate(432.8125, 115)" id="flowchart-B0-3" class="node default"><rect height="64.5999984741211" width="230.953125" y="-32.29999923706055" x="-115.4765625" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (original):</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Hello</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">World'</tspan></tspan></text></g></g></g><g transform="translate(432.8125, 264.8999996185303)" id="flowchart-B1-4" class="node default"><rect height="47" width="217.921875" y="-23.5" x="-108.9609375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (added):</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 'Big</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> '</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>Document now reads: "Hello Big World"</p>
<p>The original file content in Buffer 0 was never modified or copied.</p>
<h2 id="lazy-loading">Lazy Loading</h2>
<p>For large files, Fresh doesn't load the entire file into memory. Buffers can be <strong>unloaded</strong> - they store a file path and byte range instead of actual data.</p>
<p>This is actually how the original <a href="https://computerhistory.org/blog/microsoft-word-for-windows-1-1a-source-code/">Word 1.1a</a> piece table worked: pieces pointed directly to spans in the original file on disk, loading content only when needed. VS Code's 2018 implementation loads files fully into memory; Fresh returns to the original memory-conscious design.</p>
<h3 id="before-3mb-file-just-opened">Before: 3MB file just opened</h3>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 920.953125 277.6000061035156" style="max-width: 920.953px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="114.5999984741211" width="904.953125" y="155" x="8" style=""/><g transform="translate(435.2734375, 155)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="97" width="860.5" y="8" x="30.2265625" style=""/><g transform="translate(444.2734375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M165.492,80L165.492,84.167C165.492,88.333,165.492,96.667,165.492,105C165.492,113.333,165.492,121.667,165.492,130C165.492,138.333,165.492,146.667,165.492,154.333C165.492,162,165.492,169,165.492,172.5L165.492,176"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P2_B1_0" d="M460.477,80L460.477,84.167C460.477,88.333,460.477,96.667,460.477,105C460.477,113.333,460.477,121.667,460.477,130C460.477,138.333,460.477,146.667,460.477,154.333C460.477,162,460.477,169,460.477,172.5L460.477,176"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P3_B2_0" d="M755.461,80L755.461,84.167C755.461,88.333,755.461,96.667,755.461,105C755.461,113.333,755.461,121.667,755.461,130C755.461,138.333,755.461,146.667,755.461,154.333C755.461,162,755.461,169,755.461,172.5L755.461,176"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(165.4921875, 56.5)" id="flowchart-P1-0" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(460.4765625, 56.5)" id="flowchart-P2-1" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(755.4609375, 56.5)" id="flowchart-P3-2" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(165.4921875, 212.29999923706055)" id="flowchart-B0-3" class="node default"><rect height="64.5999984741211" width="244.984375" y="-32.29999923706055" x="-122.4921875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">file:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> large.txt,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(460.4765625, 212.29999923706055)" id="flowchart-B1-4" class="node default"><rect height="64.5999984741211" width="244.984375" y="-32.29999923706055" x="-122.4921875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">file:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> large.txt,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1-2MB</tspan></tspan></text></g></g></g><g transform="translate(755.4609375, 212.29999923706055)" id="flowchart-B2-5" class="node default"><rect height="64.5999984741211" width="244.984375" y="-32.29999923706055" x="-122.4921875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">file:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> large.txt,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2-3MB</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<h3 id="after-user-scrolls-to-middle">After: User scrolls to middle</h3>
<p>Fresh loads only the visible chunk from disk:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 900.5 277.6000061035156" style="max-width: 900.5px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="Buffers" class="cluster"><rect height="114.5999984741211" width="884.5" y="155" x="8" style=""/><g transform="translate(425.046875, 155)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffers</tspan></tspan></text></g></g></g><g data-look="classic" id="Tree" class="cluster"><rect height="97" width="840.046875" y="8" x="30.2265625" style=""/><g transform="translate(434.046875, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Tree</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P1_B0_0" d="M165.492,80L165.492,84.167C165.492,88.333,165.492,96.667,165.492,105C165.492,113.333,165.492,121.667,165.492,130C165.492,138.333,165.492,146.667,165.492,154.333C165.492,162,165.492,169,165.492,172.5L165.492,176"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P2_B1_0" d="M450.25,80L450.25,84.167C450.25,88.333,450.25,96.667,450.25,105C450.25,113.333,450.25,121.667,450.25,130C450.25,138.333,450.25,146.667,450.25,154.333C450.25,162,450.25,169,450.25,172.5L450.25,176"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-dotted edge-thickness-normal edge-pattern-solid flowchart-link" id="L_P3_B2_0" d="M735.008,80L735.008,84.167C735.008,88.333,735.008,96.667,735.008,105C735.008,113.333,735.008,121.667,735.008,130C735.008,138.333,735.008,146.667,735.008,154.333C735.008,162,735.008,169,735.008,172.5L735.008,176"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(165.4921875, 56.5)" id="flowchart-P1-0" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(450.25, 56.5)" id="flowchart-P2-1" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(735.0078125, 56.5)" id="flowchart-P3-2" class="node default"><rect height="47" width="200.53125" y="-23.5" x="-100.265625" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> buf</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(165.4921875, 212.29999923706055)" id="flowchart-B0-3" class="node default"><rect height="64.5999984741211" width="244.984375" y="-32.29999923706055" x="-122.4921875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">file:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> large.txt,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0-1MB</tspan></tspan></text></g></g></g><g transform="translate(450.25, 212.29999923706055)" id="flowchart-B1-4" class="node default"><rect height="64.5999984741211" width="224.53125" y="-32.29999923706055" x="-112.265625" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> LOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">actual</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> in</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> memory</tspan></tspan></text></g></g></g><g transform="translate(735.0078125, 212.29999923706055)" id="flowchart-B2-5" class="node default"><rect height="64.5999984741211" width="244.984375" y="-32.29999923706055" x="-122.4921875" style="" class="basic label-container"/><g transform="translate(0, -17.299999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Buffer</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> UNLOADED</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">file:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> large.txt,</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2-3MB</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<h2 id="zero-copy-reads">Zero-Copy Reads</h2>
<p>When reading text for display, Fresh doesn't copy bytes. It returns slices pointing directly into the buffers:</p>
<pre class="rust"><code>// Returns &amp;[u8] pointing into buffer memory
// No allocation, no copy
let text = buffer.get_text_range(100, 200);</code></pre>
<p>Multiple pieces can reference the same buffer region. Displaying the same text twice doesn't double memory usage.</p>
<h2 id="the-tree-structure">The Tree Structure</h2>
<p>The pieces are organized in a balanced binary tree for fast lookups:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 507.453125 294.20001220703125" style="max-width: 507.453px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_I2_0" d="M248.328,73.6L240.675,77.767C233.021,81.933,217.714,90.267,210.06,97.933C202.406,105.6,202.406,112.6,202.406,116.1L202.406,119.6"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_L3_0" d="M368.828,73.6L376.482,77.767C384.135,81.933,399.443,90.267,407.096,99.483C414.75,108.7,414.75,118.8,414.75,123.85L414.75,128.9"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L1_0" d="M140.153,189.2L132.244,193.367C124.336,197.533,108.52,205.867,100.611,213.533C92.703,221.2,92.703,228.2,92.703,231.7L92.703,235.2"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L2_0" d="M264.66,189.2L272.568,193.367C280.476,197.533,296.293,205.867,304.201,213.533C312.109,221.2,312.109,228.2,312.109,231.7L312.109,235.2"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(308.578125, 40.79999923706055)" id="flowchart-I1-0" class="node default"><rect height="65.5999984741211" width="164.1796875" y="-32.79999923706055" x="-82.08984375" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 100</tspan></tspan></text></g></g></g><g transform="translate(202.40625, 156.39999771118164)" id="flowchart-I2-2" class="node default"><rect height="65.5999984741211" width="155.28125" y="-32.79999923706055" x="-77.640625" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan></tspan></text></g></g></g><g transform="translate(414.75, 156.39999771118164)" id="flowchart-L3-4" class="node default"><rect height="47" width="169.40625" y="-23.5" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan></text></g></g></g><g transform="translate(92.703125, 262.6999969482422)" id="flowchart-L1-6" class="node default"><rect height="47" width="169.40625" y="-23.5" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan></text></g></g></g><g transform="translate(312.109375, 262.6999969482422)" id="flowchart-L2-8" class="node default"><rect height="47" width="169.40625" y="-23.5" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>Each internal node caches the total bytes in its left subtree. To find byte offset 75:</p>
<ol type="1">
<li>Root has <code>left_bytes: 100</code>, and 75 &lt; 100, so go left</li>
<li>Internal has <code>left_bytes: 50</code>, and 75 &gt;= 50, so go right with offset 75-50=25</li>
<li>Piece has 50 bytes, offset 25 is within it</li>
</ol>
<p>This is O(log P) where P is the number of pieces.</p>
<h2 id="line-feed-tracking">Line Feed Tracking</h2>
<p>Text editors need fast line-based operations: "go to line 1000", "what line is byte offset 50000 on?", or simply displaying line numbers. Scanning the entire document for newlines would be O(N) - too slow for large files.</p>
<p>Fresh tracks line feeds the same way it tracks bytes. Each piece stores its newline count, and internal nodes cache the count for their left subtree:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 507.453125 348" style="max-width: 507.453px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"/><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_I2_0" d="M242.261,91.2L235.618,95.367C228.976,99.533,215.691,107.867,209.049,115.533C202.406,123.2,202.406,130.2,202.406,133.7L202.406,137.2"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I1_L3_0" d="M374.896,91.2L381.538,95.367C388.18,99.533,401.465,107.867,408.108,117C414.75,126.133,414.75,136.067,414.75,141.033L414.75,146"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L1_0" d="M133.883,224.4L127.02,228.567C120.156,232.733,106.43,241.067,99.566,248.733C92.703,256.4,92.703,263.4,92.703,266.9L92.703,270.4"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_I2_L2_0" d="M270.93,224.4L277.793,228.567C284.656,232.733,298.383,241.067,305.246,248.733C312.109,256.4,312.109,263.4,312.109,266.9L312.109,270.4"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(308.578125, 49.599998474121094)" id="flowchart-I1-0" class="node default"><rect height="83.19999694824219" width="164.1796875" y="-41.599998474121094" x="-82.08984375" style="" class="basic label-container"/><g transform="translate(0, -26.599998474121094)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 100</tspan></tspan><tspan dy="1.1em" y="2.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">lf_left:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 3</tspan></tspan></text></g></g></g><g transform="translate(202.40625, 182.79999542236328)" id="flowchart-I2-2" class="node default"><rect height="83.19999694824219" width="155.28125" y="-41.599998474121094" x="-77.640625" style="" class="basic label-container"/><g transform="translate(0, -26.599998474121094)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Internal</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">left_bytes:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan></tspan><tspan dy="1.1em" y="2.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">lf_left:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2</tspan></tspan></text></g></g></g><g transform="translate(414.75, 182.79999542236328)" id="flowchart-L3-4" class="node default"><rect height="65.5999984741211" width="169.40625" y="-32.79999923706055" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 50</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">line_feeds:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1</tspan></tspan></text></g></g></g><g transform="translate(92.703125, 307.1999931335449)" id="flowchart-L1-6" class="node default"><rect height="65.5999984741211" width="169.40625" y="-32.79999923706055" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 30</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">line_feeds:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2</tspan></tspan></text></g></g></g><g transform="translate(312.109375, 307.1999931335449)" id="flowchart-L2-8" class="node default"><rect height="65.5999984741211" width="169.40625" y="-32.79999923706055" x="-84.703125" style="" class="basic label-container"/><g transform="translate(0, -17.799999237060547)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Piece:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 20</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> bytes</tspan></tspan><tspan dy="1.1em" y="1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">line_feeds:</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 0</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>To find which piece contains line 3:</p>
<ol type="1">
<li>Root has <code>lf_left: 3</code>, and 3 &gt;= 3, so go right with line 3-3=0</li>
<li>Piece L3 has <code>line_feeds: 1</code>, line 0 is within it</li>
</ol>
<p>This enables O(log P) line-to-offset conversion. The same structure supports offset-to-line lookup by accumulating line counts while traversing.</p>
<h2 id="large-file-mode">Large File Mode</h2>
<p>For files over 100MB, Fresh switches to <strong>large file mode</strong>: no line indexing, pure byte-based navigation.</p>
<p>Why skip line indexing? Counting newlines in a 500MB file means reading the entire file - exactly what lazy loading tries to avoid. Instead, Fresh:</p>
<ul>
<li><strong>Navigates by bytes</strong>: The viewport tracks a byte offset, not a line number. Scrolling moves by byte ranges.</li>
<li><strong>Estimates line counts</strong>: For the scrollbar and status bar, Fresh estimates total lines as <code>file_size / average_line_length</code>.</li>
<li><strong>Shows approximate line numbers</strong>: Visible lines display estimated line numbers based on bytes seen so far.</li>
</ul>
<p>This means "go to line 50000" in a huge file is an approximation, but opening and scrolling remains instant regardless of file size.</p>
<h2 id="immutable-tree-structure">Immutable Tree Structure</h2>
<p>Fresh uses immutable nodes - once created, a node is never modified. Edits create new nodes instead.</p>
<blockquote>
<p><strong>Implementation note:</strong> Fresh is written in Rust. Nodes are wrapped in <code>Arc&lt;T&gt;</code> (Atomic Reference Counted pointer) - think of it as a pointer that tracks how many things reference it. Multiple parts of the code (even different threads) can safely hold the same <code>Arc</code>, and the data is automatically freed when the last reference is dropped. We'll gloss over this detail going forward - just know that "sharing" a node is cheap and thread-safe.</p>
</blockquote>
<p>After an edit, old tree versions remain valid:</p>
<p><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 0 550.396484375 210" style="max-width: 550.396px; background-color: transparent;" class="flowchart" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#my-svg .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#my-svg .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#my-svg .cluster-label text{fill:#333;}#my-svg .cluster-label span{color:#333;}#my-svg .cluster-label span p{background-color:transparent;}#my-svg .label text,#my-svg span{fill:#333;color:#333;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .rough-node .label text,#my-svg .node .label text,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-anchor:middle;}#my-svg .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#my-svg .rough-node .label,#my-svg .node .label,#my-svg .image-shape .label,#my-svg .icon-shape .label{text-align:center;}#my-svg .node.clickable{cursor:pointer;}#my-svg .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#my-svg .arrowheadPath{fill:#333333;}#my-svg .edgePath .path{stroke:#333333;stroke-width:2.0px;}#my-svg .flowchart-link{stroke:#333333;fill:none;}#my-svg .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#my-svg .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#my-svg .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#my-svg .cluster text{fill:#333;}#my-svg .cluster span{color:#333;}#my-svg div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#my-svg .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg rect.text{fill:none;stroke-width:0;}#my-svg .icon-shape,#my-svg .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#my-svg .icon-shape p,#my-svg .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#my-svg .icon-shape rect,#my-svg .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#my-svg .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#my-svg .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"/></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="my-svg_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="my-svg_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"/></marker><g class="root"><g class="clusters"><g data-look="classic" id="subGraph1" class="cluster"><rect height="194" width="197.9140625" y="8" x="8" style=""/><g transform="translate(34.91015625, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Version</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 2</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (after</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> edit)</tspan></tspan></text></g></g></g><g data-look="classic" id="subGraph0" class="cluster"><rect height="194" width="316.482421875" y="8" x="225.9140625" style=""/><g transform="translate(305.4365234375, 8)" class="cluster-label"><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Version</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> 1</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> (before</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> edit)</tspan></tspan></text></g></g></g></g><g class="edgePaths"><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V1_Root_V1_L_0" d="M348.281,80L342.157,84.167C336.032,88.333,323.784,96.667,317.659,104.333C311.535,112,311.535,119,311.535,122.5L311.535,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V1_Root_V1_R_0" d="M417.363,80L423.488,84.167C429.612,88.333,441.861,96.667,447.985,104.333C454.109,112,454.109,119,454.109,122.5L454.109,126"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V2_Root_V1_L_0" d="M130.428,80L133.624,84.167C136.82,88.333,143.212,96.667,165.487,106.548C187.763,116.429,225.923,127.858,245.002,133.573L264.082,139.287"/><path marker-end="url(#my-svg_flowchart-v2-pointEnd)" style="" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_V2_Root_V2_R_0" d="M107.557,80L106.698,84.167C105.839,88.333,104.121,96.667,103.261,104.333C102.402,112,102.402,119,102.402,122.5L102.402,126"/></g><g class="edgeLabels"><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g><rect style="stroke: none" class="background"/></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><text y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"/></text></g></g></g><g class="nodes"><g transform="translate(382.822265625, 56.5)" id="flowchart-V1_Root-0" class="node default"><rect height="47" width="115.2421875" y="-23.5" x="-57.62109375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Root</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> v1</tspan></tspan></text></g></g></g><g transform="translate(311.53515625, 153.5)" id="flowchart-V1_L-1" class="node default"><rect height="47" width="87.2421875" y="-23.5" x="-43.62109375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Left</tspan></tspan></text></g></g></g><g transform="translate(454.109375, 153.5)" id="flowchart-V1_R-3" class="node default"><rect height="47" width="97.90625" y="-23.5" x="-48.953125" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Right</tspan></tspan></text></g></g></g><g transform="translate(112.40234375, 56.5)" id="flowchart-V2_Root-4" class="node default"><rect height="47" width="115.2421875" y="-23.5" x="-57.62109375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Root</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> v2</tspan></tspan></text></g></g></g><g transform="translate(102.40234375, 153.5)" id="flowchart-V2_R-7" class="node default"><rect height="47" width="118.8046875" y="-23.5" x="-59.40234375" style="" class="basic label-container"/><g transform="translate(0, -8.5)" style="" class="label"><rect/><g><rect style="stroke: none" class="background"/><text style="" y="-10.1"><tspan dy="1.1em" y="-0.1em" x="0" class="text-outer-tspan"><tspan font-weight="normal" class="text-inner-tspan" font-style="normal">Right</tspan><tspan font-weight="normal" class="text-inner-tspan" font-style="normal"> v2</tspan></tspan></text></g></g></g></g></g></g></svg></p>
<p>Version 2 shares the unchanged left subtree with Version 1. This enables:</p>
<ul>
<li>Undo/redo by keeping old root references</li>
<li>Concurrent reads without locks</li>
<li>Cheap snapshots</li>
</ul>
<h2 id="structural-diffing">Structural Diffing</h2>
<p>Fresh uses piece tree structure to power gutter change indicators (the marks showing modified lines). The algorithm finds what changed since last save:</p>
<ol type="1">
<li><strong>Pointer check</strong>: If saved and current tree roots are the same object, content is identical (instant).</li>
<li><strong>Structure diff</strong>: Compare piece references to find differing byte ranges. O(pieces), not O(file size).</li>
<li><strong>Content verification</strong> (optional): For small regions, verify bytes actually differ (handles undo edge cases).</li>
</ol>
<p>The diff returns line ranges that Fresh checks against the current viewport - only visible changed lines need indicators. This is especially useful for large files: detecting modifications in a 500MB file requires comparing piece metadata, not reading from disk.</p>
<h2 id="crash-recovery">Crash Recovery</h2>
<p>Fresh auto-saves modified buffers every 2 seconds for crash recovery. The piece tree structure makes this efficient for large files.</p>
<p><strong>The key insight</strong>: Recovery doesn't need to save the entire file - just the modifications. For a 500MB file with a few edits, Fresh saves only the changed chunks (a few KB), not 500MB.</p>
<p>The recovery format mirrors piece tree structure:</p>
<ul>
<li>Each chunk stores: byte offset, original length replaced, new content</li>
<li>To recover: load original file from disk, apply chunks on top</li>
</ul>
<p>This works because piece tree edits are already expressed as "replace bytes X-Y with content Z" - exactly what recovery chunks store. For new/small files, a single chunk contains the full content.</p>
<p>On crash detection (lock file exists but process died), Fresh offers to recover by reconstructing: original file + stored chunks  recovered content.</p>
<h2 id="fresh-vs-vs-code">Fresh vs VS Code</h2>
<p><a href="https://github.com/microsoft/vscode-textbuffer">VS Code also uses a piece tree</a>, but with a mutable tree - nodes are modified in place during rebalancing. Fresh uses a fully <a href="https://en.wikipedia.org/wiki/Persistent_data_structure">persistent data structure</a>: edits create new tree versions via path-copying, sharing unchanged subtrees between versions.</p>
<p>This gives Fresh cheap undo (keep old roots), lock-free concurrent reads, and instant snapshots - at the cost of more allocations per edit.</p>
<p>Fresh also implements lazy loading; VS Code loads entire files into memory.</p>
<h2 id="comparison-piece-tree-vs-rope">Comparison: Piece Tree vs Rope</h2>
<p>Different editors use different text storage structures:</p>
<ul>
<li><strong>Piece tree</strong>: VS Code, Fresh</li>
<li><strong><a href="https://en.wikipedia.org/wiki/Rope_(data_structure)">Rope</a></strong>: Helix (<a href="https://github.com/cessen/ropey">Ropey</a>), Zed (<a href="https://zed.dev/blog/zed-decoded-rope-sumtree">SumTree</a>)</li>
<li><strong>Rope-like</strong>: Vim (<a href="https://github.com/vim/vim/blob/master/src/memline.c">memline</a>), <a href="https://github.com/neovim/neovim/discussions/25647">Neovim?</a></li>
<li><strong><a href="https://en.wikipedia.org/wiki/Gap_buffer">Gap buffer</a></strong>: Emacs</li>
</ul>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Piece Tree (Fresh, VS Code, MS Word 1.1)</th>
<th>Rope (Helix, Zed, Neovim?)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Node contents</td>
<td>Pointer to buffer</td>
<td>Actual text (~1KB chunks)</td>
</tr>
<tr>
<td>Insert</td>
<td>Append to buffer, add piece</td>
<td>May copy/split chunk</td>
</tr>
<tr>
<td>Original file</td>
<td>Preserved in buffer 0</td>
<td>Reorganized into chunks</td>
</tr>
<tr>
<td>Large files</td>
<td>Lazy load regions (Fresh, Word 1.1a)</td>
<td>Must load or stream</td>
</tr>
<tr>
<td>Memory for edits</td>
<td>Minimal (just pointers)</td>
<td>Copies chunk data</td>
</tr>
</tbody>
</table>
<h2 id="piece-tree-trade-offs">Piece Tree Trade-offs</h2>
<p><strong>Pros:</strong> Original file preserved, inserts never copy existing text, natural lazy loading, pieces are small (~24 bytes) so more fit in cache, enables structural diffing (see above).</p>
<p><strong>Cons:</strong> Extra indirection (find piece, then fetch buffer), buffer fragmentation over many edits, poor cache locality for text content. Piece count grows with edits, though periodic coalescing can mitigate this.</p>
<p><em>(Note: Fresh's current implementation rebuilds the entire tree on each edit rather than path-copying, making edits O(P) instead of O(log P). This is an implementation gap, not inherent to the design.)</em></p>
<h2 id="further-reading">Further Reading</h2>
<ul>
<li><a href="https://sinelaw.github.io/fresh/">Fresh</a> - The editor discussed in this post (<a href="https://github.com/sinelaw/fresh">source on GitHub</a>)</li>
<li><a href="https://computerhistory.org/blog/microsoft-word-for-windows-1-1a-source-code/">Microsoft Word 1.1a Source Code</a> - Original piece table implementation from 1990</li>
<li><a href="https://code.visualstudio.com/blogs/2018/03/23/text-buffer-reimplementation">VS Code's Piece Table</a> - Microsoft's 2018 write-up on reviving piece tables</li>
<li><a href="https://zed.dev/blog/zed-decoded-rope-sumtree">Zed's Rope &amp; SumTree</a> - How Zed implements ropes with B+ trees</li>
<li><a href="https://coredumped.dev/2023/08/09/text-showdown-gap-buffers-vs-ropes/">Text Showdown: Gap Buffers vs Ropes</a> - Performance comparison</li>
<li><a href="https://www.cs.unm.edu/~crowley/papers/sds.pdf">Data Structures for Text Sequences</a> - Charles Crowley, 1998 (academic survey)</li>
</ul>

  </article>

  <section class="comments">
    <script src="https://utteranc.es/client.js"
        repo="sinelaw/utterances"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
    </script>
  </section>
</main>

<footer class="site-footer">
  <div class="wrapper">
    <a href="/blog/"> Back to all posts</a>
    <div class="social-links">
      <a href="https://x.com/TheNoamLewis" title="Twitter/X" aria-label="Twitter">
        <img src="/blog/assets/icon-x.svg" alt="X/Twitter" width="24" height="24">
      </a>
      <a href="https://github.com/sinelaw" title="GitHub" aria-label="GitHub">
        <img src="/blog/assets/icon-github.svg" alt="GitHub" width="24" height="24">
      </a>
    </div>
  </div>
</footer>

</body>
</html>
